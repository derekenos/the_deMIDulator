MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      main.asm                                          *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 ; Software Stack uses FSR2 so hands off!
                      00022 
                      00023 ;**********************************************************************
                      00024 ; ENVIRONMENTAL DEFINES
                      00025 ;**********************************************************************
                      00026 
                      00027         ; define processor
                      00028         ; ..13K50 is default shipping processor, ..14k22 used for development
                      00029         #define PIC18LF13K50
                      00030 ;       #define PIC18LF14K22
                      00031 
                      00032 #ifdef  PIC18LF13K50
                      00033         list            p=18lf13k50                     ; list directive to define processor
                      00034 #endif
                      00035 #ifdef  PIC18LF14K22
                      00036         list            p=18lf14k22                     ; list directive to define processor
                      00037 #endif
                      00038         
                      00039         list            r=dec                                           ; set default radix to decimal
                      00040 
                      00041         #define USER_CODE_START_ADDRESS         0x0040  ; address must be aligned to 64-byte boundary
                      00042 
                      00043 ;**********************************************************************
                      00044 ; CONDITIONAL ASSEMBLY DEFINES
                      00045 ;**********************************************************************
                      00046 
                      00047 ; THROUGH_HOLE_PCB option swaps Sine/Square switch and LED assignments
                      00048         #define THROUGH_HOLE_PCB
                      00049 
                      00050 ; LED_POLARITY_REVERSED option reverses logic polarity for LEDs
                      00051         #define LED_POLARITY_REVERSED
                      00052         
                      00053 ; LED_STEADY_STATE_DISABLED option saves 4mA per LED but introduces high frequency noise during playback
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00054 ;       #define LED_STEADY_STATE_DISABLED
                      00055 
                      00056 ;       MIDI_DEBUG_TRIGGER_ENABLED option enables debug code in midiMessageMapper()
                      00057 ; MIDI_DEBUG_CC_NAME defines which on/off (127/0) controller number to use
                      00058 ;       #define MIDI_DEBUG_TRIGGER_ENABLED
                      00059 ;       #define MIDI_DEBUG_CC_NAME                                      GENERAL_PURPOSE_CONTROLLER_7
                      00060         
                      00061 ;**********************************************************************
                      00062 ; INCLUDE FILES
                      00063 ;**********************************************************************
                      00064 
                      00065 #ifdef  PIC18LF13K50
                      00066         ; processor specific variable definitions
                      00067         #include        <p18lf13k50.inc>
                      00001         LIST
                      00002 
                      00003 ;==========================================================================
                      00004 ;  MPASM PIC18LF13K50 processor include
                      00005 ; 
                      00006 ;  (c) Copyright 1999-2011 Microchip Technology, All rights reserved
                      00007 ;==========================================================================
                      00008 
                      01517         LIST
                      00068         ; configuration bit options copied from p18lf13k50.inc
                      00069         #include        "../include/config_PIC18LF13K50.inc"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      config.inc                                        *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 #ifndef CONFIG_INC
                      00022 #define CONFIG_INC
                      00023 
                      00024 ;==========================================================================
                      00025 ;
                      00026 ;   IMPORTANT: For the PIC18 devices, the __CONFIG directive has been
                      00027 ;              superseded by the CONFIG directive.  The following settings
                      00028 ;              are available for this device.
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00029 ;
                      00030 ;   CPU System Clock Selection bit:
                      00031 ;     CPUDIV = NOCLKDIV    No CPU System Clock divide
                      00032 ;     CPUDIV = CLKDIV2     CPU System Clock divided by 2
                      00033 ;     CPUDIV = CLKDIV3     CPU System Clock divided by 3
                      00034 ;     CPUDIV = CLKDIV4     CPU System Clock divided by 4
                      00035         CONFIG CPUDIV = NOCLKDIV
                      00036 
                      00037 ;
                      00038 ;   USB Clock Selection bit:
                      00039 ;     USBDIV = OFF         USB Clock comes directly from the OSC1/OSC2 oscillator block; no divide
                      00040 ;     USBDIV = ON          USB clock comes from the OSC1/OSC2 divided by 2
                      00041         CONFIG USBDIV = OFF
                      00042 
                      00043 ;
                      00044 ;   Oscillator Selection bits:
                      00045 ;     FOSC = LP            LP oscillator
                      00046 ;     FOSC = XT            XT oscillator
                      00047 ;     FOSC = HS            HS oscillator
                      00048 ;     FOSC = ERCCLKOUT     External RC oscillator, CLKOUT function on OSC2
                      00049 ;     FOSC = ECCLKOUTH     EC, CLKOUT function on OSC2 (high)
                      00050 ;     FOSC = ECH           EC (high)
                      00051 ;     FOSC = ERC           External RC oscillator
                      00052 ;     FOSC = IRC           Internal RC oscillator
                      00053 ;     FOSC = IRCCLKOUT     Internal RC oscillator, CLKOUT function on OSC2
                      00054 ;     FOSC = ECCLKOUTM     EC, CLKOUT function on OSC2 (medium)
                      00055 ;     FOSC = ECM           EC (medium)
                      00056 ;     FOSC = ECCLKOUTL     EC, CLKOUT function on OSC2 (low)
                      00057 ;     FOSC = ECL           EC (low)
                      00058         CONFIG FOSC = IRC
                      00059 
                      00060 ;
                      00061 ;   4 X PLL Enable bit:
                      00062 ;     PLLEN = OFF          PLL is under software control
                      00063 ;     PLLEN = ON           Oscillator multiplied by 4
                      00064         CONFIG PLLEN = OFF
                      00065 
                      00066 ;
                      00067 ;   Primary Clock Enable Bit:
                      00068 ;     PCLKEN = OFF         Primary clock is under software control
                      00069 ;     PCLKEN = ON          Primary clock enabled
                      00070         CONFIG PCLKEN = ON
                      00071 
                      00072 ;
                      00073 ;   Fail-Safe Clock Monitor Enable bit:
                      00074 ;     FCMEN = OFF          Fail-Safe Clock Monitor disabled
                      00075 ;     FCMEN = ON           Fail-Safe Clock Monitor enabled
                      00076         CONFIG FCMEN = OFF
                      00077 
                      00078 ;
                      00079 ;   Internal/External Oscillator Switchover bit:
                      00080 ;     IESO = OFF           Oscillator Switchover mode disabled
                      00081 ;     IESO = ON            Oscillator Switchover mode enabled
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00082         CONFIG IESO = ON
                      00083 
                      00084 ;
                      00085 ;   Power-up Timer Enable bit:
                      00086 ;     PWRTEN = ON          PWRT enabled
                      00087 ;     PWRTEN = OFF         PWRT disabled
                      00088         CONFIG PWRTEN = ON
                      00089 
                      00090 ;
                      00091 ;   Brown-out Reset Enable bits:
                      00092 ;     BOREN = OFF          Brown-out Reset disabled in hardware and software
                      00093 ;     BOREN = ON           Brown-out Reset enabled and controlled by software (SBOREN is enabled)
                      00094 ;     BOREN = NOSLP        Brown-out Reset enabled in hardware only and disabled in Sleep mode (SBOREN i
                            s disabled)
                      00095 ;     BOREN = SBORDIS      Brown-out Reset enabled in hardware only (SBOREN is disabled)
                      00096         CONFIG BOREN = ON
                      00097 
                      00098 ;
                      00099 ;   Brown Out Voltage:
                      00100 ;     BORV = 30            VBOR set to 3.0 V nominal
                      00101 ;     BORV = 27            VBOR set to 2.7 V nominal
                      00102 ;     BORV = 22            VBOR set to 2.2 V nominal
                      00103 ;     BORV = 19            VBOR set to 1.9 V nominal
                      00104         CONFIG BORV = 19
                      00105 
                      00106 ;
                      00107 ;   Watchdog Timer Enable bit:
                      00108 ;     WDTEN = OFF          WDT is controlled by SWDTEN bit of the WDTCON register
                      00109 ;     WDTEN = ON           WDT is always enabled. SWDTEN bit has no effect.
                      00110         CONFIG WDTEN = OFF
                      00111 
                      00112 ;
                      00113 ;   Watchdog Timer Postscale Select bits:
                      00114 ;     WDTPS = 1            1:1
                      00115 ;     WDTPS = 2            1:2
                      00116 ;     WDTPS = 4            1:4
                      00117 ;     WDTPS = 8            1:8
                      00118 ;     WDTPS = 16           1:16
                      00119 ;     WDTPS = 32           1:32
                      00120 ;     WDTPS = 64           1:64
                      00121 ;     WDTPS = 128          1:128
                      00122 ;     WDTPS = 256          1:256
                      00123 ;     WDTPS = 512          1:512
                      00124 ;     WDTPS = 1024         1:1024
                      00125 ;     WDTPS = 2048         1:2048
                      00126 ;     WDTPS = 4096         1:4096
                      00127 ;     WDTPS = 8192         1:8192
                      00128 ;     WDTPS = 16384        1:16384
                      00129 ;     WDTPS = 32768        1:32768
                      00130         CONFIG WDTPS = 1
                      00131 
                      00132 ;
                      00133 ;   MCLR Pin Enable bit:
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00134 ;     MCLRE = OFF          RA3 input pin enabled; MCLR disabled
                      00135 ;     MCLRE = ON           MCLR pin enabled, RA3 input pin disabled
                      00136         CONFIG MCLRE = OFF
                      00137 
                      00138 ;
                      00139 ;   HFINTOSC Fast Start-up bit:
                      00140 ;     HFOFST = OFF         The system clock is held off until the HFINTOSC is stable.
                      00141 ;     HFOFST = ON          HFINTOSC starts clocking the CPU without waiting for the oscillator to stabli
                            ze.
                      00142         CONFIG HFOFST = OFF
                      00143 
                      00144 ;
                      00145 ;   Stack Full/Underflow Reset Enable bit:
                      00146 ;     STVREN = OFF         Stack full/underflow will not cause Reset
                      00147 ;     STVREN = ON          Stack full/underflow will cause Reset
                      00148         CONFIG STVREN = ON
                      00149 
                      00150 ;
                      00151 ;   Single-Supply ICSP Enable bit:
                      00152 ;     LVP = OFF            Single-Supply ICSP disabled
                      00153 ;     LVP = ON             Single-Supply ICSP enabled
                      00154         CONFIG LVP = OFF
                      00155 
                      00156 ;
                      00157 ;   Boot Block Size Select Bit:
                      00158 ;     BBSIZ = OFF          512W boot block size
                      00159 ;     BBSIZ = ON           1kW boot block size
                      00160         CONFIG BBSIZ = ON
                      00161 
                      00162 ;
                      00163 ;   Extended Instruction Set Enable bit:
                      00164 ;     XINST = OFF          Instruction set extension and Indexed Addressing mode disabled (Legacy mode)
                      00165 ;     XINST = ON           Instruction set extension and Indexed Addressing mode enabled
                      00166         CONFIG XINST = OFF
                      00167 
                      00168 ;
                      00169 ;   Code Protection bit:
                      00170 ;     CP0 = ON             Block 0 code-protected
                      00171 ;     CP0 = OFF            Block 0 not code-protected
                      00172         CONFIG CP0 = OFF
                      00173 
                      00174 ;
                      00175 ;   Code Protection bit:
                      00176 ;     CP1 = ON             Block 1 code-protected
                      00177 ;     CP1 = OFF            Block 1 not code-protected
                      00178         CONFIG CP1 = OFF
                      00179         
                      00180 ;
                      00181 ;   Boot Block Code Protection bit:
                      00182 ;     CPB = ON             Boot block code-protected
                      00183 ;     CPB = OFF            Boot block not code-protected
                      00184         CONFIG CPB = OFF
                      00185 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00186 ;
                      00187 ;   Data EEPROM Code Protection bit:
                      00188 ;     CPD = ON             Data EEPROM code-protected
                      00189 ;     CPD = OFF            Data EEPROM not code-protected
                      00190         CONFIG CPD = OFF
                      00191 
                      00192 ;
                      00193 ;   Write Protection bit:
                      00194 ;     WRT0 = ON            Block 0 write-protected
                      00195 ;     WRT0 = OFF           Block 0 not write-protected
                      00196         CONFIG WRT0 = OFF
                      00197         
                      00198 ;
                      00199 ;   Write Protection bit:
                      00200 ;     WRT1 = ON            Block 1 write-protected
                      00201 ;     WRT1 = OFF           Block 1 not write-protected
                      00202         CONFIG WRT1 = OFF
                      00203 
                      00204 ;
                      00205 ;   Boot Block Write Protection bit:
                      00206 ;     WRTB = ON            Boot block write-protected
                      00207 ;     WRTB = OFF           Boot block not write-protected
                      00208         CONFIG WRTB = OFF
                      00209 
                      00210 ;
                      00211 ;   Configuration Register Write Protection bit:
                      00212 ;     WRTC = ON            Configuration registers write-protected
                      00213 ;     WRTC = OFF           Configuration registers not write-protected
                      00214         CONFIG WRTC = OFF
                      00215 
                      00216 ;
                      00217 ;   Data EEPROM Write Protection bit:
                      00218 ;     WRTD = ON            Data EEPROM write-protected
                      00219 ;     WRTD = OFF           Data EEPROM not write-protected
                      00220         CONFIG WRTD = OFF
                      00221 
                      00222 ;
                      00223 ;   Table Read Protection bit:
                      00224 ;     EBTR0 = ON           Block 0 protected from table reads executed in other blocks
                      00225 ;     EBTR0 = OFF          Block 0 not protected from table reads executed in other blocks
                      00226         CONFIG EBTR0 = OFF
                      00227 
                      00228 ;
                      00229 ;   Table Read Protection bit:
                      00230 ;     EBTR1 = ON           Block 1 protected from table reads executed in other blocks
                      00231 ;     EBTR1 = OFF          Block 1 not protected from table reads executed in other blocks
                      00232         CONFIG EBTR1 = OFF
                      00233 
                      00234 ;
                      00235 ;   Boot Block Table Read Protection bit:
                      00236 ;     EBTRB = ON           Boot block protected from table reads executed in other blocks
                      00237 ;     EBTRB = OFF          Boot block not protected from table reads executed in other blocks
                      00238         CONFIG EBTRB = OFF
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00239 
                      00240 ;
                      00241 ;==========================================================================
                      00242 
                      00243 #endif
                      00070 #endif
                      00071 
                      00072 #ifdef  PIC18LF14K22
                      00073         ; processor specific variable definitions
                      00074         #include        <p18lf14k22.inc>
                      00075         ; configuration bit options copied from p18lf13k50.inc
                      00076         #include        "../include/config_PIC18LF14K22.inc"
                      00077 #endif
                      00078 
                      00079         #include        "../header/midi.h"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      midi.h                                            *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 #ifndef _MIDIH_
                      00022 #define _MIDIH_
                      00023 
                      00024 
                      00025 ; ******************* MIDI SYSEX DEFINES ***********************
                      00026 #define         VENDOR_ID       0x77
                      00027 #define         DEVICE_ID       0x1D
                      00028 #define         TERMINAL_PACKET_COMMAND_VALUE   0x1E
                      00029 
                      00030 ; ******************* MIDI BUFFER SIZES ***********************
                      00031 
                      00032 #define         MAX_MIDI_MESSAGE_SIZE   24
                      00033 #define         ACTIVE_NOTE_TABLE_SIZE  25
                      00034 
                      00035 
                      00036 ; ******************* STATUS BYTE DEFINITONS ***********************
                      00037 
                      00038 ; Note that lower nybble (channel) should be masked out for comparison
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00039 ;------------------------
                      00040 #define         NOTE_OFF                                0x80
                      00041 #define         NOTE_ON                                 0x90
                      00042 #define         KEY_PRESSURE                    0xA0
                      00043 #define         CONTROL_CHANGE                  0xB0
                      00044 #define         PROGRAM_CHANGE                  0xC0
                      00045 #define         CHANNEL_PRESSURE                0xD0
                      00046 #define         PITCH_WHEEL                             0xE0
                      00047 
                      00048 ; Sysex Status Byte Definitions
                      00049 #define         SYSEX                                   0xF0
                      00050 #define         EOX                                             0xF7
                      00051 
                      00052 #define         NOTE_OFF_MESSAGE_LENGTH                         3
                      00053 #define         NOTE_ON_MESSAGE_LENGTH                          3
                      00054 #define         KEY_PRESSURE_MESSAGE_LENGTH                     3
                      00055 #define         CONTROL_CHANGE_MESSAGE_LENGTH           3
                      00056 #define         PROGRAM_CHANGE_MESSAGE_LENGTH           2
                      00057 #define         CHANNEL_PRESSURE_MESSAGE_LENGTH         2
                      00058 #define         PITCH_WHEEL_MESSAGE_LENGTH                      3
                      00059 
                      00060 ; SysEx Sub Types
                      00061 ;----------------------------
                      00062 #define         NON_REAL_TIME                                           0x7E
                      00063 #define         GENERAL_INFORMATION                                     0x06
                      00064 #define         IDENTITY_REQUEST                                        0x01
                      00065 #define         IDENTITY_REPLY                                          0x02
                      00066 
                      00067 ; Control Change Data Types
                      00068 ;----------------------------
                      00069 #define         BANK_SELECT_MSB                                         0
                      00070 #define         MODULATION_WHEEL_MSB                            1
                      00071 #define         BREATH_CONTROLLER_MSB                           2
                      00072 #define         UNDEFINED_003                                           3
                      00073 #define         FOOT_CONTROLLER_MSB                                     4
                      00074 #define         PORTAMENTO_TIME                                         5
                      00075 #define         DATA_ENTRY_MSB                                          6
                      00076 #define         CHANNEL_VOLUME_MSB                                      7
                      00077 #define         BALANCE_MSB                                                     8
                      00078 #define         UNDEFINED_MSB                                           9
                      00079 #define         PAN_MSB                                                         10
                      00080 #define         EXPRESSION_MSB                                          11
                      00081 #define         EFFECT_CONTROL_1_MSB                            12
                      00082 #define         EFFECT_CONTROL_2_MSB                            13
                      00083 #define         UNDEFINED_014                                           14
                      00084 #define         UNDEFINED_015                                           15
                      00085 #define         GENERAL_PURPOSE_CONTROLLER_1_MSB        16
                      00086 #define         GENERAL_PURPOSE_CONTROLLER_2_MSB        17
                      00087 #define         GENERAL_PURPOSE_CONTROLLER_3_MSB        18
                      00088 #define         GENERAL_PURPOSE_CONTROLLER_4_MSB        19
                      00089 #define         UNDEFINED_020                                           20
                      00090 #define         UNDEFINED_021                                           21
                      00091 #define         UNDEFINED_022                                           22
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00092 #define         UNDEFINED_023                                           23
                      00093 #define         UNDEFINED_024                                           24
                      00094 #define         UNDEFINED_025                                           25
                      00095 #define         UNDEFINED_026                                           26
                      00096 #define         UNDEFINED_027                                           27
                      00097 #define         UNDEFINED_028                                           28
                      00098 #define         UNDEFINED_029                                           29
                      00099 #define         UNDEFINED_030                                           30
                      00100 #define         UNDEFINED_031                                           31
                      00101 #define         BANK_SELECT_LSB                                         32
                      00102 #define         MODULATION_WHEEL_LSB                            33
                      00103 #define         BREATH_CONTROLLER_LSB                           34
                      00104 #define         UNDEFINED_035                                           35
                      00105 #define         FOOT_CONTROLLER_LSB                                     36
                      00106 #define         PORTAMENTO_TIME_LSB                                     37
                      00107 #define         DATA_ENTRY_LSB                                          38
                      00108 #define         CHANNEL_VOLUME_LSB                                      39
                      00109 #define         BALANCE_LSB                                                     40
                      00110 #define         UNDEFINED_041                                           41
                      00111 #define         PAN_LSB                                                         42
                      00112 #define         EXPRESSION_LSB                                          43
                      00113 #define         EFFECT_CONTROL_1_LSB                            44
                      00114 #define         EFFECT_CONTROL_2_LSB                            45
                      00115 #define         UNDEFINED_046                                           46
                      00116 #define         UNDEFINED_047                                           47
                      00117 #define         GENERAL_PURPOSE_CONTROLLER_1_LSB        48
                      00118 #define         GENERAL_PURPOSE_CONTROLLER_2_LSB        49
                      00119 #define         GENERAL_PURPOSE_CONTROLLER_3_LSB        50
                      00120 #define         GENERAL_PURPOSE_CONTROLLER_4_LSB        51
                      00121 #define         UNDEFINED_052                                           52
                      00122 #define         UNDEFINED_053                                           53
                      00123 #define         UNDEFINED_054                                           54
                      00124 #define         UNDEFINED_055                                           55
                      00125 #define         UNDEFINED_056                                           56
                      00126 #define         UNDEFINED_057                                           57
                      00127 #define         UNDEFINED_058                                           58
                      00128 #define         UNDEFINED_059                                           59
                      00129 #define         UNDEFINED_060                                           60
                      00130 #define         UNDEFINED_061                                           61
                      00131 #define         UNDEFINED_062                                           62
                      00132 #define         UNDEFINED_063                                           63
                      00133 #define         SUSTAIN_PEDAL                                           64
                      00134 #define         PORTAMENTO_ONOFF                                        65
                      00135 #define         SOSTENUTO                                                       66
                      00136 #define         SOFT_PEDAL                                                      67
                      00137 #define         LEGATO_FOOTSWITCH                                       68
                      00138 #define         HOLD_2                                                          69
                      00139 #define         SOUND_CONTROLLER_1_DEFAULT_SOUND_VARIATION                              70
                      00140 #define         SOUND_CONTROLLER_2_DEFAULT_TIMBRE_HARMONIC_QUALITY              71
                      00141 #define         SOUND_CONTROLLER_3_DEFAULT_RELEASE_TIME                                 72
                      00142 #define         SOUND_CONTROLLER_4_DEFAULT_ATTACK_TIME                                  73
                      00143 #define         SOUND_CONTROLLER_5_DEFAULT_BRIGHTNESS                                   74
                      00144 #define         SOUND_CONTROLLER_6_GM2_DEFAULT_DECAY_TIME                               75
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 10


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00145 #define         SOUND_CONTROLLER_7_GM2_DEFAULT_VIBRATO_RATE                             76
                      00146 #define         SOUND_CONTROLLER_8_GM2_DEFAULT_VIBRATO_DEPTH                    77
                      00147 #define         SOUND_CONTROLLER_9_GM2_DEFAULT_VIBRATO_DELAY                    78
                      00148 #define         SOUND_CONTROLLER_10_GM2_DEFAULT_UNDEFINED                               79
                      00149 #define         GENERAL_PURPOSE_CONTROLLER_5                                                    80
                      00150 #define         GENERAL_PURPOSE_CONTROLLER_6                                                    81
                      00151 #define         GENERAL_PURPOSE_CONTROLLER_7                                                    82
                      00152 #define         GENERAL_PURPOSE_CONTROLLER_8                                                    83
                      00153 #define         PORTAMENTO_CONTROL                                                                      
                                    84
                      00154 #define         UNDEFINED_85                                                                    85
                      00155 #define         UNDEFINED_86                                                                    86
                      00156 #define         UNDEFINED_87                                                                    87
                      00157 #define         UNDEFINED_88                                                                    88
                      00158 #define         UNDEFINED_89                                                                    89
                      00159 #define         UNDEFINED_90                                                                    90
                      00160 #define         EFFECTS_1_DEPTH_DEFAULT_REVERB_SEND                             91
                      00161 #define         EFFECTS_2_DEPTH_DEFAULT_TREMOLO_DEPTH                   92
                      00162 #define         EFFECTS_3_DEPTH_DEFAULT_CHORUS_SEND                             93
                      00163 #define         EFFECTS_4_DEPTH_DEFAULT_CELESTE_[DETUNE]_DEPTH  94
                      00164 #define         EFFECTS_5_DEPTH_DEFAULT_PHASER_DEPTH                    95
                      00165 #define         DATA_INCREMENT                                                                  96
                      00166 #define         DATA_DECREMENT                                                                  97
                      00167 #define         NON_REG_PARAMETER_NUMBER_LSB                            98
                      00168 #define         NON_REG_PARAMETER_NUMBER_MSB                            99
                      00169 #define         REGISTERED_PARAMETER_NUMBER_LSB                                 100
                      00170 #define         REGISTERED_PARAMETER_NUMBERMSB                                  101
                      00171 #define         UNDEFINED_102                                           102
                      00172 #define         UNDEFINED_103                                           103
                      00173 #define         UNDEFINED_104                                           104
                      00174 #define         UNDEFINED_105                                           105
                      00175 #define         UNDEFINED_106                                           106
                      00176 #define         UNDEFINED_107                                           107
                      00177 #define         UNDEFINED_108                                           108
                      00178 #define         UNDEFINED_109                                           109
                      00179 #define         UNDEFINED_110                                           110
                      00180 #define         UNDEFINED_111                                           111
                      00181 #define         UNDEFINED_112                                           112
                      00182 #define         UNDEFINED_113                                           113
                      00183 #define         UNDEFINED_114                                           114
                      00184 #define         UNDEFINED_115                                           115
                      00185 #define         UNDEFINED_116                                           116
                      00186 #define         UNDEFINED_117                                           117
                      00187 #define         UNDEFINED_118                                           118
                      00188 #define         UNDEFINED_119                                           119
                      00189 #define         ALL_SOUND_OFF                                           120
                      00190 #define         RESET_ALL_CONTROLLERS                           121
                      00191 #define         LOCAL_CONTROL_ONOFF                                     122
                      00192 #define         ALL_NOTES_OFF                                           123
                      00193 #define         OMNI_MODE_OFF                                           124
                      00194 #define         OMNI_MODE_ON                                            125
                      00195 #define         POLY_MODE_OFF                                           126
                      00196 #define         POLY_MODE_ON                                            127
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 11


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00197 
                      00198 
                      00199 ; ******************* MIDI MESSAGE STATES ***********************
                      00200 
                      00201 #define CHANNEL                                         0x00
                      00202 #define DATA_BYTE0                                      0x01
                      00203 #define DATA_BYTE1                                      0x02
                      00204 #define MESSAGE_COMPLETE                        0xFF
                      00205 
                      00206 #define NOTE_COMPLETE                           DATA_BYTE1
                      00207 #define AFTERTOUCH_COMPLETE                     DATA_BYTE1
                      00208 #define CONTROL_CHANGE_COMPLETE         DATA_BYTE1
                      00209 #define PROGRAM_CHANGE_COMPLETE         DATA_BYTE0
                      00210 #define PITCH_WHEEL_COMPLETE            DATA_BYTE1
                      00211 
                      00212 
                      00213 ; ******************* FLAG VARIABLE DEFINITIONS ***********************
                      00214 
                      00215 ; midiFlags (bits 3:7 free for use by other modules)
                      00216 #define uartState_rxInProgress                  0
                      00217 #define midiState_messageNeedsMapping   1
                      00218 #define midiThruModeEnabled                             2
                      00219 
                      00220 
                      00221 #endif
                      00080         #include        "../header/eeprom.h"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      eeprom.h                                          *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 #ifndef _EEPROMH_
                      00022 #define _EEPROMH_
                      00023 
                      00024 ; ******************* FLAG VARIABLE DEFINITIONS ***********************
                      00025 
                      00026 ; eepromFlags
                      00027 #define sampleChunkReady        0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 12


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00028 #define samplesLoaded                   1
                      00029 #define intState                                        2
                      00030 #define ready                                           3
                      00031 
                      00032 ; CAT25128 Status reg flags
                      00033 #define NOT_RDY 0
                      00034 #define WEL                     1
                      00035 #define BP0                     2
                      00036 #define BP1                     3
                      00037 #define WPEN            7
                      00038 
                      00039 ; ******************* COMMAND DEFINES ***********************
                      00040 #define EE_WREN         B'00000110'     ; Enable Write Operations
                      00041 #define EE_WRDI         B'00000100'     ; Disable Write Operations
                      00042 #define EE_RDSR         B'00000101'     ; Read Status Register
                      00043 #define EE_WRSR         B'00000001'     ; Write Status Register
                      00044 #define EE_READ         B'00000011'     ; Read Data from Memory
                      00045 #define EE_WRITE        B'00000010'     ; Write Data to Memory
                      00046 
                      00047 ; ******************* GENERAL DEFINES ***********************
                      00048 #define SAMPLE_DATA_BUFFER_SIZE 64
                      00049 #define EEPROM_SIZE_BITS 128000
                      00050 #define NEXT_SAMPLE_ADDRESSES_EL_SIZE   2
                      00051 
                      00052 ;**********************************************************************
                      00053 ; MACROS
                      00054 ;**********************************************************************
                      00055 
                      00056 
                      00057 ;**********************************************************************
                      00058 ASSERT_SS       MACRO
                      00059         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00060         ENDM
                      00061 
                      00062 ;**********************************************************************
                      00063 DEASSERT_SS     MACRO
                      00064         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00065         ENDM
                      00066 
                      00067 ;**********************************************************************
                      00068 EE_DISABLE_INTS MACRO
                      00069         bcf             eepromFlags, intState, ACCESS
                      00070         btfsc   INTCON, GIE, ACCESS
                      00071         bsf             eepromFlags, intState, ACCESS
                      00072         bcf             INTCON, GIE, ACCESS
                      00073         ENDM
                      00074 
                      00075 ;**********************************************************************
                      00076 EE_RESTORE_INTS MACRO
                      00077         btfsc   eepromFlags, intState, ACCESS
                      00078         bsf             INTCON, GIE, ACCESS
                      00079         ENDM
                      00080 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 13


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00081 ;**********************************************************************
                      00082 WRITE_INTERNAL_EEPROM   MACRO   literal_address, register_value
                      00083         local   writeIntEE_loop
                      00084         
                      00085         ; load address
                      00086         movlw   literal_address
                      00087         movwf   EEADR, ACCESS
                      00088         ; load value
                      00089         movff   register_value, EEDATA
                      00090         ; configure eeprom
                      00091         ; point to EEPROM DATA memory
                      00092         bcf             EECON1, EEPGD, ACCESS
                      00093         ; Access EEPROM/Program
                      00094         bcf             EECON1, CFGS, ACCESS    
                      00095         ; Enable writes
                      00096         bsf             EECON1, WREN, ACCESS
                      00097 
                      00098         ; don't have to disable interrupts because I'm only calling this
                      00099         ; from within the high-priority ISR
                      00100 
                      00101         ; required write enable sequence
                      00102         movlw   0x55
                      00103         movwf   EECON2, ACCESS
                      00104         movlw   0xAA
                      00105         movwf   EECON2, ACCESS
                      00106 
                      00107         ; set WR bit to begin write
                      00108         bsf             EECON1, WR, ACCESS
                      00109 writeIntEE_loop
                      00110         ; wait for write to complete
                      00111         btfsc   EECON1, WR, ACCESS
                      00112         bra             writeIntEE_loop
                      00113         ; disable writes
                      00114         bcf             EECON1, WREN, ACCESS
                      00115 
                      00116         ; point to Program memory
                      00117         bsf             EECON1, EEPGD, ACCESS
                      00118 
                      00119         ENDM
                      00120 
                      00121 ;**********************************************************************
                      00122 WRITE_INTERNAL_EEPROM_FROM_REGS MACRO   address, data
                      00123         local   writeIntEE_loop
                      00124         
                      00125         ; load address
                      00126         movff   address, EEADR
                      00127         ; load value
                      00128         movff   data, EEDATA
                      00129         ; configure eeprom
                      00130         ; point to EEPROM DATA memory
                      00131         bcf             EECON1, EEPGD, ACCESS
                      00132         ; Access EEPROM/Program
                      00133         bcf             EECON1, CFGS, ACCESS    
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 14


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00134         ; Enable writes
                      00135         bsf             EECON1, WREN, ACCESS
                      00136 
                      00137         ; don't have to disable interrupts because I'm only calling this
                      00138         ; from within the high-priority ISR
                      00139 
                      00140         ; required write enable sequence
                      00141         movlw   0x55
                      00142         movwf   EECON2, ACCESS
                      00143         movlw   0xAA
                      00144         movwf   EECON2, ACCESS
                      00145 
                      00146         ; set WR bit to begin write
                      00147         bsf             EECON1, WR, ACCESS
                      00148 writeIntEE_loop
                      00149         ; wait for write to complete
                      00150         btfsc   EECON1, WR, ACCESS
                      00151         bra             writeIntEE_loop
                      00152         ; disable writes
                      00153         bcf             EECON1, WREN, ACCESS
                      00154 
                      00155         ; point to Program memory
                      00156         bsf             EECON1, EEPGD, ACCESS
                      00157 
                      00158         ENDM
                      00159 
                      00160 ;;**********************************************************************
                      00161 ;;SPI_TX_LITERAL_RX_IN_WREG     MACRO   value
                      00162 ;       local   waitLoop
                      00163 ;
                      00164 ;; routine as recommended in Microchip PIC18F2458/2553/4458/4553 errata
                      00165 ;
                      00166 ;       ; clear interrupt flag
                      00167 ;       bcf             PIR1, SSPIF, ACCESS
                      00168 ;
                      00169 ;       ; perform read, even if the data in SSPBUF is not important 
                      00170 ;       movf    SSPBUF, w, ACCESS
                      00171 ;
                      00172 ;       ; SSPBUF = value
                      00173 ;       movlw   value
                      00174 ;       movwf   SSPBUF, ACCESS
                      00175 ;
                      00176 ;       ; wait fro transfer to complete
                      00177 ;waitLoop
                      00178 ;       btfss   PIR1, SSPIF, ACCESS
                      00179 ;       bra             waitLoop
                      00180 ;
                      00181 ;       ; the data received should be valid
                      00182 ;       movf    SSPBUF, w, ACCESS
                      00183 ;
                      00184 ;       ENDM
                      00185                                                 
                      00186 ;;**********************************************************************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 15


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00187 ;SPI_TX_WREG_RX_IN_WREG MACRO
                      00188 ;       local   waitLoop
                      00189 ;
                      00190 ;       ; save WREG to software stack
                      00191 ;       PUSH_R  WREG
                      00192 ;       
                      00193 ;; routine as recommended in Microchip PIC18F2458/2553/4458/4553 errata
                      00194 ;       ; clear interrupt flag
                      00195 ;       bcf             PIR1, SSPIF, ACCESS
                      00196 ;
                      00197 ;       ; perform read, even if the data in SSPBUF is not important 
                      00198 ;       movf    SSPBUF, w, ACCESS
                      00199 ;
                      00200 ;       ; SSPBUF = restored WREG from software stack
                      00201 ;       POP_R   WREG
                      00202 ;       movwf   SSPBUF, ACCESS
                      00203 ;
                      00204 ;       ; wait for transfer to complete
                      00205 ;waitLoop
                      00206 ;       btfss   PIR1, SSPIF, ACCESS
                      00207 ;       bra             waitLoop
                      00208 ;
                      00209 ;       ; the data received should be valid
                      00210 ;       movf    SSPBUF, w, ACCESS
                      00211 ;
                      00212 ;       ENDM
                      00213 
                      00214 #endif
                      00081         #include        "../header/softwareStack.h"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      softwareStack.h                                   *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 #ifndef SOFTWARESTACK_H
                      00022 #define SOFTWARESTACK_H
                      00023 
                      00024         #define softwareStackPointerFSR         FSR2
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 16


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00025         #define softwareStackPointerINDF        INDF2
                      00026         #define softwareStackPointerPOSTINC     POSTINC2
                      00027         #define softwareStackPointerPOSTDEC     POSTDEC2
                      00028         #define softwareStackPointerPREINC      PREINC2 
                      00029         #define softwareStackPointerPLUSW       PLUSW2  
                      00030 
                      00031 ; **** MACRO: PUSH_R    regName
                      00032 PUSH_R  MACRO   regName
                      00033         movff   regName, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00034                 ENDM
                      00035                 
                      00036 ; **** MACRO: POP_R     regName
                      00037 POP_R   MACRO   regName
                      00038         movff   softwareStackPointerPREINC, regName     ; ++softwareStackPointerINDF = regName
                      00039                 ENDM
                      00040 
                      00041 #endif
                      00082         #include        "../header/soundGen.h"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      soundGen.h                                        *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 #ifndef _SOUNDGENH_
                      00022 #define _SOUNDGENH_
                      00023 
                      00024 ;**********************************************************************
                      00025 ; GENERAL
                      00026 ;**********************************************************************
                      00027 
                      00028 ; Current code structure requires that MAX_POLY_DEPTH be set to 4!
                      00029 #define MAX_POLY_DEPTH                                  4       
                      00030 
                      00031 #define ACTIVE_NOTE_DELTAS_ELEMENT_SIZE 2
                      00032 #define ACTIVE_NOTE_DELTAS_SIZE                 MAX_POLY_DEPTH * ACTIVE_NOTE_DELTAS_ELEMENT_SIZE
                      00033 
                      00034 #define DELEGATED_DELTAS_ELEMENT_SIZE   2
                      00035 #define DELEGATED_DELTAS_SIZE                   MAX_POLY_DEPTH * DELEGATED_DELTAS_ELEMENT_SIZE
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 17


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00036 
                      00037 #define OSC_DELTAS_ELEMENT_SIZE                 2
                      00038 #define OSC_DELTAS_SIZE                                 MAX_POLY_DEPTH * OSC_DELTAS_ELEMENT_SIZE
                      00039 
                      00040 #define ACCUMULATORS_ELEMENT_SIZE               4
                      00041 #define ACCUMULATORS_SIZE                               MAX_POLY_DEPTH * ACCUMULATORS_ELEMENT_SIZE
                      00042 
                      00043 #define ACTIVE_OUTPUT_VALUES_EL_SIZE    1
                      00044 #define ACTIVE_OUTPUT_VALUES_SIZE               MAX_POLY_DEPTH * ACTIVE_OUTPUT_VALUES_EL_SIZE
                      00045 
                      00046 #define LED_BLINK_RATE_VOICE_THROUGH    20
                      00047 #define LED_BLINK_RATE_VOICE_RECORD             6
                      00048 
                      00049 ; set soundGen timebase prescales for wave and sample modes
                      00050 ; Timer2 interrupt period is currently 32uS
                      00051 ; set sample timebase period to 192uS (5208 Hz)
                      00052 #define SAMPLE_PRESCALE 6
                      00053 ; wave sine/square timebase period to 64uS (15.625 kHz)
                      00054 #define WAVE_PRESCALE   2
                      00055 
                      00056 #define MAX_MODE_LEVEL  MONO
                      00057 
                      00058 ; set power-up Attack and Release parameters
                      00059 ; adsrAttackRate and adsrReleaseRate variables have a range of 0 - 64
                      00060 ; rate of 0 == MIDI Attack/Release Time of 127
                      00061 ; rate of 64 == MIDI Attack/Release Time of 0
                      00062 #define ADSR_ATTACK_RATE        63
                      00063 #define ADSR_RELEASE_RATE       16
                      00064 
                      00065 ; set adsr prescale target to increment adsrLimiterRegs value every 19.52mS
                      00066 ; 19.52mS gives a max individual attack/release time of 4.99712 Seconds
                      00067 ; the "increment" value is set by adsrAttackRate and adsrReleaseRate
                      00068 #define ADSR_PRESCALE 610
                      00069 
                      00070 ; changing from 0x00 reference to 0x80 to improve Attack/Release waveform quality
                      00071 #define PWM_IDLE_OUTPUT_VALUE 0x80
                      00072 
                      00073 ; In SINE mode, this values sets the range (+/- PWM_IDLE_OUTPUT_VALUE) of activeOutputValue within which
                             an oscillator will be
                      00074 ; ungated for changes to its delegatedDelta value.  Only allowing changes when activeOutputValue is appr
                            oximately == PWM_IDLE_OUTPUT_VALUE
                      00075 ; greatly reduces popping caused by Sine wave cycle clipping
                      00076 #define OSC_TRANSITION_OUTPUT_THRESHOLD 0x04
                      00077 
                      00078 ; Audio input DC Bias measurement, 253 ADC sample average:
                      00079 ;   (VDD == 3.2V / 256 = 0.0125V per ADC increment)
                      00080 ;   on-board mic selected, MIC connceted      = 0x47 (@ VDD = 3.2V, 0x47 correlates to 0.8875V)
                      00081 ;   external mic selected, input floating     = 0x38 (@ VDD = 3.2V, 0x38 correlates to 0.7000V)
                      00082 ;   line-in selected, input floating          = 0x53 (@ VDD = 3.2V, 0x53 correlates to 1.0375V)
                      00083 ; Should have balanced these offsets in the hardware. oh well.
                      00084 ; Sine and Square outputs idle at 0x80, so compensate for difference in Sample bias to mitigate popping
                      00085 ; average of above measurement is 0x46, 0x80 - 0x46 = 0x3A
                      00086 ;#define SAMPLE_DC_OFFSET (PWM_IDLE_OUTPUT_VALUE - 0x46)
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 18


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00087 ; DEBUG - sample dc offset will change with component tolerances.  need to set manually for each PCB
                      00088 ; measured 0.930V RMS, 0.930 / 0.0125 = 74.4
                      00089 #define SAMPLE_DC_OFFSET (PWM_IDLE_OUTPUT_VALUE - 74)
                      00090 
                      00091 ; define the time to wait from record button release to start of sample recording
                      00092 ; this is an attempt to eliminate the record button's physical noise from the sample
                      00093 ;   Calculation Method:
                      00094 ;     timer2 int period == 32uS
                      00095 ;     samplePrescaleCounter == 6
                      00096 ;     32uS * 6 = 192uS
                      00097 ;     RECORD_BUTTON_RELEASE_WAIT_TIME = waitTimeInMs / 0.192
                      00098 ;                 maxTime = 192uS * 256 = 49.152mS
                      00099 ;
                      00100 ; load for delay of 5mS. (5 / 0.192 = 26.0417)
                      00101 #define RECORD_BUTTON_RELEASE_WAIT_TIME 26
                      00102 
                      00103 ;**********************************************************************
                      00104 ; ENUM TYPE DEFINITIONS
                      00105 ;**********************************************************************
                      00106 
                      00107 ; waveShape
                      00108 #define SINE 0
                      00109 #define SQUARE 1
                      00110 #define SAMPLE 2
                      00111 
                      00112 ; recordOrPlayback
                      00113 #define VOICE_THROUGH 0
                      00114 #define RECORD 1
                      00115 #define PLAYBACK 2
                      00116 
                      00117 ; modeLevels
                      00118 #define POLY 0
                      00119 #define SUSTAIN 1
                      00120 #define MONO 2
                      00121 
                      00122 
                      00123 ;**********************************************************************
                      00124 ; FLAG VARIABLE DEFINITIONS
                      00125 ;**********************************************************************
                      00126 
                      00127 ; midiFlags
                      00128 #define turnSoundOn 3
                      00129 #define turnSoundOff 4
                      00130 #define keyPressed 5
                      00131 #define soundOn 6
                      00132 
                      00133 ; soundGenFlags
                      00134 #define delegatorBusy 0
                      00135 #define pgDec 1
                      00136 #define needRefresh 2
                      00137 #define activeNoteTableModified 3
                      00138 
                      00139 ; oscResetFlags
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 19


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00140 #define osc0    0
                      00141 #define osc1    1
                      00142 #define osc2    2
                      00143 #define osc3    3
                      00144 
                      00145 ; oscStateFlags
                      00146 #define release 0
                      00147 #define sustain 1
                      00148 #define decay 2
                      00149 #define attack 3
                      00150 
                      00151 
                      00152 ;**********************************************************************
                      00153 ; MACROS
                      00154 ;**********************************************************************
                      00155 
                      00156 ;**********************************************************************
                      00157 CLEAR_ACCUMULATORS      MACRO
                      00158         local   loop
                      00159 
                      00160         ; init local variables
                      00161         PUSH_R  r0
                      00162         PUSH_R  FSR0L
                      00163         PUSH_R  FSR0H
                      00164         
                      00165         ; load fsr
                      00166         lfsr    FSR0, accumulators
                      00167 
                      00168         ; init count
                      00169         movf    polyDepth, w, ACCESS
                      00170         movwf   r0, ACCESS
                      00171 loop    
                      00172         ; each accumulator is 4 bytes wide
                      00173         clrf    POSTINC0, ACCESS        
                      00174         clrf    POSTINC0, ACCESS        
                      00175         clrf    POSTINC0, ACCESS        
                      00176         clrf    POSTINC0, ACCESS        
                      00177         ; decrement count, skip if done
                      00178         decfsz  r0, f, ACCESS
                      00179         bra             loop
                      00180 
                      00181         ; restore variables
                      00182         POP_R   FSR0H
                      00183         POP_R   FSR0L
                      00184         POP_R   r0
                      00185         
                      00186         ENDM
                      00187         
                      00188 
                      00189 ;**********************************************************************
                      00190 ENABLE_SUSTAIN  MACRO
                      00191         comf    oscResetFlags, w, ACCESS
                      00192         andlw   0x0f
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 20


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00193         movwf   sustainFlags, ACCESS
                      00194         ENDM
                      00195         
                      00196 ;**********************************************************************
                      00197 DISABLE_SUSTAIN MACRO
                      00198         clrf    sustainFlags, ACCESS
                      00199         ENDM
                      00200 
                      00201 ;**********************************************************************
                      00202 REVERSE_SAMPLE_IF_MOD_OVER_63   MACRO
                      00203         local exitMacro
                      00204         ; if modulation > 63 then reverse sample
                      00205         movlw   63
                      00206         cpfsgt  modulation, ACCESS
                      00207         bra             exitMacro
                      00208         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
                      00209         movf    nextSampleAddress, w, ACCESS
                      00210         subwf   sampleEndAddress, w, ACCESS
                      00211         movwf   nextSampleAddress, ACCESS
                      00212         movf    nextSampleAddress + 1, w, ACCESS
                      00213         subwfb  sampleEndAddress + 1, w, ACCESS
                      00214         movwf   nextSampleAddress + 1, ACCESS
                      00215 exitMacro
                      00216         ENDM
                      00217 
                      00218 ;**********************************************************************
                      00219 OSC_READ_ADSR_FLAG      MACRO   FLAG
                      00220 ; oscillator number passed in WREG
                      00221 ; boolean value is returned in WREG and ZERO flag is set accordingly
                      00222 
                      00223         ; push working regs onto software stack
                      00224         PUSH_R  FSR0L
                      00225         PUSH_R  FSR0H
                      00226         
                      00227         ; load fsr
                      00228         lfsr    FSR0, oscStateFlags
                      00229         ; read the register into WREG
                      00230         movf    PLUSW0, w, ACCESS
                      00231         andlw   1<<FLAG
                      00232         
                      00233         ; restore working regs from stack
                      00234         POP_R   FSR0H
                      00235         POP_R   FSR0L   
                      00236         
                      00237         ENDM
                      00238 
                      00239 ;**********************************************************************
                      00240 OSC_ADVANCE_ADSR        MACRO   OSC_NUMBER
                      00241         local   macroDone, doAttack, attackDone, doRelease, releaseDone
                      00242 
                      00243         ; ignore advance if oscillator is sustained
                      00244         btfsc   sustainFlags, OSC_NUMBER, ACCESS
                      00245         bra             macroDone
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 21


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00246         
                      00247         btfsc   oscStateFlags + OSC_NUMBER, attack, ACCESS
                      00248         bra             doAttack
                      00249         btfsc   oscStateFlags + OSC_NUMBER, release, ACCESS
                      00250         bra             doRelease
                      00251         bra             macroDone
                      00252         
                      00253 doAttack
                      00254         ; osc is attacking
                      00255 
                      00256         ; test condition ((adsrLimiterRegs -= ADSR_ATTACK_RATE) <=0)
                      00257         movf    adsrAttackRate, w, ACCESS
                      00258         subwf   adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00259         bnc             attackDone
                      00260         bz              attackDone
                      00261 
                      00262         ; condition is FALSE so do the subtraction and exit
                      00263         ; (adsrLimiterRegs -= ADSR_ATTACK_RATE)
                      00264         movf    adsrAttackRate, w, ACCESS
                      00265         subwf   adsrLimiterRegs + OSC_NUMBER, f, ACCESS
                      00266         bra             macroDone
                      00267 
                      00268 attackDone
                      00269         ; clear attack flag
                      00270         bcf             oscStateFlags + OSC_NUMBER, attack, ACCESS
                      00271         clrf    adsrLimiterRegs + OSC_NUMBER, ACCESS
                      00272         bra     macroDone
                      00273 
                      00274 doRelease
                      00275         ; osc is releasing
                      00276 
                      00277         ; test condition: ((adsrLimiterRegs + ADSR_ATTACK_RATE) >= 255)
                      00278         movf    adsrReleaseRate, w, ACCESS
                      00279         addwf   adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00280         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
                      00281         bc              releaseDone
                      00282         comf    WREG, w, ACCESS
                      00283         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
                      00284         bz              releaseDone
                      00285 
                      00286         ; condition is FALSE so do the addition and exit
                      00287         ; do (adsrLimiterRegs += ADSR_ATTACK_RATE)      
                      00288         movf    adsrReleaseRate, w, ACCESS
                      00289         addwf   adsrLimiterRegs + OSC_NUMBER, f, ACCESS
                      00290         bra             macroDone
                      00291         
                      00292 releaseDone
                      00293         ; clear release flag
                      00294         bcf             oscStateFlags + OSC_NUMBER, release, ACCESS
                      00295         ; set limit reg to max
                      00296         setf    adsrLimiterRegs + OSC_NUMBER, ACCESS
                      00297         ; clear oscillator's delegatedDelta
                      00298         clrf    delegatedDeltas + OSC_NUMBER * 2;
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 22


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00299         clrf    delegatedDeltas + (OSC_NUMBER * 2) + 1; 
                      00300         bra     macroDone
                      00301         
                      00302 macroDone
                      00303         ENDM
                      00304         
                      00305 ;**********************************************************************
                      00306 OSC_MIX MACRO   OSC_NUMBER
                      00307         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                      00308                 
                      00309         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
                      00310         movlw   PWM_IDLE_OUTPUT_VALUE
                      00311         subwf   activeOutputValues + OSC_NUMBER, w
                      00312         bnc             mixDoNeg
                      00313 mixDoPos
                      00314         ; WREG = adsrLimiterRegs/2
                      00315         bcf             STATUS, C, ACCESS
                      00316         rrcf    adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00317         subwf   activeOutputValues + OSC_NUMBER, w
                      00318         bra             mixDoDone
                      00319 mixDoNeg
                      00320         ; WREG = adsrLimiterRegs/2
                      00321         bcf             STATUS, C, ACCESS
                      00322         rrcf    adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00323         addwf   activeOutputValues + OSC_NUMBER, w      
                      00324 mixDoDone
                      00325         ; overflow indicates that last operation toggled bit 7
                      00326         btfsc   STATUS, OV, ACCESS
                      00327         movlw   PWM_IDLE_OUTPUT_VALUE
                      00328 
                      00329 mixDone
                      00330         ; add WREG to mixedOutputL/H
                      00331         addwf   mixedOutputL, f, ACCESS
                      00332         btfsc   STATUS, C, ACCESS
                      00333         incf    mixedOutputH, f, ACCESS
                      00334         
                      00335         ENDM
                      00336 
                      00337 ;**********************************************************************
                      00338 OSC_STATE_BLOCK MACRO   OSC_NUMBER
                      00339         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
                      00340         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                      00341                 
                      00342         ; if oscillator is locked for sustain then leave it alone
                      00343         btfsc   sustainFlags, OSC_NUMBER, ACCESS
                      00344         bra             oscActive
                      00345                         
                      00346 checkDelegating
                      00347         ; don't update if delegator is busy because delegatedDelta value is volatile
                      00348         btfsc   soundGenFlags, delegatorBusy, ACCESS
                      00349         ; delegator is busy so just keep spinning
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 23


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00350         bra             oscCheckActive
                      00351         
                      00352         ; THRESHOLD METHOD WORKS WELL
                      00353         movlw   SINE
                      00354         cpfseq waveShape, ACCESS
                      00355         bra             oscCheckNotSine
                      00356         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
                      00357         movlw   PWM_IDLE_OUTPUT_VALUE
                      00358         subwf   activeOutputValues + OSC_NUMBER, w
                      00359         ; invert if negative
                      00360         btfss   STATUS, C, ACCESS
                      00361         negf    WREG, ACCESS
                      00362         ; check if offset is below threshold value
                      00363         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
                      00364         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                      00365         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
                      00366         bnc             oscCheckActive
                      00367 
                      00368 oscCheckNotSine
                      00369 
                      00370         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
                      00371         movff   delegatedDeltas + (OSC_NUMBER * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (OSC_NUM
                            BER * OSC_DELTAS_ELEMENT_SIZE) + 0
                      00372         movff   delegatedDeltas + (OSC_NUMBER * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (OSC_NUM
                            BER * OSC_DELTAS_ELEMENT_SIZE) + 1
                      00373 
                      00374 oscCheckActive
                      00375         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                      00376         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
                      00377         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
                      00378         bnz             oscActive
                      00379         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
                      00380         bz              resetOscillator
                      00381         
                      00382 oscActive
                      00383         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
                      00384         btfsc   oscResetFlags, OSC_NUMBER, ACCESS
                      00385         bra             zeroAcc
                      00386 
                      00387         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                      00388         ; accumulator += activeNoteDelta
                      00389         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
                      00390         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, w
                      00391         addwf   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
                      00392         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
                      00393         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 24


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00394         movlw   0
                      00395         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
                      00396         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                      00397         
                      00398 zeroAcc
                      00399         ; we're done with oscResetFlags flag so ensure that it's clear
                      00400         bcf             oscResetFlags, OSC_NUMBER, ACCESS
                      00401         
                      00402         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                      00403         ; accumulator += pitchWheel
                      00404         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
                      00405         addwf   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
                      00406         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
                      00407         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
                      00408         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
                      00409         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
                      00410         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
                      00411         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                      00412         
                      00413         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                      00414         ; branch to waveform specific table address load
                      00415         movlw   SAMPLE
                      00416         cpfseq  waveShape, ACCESS
                      00417         bra             waveIsNotSample
                      00418 waveIsSample
                      00419 
                      00420         ; if samplesLoaded flag is set then load next EEPROM read address
                      00421         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                      00422         ; being able to load the samples in time, cause audio chopping rather than detuning
                      00423         btfss   eepromFlags, samplesLoaded, ACCESS
                      00424         bra             macroDone
                      00425         
                      00426         ; check for note transition
                      00427         ; keyPressed flag is set every time a MIDI Note On message is received
                      00428         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
                             beginning...
                      00429         ; whenever a Note On message is received.
                      00430         btfss   midiFlags, keyPressed, ACCESS
                      00431         bra             noTransition
                      00432         ; is modeLevel == POLY
                      00433         movlw   POLY
                      00434         xorwf   modeLevel, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 25


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00435         ; mode is POLY so reset accumulator to restart sample from beginning
                      00436         bz              clrSampleAcc
                      00437 
                      00438 noTransition    
                      00439         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                      00440         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
                      00441         ; is waveTableIndex > sampleEndAddress?
                      00442         movf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
                      00443         subwf   sampleEndAddress, w, ACCESS
                      00444         movf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
                      00445         subwfb  sampleEndAddress + 1, w, ACCESS
                      00446         ; result is positive so waveTableIndex is within valid range
                      00447         bc              addressOk
                      00448         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                      00449         ; reset accumulator
                      00450 clrSampleAcc
                      00451         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
                      00452         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
                      00453         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
                      00454         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
                      00455 addressOk
                      00456         
                      00457         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
                      00458         movff   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (OSC_NUMBER * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
                      00459         movff   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (OSC_NUMBER * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                      00460         
                      00461         bra             macroDone
                      00462         
                      00463 waveIsNotSample
                      00464         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                      00465         ; branch to waveform specific table address load
                      00466         movlw   SINE
                      00467         cpfseq  waveShape, ACCESS
                      00468         bra             waveIsSquare
                      00469 
                      00470 waveIsSine      
                      00471         ; 
                      00472         ; load address of SINE table read
                      00473         ; offset = ((accumulator >> 8) & 0xff)
                      00474         movf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1, w
                      00475         addwf   sineTableBaseAddress + 0, w
                      00476         movwf   TBLPTRL, ACCESS
                      00477         movf    sineTableBaseAddress + 1, w
                      00478         btfsc   STATUS, C, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 26


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00479         addlw   1
                      00480         movwf   TBLPTRH, ACCESS
                      00481         movf    sineTableBaseAddress + 2, w
                      00482         btfsc   STATUS, C, ACCESS
                      00483         addlw   1
                      00484         movwf   TBLPTRU, ACCESS
                      00485         bra             tableAddressLoaded
                      00486 
                      00487 waveIsSquare
                      00488         ; load address of SQUARE table read
                      00489         ; offset = ((accumulator >> 8) & 0xff)
                      00490         movf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1, w
                      00491         addwf   squareTableBaseAddress + 0, w
                      00492         movwf   TBLPTRL, ACCESS
                      00493         movf    squareTableBaseAddress + 1, w
                      00494         btfsc   STATUS, C, ACCESS
                      00495         addlw   1
                      00496         movwf   TBLPTRH, ACCESS
                      00497         movf    squareTableBaseAddress + 2, w
                      00498         btfsc   STATUS, C, ACCESS
                      00499         addlw   1
                      00500         movwf   TBLPTRU, ACCESS
                      00501 
                      00502 tableAddressLoaded
                      00503         ; read value from program memory
                      00504         tblrd*
                      00505         movff   TABLAT, activeOutputValues + (OSC_NUMBER * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
                      00506         bra             macroDone
                      00507         
                      00508 resetOscillator
                      00509         ; set oscillator reset flag
                      00510         bsf             oscResetFlags, OSC_NUMBER, ACCESS
                      00511         movlw   PWM_IDLE_OUTPUT_VALUE
                      00512         movwf   activeOutputValues + (OSC_NUMBER * ACTIVE_OUTPUT_VALUES_EL_SIZE)
                      00513         clrf    oscDeltas + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE) + 0
                      00514         clrf    oscDeltas + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE) + 1
                      00515         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 0
                      00516         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1
                      00517         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 2
                      00518         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 3
                      00519 
                      00520 macroDone
                      00521 
                      00522         ENDM
                      00523         
                      00524         
                      00525 #endif
                      00526 
                      00527 
                      00083 
                      00084         
                      00085 ;**********************************************************************
                      00086 ; GLOBAL VARIABLES
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 27


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00087 ;**********************************************************************
                      00088 
                      00089         ; declare isr tmp and working register variables
                      00090         ; align to RAM address 0x0000
                      00091         CBLOCK 0
  00000000            00092                 wTmp:1
  00000001            00093                 statusTmp:1
  00000002            00094                 bsrTmp:1
  00000003            00095                 r0:1
  00000004            00096                 r1:1
  00000005            00097                 r2:1
  00000006            00098                 r3:1
  00000007            00099                 r4:1
  00000008            00100                 r5:1
  00000009            00101                 r6:1
  0000000A            00102                 r7:1
                      00103         ENDC
                      00104         
                      00105 
                      00106 ;**********************************************************************
                      00107 ; CODE BEGIN / RESET VECTOR
                      00108 ;**********************************************************************
                      00109 
                      00110         ORG             0x0000                                                  ; processor reset vector
000000 6AFA           00111         clrf    PCLATH                                                  ; ensure page bits are cleared
000002 EF?? F???      00112         goto    mootLoader                                              ; jump to bootloader
                      00113 
                      00114 ;**********************************************************************
                      00115 ; INTERRUPT VECTORS
                      00116 ;**********************************************************************
                      00117 
                      00118         ORG     0x0008                                          ; high-priority interrupt vector
000008 EF?? F???      00119         goto    highPriorityISR_redirect
                      00120 
                      00121         ORG     0x0018                                          ; low-priority interrupt vector
000018 EF?? F???      00122         goto    lowPriorityISR_redirect
                      00123 
                      00124 
                      00125 ;**********************************************************************
                      00126 ; USER-DEFINED MAIN() AND ISR() REDIRECTS
                      00127 ;**********************************************************************
                      00128 ; To prevent the user from rendering the bootloader unusable in the event
                      00129 ; of a failed Program Memory write, the first >=64 bytes of Program Memory
                      00130 ; will not be writable (set via USER_CODE_START_ADDRESS define) via the
                      00131 ; bootloader so must contain no user code.
                      00132 ; The first 64 bytes will contain only:
                      00133 ;
                      00134 ; 0x0000: clrf  PCLATH                                          ; set bank-select bits to Bank0
                      00135 ; 0x0001: goto  mootLoader                                      ; jump to bootloader on reset
                      00136 ; 0x0008: goto  highPriorityISR_redirect        ; jump to high priority ISR redirect in user space
                      00137 ; 0x0018: goto  lowPriorityISR_redirect         ; jump to low priority ISR redirect in user space
                      00138 ;
                      00139 ; since these will not be modifiable without a hardware programmer, these
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 28


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00140 ; redirects will point to the following static addresses:
                      00141 ;
                      00142 ; 0x0040: goto main                             ; jump to main()
                      00143 ; 0x0044: goto highPriorityISR  ; jump to highPriorityISR()
                      00144 ; 0x0048: goto lowPriorityISR   ; jump to lowPriorityISR()
                      00145 ;
                      00146 ; When writing new firmware, the user is responsible for maintaing these 
                      00147 ; jump instructions at these addresses.  Note that the "goto" instruction
                      00148 ; requires 2 words of Program Memory space.
                      00149 
                      00150         ORG             USER_CODE_START_ADDRESS
000040                00151 main_redirect
000040 EF?? F???      00152         goto    main
000044                00153 highPriorityISR_redirect
000044 EF?? F???      00154         goto    highPriorityISR
000048                00155 lowPriorityISR_redirect
000048 EF?? F???      00156         goto    lowPriorityISR
                      00157 
                      00158 ;**********************************************************************
                      00159 ; INTERRUPT SERVICE ROUTINE CODE BEGIN
                      00160 ;**********************************************************************
                      00161 
                      00162         ; insert ISR code
                      00163         #include        "../source/ISRs.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      ISRs.asm                                          *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021         
                      00022 ;**********************************************************************
                      00023 ; INCLUDES
                      00024 ;**********************************************************************
                      00025 
                      00026         #include        "../header/midi.h"
                      00222 
                      00223 ;**********************************************************************
                      00224 ;                                                                     *
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 29


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00225 ;    Project:       deMIDulator                                       *
                      00226 ;    Filename:      midi.h                                            *
                      00227 ;    Date:                                                            *
                      00228 ;    File Version:                                                    *
                      00229 ;                                                                     *
                      00230 ;    Author:        Derek Enos                                        *
                      00231 ;    Company:                                                         *
                      00232 ;                                                                     * 
                      00233 ;                                                                     *
                      00234 ;**********************************************************************
                      00235 ;                                                                     *
                      00236 ;    Files required:                                                  *
                      00237 ;                                                                     *
                      00238 ;                                                                     *
                      00239 ;                                                                     *
                      00240 ;**********************************************************************
                      00241 
                      00242 #ifndef _MIDIH_
                      00243 #define _MIDIH_
                      00244 
                      00245 
                      00246 ; ******************* MIDI SYSEX DEFINES ***********************
                      00247 #define         VENDOR_ID       0x77
                      00248 #define         DEVICE_ID       0x1D
                      00249 #define         TERMINAL_PACKET_COMMAND_VALUE   0x1E
                      00250 
                      00251 ; ******************* MIDI BUFFER SIZES ***********************
                      00252 
                      00253 #define         MAX_MIDI_MESSAGE_SIZE   24
                      00254 #define         ACTIVE_NOTE_TABLE_SIZE  25
                      00255 
                      00256 
                      00257 ; ******************* STATUS BYTE DEFINITONS ***********************
                      00258 
                      00259 ; Note that lower nybble (channel) should be masked out for comparison
                      00260 ;------------------------
                      00261 #define         NOTE_OFF                                0x80
                      00262 #define         NOTE_ON                                 0x90
                      00263 #define         KEY_PRESSURE                    0xA0
                      00264 #define         CONTROL_CHANGE                  0xB0
                      00265 #define         PROGRAM_CHANGE                  0xC0
                      00266 #define         CHANNEL_PRESSURE                0xD0
                      00267 #define         PITCH_WHEEL                             0xE0
                      00268 
                      00269 ; Sysex Status Byte Definitions
                      00270 #define         SYSEX                                   0xF0
                      00271 #define         EOX                                             0xF7
                      00272 
                      00273 #define         NOTE_OFF_MESSAGE_LENGTH                         3
                      00274 #define         NOTE_ON_MESSAGE_LENGTH                          3
                      00275 #define         KEY_PRESSURE_MESSAGE_LENGTH                     3
                      00276 #define         CONTROL_CHANGE_MESSAGE_LENGTH           3
                      00277 #define         PROGRAM_CHANGE_MESSAGE_LENGTH           2
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 30


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00278 #define         CHANNEL_PRESSURE_MESSAGE_LENGTH         2
                      00279 #define         PITCH_WHEEL_MESSAGE_LENGTH                      3
                      00280 
                      00281 ; SysEx Sub Types
                      00282 ;----------------------------
                      00283 #define         NON_REAL_TIME                                           0x7E
                      00284 #define         GENERAL_INFORMATION                                     0x06
                      00285 #define         IDENTITY_REQUEST                                        0x01
                      00286 #define         IDENTITY_REPLY                                          0x02
                      00287 
                      00288 ; Control Change Data Types
                      00289 ;----------------------------
                      00290 #define         BANK_SELECT_MSB                                         0
                      00291 #define         MODULATION_WHEEL_MSB                            1
                      00292 #define         BREATH_CONTROLLER_MSB                           2
                      00293 #define         UNDEFINED_003                                           3
                      00294 #define         FOOT_CONTROLLER_MSB                                     4
                      00295 #define         PORTAMENTO_TIME                                         5
                      00296 #define         DATA_ENTRY_MSB                                          6
                      00297 #define         CHANNEL_VOLUME_MSB                                      7
                      00298 #define         BALANCE_MSB                                                     8
                      00299 #define         UNDEFINED_MSB                                           9
                      00300 #define         PAN_MSB                                                         10
                      00301 #define         EXPRESSION_MSB                                          11
                      00302 #define         EFFECT_CONTROL_1_MSB                            12
                      00303 #define         EFFECT_CONTROL_2_MSB                            13
                      00304 #define         UNDEFINED_014                                           14
                      00305 #define         UNDEFINED_015                                           15
                      00306 #define         GENERAL_PURPOSE_CONTROLLER_1_MSB        16
                      00307 #define         GENERAL_PURPOSE_CONTROLLER_2_MSB        17
                      00308 #define         GENERAL_PURPOSE_CONTROLLER_3_MSB        18
                      00309 #define         GENERAL_PURPOSE_CONTROLLER_4_MSB        19
                      00310 #define         UNDEFINED_020                                           20
                      00311 #define         UNDEFINED_021                                           21
                      00312 #define         UNDEFINED_022                                           22
                      00313 #define         UNDEFINED_023                                           23
                      00314 #define         UNDEFINED_024                                           24
                      00315 #define         UNDEFINED_025                                           25
                      00316 #define         UNDEFINED_026                                           26
                      00317 #define         UNDEFINED_027                                           27
                      00318 #define         UNDEFINED_028                                           28
                      00319 #define         UNDEFINED_029                                           29
                      00320 #define         UNDEFINED_030                                           30
                      00321 #define         UNDEFINED_031                                           31
                      00322 #define         BANK_SELECT_LSB                                         32
                      00323 #define         MODULATION_WHEEL_LSB                            33
                      00324 #define         BREATH_CONTROLLER_LSB                           34
                      00325 #define         UNDEFINED_035                                           35
                      00326 #define         FOOT_CONTROLLER_LSB                                     36
                      00327 #define         PORTAMENTO_TIME_LSB                                     37
                      00328 #define         DATA_ENTRY_LSB                                          38
                      00329 #define         CHANNEL_VOLUME_LSB                                      39
                      00330 #define         BALANCE_LSB                                                     40
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 31


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00331 #define         UNDEFINED_041                                           41
                      00332 #define         PAN_LSB                                                         42
                      00333 #define         EXPRESSION_LSB                                          43
                      00334 #define         EFFECT_CONTROL_1_LSB                            44
                      00335 #define         EFFECT_CONTROL_2_LSB                            45
                      00336 #define         UNDEFINED_046                                           46
                      00337 #define         UNDEFINED_047                                           47
                      00338 #define         GENERAL_PURPOSE_CONTROLLER_1_LSB        48
                      00339 #define         GENERAL_PURPOSE_CONTROLLER_2_LSB        49
                      00340 #define         GENERAL_PURPOSE_CONTROLLER_3_LSB        50
                      00341 #define         GENERAL_PURPOSE_CONTROLLER_4_LSB        51
                      00342 #define         UNDEFINED_052                                           52
                      00343 #define         UNDEFINED_053                                           53
                      00344 #define         UNDEFINED_054                                           54
                      00345 #define         UNDEFINED_055                                           55
                      00346 #define         UNDEFINED_056                                           56
                      00347 #define         UNDEFINED_057                                           57
                      00348 #define         UNDEFINED_058                                           58
                      00349 #define         UNDEFINED_059                                           59
                      00350 #define         UNDEFINED_060                                           60
                      00351 #define         UNDEFINED_061                                           61
                      00352 #define         UNDEFINED_062                                           62
                      00353 #define         UNDEFINED_063                                           63
                      00354 #define         SUSTAIN_PEDAL                                           64
                      00355 #define         PORTAMENTO_ONOFF                                        65
                      00356 #define         SOSTENUTO                                                       66
                      00357 #define         SOFT_PEDAL                                                      67
                      00358 #define         LEGATO_FOOTSWITCH                                       68
                      00359 #define         HOLD_2                                                          69
                      00360 #define         SOUND_CONTROLLER_1_DEFAULT_SOUND_VARIATION                              70
                      00361 #define         SOUND_CONTROLLER_2_DEFAULT_TIMBRE_HARMONIC_QUALITY              71
                      00362 #define         SOUND_CONTROLLER_3_DEFAULT_RELEASE_TIME                                 72
                      00363 #define         SOUND_CONTROLLER_4_DEFAULT_ATTACK_TIME                                  73
                      00364 #define         SOUND_CONTROLLER_5_DEFAULT_BRIGHTNESS                                   74
                      00365 #define         SOUND_CONTROLLER_6_GM2_DEFAULT_DECAY_TIME                               75
                      00366 #define         SOUND_CONTROLLER_7_GM2_DEFAULT_VIBRATO_RATE                             76
                      00367 #define         SOUND_CONTROLLER_8_GM2_DEFAULT_VIBRATO_DEPTH                    77
                      00368 #define         SOUND_CONTROLLER_9_GM2_DEFAULT_VIBRATO_DELAY                    78
                      00369 #define         SOUND_CONTROLLER_10_GM2_DEFAULT_UNDEFINED                               79
                      00370 #define         GENERAL_PURPOSE_CONTROLLER_5                                                    80
                      00371 #define         GENERAL_PURPOSE_CONTROLLER_6                                                    81
                      00372 #define         GENERAL_PURPOSE_CONTROLLER_7                                                    82
                      00373 #define         GENERAL_PURPOSE_CONTROLLER_8                                                    83
                      00374 #define         PORTAMENTO_CONTROL                                                                      
                                    84
                      00375 #define         UNDEFINED_85                                                                    85
                      00376 #define         UNDEFINED_86                                                                    86
                      00377 #define         UNDEFINED_87                                                                    87
                      00378 #define         UNDEFINED_88                                                                    88
                      00379 #define         UNDEFINED_89                                                                    89
                      00380 #define         UNDEFINED_90                                                                    90
                      00381 #define         EFFECTS_1_DEPTH_DEFAULT_REVERB_SEND                             91
                      00382 #define         EFFECTS_2_DEPTH_DEFAULT_TREMOLO_DEPTH                   92
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 32


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00383 #define         EFFECTS_3_DEPTH_DEFAULT_CHORUS_SEND                             93
                      00384 #define         EFFECTS_4_DEPTH_DEFAULT_CELESTE_[DETUNE]_DEPTH  94
                      00385 #define         EFFECTS_5_DEPTH_DEFAULT_PHASER_DEPTH                    95
                      00386 #define         DATA_INCREMENT                                                                  96
                      00387 #define         DATA_DECREMENT                                                                  97
                      00388 #define         NON_REG_PARAMETER_NUMBER_LSB                            98
                      00389 #define         NON_REG_PARAMETER_NUMBER_MSB                            99
                      00390 #define         REGISTERED_PARAMETER_NUMBER_LSB                                 100
                      00391 #define         REGISTERED_PARAMETER_NUMBERMSB                                  101
                      00392 #define         UNDEFINED_102                                           102
                      00393 #define         UNDEFINED_103                                           103
                      00394 #define         UNDEFINED_104                                           104
                      00395 #define         UNDEFINED_105                                           105
                      00396 #define         UNDEFINED_106                                           106
                      00397 #define         UNDEFINED_107                                           107
                      00398 #define         UNDEFINED_108                                           108
                      00399 #define         UNDEFINED_109                                           109
                      00400 #define         UNDEFINED_110                                           110
                      00401 #define         UNDEFINED_111                                           111
                      00402 #define         UNDEFINED_112                                           112
                      00403 #define         UNDEFINED_113                                           113
                      00404 #define         UNDEFINED_114                                           114
                      00405 #define         UNDEFINED_115                                           115
                      00406 #define         UNDEFINED_116                                           116
                      00407 #define         UNDEFINED_117                                           117
                      00408 #define         UNDEFINED_118                                           118
                      00409 #define         UNDEFINED_119                                           119
                      00410 #define         ALL_SOUND_OFF                                           120
                      00411 #define         RESET_ALL_CONTROLLERS                           121
                      00412 #define         LOCAL_CONTROL_ONOFF                                     122
                      00413 #define         ALL_NOTES_OFF                                           123
                      00414 #define         OMNI_MODE_OFF                                           124
                      00415 #define         OMNI_MODE_ON                                            125
                      00416 #define         POLY_MODE_OFF                                           126
                      00417 #define         POLY_MODE_ON                                            127
                      00418 
                      00419 
                      00420 ; ******************* MIDI MESSAGE STATES ***********************
                      00421 
                      00422 #define CHANNEL                                         0x00
                      00423 #define DATA_BYTE0                                      0x01
                      00424 #define DATA_BYTE1                                      0x02
                      00425 #define MESSAGE_COMPLETE                        0xFF
                      00426 
                      00427 #define NOTE_COMPLETE                           DATA_BYTE1
                      00428 #define AFTERTOUCH_COMPLETE                     DATA_BYTE1
                      00429 #define CONTROL_CHANGE_COMPLETE         DATA_BYTE1
                      00430 #define PROGRAM_CHANGE_COMPLETE         DATA_BYTE0
                      00431 #define PITCH_WHEEL_COMPLETE            DATA_BYTE1
                      00432 
                      00433 
                      00434 ; ******************* FLAG VARIABLE DEFINITIONS ***********************
                      00435 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 33


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00436 ; midiFlags (bits 3:7 free for use by other modules)
                      00437 #define uartState_rxInProgress                  0
                      00438 #define midiState_messageNeedsMapping   1
                      00439 #define midiThruModeEnabled                             2
                      00440 
                      00441 
                      00442 #endif
                      00027         #include        "../header/soundGen.h"
                      00528 
                      00529 ;**********************************************************************
                      00530 ;                                                                     *
                      00531 ;    Project:       deMIDulator                                       *
                      00532 ;    Filename:      soundGen.h                                        *
                      00533 ;    Date:                                                            *
                      00534 ;    File Version:                                                    *
                      00535 ;                                                                     *
                      00536 ;    Author:        Derek Enos                                        *
                      00537 ;    Company:                                                         *
                      00538 ;                                                                     * 
                      00539 ;                                                                     *
                      00540 ;**********************************************************************
                      00541 ;                                                                     *
                      00542 ;    Files required:                                                  *
                      00543 ;                                                                     *
                      00544 ;                                                                     *
                      00545 ;                                                                     *
                      00546 ;**********************************************************************
                      00547 
                      00548 #ifndef _SOUNDGENH_
                      00549 #define _SOUNDGENH_
                      00550 
                      00551 ;**********************************************************************
                      00552 ; GENERAL
                      00553 ;**********************************************************************
                      00554 
                      00555 ; Current code structure requires that MAX_POLY_DEPTH be set to 4!
                      00556 #define MAX_POLY_DEPTH                                  4       
                      00557 
                      00558 #define ACTIVE_NOTE_DELTAS_ELEMENT_SIZE 2
                      00559 #define ACTIVE_NOTE_DELTAS_SIZE                 MAX_POLY_DEPTH * ACTIVE_NOTE_DELTAS_ELEMENT_SIZE
                      00560 
                      00561 #define DELEGATED_DELTAS_ELEMENT_SIZE   2
                      00562 #define DELEGATED_DELTAS_SIZE                   MAX_POLY_DEPTH * DELEGATED_DELTAS_ELEMENT_SIZE
                      00563 
                      00564 #define OSC_DELTAS_ELEMENT_SIZE                 2
                      00565 #define OSC_DELTAS_SIZE                                 MAX_POLY_DEPTH * OSC_DELTAS_ELEMENT_SIZE
                      00566 
                      00567 #define ACCUMULATORS_ELEMENT_SIZE               4
                      00568 #define ACCUMULATORS_SIZE                               MAX_POLY_DEPTH * ACCUMULATORS_ELEMENT_SIZE
                      00569 
                      00570 #define ACTIVE_OUTPUT_VALUES_EL_SIZE    1
                      00571 #define ACTIVE_OUTPUT_VALUES_SIZE               MAX_POLY_DEPTH * ACTIVE_OUTPUT_VALUES_EL_SIZE
                      00572 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 34


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00573 #define LED_BLINK_RATE_VOICE_THROUGH    20
                      00574 #define LED_BLINK_RATE_VOICE_RECORD             6
                      00575 
                      00576 ; set soundGen timebase prescales for wave and sample modes
                      00577 ; Timer2 interrupt period is currently 32uS
                      00578 ; set sample timebase period to 192uS (5208 Hz)
                      00579 #define SAMPLE_PRESCALE 6
                      00580 ; wave sine/square timebase period to 64uS (15.625 kHz)
                      00581 #define WAVE_PRESCALE   2
                      00582 
                      00583 #define MAX_MODE_LEVEL  MONO
                      00584 
                      00585 ; set power-up Attack and Release parameters
                      00586 ; adsrAttackRate and adsrReleaseRate variables have a range of 0 - 64
                      00587 ; rate of 0 == MIDI Attack/Release Time of 127
                      00588 ; rate of 64 == MIDI Attack/Release Time of 0
                      00589 #define ADSR_ATTACK_RATE        63
                      00590 #define ADSR_RELEASE_RATE       16
                      00591 
                      00592 ; set adsr prescale target to increment adsrLimiterRegs value every 19.52mS
                      00593 ; 19.52mS gives a max individual attack/release time of 4.99712 Seconds
                      00594 ; the "increment" value is set by adsrAttackRate and adsrReleaseRate
                      00595 #define ADSR_PRESCALE 610
                      00596 
                      00597 ; changing from 0x00 reference to 0x80 to improve Attack/Release waveform quality
                      00598 #define PWM_IDLE_OUTPUT_VALUE 0x80
                      00599 
                      00600 ; In SINE mode, this values sets the range (+/- PWM_IDLE_OUTPUT_VALUE) of activeOutputValue within which
                             an oscillator will be
                      00601 ; ungated for changes to its delegatedDelta value.  Only allowing changes when activeOutputValue is appr
                            oximately == PWM_IDLE_OUTPUT_VALUE
                      00602 ; greatly reduces popping caused by Sine wave cycle clipping
                      00603 #define OSC_TRANSITION_OUTPUT_THRESHOLD 0x04
                      00604 
                      00605 ; Audio input DC Bias measurement, 253 ADC sample average:
                      00606 ;   (VDD == 3.2V / 256 = 0.0125V per ADC increment)
                      00607 ;   on-board mic selected, MIC connceted      = 0x47 (@ VDD = 3.2V, 0x47 correlates to 0.8875V)
                      00608 ;   external mic selected, input floating     = 0x38 (@ VDD = 3.2V, 0x38 correlates to 0.7000V)
                      00609 ;   line-in selected, input floating          = 0x53 (@ VDD = 3.2V, 0x53 correlates to 1.0375V)
                      00610 ; Should have balanced these offsets in the hardware. oh well.
                      00611 ; Sine and Square outputs idle at 0x80, so compensate for difference in Sample bias to mitigate popping
                      00612 ; average of above measurement is 0x46, 0x80 - 0x46 = 0x3A
                      00613 ;#define SAMPLE_DC_OFFSET (PWM_IDLE_OUTPUT_VALUE - 0x46)
                      00614 ; DEBUG - sample dc offset will change with component tolerances.  need to set manually for each PCB
                      00615 ; measured 0.930V RMS, 0.930 / 0.0125 = 74.4
                      00616 #define SAMPLE_DC_OFFSET (PWM_IDLE_OUTPUT_VALUE - 74)
                      00617 
                      00618 ; define the time to wait from record button release to start of sample recording
                      00619 ; this is an attempt to eliminate the record button's physical noise from the sample
                      00620 ;   Calculation Method:
                      00621 ;     timer2 int period == 32uS
                      00622 ;     samplePrescaleCounter == 6
                      00623 ;     32uS * 6 = 192uS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 35


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00624 ;     RECORD_BUTTON_RELEASE_WAIT_TIME = waitTimeInMs / 0.192
                      00625 ;                 maxTime = 192uS * 256 = 49.152mS
                      00626 ;
                      00627 ; load for delay of 5mS. (5 / 0.192 = 26.0417)
                      00628 #define RECORD_BUTTON_RELEASE_WAIT_TIME 26
                      00629 
                      00630 ;**********************************************************************
                      00631 ; ENUM TYPE DEFINITIONS
                      00632 ;**********************************************************************
                      00633 
                      00634 ; waveShape
                      00635 #define SINE 0
                      00636 #define SQUARE 1
                      00637 #define SAMPLE 2
                      00638 
                      00639 ; recordOrPlayback
                      00640 #define VOICE_THROUGH 0
                      00641 #define RECORD 1
                      00642 #define PLAYBACK 2
                      00643 
                      00644 ; modeLevels
                      00645 #define POLY 0
                      00646 #define SUSTAIN 1
                      00647 #define MONO 2
                      00648 
                      00649 
                      00650 ;**********************************************************************
                      00651 ; FLAG VARIABLE DEFINITIONS
                      00652 ;**********************************************************************
                      00653 
                      00654 ; midiFlags
                      00655 #define turnSoundOn 3
                      00656 #define turnSoundOff 4
                      00657 #define keyPressed 5
                      00658 #define soundOn 6
                      00659 
                      00660 ; soundGenFlags
                      00661 #define delegatorBusy 0
                      00662 #define pgDec 1
                      00663 #define needRefresh 2
                      00664 #define activeNoteTableModified 3
                      00665 
                      00666 ; oscResetFlags
                      00667 #define osc0    0
                      00668 #define osc1    1
                      00669 #define osc2    2
                      00670 #define osc3    3
                      00671 
                      00672 ; oscStateFlags
                      00673 #define release 0
                      00674 #define sustain 1
                      00675 #define decay 2
                      00676 #define attack 3
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 36


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00677 
                      00678 
                      00679 ;**********************************************************************
                      00680 ; MACROS
                      00681 ;**********************************************************************
                      00682 
                      00683 ;**********************************************************************
                      00684 CLEAR_ACCUMULATORS      MACRO
                      00685         local   loop
                      00686 
                      00687         ; init local variables
                      00688         PUSH_R  r0
                      00689         PUSH_R  FSR0L
                      00690         PUSH_R  FSR0H
                      00691         
                      00692         ; load fsr
                      00693         lfsr    FSR0, accumulators
                      00694 
                      00695         ; init count
                      00696         movf    polyDepth, w, ACCESS
                      00697         movwf   r0, ACCESS
                      00698 loop    
                      00699         ; each accumulator is 4 bytes wide
                      00700         clrf    POSTINC0, ACCESS        
                      00701         clrf    POSTINC0, ACCESS        
                      00702         clrf    POSTINC0, ACCESS        
                      00703         clrf    POSTINC0, ACCESS        
                      00704         ; decrement count, skip if done
                      00705         decfsz  r0, f, ACCESS
                      00706         bra             loop
                      00707 
                      00708         ; restore variables
                      00709         POP_R   FSR0H
                      00710         POP_R   FSR0L
                      00711         POP_R   r0
                      00712         
                      00713         ENDM
                      00714         
                      00715 
                      00716 ;**********************************************************************
                      00717 ENABLE_SUSTAIN  MACRO
                      00718         comf    oscResetFlags, w, ACCESS
                      00719         andlw   0x0f
                      00720         movwf   sustainFlags, ACCESS
                      00721         ENDM
                      00722         
                      00723 ;**********************************************************************
                      00724 DISABLE_SUSTAIN MACRO
                      00725         clrf    sustainFlags, ACCESS
                      00726         ENDM
                      00727 
                      00728 ;**********************************************************************
                      00729 REVERSE_SAMPLE_IF_MOD_OVER_63   MACRO
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 37


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00730         local exitMacro
                      00731         ; if modulation > 63 then reverse sample
                      00732         movlw   63
                      00733         cpfsgt  modulation, ACCESS
                      00734         bra             exitMacro
                      00735         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
                      00736         movf    nextSampleAddress, w, ACCESS
                      00737         subwf   sampleEndAddress, w, ACCESS
                      00738         movwf   nextSampleAddress, ACCESS
                      00739         movf    nextSampleAddress + 1, w, ACCESS
                      00740         subwfb  sampleEndAddress + 1, w, ACCESS
                      00741         movwf   nextSampleAddress + 1, ACCESS
                      00742 exitMacro
                      00743         ENDM
                      00744 
                      00745 ;**********************************************************************
                      00746 OSC_READ_ADSR_FLAG      MACRO   FLAG
                      00747 ; oscillator number passed in WREG
                      00748 ; boolean value is returned in WREG and ZERO flag is set accordingly
                      00749 
                      00750         ; push working regs onto software stack
                      00751         PUSH_R  FSR0L
                      00752         PUSH_R  FSR0H
                      00753         
                      00754         ; load fsr
                      00755         lfsr    FSR0, oscStateFlags
                      00756         ; read the register into WREG
                      00757         movf    PLUSW0, w, ACCESS
                      00758         andlw   1<<FLAG
                      00759         
                      00760         ; restore working regs from stack
                      00761         POP_R   FSR0H
                      00762         POP_R   FSR0L   
                      00763         
                      00764         ENDM
                      00765 
                      00766 ;**********************************************************************
                      00767 OSC_ADVANCE_ADSR        MACRO   OSC_NUMBER
                      00768         local   macroDone, doAttack, attackDone, doRelease, releaseDone
                      00769 
                      00770         ; ignore advance if oscillator is sustained
                      00771         btfsc   sustainFlags, OSC_NUMBER, ACCESS
                      00772         bra             macroDone
                      00773         
                      00774         btfsc   oscStateFlags + OSC_NUMBER, attack, ACCESS
                      00775         bra             doAttack
                      00776         btfsc   oscStateFlags + OSC_NUMBER, release, ACCESS
                      00777         bra             doRelease
                      00778         bra             macroDone
                      00779         
                      00780 doAttack
                      00781         ; osc is attacking
                      00782 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 38


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00783         ; test condition ((adsrLimiterRegs -= ADSR_ATTACK_RATE) <=0)
                      00784         movf    adsrAttackRate, w, ACCESS
                      00785         subwf   adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00786         bnc             attackDone
                      00787         bz              attackDone
                      00788 
                      00789         ; condition is FALSE so do the subtraction and exit
                      00790         ; (adsrLimiterRegs -= ADSR_ATTACK_RATE)
                      00791         movf    adsrAttackRate, w, ACCESS
                      00792         subwf   adsrLimiterRegs + OSC_NUMBER, f, ACCESS
                      00793         bra             macroDone
                      00794 
                      00795 attackDone
                      00796         ; clear attack flag
                      00797         bcf             oscStateFlags + OSC_NUMBER, attack, ACCESS
                      00798         clrf    adsrLimiterRegs + OSC_NUMBER, ACCESS
                      00799         bra     macroDone
                      00800 
                      00801 doRelease
                      00802         ; osc is releasing
                      00803 
                      00804         ; test condition: ((adsrLimiterRegs + ADSR_ATTACK_RATE) >= 255)
                      00805         movf    adsrReleaseRate, w, ACCESS
                      00806         addwf   adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00807         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
                      00808         bc              releaseDone
                      00809         comf    WREG, w, ACCESS
                      00810         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
                      00811         bz              releaseDone
                      00812 
                      00813         ; condition is FALSE so do the addition and exit
                      00814         ; do (adsrLimiterRegs += ADSR_ATTACK_RATE)      
                      00815         movf    adsrReleaseRate, w, ACCESS
                      00816         addwf   adsrLimiterRegs + OSC_NUMBER, f, ACCESS
                      00817         bra             macroDone
                      00818         
                      00819 releaseDone
                      00820         ; clear release flag
                      00821         bcf             oscStateFlags + OSC_NUMBER, release, ACCESS
                      00822         ; set limit reg to max
                      00823         setf    adsrLimiterRegs + OSC_NUMBER, ACCESS
                      00824         ; clear oscillator's delegatedDelta
                      00825         clrf    delegatedDeltas + OSC_NUMBER * 2;
                      00826         clrf    delegatedDeltas + (OSC_NUMBER * 2) + 1; 
                      00827         bra     macroDone
                      00828         
                      00829 macroDone
                      00830         ENDM
                      00831         
                      00832 ;**********************************************************************
                      00833 OSC_MIX MACRO   OSC_NUMBER
                      00834         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                      00835                 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 39


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00836         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
                      00837         movlw   PWM_IDLE_OUTPUT_VALUE
                      00838         subwf   activeOutputValues + OSC_NUMBER, w
                      00839         bnc             mixDoNeg
                      00840 mixDoPos
                      00841         ; WREG = adsrLimiterRegs/2
                      00842         bcf             STATUS, C, ACCESS
                      00843         rrcf    adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00844         subwf   activeOutputValues + OSC_NUMBER, w
                      00845         bra             mixDoDone
                      00846 mixDoNeg
                      00847         ; WREG = adsrLimiterRegs/2
                      00848         bcf             STATUS, C, ACCESS
                      00849         rrcf    adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      00850         addwf   activeOutputValues + OSC_NUMBER, w      
                      00851 mixDoDone
                      00852         ; overflow indicates that last operation toggled bit 7
                      00853         btfsc   STATUS, OV, ACCESS
                      00854         movlw   PWM_IDLE_OUTPUT_VALUE
                      00855 
                      00856 mixDone
                      00857         ; add WREG to mixedOutputL/H
                      00858         addwf   mixedOutputL, f, ACCESS
                      00859         btfsc   STATUS, C, ACCESS
                      00860         incf    mixedOutputH, f, ACCESS
                      00861         
                      00862         ENDM
                      00863 
                      00864 ;**********************************************************************
                      00865 OSC_STATE_BLOCK MACRO   OSC_NUMBER
                      00866         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
                      00867         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                      00868                 
                      00869         ; if oscillator is locked for sustain then leave it alone
                      00870         btfsc   sustainFlags, OSC_NUMBER, ACCESS
                      00871         bra             oscActive
                      00872                         
                      00873 checkDelegating
                      00874         ; don't update if delegator is busy because delegatedDelta value is volatile
                      00875         btfsc   soundGenFlags, delegatorBusy, ACCESS
                      00876         ; delegator is busy so just keep spinning
                      00877         bra             oscCheckActive
                      00878         
                      00879         ; THRESHOLD METHOD WORKS WELL
                      00880         movlw   SINE
                      00881         cpfseq waveShape, ACCESS
                      00882         bra             oscCheckNotSine
                      00883         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
                      00884         movlw   PWM_IDLE_OUTPUT_VALUE
                      00885         subwf   activeOutputValues + OSC_NUMBER, w
                      00886         ; invert if negative
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 40


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00887         btfss   STATUS, C, ACCESS
                      00888         negf    WREG, ACCESS
                      00889         ; check if offset is below threshold value
                      00890         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
                      00891         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                      00892         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
                      00893         bnc             oscCheckActive
                      00894 
                      00895 oscCheckNotSine
                      00896 
                      00897         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
                      00898         movff   delegatedDeltas + (OSC_NUMBER * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (OSC_NUM
                            BER * OSC_DELTAS_ELEMENT_SIZE) + 0
                      00899         movff   delegatedDeltas + (OSC_NUMBER * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (OSC_NUM
                            BER * OSC_DELTAS_ELEMENT_SIZE) + 1
                      00900 
                      00901 oscCheckActive
                      00902         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                      00903         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
                      00904         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
                      00905         bnz             oscActive
                      00906         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
                      00907         bz              resetOscillator
                      00908         
                      00909 oscActive
                      00910         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
                      00911         btfsc   oscResetFlags, OSC_NUMBER, ACCESS
                      00912         bra             zeroAcc
                      00913 
                      00914         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                      00915         ; accumulator += activeNoteDelta
                      00916         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
                      00917         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, w
                      00918         addwf   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
                      00919         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
                      00920         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
                      00921         movlw   0
                      00922         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
                      00923         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                      00924         
                      00925 zeroAcc
                      00926         ; we're done with oscResetFlags flag so ensure that it's clear
                      00927         bcf             oscResetFlags, OSC_NUMBER, ACCESS
                      00928         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 41


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00929         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                      00930         ; accumulator += pitchWheel
                      00931         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
                      00932         addwf   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
                      00933         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
                      00934         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
                      00935         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
                      00936         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
                      00937         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
                      00938         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                      00939         
                      00940         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                      00941         ; branch to waveform specific table address load
                      00942         movlw   SAMPLE
                      00943         cpfseq  waveShape, ACCESS
                      00944         bra             waveIsNotSample
                      00945 waveIsSample
                      00946 
                      00947         ; if samplesLoaded flag is set then load next EEPROM read address
                      00948         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                      00949         ; being able to load the samples in time, cause audio chopping rather than detuning
                      00950         btfss   eepromFlags, samplesLoaded, ACCESS
                      00951         bra             macroDone
                      00952         
                      00953         ; check for note transition
                      00954         ; keyPressed flag is set every time a MIDI Note On message is received
                      00955         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
                             beginning...
                      00956         ; whenever a Note On message is received.
                      00957         btfss   midiFlags, keyPressed, ACCESS
                      00958         bra             noTransition
                      00959         ; is modeLevel == POLY
                      00960         movlw   POLY
                      00961         xorwf   modeLevel, w, ACCESS
                      00962         ; mode is POLY so reset accumulator to restart sample from beginning
                      00963         bz              clrSampleAcc
                      00964 
                      00965 noTransition    
                      00966         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                      00967         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
                      00968         ; is waveTableIndex > sampleEndAddress?
                      00969         movf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
                      00970         subwf   sampleEndAddress, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 42


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00971         movf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
                      00972         subwfb  sampleEndAddress + 1, w, ACCESS
                      00973         ; result is positive so waveTableIndex is within valid range
                      00974         bc              addressOk
                      00975         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                      00976         ; reset accumulator
                      00977 clrSampleAcc
                      00978         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
                      00979         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
                      00980         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
                      00981         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
                      00982 addressOk
                      00983         
                      00984         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
                      00985         movff   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (OSC_NUMBER * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
                      00986         movff   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (OSC_NUMBER * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                      00987         
                      00988         bra             macroDone
                      00989         
                      00990 waveIsNotSample
                      00991         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                      00992         ; branch to waveform specific table address load
                      00993         movlw   SINE
                      00994         cpfseq  waveShape, ACCESS
                      00995         bra             waveIsSquare
                      00996 
                      00997 waveIsSine      
                      00998         ; 
                      00999         ; load address of SINE table read
                      01000         ; offset = ((accumulator >> 8) & 0xff)
                      01001         movf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1, w
                      01002         addwf   sineTableBaseAddress + 0, w
                      01003         movwf   TBLPTRL, ACCESS
                      01004         movf    sineTableBaseAddress + 1, w
                      01005         btfsc   STATUS, C, ACCESS
                      01006         addlw   1
                      01007         movwf   TBLPTRH, ACCESS
                      01008         movf    sineTableBaseAddress + 2, w
                      01009         btfsc   STATUS, C, ACCESS
                      01010         addlw   1
                      01011         movwf   TBLPTRU, ACCESS
                      01012         bra             tableAddressLoaded
                      01013 
                      01014 waveIsSquare
                      01015         ; load address of SQUARE table read
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 43


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01016         ; offset = ((accumulator >> 8) & 0xff)
                      01017         movf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1, w
                      01018         addwf   squareTableBaseAddress + 0, w
                      01019         movwf   TBLPTRL, ACCESS
                      01020         movf    squareTableBaseAddress + 1, w
                      01021         btfsc   STATUS, C, ACCESS
                      01022         addlw   1
                      01023         movwf   TBLPTRH, ACCESS
                      01024         movf    squareTableBaseAddress + 2, w
                      01025         btfsc   STATUS, C, ACCESS
                      01026         addlw   1
                      01027         movwf   TBLPTRU, ACCESS
                      01028 
                      01029 tableAddressLoaded
                      01030         ; read value from program memory
                      01031         tblrd*
                      01032         movff   TABLAT, activeOutputValues + (OSC_NUMBER * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
                      01033         bra             macroDone
                      01034         
                      01035 resetOscillator
                      01036         ; set oscillator reset flag
                      01037         bsf             oscResetFlags, OSC_NUMBER, ACCESS
                      01038         movlw   PWM_IDLE_OUTPUT_VALUE
                      01039         movwf   activeOutputValues + (OSC_NUMBER * ACTIVE_OUTPUT_VALUES_EL_SIZE)
                      01040         clrf    oscDeltas + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE) + 0
                      01041         clrf    oscDeltas + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE) + 1
                      01042         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 0
                      01043         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1
                      01044         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 2
                      01045         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 3
                      01046 
                      01047 macroDone
                      01048 
                      01049         ENDM
                      01050         
                      01051         
                      01052 #endif
                      01053 
                      01054 
                      00028         #include        "../header/userinterface.h"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      userinterface.h                                   *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 44


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 #ifndef _USERINTERFACEH_
                      00022 #define _USERINTERFACEH_
                      00023 
                      00024 #define LEVEL_POLY_LED_BLINK_RATE               0
                      00025 #define LEVEL_SUSTAIN_LED_BLINK_RATE    2
                      00026 #define LEVEL_MONO_LED_BLINK_RATE               1
                      00027 
                      00028 ;**********************************************************************
                      00029 ; MACROS
                      00030 ;**********************************************************************
                      00031                                                         
                      00032 #ifndef THROUGH_HOLE_PCB
                      00033 
                      00034 #ifdef  LED_STEADY_STATE_DISABLED
                      00035 
                      00036 LED_SINE_ON     MACRO
                      00037 #ifndef LED_POLARITY_REVERSED
                      00038         bcf             ledOnOffFlags, RA5, ACCESS      ; LED is on
                      00039 #else
                      00040         bsf             ledOnOffFlags, RA5, ACCESS      ; LED is on
                      00041 #endif
                      00042         ENDM
                      00043 
                      00044 LED_SQUARE_ON   MACRO
                      00045 #ifndef LED_POLARITY_REVERSED
                      00046         bcf             ledOnOffFlags, RC4, ACCESS      ; LED is on
                      00047 #else
                      00048         bsf             ledOnOffFlags, RC4, ACCESS      ; LED is on
                      00049 #endif
                      00050         ENDM
                      00051 
                      00052 LED_SAMPLE_ON   MACRO
                      00053 #ifndef LED_POLARITY_REVERSED
                      00054         bcf             ledOnOffFlags, RC3, ACCESS      ; LED is on
                      00055 #else
                      00056         bsf             ledOnOffFlags, RC3, ACCESS      ; LED is on
                      00057 #endif
                      00058         ENDM
                      00059 
                      00060 LED_SINE_OFF    MACRO
                      00061 #ifndef LED_POLARITY_REVERSED
                      00062         bsf             ledOnOffFlags, RA5, ACCESS      ; LED is off
                      00063 #else
                      00064         bcf             ledOnOffFlags, RA5, ACCESS      ; LED is off
                      00065 #endif
                      00066         ENDM
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 45


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00067 
                      00068 LED_SQUARE_OFF  MACRO
                      00069 #ifndef LED_POLARITY_REVERSED
                      00070         bsf             ledOnOffFlags, RC4, ACCESS      ; LED is off
                      00071 #else
                      00072         bcf             ledOnOffFlags, RC4, ACCESS      ; LED is off
                      00073 #endif
                      00074         ENDM
                      00075 
                      00076 LED_SAMPLE_OFF  MACRO
                      00077 #ifndef LED_POLARITY_REVERSED
                      00078         bsf             ledOnOffFlags, RC3, ACCESS      ; LED is off
                      00079 #else
                      00080         bcf             ledOnOffFlags, RC3, ACCESS      ; LED is off
                      00081 #endif
                      00082         ENDM
                      00083 
                      00084 LED_SINE_TOGGLE MACRO
                      00085         btg             ledOnOffFlags, RA5, ACCESS      ; LED is toggled
                      00086         ENDM
                      00087 
                      00088 LED_SQUARE_TOGGLE       MACRO
                      00089         btg             ledOnOffFlags, RC4, ACCESS      ; LED is toggled
                      00090         ENDM
                      00091 
                      00092 LED_SAMPLE_TOGGLE       MACRO
                      00093         btg             ledOnOffFlags, RC3, ACCESS      ; LED is toggled
                      00094         ENDM
                      00095 
                      00096 #else   ; #ifdef LED_STEADY_STATE_DISABLED
                      00097 
                      00098 LED_SINE_ON     MACRO
                      00099 #ifndef LED_POLARITY_REVERSED
                      00100         bcf             LATA, RA5, ACCESS       ; LED is on
                      00101 #else
                      00102         bsf             LATA, RA5, ACCESS       ; LED is on
                      00103 #endif
                      00104         ENDM
                      00105 
                      00106 LED_SQUARE_ON   MACRO
                      00107 #ifndef LED_POLARITY_REVERSED
                      00108         bcf             LATC, RC4, ACCESS       ; LED is on
                      00109 #else
                      00110         bsf             LATC, RC4, ACCESS       ; LED is on
                      00111 #endif
                      00112         ENDM
                      00113 
                      00114 LED_SAMPLE_ON   MACRO
                      00115 #ifndef LED_POLARITY_REVERSED
                      00116         bcf             LATC, RC3, ACCESS       ; LED is on
                      00117 #else
                      00118         bsf             LATC, RC3, ACCESS       ; LED is on
                      00119 #endif
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 46


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00120         ENDM
                      00121 
                      00122 LED_SINE_OFF    MACRO
                      00123 #ifndef LED_POLARITY_REVERSED
                      00124         bsf             LATA, RA5, ACCESS       ; LED is off
                      00125 #else
                      00126         bcf             LATA, RA5, ACCESS       ; LED is off
                      00127 #endif
                      00128         ENDM
                      00129 
                      00130 LED_SQUARE_OFF  MACRO
                      00131 #ifndef LED_POLARITY_REVERSED
                      00132         bsf             LATC, RC4, ACCESS       ; LED is off
                      00133 #else
                      00134         bcf             LATC, RC4, ACCESS       ; LED is off
                      00135 #endif
                      00136         ENDM
                      00137 
                      00138 LED_SAMPLE_OFF  MACRO
                      00139 #ifndef LED_POLARITY_REVERSED
                      00140         bsf             LATC, RC3, ACCESS       ; LED is off
                      00141 #else
                      00142         bcf             LATC, RC3, ACCESS       ; LED is off
                      00143 #endif
                      00144         ENDM
                      00145 
                      00146 LED_SINE_TOGGLE MACRO
                      00147         btg             LATA, RA5, ACCESS       ; LED is toggled
                      00148         ENDM
                      00149 
                      00150 LED_SQUARE_TOGGLE       MACRO
                      00151         btg             LATC, RC4, ACCESS       ; LED is toggled
                      00152         ENDM
                      00153 
                      00154 LED_SAMPLE_TOGGLE       MACRO
                      00155         btg             LATC, RC3, ACCESS       ; LED is toggled
                      00156         ENDM
                      00157 
                      00158 #endif  ; #ifdef LED_STEADY_STATE_DISABLED
                      00159 
                      00160 #else   ; #ifndef THROUGH_HOLE_PCB
                      00161 
                      00162 #ifdef  LED_STEADY_STATE_DISABLED
                      00163 
                      00164 LED_SINE_ON     MACRO
                      00165 #ifndef LED_POLARITY_REVERSED
                      00166         bcf             ledOnOffFlags, RC3, ACCESS      ; SINE LED
                      00167 #else
                      00168         bsf             ledOnOffFlags, RC3, ACCESS      ; SINE LED
                      00169 #endif
                      00170         ENDM
                      00171 
                      00172 LED_SQUARE_ON   MACRO
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 47


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00173 #ifndef LED_POLARITY_REVERSED
                      00174         bcf             ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00175 #else
                      00176         bsf             ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00177 #endif
                      00178         ENDM
                      00179 
                      00180 LED_SAMPLE_ON   MACRO
                      00181 #ifndef LED_POLARITY_REVERSED
                      00182         bcf             ledOnOffFlags, RA5, ACCESS      ; SAMPLE LED
                      00183 #else
                      00184         bsf             ledOnOffFlags, RA5, ACCESS      ; SAMPLE LED
                      00185 #endif
                      00186         ENDM
                      00187 
                      00188 LED_SINE_OFF    MACRO
                      00189 #ifndef LED_POLARITY_REVERSED
                      00190         bsf             ledOnOffFlags, RC3, ACCESS      ; SINE LED
                      00191 #else
                      00192         bcf             ledOnOffFlags, RC3, ACCESS      ; SINE LED
                      00193 #endif
                      00194         ENDM
                      00195 
                      00196 LED_SQUARE_OFF  MACRO
                      00197 #ifndef LED_POLARITY_REVERSED
                      00198         bsf             ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00199 #else
                      00200         bcf             ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00201 #endif
                      00202         ENDM
                      00203 
                      00204 LED_SAMPLE_OFF  MACRO
                      00205 #ifndef LED_POLARITY_REVERSED
                      00206         bsf             ledOnOffFlags, RA5, ACCESS      ; SAMPLE LED
                      00207 #else
                      00208         bcf             ledOnOffFlags, RA5, ACCESS      ; SAMPLE LED
                      00209 #endif
                      00210         ENDM
                      00211 
                      00212 LED_SINE_TOGGLE MACRO
                      00213         btg             ledOnOffFlags, RC3, ACCESS      ; SINE LED
                      00214         ENDM
                      00215 
                      00216 LED_SQUARE_TOGGLE       MACRO
                      00217         btg             ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00218         ENDM
                      00219 
                      00220 LED_SAMPLE_TOGGLE       MACRO
                      00221         btg             ledOnOffFlags, RA5, ACCESS      ; SAMPLE LED
                      00222         ENDM
                      00223         
                      00224 #else   ; #ifdef LED_STEADY_STATE_DISABLED
                      00225 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 48


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00226 LED_SINE_ON     MACRO
                      00227 #ifndef LED_POLARITY_REVERSED
                      00228         bcf             LATC, RC3, ACCESS       ; SINE LED
                      00229 #else
                      00230         bsf             LATC, RC3, ACCESS       ; SINE LED
                      00231 #endif
                      00232         ENDM
                      00233 
                      00234 LED_SQUARE_ON   MACRO
                      00235 #ifndef LED_POLARITY_REVERSED
                      00236         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                      00237 #else
                      00238         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                      00239 #endif
                      00240         ENDM
                      00241 
                      00242 LED_SAMPLE_ON   MACRO
                      00243 #ifndef LED_POLARITY_REVERSED
                      00244         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                      00245 #else
                      00246         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                      00247 #endif
                      00248         ENDM
                      00249 
                      00250 LED_SINE_OFF    MACRO
                      00251 #ifndef LED_POLARITY_REVERSED
                      00252         bsf             LATC, RC3, ACCESS       ; SINE LED
                      00253 #else
                      00254         bcf             LATC, RC3, ACCESS       ; SINE LED
                      00255 #endif
                      00256         ENDM
                      00257 
                      00258 LED_SQUARE_OFF  MACRO
                      00259 #ifndef LED_POLARITY_REVERSED
                      00260         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                      00261 #else
                      00262         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                      00263 #endif
                      00264         ENDM
                      00265 
                      00266 LED_SAMPLE_OFF  MACRO
                      00267 #ifndef LED_POLARITY_REVERSED
                      00268         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                      00269 #else
                      00270         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                      00271 #endif
                      00272         ENDM
                      00273 
                      00274 LED_SINE_TOGGLE MACRO
                      00275         btg             LATC, RC3, ACCESS       ; SINE LED
                      00276         ENDM
                      00277 
                      00278 LED_SQUARE_TOGGLE       MACRO
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 49


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00279         btg             LATC, RC4, ACCESS       ; SQUARE LED
                      00280         ENDM
                      00281 
                      00282 LED_SAMPLE_TOGGLE       MACRO
                      00283         btg             LATA, RA5, ACCESS       ; SAMPLE LED
                      00284         ENDM
                      00285 
                      00286 #endif  ; #ifdef LED_STEADY_STATE_DISABLED
                      00287 
                      00288 #endif  ; #ifndef THROUGH_HOLE_PCB
                      00289 
                      00290 LED_SINE_TOGGLE_OTHERS_OFF      MACRO
                      00291         LED_SINE_TOGGLE
                      00292         LED_SQUARE_OFF
                      00293         LED_SAMPLE_OFF
                      00294         ENDM
                      00295 
                      00296 LED_SQUARE_TOGGLE_OTHERS_OFF    MACRO
                      00297         LED_SINE_OFF
                      00298         LED_SQUARE_TOGGLE
                      00299         LED_SAMPLE_OFF
                      00300         ENDM
                      00301 
                      00302 LED_SAMPLE_TOGGLE_OTHERS_OFF    MACRO
                      00303         LED_SINE_OFF
                      00304         LED_SQUARE_OFF
                      00305         LED_SAMPLE_TOGGLE
                      00306         ENDM
                      00307 
                      00308 LED_ALL_TOGGLE  MACRO
                      00309         LED_SINE_TOGGLE
                      00310         LED_SQUARE_TOGGLE
                      00311         LED_SAMPLE_TOGGLE
                      00312         ENDM
                      00313 
                      00314 LED_ALL_ON      MACRO
                      00315         LED_SINE_ON
                      00316         LED_SQUARE_ON
                      00317         LED_SAMPLE_ON
                      00318         ENDM
                      00319 
                      00320 LED_ALL_OFF     MACRO
                      00321         LED_SINE_OFF
                      00322         LED_SQUARE_OFF
                      00323         LED_SAMPLE_OFF
                      00324         ENDM
                      00325 
                      00326 LED_ONLY_SINE_ON        MACRO
                      00327         LED_SINE_ON
                      00328         LED_SQUARE_OFF
                      00329         LED_SAMPLE_OFF
                      00330         ENDM
                      00331 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 50


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00332 LED_ONLY_SQUARE_ON      MACRO
                      00333         LED_SINE_OFF
                      00334         LED_SQUARE_ON
                      00335         LED_SAMPLE_OFF
                      00336         ENDM
                      00337 
                      00338 LED_ONLY_SAMPLE_ON      MACRO
                      00339         LED_SINE_OFF
                      00340         LED_SQUARE_OFF
                      00341         LED_SAMPLE_ON
                      00342         ENDM
                      00343 
                      00344 #endif  ; #ifndef _USERINTERFACEH_
                      00345 
                      00029 
                      00030 ;**********************************************************************
                      00031 ; DEFINITIONS
                      00032 ;**********************************************************************
                      00033         
                      00034 ;**********************************************************************
                      00035 ; LOCAL VARIABLES
                      00036 ;********************************************************************** 
                      00037 
                      00038 ;**********************************************************************
                      00039 ; LOCAL MACROS
                      00040 ;********************************************************************** 
                      00041 INC_PRESCALE_COUNTERS MACRO
                      00042         ; increment prescale counters, clear on match with SAMPLE_PRESCALE or WAVE_PRESCALE
                      00043         incf    samplePrescaleCounter, f, ACCESS
                      00044         movlw   SAMPLE_PRESCALE
                      00045         cpfslt  samplePrescaleCounter, ACCESS   
                      00046         clrf    samplePrescaleCounter, ACCESS
                      00047 
                      00048         incf    wavePrescaleCounter, f, ACCESS
                      00049         movlw   WAVE_PRESCALE
                      00050         cpfslt  wavePrescaleCounter, ACCESS
                      00051         clrf    wavePrescaleCounter, ACCESS
                      00052         
                      00053         ; adsrPrescaleCounter reset is handled by serviceADSR()
                      00054         incf    adsrPrescaleCounter + 0, f, ACCESS
                      00055         btfsc   STATUS, C, ACCESS
                      00056         incf    adsrPrescaleCounter + 1, f, ACCESS
                      00057         
                      00058         ENDM
                      00059         
                      00060 ;**********************************************************************
                      00061 ; High Priority Interrupts Service Routines
                      00062 ;**********************************************************************
                      00063 
00004C                00064 highPriorityISR
                      00065         ; Using fast return for high-priority interrupts so context saving is not necessary
                      00066         ; push working regs onto software stack
                      00067         PUSH_R  r0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 51


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00004C C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00068         PUSH_R  r1
000050 C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00069         ; define variables to pushed registers
                      00070         #define address         r0
                      00071         #define tmpValue        r1
                      00072         
                      00073         ;**********************************************************************
                      00074         ; ****************
                      00075         ; **** Timer2 ****
                      00076         ; ****************
                      00077 
                      00078         ;**** start procedure: check if Timer2 interrupt needs servicing ****
                      00079         ; is Timer2 interrupt enabled?
000054 A29D           00080         btfss   PIE1, TMR2IE, ACCESS
000056 EF?? F???      00081         goto    highPriorityISR_Timer2Done
                      00082         ; if Timer2 interrupt flag set?
00005A A29E           00083         btfss   PIR1, TMR2IF, ACCESS
00005C EF?? F???      00084         goto    highPriorityISR_Timer2Done
                      00085 
                      00086         ; clear Timer2 interrupt flag
                      00087         ; this will allow function to determine if another interrupt occurred during processing
                      00088         ; this is applicable for sample record routine which I suspect takes > 1 Timer2 interrupt period
                             to complete
                      00089         ; haven't tested this yet but code to handle event fixes sample record/playback rate disparity
000060 929E           00090         bcf             PIR1, TMR2IF, ACCESS
                      00091 
                      00092 #ifdef  LED_STEADY_STATE_DISABLED
                      00093         ; toggle ON LEDs to save precious mA.  Saves ~4mA over steady state current for single LED
                      00094         btfss   ledOnOffFlags, RA5, ACCESS
                      00095         btg             LATA, RA5, ACCESS       ; SINE LED
                      00096         btfsc   ledOnOffFlags, RA5, ACCESS
                      00097         bcf             LATA, RA5, ACCESS       ; SINE LED
                      00098         
                      00099         btfss   ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00100         btg             LATC, RC4, ACCESS       ; SQUARE LED
                      00101         btfsc   ledOnOffFlags, RC4, ACCESS      ; SQUARE LED
                      00102         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                      00103         
                      00104         btfss   ledOnOffFlags, RC3, ACCESS      ; SAMPLE LED
                      00105         btg             LATC, RC3, ACCESS       ; SAMPLE LED
                      00106         btfsc   ledOnOffFlags, RC3, ACCESS      ; SAMPLE LED
                      00107         bcf             LATC, RC3, ACCESS       ; SAMPLE LED    
                      00108 #endif
                      00109 
                      00110         ; process SAMPLE or WAVE prescale counter
                      00111         ; audio playback/sample clock is (PWM Base Clk / SAMPLE_PRESCALE)
                      00112         ; waveform playback clock is (PWM Base Clk / WAVE_PRESCALE)
                      00113         ; wait for appropriate prescale counter to be reset to 0 before processing next sound step
                      00114         ; if current mode SAMPLE? 
000062 0E02           00115         movlw   SAMPLE
000064 181E           00116         xorwf   waveShape, w, ACCESS
                      00117         ; not SAMPLE so check wavePrescale
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 52


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000066 E1??           00118         bnz             highPriorityISRTimer2_prescaleNotSample
                      00119         ; is SAMPLE so check samplePrescale
000068 5221           00120         movf    samplePrescaleCounter, f, ACCESS
00006A E0??           00121         bz              highPriorityISRTimer2_prescaleOK
00006C EF?? F???      00122         goto    highPriorityISRTimer2_skipStep
                      00123 
                      00124         ; playback mode is SINE or SQUARE wave so wait for wavePrescale counter to be reset to 0 before 
                            continuing
Warning[208]: Label truncated at 32 characters. (highPriorityISRTimer2_prescaleNotSample)
000070                00125 highPriorityISRTimer2_prescaleNotSample
000070 5222           00126         movf    wavePrescaleCounter, f, ACCESS
000072 E0??           00127         bz              highPriorityISRTimer2_prescaleOK
000074 EF?? F???      00128         goto    highPriorityISRTimer2_skipStep
000078                00129 highPriorityISRTimer2_prescaleOK
                      00130 
000078 EC?? F???      00131         call    processSoundState       
                      00132 
                      00133         ; if Timer2 interrupt flag is set then clear it and increment prescale counters twice
00007C A29E           00134         btfss   PIR1, TMR2IF, ACCESS
00007E D???           00135         bra             highPriorityISRTimer2_skipStep
                      00136         
                      00137         ; clear the flag
000080 929E           00138         bcf             PIR1, TMR2IF, ACCESS
                      00139         
                      00140         ; increment prescale counters, clear on match with SAMPLE_PRESCALE, WAVE_PRESCALE or ADSR_PRESCA
                            LE
                      00141         INC_PRESCALE_COUNTERS
                          M         ; increment prescale counters, clear on match with SAMPLE_PRESCALE or WAVE_PRESCALE
000082 2A21               M         incf    samplePrescaleCounter, f, ACCESS
000084 0E06               M         movlw   SAMPLE_PRESCALE
000086 6021               M         cpfslt  samplePrescaleCounter, ACCESS   
000088 6A21               M         clrf    samplePrescaleCounter, ACCESS
                          M 
00008A 2A22               M         incf    wavePrescaleCounter, f, ACCESS
00008C 0E02               M         movlw   WAVE_PRESCALE
00008E 6022               M         cpfslt  wavePrescaleCounter, ACCESS
000090 6A22               M         clrf    wavePrescaleCounter, ACCESS
                          M         
                          M         ; adsrPrescaleCounter reset is handled by serviceADSR()
000092 2A39               M         incf    adsrPrescaleCounter + 0, f, ACCESS
000094 B0D8               M         btfsc   STATUS, C, ACCESS
000096 2A3A               M         incf    adsrPrescaleCounter + 1, f, ACCESS
                          M         
                      00142 
000098                00143 highPriorityISRTimer2_skipStep
                      00144         ; increment prescale counters, clear on match with SAMPLE_PRESCALE, WAVE_PRESCALE or ADSR_PRESCA
                            LE
                      00145         INC_PRESCALE_COUNTERS
                          M         ; increment prescale counters, clear on match with SAMPLE_PRESCALE or WAVE_PRESCALE
000098 2A21               M         incf    samplePrescaleCounter, f, ACCESS
00009A 0E06               M         movlw   SAMPLE_PRESCALE
00009C 6021               M         cpfslt  samplePrescaleCounter, ACCESS   
00009E 6A21               M         clrf    samplePrescaleCounter, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 53


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M 
0000A0 2A22               M         incf    wavePrescaleCounter, f, ACCESS
0000A2 0E02               M         movlw   WAVE_PRESCALE
0000A4 6022               M         cpfslt  wavePrescaleCounter, ACCESS
0000A6 6A22               M         clrf    wavePrescaleCounter, ACCESS
                          M         
                          M         ; adsrPrescaleCounter reset is handled by serviceADSR()
0000A8 2A39               M         incf    adsrPrescaleCounter + 0, f, ACCESS
0000AA B0D8               M         btfsc   STATUS, C, ACCESS
0000AC 2A3A               M         incf    adsrPrescaleCounter + 1, f, ACCESS
                          M         
                      00146                 
                      00147 
0000AE                00148 highPriorityISR_Timer2Done
                      00149 
                      00150 
                      00151         ;**********************************************************************
                      00152         ; **************
                      00153         ; **** INT0 ****
                      00154         ; **************
                      00155 
                      00156         ; if(INT0IE && INT0IF)
0000AE A8F2           00157         btfss   INTCON, INT0IE, ACCESS
0000B0 EF?? F???      00158         goto    highPriorityISR_INT0Done
0000B4 A2F2           00159         btfss   INTCON, INT0IF, ACCESS
0000B6 EF?? F???      00160         goto    highPriorityISR_INT0Done
                      00161 
                      00162         ;       INT0IF = 0;
0000BA 92F2           00163         bcf             INTCON, INT0IF, ACCESS
                      00164 
                      00165 #ifndef THROUGH_HOLE_PCB
                      00166         call    userInterface_incWaveform
                      00167 #else
0000BC EC?? F???      00168         call    userInterface_incMode
                      00169 #endif
                      00170         
0000C0                00171 highPriorityISR_INT0Done
                      00172 
                      00173         ; undefine variables from pushed registers
                      00174         #undefine       address
                      00175         #undefine       tmpValue
                      00176         ; pop working regs from software stack
                      00177         POP_R   r1
0000C0 CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      00178         POP_R   r0
0000C4 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00179         ; Using fast return for high-priority interrupts so context saving is not necessary
0000C8 0011           00180         retfie  FAST
                      00181 
                      00182         
                      00183 ;**********************************************************************
                      00184 ; Low Priority Interrupts Service Routines
                      00185 ;**********************************************************************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 54


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00186 
0000CA                00187 lowPriorityISR
                      00188         ; save context
0000CA 6E00           00189         movwf   wTmp, ACCESS
0000CC CFD8 F001      00190         movff   STATUS, statusTmp
0000D0 CFE0 F002      00191         movff   BSR, bsrTmp
                      00192 
                      00193         ; push working regs onto software stack
                      00194         PUSH_R  r0
0000D4 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00195         ; define variables for pushed registers
                      00196         #define tmpValue        r0
                      00197 
                      00198         ;**********************************************************************
                      00199         ; **************
                      00200         ; **** UART ****
                      00201         ; **************
                      00202 
                      00203         ; if(RCIF)
0000D8 BA9E           00204         btfsc   PIR1, RCIF, ACCESS
0000DA EC?? F???      00205         call    processRxAsMIDI
                      00206 
                      00207 
                      00208         ;**********************************************************************
                      00209         ; **************
                      00210         ; **** INT1 ****
                      00211         ; **************
                      00212 
                      00213         ; if(INT1IE && INT1IF)
0000DE A6F0           00214         btfss   INTCON3, INT1IE, ACCESS
0000E0 EF?? F???      00215         goto    lowPriorityISR_INT1Done
0000E4 A0F0           00216         btfss   INTCON3, INT1IF, ACCESS
0000E6 EF?? F???      00217         goto    lowPriorityISR_INT1Done
                      00218 
                      00219         ;       INT1IF = 0;
0000EA 90F0           00220         bcf             INTCON3, INT1IF, ACCESS
                      00221 
                      00222         ;       recordOrPlayback = VOICE_THROUGH;
0000EC 0E00           00223         movlw   VOICE_THROUGH
0000EE 6E1F           00224         movwf   recordOrPlayback, ACCESS
                      00225 
                      00226         ; eliminate record switch noise by waiting for it to stop bouncing before dumping data to eeprom
                      00227         ; after record button is released, processSoundState() will begin decrementing recordWaitCountdo
                            wn...
                      00228         ; and not begin recording until recordWaitCountdown == 0
                      00229 
0000F0 0E1A           00230         movlw   RECORD_BUTTON_RELEASE_WAIT_TIME
0000F2 6E3B           00231         movwf   recordWaitCountdown, ACCESS
                      00232         
                      00233         ;       sampleDataBufferIndex = 0;
0000F4 6A11           00234         clrf    sampleDataBufferIndex, ACCESS           
                      00235         ;       sampleChunkCount = 0;
0000F6 6A12           00236         clrf    sampleChunkCount, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 55


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00237         ;       sampleChunkReady = FALSE;
0000F8 9017           00238         bcf             eepromFlags, sampleChunkReady, ACCESS
                      00239         
0000FA                00240 lowPriorityISR_INT1Done
                      00241 
                      00242         ;**********************************************************************
                      00243         ; **************
                      00244         ; **** INT2 ****
                      00245         ; **************
                      00246 
                      00247         ; if(INT2IE && INT2IF)
0000FA A8F0           00248         btfss   INTCON3, INT2IE, ACCESS
0000FC EF?? F???      00249         goto    lowPriorityISR_INT2Done
000100 A2F0           00250         btfss   INTCON3, INT2IF, ACCESS
000102 EF?? F???      00251         goto    lowPriorityISR_INT2Done
                      00252 
                      00253         ;       INT2IF = 0;
000106 92F0           00254         bcf             INTCON3, INT2IF, ACCESS
                      00255 
                      00256 #ifndef THROUGH_HOLE_PCB
                      00257         call    userInterface_incMode
                      00258 #else
000108 EC?? F???      00259         call    userInterface_incWaveform
                      00260 #endif
                      00261         
00010C                00262 lowPriorityISR_INT2Done
                      00263 
                      00264         ;**********************************************************************
                      00265         ; ****************
                      00266         ; **** TIMER0 ****
                      00267         ; ****************
                      00268         ;
                      00269         ; Timer0 handles LED state updates based on current waveShape and mode
                      00270                 
                      00271         ; if(TMR0IE && TMR0IF)
00010C AAF2           00272         btfss   INTCON, TMR0IE, ACCESS
00010E EF?? F???      00273         goto    lowPriorityISR_TMR0Done
000112 A4F2           00274         btfss   INTCON, TMR0IF, ACCESS
000114 EF?? F???      00275         goto    lowPriorityISR_TMR0Done
                      00276 
000118 94F2           00277         bcf             INTCON, TMR0IF, ACCESS
                      00278                 
                      00279         ; if playbackOrRecord == VOICE_THROUGH or RECORD, then turn all LEDs ON
00011A 0E00           00280         movlw   VOICE_THROUGH
00011C 181F           00281         xorwf   recordOrPlayback, w, ACCESS
00011E E0??           00282         bz              lowPriorityISR_TMR0AllOn
000120 0E01           00283         movlw   RECORD
000122 181F           00284         xorwf   recordOrPlayback, w, ACCESS
000124 E1??           00285         bnz             lowPriorityISR_TMR0NotAllOn
000126                00286 lowPriorityISR_TMR0AllOn
                      00287         LED_ALL_ON      
                          M         LED_SINE_ON
                          M #ifndef LED_POLARITY_REVERSED
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 56


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
000126 868B               M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
000128 888B               M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
00012A 8A89               M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
00012C D???           00288         bra             lowPriorityISR_TMR0Done
                      00289 
00012E                00290 lowPriorityISR_TMR0NotAllOn
                      00291         ; check if waveShape == SINE
00012E 0E00           00292         movlw   SINE
000130 621E           00293         cpfseq  waveShape, ACCESS
000132 D???           00294         bra             lowPriorityISR_TMR0TrySq
                      00295 
                      00296         ; waveShape == SINE
                      00297         ; if ledBlinkRate == 0 then LED is steady state
000134 523C           00298         movf    ledBlinkRate, f, ACCESS
000136 E1??           00299         bnz             lowPriorityISR_TMR0SiBlink
                      00300         ; led is steady state
                      00301         LED_ONLY_SINE_ON
                          M         LED_SINE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
000138 868B               M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
00013A 988B               M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
00013C 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
00013E D???           00302         bra             lowPriorityISR_TMR0Done
000140                00303 lowPriorityISR_TMR0SiBlink
                      00304         ; led is blinking
000140 2E3D           00305         decfsz  ledBlinkCounter, f, ACCESS
000142 D???           00306         bra             lowPriorityISR_TMR0Done
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 57


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00307         ; toggle the LED
                      00308         LED_SINE_TOGGLE_OTHERS_OFF
                          M         LED_SINE_TOGGLE
000144 768B               M         btg             LATC, RC3, ACCESS       ; SINE LED
                          M         LED_SQUARE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
000146 988B               M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
000148 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
                      00309         ; reload the counter
00014A C03C F03D      00310         movff   ledBlinkRate, ledBlinkCounter   
00014E D???           00311         bra             lowPriorityISR_TMR0Done
                      00312 
000150                00313 lowPriorityISR_TMR0TrySq
                      00314         ; waveShape is != SINE so check if waveShape == SQUARE
000150 0E01           00315         movlw   SQUARE
000152 621E           00316         cpfseq  waveShape, ACCESS
000154 D???           00317         bra             lowPriorityISR_TMR0TrySa
                      00318 
                      00319         ; waveShape == SQUARE
                      00320         ; if ledBlinkRate == 0 then LED is steady state
000156 523C           00321         movf    ledBlinkRate, f, ACCESS
000158 E1??           00322         bnz             lowPriorityISR_TMR0SqBlink
                      00323         ; led is steady state
                      00324         LED_ONLY_SQUARE_ON
                          M         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
00015A 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
00015C 888B               M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
00015E 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
000160 D???           00325         bra             lowPriorityISR_TMR0Done
000162                00326 lowPriorityISR_TMR0SqBlink
                      00327         ; led is blinking
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 58


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000162 2E3D           00328         decfsz  ledBlinkCounter, f, ACCESS
000164 D???           00329         bra             lowPriorityISR_TMR0Done
                      00330         ; toggle the LED
                      00331         LED_SQUARE_TOGGLE_OTHERS_OFF
                          M         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
000166 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_TOGGLE
000168 788B               M         btg             LATC, RC4, ACCESS       ; SQUARE LED
                          M         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
00016A 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
                      00332         ; reload the counter
00016C C03C F03D      00333         movff   ledBlinkRate, ledBlinkCounter   
000170 D???           00334         bra             lowPriorityISR_TMR0Done
                      00335 
000172                00336 lowPriorityISR_TMR0TrySa
                      00337         ; waveShape is != SQUARE so assume that waveShape == SQUARE
                      00338         ; if ledBlinkRate == 0 then LED is steady state
000172 523C           00339         movf    ledBlinkRate, f, ACCESS
000174 E1??           00340         bnz             lowPriorityISR_TMR0SaBlink
                      00341         ; led is steady state
                      00342         LED_ONLY_SAMPLE_ON
                          M         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
000176 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
000178 988B               M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
00017A 8A89               M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
00017C D???           00343         bra             lowPriorityISR_TMR0Done
00017E                00344 lowPriorityISR_TMR0SaBlink
                      00345         ; led is blinking
00017E 2E3D           00346         decfsz  ledBlinkCounter, f, ACCESS
000180 D???           00347         bra             lowPriorityISR_TMR0Done
                      00348         ; toggle the LED
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 59


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00349         LED_SAMPLE_TOGGLE_OTHERS_OFF
                          M         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
000182 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
000184 988B               M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_TOGGLE
000186 7A89               M         btg             LATA, RA5, ACCESS       ; SAMPLE LED
                      00350         ; reload the counter
000188 C03C F03D      00351         movff   ledBlinkRate, ledBlinkCounter   
00018C D???           00352         bra             lowPriorityISR_TMR0Done
                      00353 
00018E                00354 lowPriorityISR_TMR0Done
                      00355 
                      00356         ; undefine variables from pushed registers
                      00357         #undefine       tmpValue
                      00358         ; pop working regs from software stack
                      00359         POP_R   r0
00018E CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00360 
                      00361         ; restore context
000192 C002 FFE0      00362         movff   bsrTmp, BSR
000196 5000           00363         movf    wTmp, w, ACCESS
000198 C001 FFD8      00364         movff   statusTmp, STATUS
                      00365         
                      00366         ; return from interrupt
00019C 0010           00367         retfie
                      00368         
                      00369         
                      00370         
                      00164 
                      00165         
                      00166 ;**********************************************************************
                      00167 ; MAINLINE CODE BEGIN
                      00168 ;**********************************************************************
                      00169 
00019E                00170 main
                      00171         ; all variables aside from softwareStack are in RAM BANK 0
                      00172         ; all single byte or 2-byte variables are in ACCESS RAM
00019E 0100           00173         BANKSEL 0
                      00174 
                      00175         ; dummy instruction to check "endOfVariables" location in disassembly
0001A0                00176 dummy_endOfVariables
0001A0 CFE8 F03F      00177         movff   WREG, endOfVariables
                      00178         
0001A4 EC?? F???      00179         call    initCore
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 60


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0001A8 EC?? F???      00180         call    initInternalEEPROM
0001AC EC?? F???      00181         call    initExternalEEPROM
0001B0 EC?? F???      00182         call    initMIDI
0001B4 EC?? F???      00183         call    initSoundGen
0001B8 EC?? F???      00184         call    initUserInterface
                      00185                 
                      00186         ; enable global interrupts
0001BC 8EF2           00187         bsf             INTCON, GIE, ACCESS
                      00188         
0001BE                00189 mainLoop        
                      00190         
                      00191         ; handle EEPROM reading / writing in mainline to minimize audio corruption
                      00192         ;
                      00193         ; check if waveShape is == SAMPLE
0001BE 0E02           00194         movlw   SAMPLE
0001C0 621E           00195         cpfseq  waveShape, ACCESS
0001C2 D???           00196         bra             mainNotSample
                      00197 
                      00198         ; if sampleChunkReady is set then write sampleDataBuffer to EEPROM
                      00199         ; ISR sets playback mode to PLAYBACK immediately after last chunk is complete...
                      00200         ; so always just write EEPROM when sampleChunkReady is set
0001C4 A017           00201         btfss   eepromFlags, sampleChunkReady, ACCESS
0001C6 D???           00202         bra             mainCheckPlayback
                      00203         ; flag is set so write it to EEPROM
0001C8 EC?? F???      00204         call    eepromWrite64
                      00205 
                      00206         ; clear the flag so that we know when next chunk is ready to go
0001CC 9017           00207         bcf             eepromFlags, sampleChunkReady, ACCESS
0001CE D???           00208         bra             mainNotSample
                      00209                 
0001D0                00210 mainCheckPlayback
                      00211         ; check if mode is PLAYBACK
0001D0 0E02           00212         movlw   PLAYBACK
0001D2 621F           00213         cpfseq  recordOrPlayback, ACCESS
0001D4 D???           00214         bra             mainNotSample
                      00215 ;       if((soundOn || turnSoundOn) && (waveShape == SAMPLE) && !sampleReady)
0001D6 BC10           00216         btfsc   midiFlags, soundOn, ACCESS
0001D8 D???           00217         bra             mainCheckSampleWaveshape
0001DA A610           00218         btfss   midiFlags, turnSoundOn, ACCESS
0001DC D???           00219         bra             mainNotSample
0001DE                00220 mainCheckSampleWaveshape
0001DE B217           00221         btfsc   eepromFlags, samplesLoaded, ACCESS
0001E0 D???           00222         bra             mainNotSample
                      00223 
                      00224         ; check if EEPROM is ready to read
0001E2 B617           00225         btfsc   eepromFlags, ready, ACCESS
0001E4 D???           00226         bra             mainEepromReady
                      00227         ; eeprom is not ready so reset activeOutputValues
0001E6 0E80           00228         movlw   PWM_IDLE_OUTPUT_VALUE
0001E8 6FE1           00229         movwf   activeOutputValues + 0
0001EA 6FE2           00230         movwf   activeOutputValues + 1
0001EC 6FE3           00231         movwf   activeOutputValues + 2
0001EE 6FE4           00232         movwf   activeOutputValues + 3
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 61


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00233         ; last time we checked, EEPROM wasn't ready so check it again
0001F0 EC?? F???      00234         call    eepromReadStatusReg
                      00235         ; WREG = EEPROM Status Reg, (eepromFlags, ready) = (STATUS, !(NOT_READY))
0001F4 B0E8           00236         btfsc   WREG, NOT_RDY, ACCESS
                      00237         ; NOT_READY bit in EEPROM Status register is set so don't do EEPROM read
0001F6 D???           00238         bra             mainNotSample
                      00239         ; NOT_READY bit in EEPROM Status register is clear so set 'ready' flag and read the eeprom
0001F8 8617           00240         bsf             eepromFlags, ready, ACCESS
                      00241         
0001FA                00242 mainEepromReady
                      00243         ; get sample(s)
0001FA C0B1 F015      00244         movff   nextSampleAddresses + 0, nextSampleAddress
0001FE C0B2 F016      00245         movff   nextSampleAddresses + 1, nextSampleAddress + 1
                      00246         ; it pains me to put this sample address reversal code here as a macro but...
                      00247         ; but can't spare the cycles in processSoundState() to modify nextSampleAddress
                      00248         REVERSE_SAMPLE_IF_MOD_OVER_63
  0000                    M         local exitMacro
                          M         ; if modulation > 63 then reverse sample
000202 0E3F               M         movlw   63
000204 641D               M         cpfsgt  modulation, ACCESS
000206 D???               M         bra             exitMacro
                          M         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
000208 5015               M         movf    nextSampleAddress, w, ACCESS
00020A 5C13               M         subwf   sampleEndAddress, w, ACCESS
00020C 6E15               M         movwf   nextSampleAddress, ACCESS
00020E 5016               M         movf    nextSampleAddress + 1, w, ACCESS
000210 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
000212 6E16               M         movwf   nextSampleAddress + 1, ACCESS
000214                    M exitMacro
000214 EC?? F???      00249         call    eepromReadSingleByte
                      00250         ; save read value to output register
000218 6FE1           00251         movwf   activeOutputValues + 0
                      00252 
                      00253         ; continue process if poly
00021A 0E01           00254         movlw   1
00021C 6423           00255         cpfsgt  polyDepth, ACCESS
00021E D???           00256         bra             mainSampleMono
                      00257 
                      00258         ; get sample(s)
000220 C0B3 F015      00259         movff   nextSampleAddresses + 2, nextSampleAddress
000224 C0B4 F016      00260         movff   nextSampleAddresses + 3, nextSampleAddress + 1
                      00261         REVERSE_SAMPLE_IF_MOD_OVER_63
  0000                    M         local exitMacro
                          M         ; if modulation > 63 then reverse sample
000228 0E3F               M         movlw   63
00022A 641D               M         cpfsgt  modulation, ACCESS
00022C D???               M         bra             exitMacro
                          M         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
00022E 5015               M         movf    nextSampleAddress, w, ACCESS
000230 5C13               M         subwf   sampleEndAddress, w, ACCESS
000232 6E15               M         movwf   nextSampleAddress, ACCESS
000234 5016               M         movf    nextSampleAddress + 1, w, ACCESS
000236 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 62


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000238 6E16               M         movwf   nextSampleAddress + 1, ACCESS
00023A                    M exitMacro
00023A EC?? F???      00262         call    eepromReadSingleByte
                      00263         ; save read value to output register
00023E 6FE2           00264         movwf   activeOutputValues + 1
                      00265 
                      00266         ; get sample(s)
000240 C0B5 F015      00267         movff   nextSampleAddresses + 4, nextSampleAddress
000244 C0B6 F016      00268         movff   nextSampleAddresses + 5, nextSampleAddress + 1
                      00269         REVERSE_SAMPLE_IF_MOD_OVER_63
  0000                    M         local exitMacro
                          M         ; if modulation > 63 then reverse sample
000248 0E3F               M         movlw   63
00024A 641D               M         cpfsgt  modulation, ACCESS
00024C D???               M         bra             exitMacro
                          M         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
00024E 5015               M         movf    nextSampleAddress, w, ACCESS
000250 5C13               M         subwf   sampleEndAddress, w, ACCESS
000252 6E15               M         movwf   nextSampleAddress, ACCESS
000254 5016               M         movf    nextSampleAddress + 1, w, ACCESS
000256 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
000258 6E16               M         movwf   nextSampleAddress + 1, ACCESS
00025A                    M exitMacro
00025A EC?? F???      00270         call    eepromReadSingleByte
                      00271         ; save read value to output register
00025E 6FE3           00272         movwf   activeOutputValues + 2
                      00273 
                      00274         ; get sample(s)
000260 C0B7 F015      00275         movff   nextSampleAddresses + 6, nextSampleAddress
000264 C0B8 F016      00276         movff   nextSampleAddresses + 7, nextSampleAddress + 1
                      00277         REVERSE_SAMPLE_IF_MOD_OVER_63
  0000                    M         local exitMacro
                          M         ; if modulation > 63 then reverse sample
000268 0E3F               M         movlw   63
00026A 641D               M         cpfsgt  modulation, ACCESS
00026C D???               M         bra             exitMacro
                          M         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
00026E 5015               M         movf    nextSampleAddress, w, ACCESS
000270 5C13               M         subwf   sampleEndAddress, w, ACCESS
000272 6E15               M         movwf   nextSampleAddress, ACCESS
000274 5016               M         movf    nextSampleAddress + 1, w, ACCESS
000276 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
000278 6E16               M         movwf   nextSampleAddress + 1, ACCESS
00027A                    M exitMacro
00027A EC?? F???      00278         call    eepromReadSingleByte
                      00279         ; save read value to output register
00027E 6FE4           00280         movwf   activeOutputValues + 3
                      00281         
                      00282 
000280                00283 mainSampleMono
                      00284         ; set sampleReady flag so ISR will update address
000280 8217           00285         bsf             eepromFlags, samplesLoaded, ACCESS
                      00286 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 63


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000282                00287 mainNotSample
                      00288 
                      00289         ; call getActiveNoteDeltas() needRefresh flag is set
000282 A418           00290         btfss   soundGenFlags, needRefresh, ACCESS
000284 D???           00291         bra             mainLoop_noRefresh
                      00292         ; immediately clear the flag.  Was previously clearing after return from getActiveNoteDeltas but
                             notes would 
                      00293         ; ocassionally hang on last note if flag was set in ISR during getActiveNoteDeltas execution
000286 9418           00294         bcf             soundGenFlags, needRefresh, ACCESS      
                      00295         ; need refresh so call for it
000288 EC?? F???      00296         call    getActiveNoteDeltas
00028C                00297 mainLoop_noRefresh
                      00298 
00028C EC?? F???      00299         call    serviceADSR
                      00300 
000290 EF?? F???      00301         goto    mainLoop
                      00302 
                      00303 ;**********************************************************************
                      00304         
                      00305         #include        "../source/init.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      init.asm                                          *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 ;**********************************************************************
                      00022 ; INCLUDE FILES
                      00023 ;**********************************************************************
                      00024 
                      00025 ;**********************************************************************
                      00026 ; LOCAL FUNCTIONS
                      00027 ;**********************************************************************
                      00028 
                      00029 ;**********************************************************************
                      00030 ; Function: void initCore()
                      00031 ;**********************************************************************
                      00032 
000294                00033 initCore
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 64


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000294 EC?? F???      00034         call initOsc
000298 EC?? F???      00035         call initIO
00029C EC?? F???      00036         call initUART
0002A0 EC?? F???      00037         call initTimer0
0002A4 EC?? F???      00038         call initTimer1
0002A8 EC?? F???      00039         call initTimer2
0002AC EC?? F???      00040         call initCCP
0002B0 EC?? F???      00041         call initSPI
0002B4 EC?? F???      00042         call initADC
0002B8 EC?? F???      00043         call initInterrupts
0002BC EC?? F???      00044         call initRAM
0002C0 EC?? F???      00045         call initHeap
0002C4 0012           00046         return
                      00047                 
                      00048         
                      00049 ;**********************************************************************
                      00050 ; Function: void initOsc()
                      00051 ;**********************************************************************
                      00052 
0002C6                00053 initOsc
                      00054         ; configure for internal clock at 8Mhz & 4x PLL = 32Mhz
                      00055         ; primary clock determined by FOSC<3:0>
                      00056         ; confirgure internal osc for 8Mhz
0002C6 8CD3           00057         bsf             OSCCON, IRCF2, ACCESS
0002C8 8AD3           00058         bsf             OSCCON, IRCF1, ACCESS
0002CA 98D3           00059         bcf             OSCCON, IRCF0, ACCESS
                      00060 
                      00061 #ifdef  PIC18LF13K50
0002CC                00062 initOsc_lp1
                      00063         ; wait for internal high freq osc to stabilize
                      00064         ; "pic18lf13k50.inc" lists bit as "IOFS" but datasheet calls it "HFIOFS"
0002CC A4D3           00065         btfss   OSCCON, IOFS, ACCESS
0002CE D???           00066         bra             initOsc_lp1
                      00067 
                      00068         ; enable PLL
0002D0 8C9B           00069         bsf             OSCTUNE, SPLLEN, ACCESS
                      00070 #endif
                      00071 
                      00072 #ifdef  PIC18LF14K22
                      00073 initOsc_lp1
                      00074         ; wait for internal high freq osc to stabilize
                      00075         btfss   OSCCON, HFIOFS, ACCESS
                      00076         bra             initOsc_lp1
                      00077 
                      00078         ; enable PLL
                      00079         bsf             OSCTUNE, PLLEN, ACCESS
                      00080 #endif  
                      00081 
                      00082 
0002D2 0012           00083         return
                      00084 
                      00085 
                      00086 ;**********************************************************************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 65


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00087 ; Function: void initIO()
                      00088 ;**********************************************************************
                      00089 
0002D4                00090 initIO
                      00091         ; IO Summary
                      00092         ; 
                      00093         ; (organized by pin #)
                      00094         ; Pin   Port    Assignment
                      00095         ; ---  ----     ----------
                      00096         ; 1             VDD             VDD
                      00097         ; 2             RA5             LED (Sine)
                      00098         ; 3             RA4             Audio In
                      00099         ; 4             RA3             ICSP
                      00100         ; 5             RC5             Audio Out
                      00101         ; 6             RC4             LED (Square)
                      00102         ; 7             RC3             LED (Sample)
                      00103         ; 8             RC6             EEPROM Chip Select
                      00104         ; 9             RC7             EEPROM Slave In
                      00105         ; 10    RB7             [Not Connected]
                      00106         ; 11    RB6             EEPROM Clock
                      00107         ; 12    RB5             MIDI In
                      00108         ; 13    RB4             EEPROM Slave Out
                      00109         ; 14    RC2             Switch (MIDI Record / Playback)
                      00110         ; 15    RC1             Switch (Voice Through / Record)
                      00111         ; 16    RC0             Switch (Waveform)
                      00112         ; 17    VUSB    [Not Connected]
                      00113         ; 18    RA1             ICSP
                      00114         ; 19    RA0             ICSP
                      00115         ; 20    VSS             VSS
                      00116         ;
                      00117         ; [PORT A]
                      00118         ; Pin   Port    Assignment                                                      Direction
                      00119         ; ---  ----             ----------                                                      --------
                            -
                      00120         ; 19    RA0             ICSP                                                            IN
                      00121         ; 18    RA1             ICSP                                                            IN
                      00122         ; 4             RA3             ICSP                                                            
                            IN
                      00123         ; 3             RA4             Audio In                                                        
                            IN
                      00124         ; 2             RA5             LED (Sine)                                                      
                            OUT
                      00125 
0002D4 8A89           00126         bsf             LATA, RA5, ACCESS       ; LED is off
0002D6 0EDF           00127         movlw   0xff ^ 1<<RA5
0002D8 6E92           00128         movwf   TRISA, ACCESS
                      00129 
                      00130         ; [PORT B]
                      00131         ; Pin   Port    Assignment                                                      Direction
                      00132         ; ---  ----             ----------                                                      --------
                            -
                      00133         ; 13    RB4             EEPROM Slave Out                                        IN
                      00134         ; 12    RB5             MIDI In                                                         IN
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 66


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00135         ; 11    RB6             EEPROM Clock                                            OUT
                      00136         ; 10    RB7             [Not Connected]                                         IN
                      00137 
0002DA 0EBF           00138         movlw   0xff ^ 1<<RB6   ; EEPROM clock is LOW
0002DC 6E8A           00139         movwf   LATB, ACCESS
0002DE 0EBF           00140         movlw   0xff ^ 1<<RB6
0002E0 6E93           00141         movwf   TRISB, ACCESS
                      00142         
                      00143         ; [PORT C]
                      00144         ; Pin   Port    Assignment                                                      Direction
                      00145         ; ---  ----             ----------                                                      --------
                            -
                      00146         ; 16    RC0             Switch (Waveform)                                       IN
                      00147         ; 15    RC1             Switch (Voice Through / Record)         IN
                      00148         ; 14    RC2             Switch (MIDI Record / Playback)         IN
                      00149         ; 7             RC3             LED (Sample)                                            OUT
                      00150         ; 6             RC4             LED (Square)                                            OUT
                      00151         ; 5             RC5             Audio Out                                                       
                            OUT
                      00152         ; 8             RC6             EEPROM Chip Select                                      OUT
                      00153         ; 9             RC7             EEPROM Slave In                                         OUT
                      00154         
0002E2 868B           00155         bsf             LATC, RC3, ACCESS       ; LED is off
0002E4 888B           00156         bsf             LATC, RC4, ACCESS       ; LED is off
0002E6 9A8B           00157         bcf             LATC, RC5, ACCESS       ; Audio out is low
0002E8 8C8B           00158         bsf             LATC, RC6, ACCESS       ; Chip select is idle
0002EA 0E07           00159         movlw   0x07
0002EC 6E94           00160         movwf   TRISC, ACCESS
                      00161         
                      00162         ; [General IO]
0002EE 9EF1           00163         bcf             INTCON2, NOT_RABPU, ACCESS      ; enable PORT A & B pullups per WPU registers
0002F0 0E08           00164         movlw   1<<ANS3 ; ANS3 = RA4(Audio In)
0002F2 6E7E           00165         movwf   ANSEL, ACCESS   ; enable digital input buffers for all non-analog inputs
0002F4 6A7F           00166         clrf    ANSELH, ACCESS  ; enable digital input buffers for all non-analog inputs        
0002F6 0012           00167         return
                      00168         
                      00169         
                      00170 ;**********************************************************************
                      00171 ; Function: void initUART()
                      00172 ;**********************************************************************
                      00173 
0002F8                00174 initUART
0002F8 0E0F           00175         movlw   15      ; 31.25K baud rate @ 32Mhz clock
0002FA 6EAF           00176         movwf   SPBRG, ACCESS
                      00177         ; Enable serial port
                      00178         ; Enable reception
0002FC 8EAB           00179         bsf             RCSTA, SPEN, ACCESS
0002FE 88AB           00180         bsf             RCSTA, CREN, ACCESS
                      00181         ; Enable transmission
000300 8AAC           00182         bsf             TXSTA, TXEN, ACCESS
000302 0012           00183         return
                      00184 
                      00185 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 67


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00186 ;**********************************************************************
                      00187 ; Function: void initTimer0()
                      00188 ;**********************************************************************
                      00189 
000304                00190 initTimer0
                      00191         ; timer is on
                      00192         ; 16-bit mode
000304 9CD5           00193         bcf     T0CON, T08BIT, ACCESS
                      00194         ; clock = internal
000306 9AD5           00195         bcf             T0CON, T0CS, ACCESS
                      00196         ; timer0 using prescaler
                      00197         ; prescale = 1:8
                      00198         ; Fosc = 32Mhz. 1/((32Mhz/4)/ 8) * overflowValue(==65536) = overflow every 65.536mS)
000308 96D5           00199         bcf             T0CON, PSA, ACCESS
00030A 94D5           00200         bcf             T0CON, T0PS2, ACCESS
00030C 82D5           00201         bsf             T0CON, T0PS1, ACCESS    
00030E 90D5           00202         bcf             T0CON, T0PS0, ACCESS    
                      00203 
000310 0012           00204         return
                      00205 
                      00206 
                      00207 ;**********************************************************************
                      00208 ; Function: void initTimer1()
                      00209 ;**********************************************************************
                      00210 
000312                00211 initTimer1
                      00212         ; DO NOT ENABLE TIMER1 OR SDO WILL NOT WORK!
000312 0012           00213         return
                      00214 
                      00215 
                      00216 ;**********************************************************************
                      00217 ; Function: void initTimer2()
                      00218 ;**********************************************************************
                      00219 
000314                00220 initTimer2
                      00221 
                      00222         ; Turn on Timer2
000314 84CA           00223         bsf             T2CON, TMR2ON, ACCESS
                      00224         ; Using default power-on prescale of 1:1
                      00225         ; Reset and interrupt on match value
000316 0EFF           00226         movlw   255
000318 6ECB           00227         movwf   PR2, ACCESS
                      00228         ; Timer2 configured for 32uS interrupt period
                      00229         ; (SYS_OSC / PERIPH_CLK_DIV) / PR2 = period
                      00230         ; (32Mhz / 4) / 256 = 32uS
00031A 0012           00231         return
                      00232         
                      00233 
                      00234 ;**********************************************************************
                      00235 ; Function: void initCCP()
                      00236 ;**********************************************************************
                      00237 
00031C                00238 initCCP
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 68


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00239         ; PWM single output
                      00240         ; PWM mode; P1A, P1C active-high; P1B, P1D active-high
                      00241         ; 10-bit PWM bits [1:0] = 0b11
00031C 86BD           00242         bsf             CCP1CON, CCP1M3, ACCESS
00031E 84BD           00243         bsf             CCP1CON, CCP1M2, ACCESS
                      00244 
000320 6ABE           00245         clrf    CCPR1L, ACCESS  
000322 0012           00246         return
                      00247 
                      00248 
                      00249 ;**********************************************************************
                      00250 ; Function: void initSPI()
                      00251 ;**********************************************************************
                      00252 
000324                00253 initSPI
                      00254         ; serial port enabled
                      00255         ; idle clock is LOW
                      00256         ; mode is SPI master, clock = Fosc/4 = 8MHz
000324 8AC6           00257         bsf             SSPCON1, SSPEN, ACCESS
                      00258 
                      00259         ; input data latched on idle->active
                      00260         ; output data latched on active->idle clock
000326 8CC7           00261         bsf             SSPSTAT, CKE, ACCESS
000328 0012           00262         return
                      00263         
                      00264 
                      00265 ;**********************************************************************
                      00266 ; Function: void initADC()
                      00267 ;**********************************************************************
                      00268 
00032A                00269 initADC
                      00270         ; channel = AN3
                      00271         ; ADC is on
00032A 86C2           00272         bsf             ADCON0, CHS1, ACCESS    
00032C 84C2           00273         bsf             ADCON0, CHS0, ACCESS    
00032E 80C2           00274         bsf             ADCON0, ADON, ACCESS    
                      00275         
                      00276         ; positive reference is internal VDD
                      00277         ; negative reference is internal VSS
                      00278 
                      00279         ; left justify result
                      00280         ; acquisition time = 4 tad
                      00281         ; clock source = Fosc/32 = 32Mhz/32 = 1Mhz, TAD = 1uS
000330 88C0           00282         bsf             ADCON2, ACQT1, ACCESS
000332 82C0           00283         bsf             ADCON2, ADCS1, ACCESS
000334 0012           00284         return
                      00285 
                      00286 
                      00287 ;**********************************************************************
                      00288 ; Function: void initInterrupts()
                      00289 ;**********************************************************************
                      00290 
000336                00291 initInterrupts
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 69


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00292         ; Enable interrupt priorities           
000336 8ED0           00293         bsf             RCON, IPEN, ACCESS
                      00294         
                      00295         ; unmask peripheral interrupts
                      00296         ; enable timer0 interrupts
                      00297         ; enable INT0 interrupts
                      00298         ; clear timer0 int flag
                      00299         ; clear INT0 int flag
000338 8CF2           00300         bsf             INTCON, PEIE, ACCESS
00033A 8AF2           00301         bsf             INTCON, TMR0IE, ACCESS
                      00302 
                      00303 ; DEBUG - PIC18LF14K22 INT0/1/2 pins not compatible with PIC18LF13K50
                      00304 #ifndef PIC18LF14K22
00033C 88F2           00305         bsf             INTCON, INT0IE, ACCESS
                      00306 #endif
00033E 94F2           00307         bcf             INTCON, TMR0IF, ACCESS
000340 92F2           00308         bcf             INTCON, INT0IF, ACCESS
                      00309         
                      00310         ; INT0 interrupt on falling edge
                      00311         ; INT1 interrupt on falling edge
                      00312         ; INT2 interrupt on falling edge
                      00313         ; Interrupt priority is low
000342 9CF1           00314         bcf             INTCON2, INTEDG0, ACCESS
000344 9AF1           00315         bcf             INTCON2, INTEDG1, ACCESS
000346 98F1           00316         bcf             INTCON2, INTEDG2, ACCESS
000348 94F1           00317         bcf             INTCON2, TMR0IP, ACCESS
                      00318                 
                      00319         ; INT2 is low Priority interrupt
                      00320         ; INT1 is low Priority interrupt
                      00321         ; enable INT2 interrupts
                      00322         ; enable INT1 interrupts
                      00323         ; clear INT2 int flag
                      00324         ; clear INT1 int flag
00034A 9EF0           00325         bcf             INTCON3, INT2IP, ACCESS
00034C 9CF0           00326         bcf             INTCON3, INT1IP, ACCESS
                      00327 ; DEBUG - PIC18LF14K22 INT0/1/2 pins not compatible with PIC18LF13K50
                      00328 #ifndef PIC18LF14K22
00034E 88F0           00329         bsf             INTCON3, INT2IE, ACCESS
000350 86F0           00330         bsf             INTCON3, INT1IE, ACCESS
                      00331 #endif
000352 92F0           00332         bcf             INTCON3, INT2IF, ACCESS
000354 90F0           00333         bcf             INTCON3, INT1IF, ACCESS
                      00334                         
                      00335         ; UART RX is low priority interrupt     
000356 9A9F           00336         bcf             IPR1, RCIP, ACCESS
                      00337         
                      00338         ; clear timer2 int flag
000358 929E           00339         bcf             PIR1, TMR2IF, ACCESS            
                      00340         
                      00341         ; enable UART rx ints
                      00342         ; enable timer2 interrupts
00035A 8A9D           00343         bsf             PIE1, RCIE, ACCESS
00035C 829D           00344         bsf             PIE1, TMR2IE, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 70


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00035E 0012           00345         return
                      00346         
                      00347 
                      00348 ;**********************************************************************
                      00349 ; Function: void initRAM()
                      00350 ;**********************************************************************
000360                00351 initRAM
                      00352         ; clear all general purpose RAM locations to 0x00
000360                00353 initRAM_bank0
                      00354         ; init pointer to start of BANK0
000360 6AE9           00355         clrf    FSR0L, ACCESS
000362 6AEA           00356         clrf    FSR0H, ACCESS
000364                00357 initRAM_bank0Lp
000364 6AEE           00358         clrf    POSTINC0, ACCESS
                      00359         ; BANK0 is done when FSR0 == 0x0100
000366 0E01           00360         movlw   1
000368 62EA           00361         cpfseq  FSR0H, ACCESS
00036A D???           00362         bra             initRAM_bank0Lp
                      00363 
00036C                00364 initRAM_bank1
                      00365         ; PIC18LF13K50 does not implement BANK1 so skip it
                      00366 
00036C                00367 initRAM_bank2
                      00368         ; init pointer to start of BANK2
00036C 6AE9           00369         clrf    FSR0L, ACCESS
00036E 0E02           00370         movlw   0x02
000370 6EEA           00371         movwf   FSR0H, ACCESS
000372                00372 initRAM_bank2Lp
000372 6AEE           00373         clrf    POSTINC0, ACCESS
                      00374         ; BANK2 is done when FSR0 == 0x0300
000374 0E03           00375         movlw   3
000376 62EA           00376         cpfseq  FSR0H, ACCESS
000378 D???           00377         bra             initRAM_bank2Lp
                      00378 
                      00379         ; reset fsr address
00037A 6AE9           00380         clrf    FSR0L, ACCESS   
00037C 6AEA           00381         clrf    FSR0H, ACCESS   
00037E 0012           00382         return
                      00383 
                      00384 ;**********************************************************************
                      00385 ; Function: void initHeap()
                      00386 ;**********************************************************************
                      00387 
000380                00388 initHeap
000380 EE22 F0FF      00389         lfsr    softwareStackPointerFSR, softwareStackBaseAddress
000384 0012           00390         return
                      00391         
                      00392 
                      00393         
                      00306         #include        "../source/midi.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 71


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      midi.asm                                          *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021         
                      00022 ;**********************************************************************
                      00023 ; INCLUDES
                      00024 ;**********************************************************************
                      00025 
                      00026         #include        "../header/midi.h"
                      00443 
                      00444 ;**********************************************************************
                      00445 ;                                                                     *
                      00446 ;    Project:       deMIDulator                                       *
                      00447 ;    Filename:      midi.h                                            *
                      00448 ;    Date:                                                            *
                      00449 ;    File Version:                                                    *
                      00450 ;                                                                     *
                      00451 ;    Author:        Derek Enos                                        *
                      00452 ;    Company:                                                         *
                      00453 ;                                                                     * 
                      00454 ;                                                                     *
                      00455 ;**********************************************************************
                      00456 ;                                                                     *
                      00457 ;    Files required:                                                  *
                      00458 ;                                                                     *
                      00459 ;                                                                     *
                      00460 ;                                                                     *
                      00461 ;**********************************************************************
                      00462 
                      00463 #ifndef _MIDIH_
                      00464 #define _MIDIH_
                      00465 
                      00466 
                      00467 ; ******************* MIDI SYSEX DEFINES ***********************
                      00468 #define         VENDOR_ID       0x77
                      00469 #define         DEVICE_ID       0x1D
                      00470 #define         TERMINAL_PACKET_COMMAND_VALUE   0x1E
                      00471 
                      00472 ; ******************* MIDI BUFFER SIZES ***********************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 72


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00473 
                      00474 #define         MAX_MIDI_MESSAGE_SIZE   24
                      00475 #define         ACTIVE_NOTE_TABLE_SIZE  25
                      00476 
                      00477 
                      00478 ; ******************* STATUS BYTE DEFINITONS ***********************
                      00479 
                      00480 ; Note that lower nybble (channel) should be masked out for comparison
                      00481 ;------------------------
                      00482 #define         NOTE_OFF                                0x80
                      00483 #define         NOTE_ON                                 0x90
                      00484 #define         KEY_PRESSURE                    0xA0
                      00485 #define         CONTROL_CHANGE                  0xB0
                      00486 #define         PROGRAM_CHANGE                  0xC0
                      00487 #define         CHANNEL_PRESSURE                0xD0
                      00488 #define         PITCH_WHEEL                             0xE0
                      00489 
                      00490 ; Sysex Status Byte Definitions
                      00491 #define         SYSEX                                   0xF0
                      00492 #define         EOX                                             0xF7
                      00493 
                      00494 #define         NOTE_OFF_MESSAGE_LENGTH                         3
                      00495 #define         NOTE_ON_MESSAGE_LENGTH                          3
                      00496 #define         KEY_PRESSURE_MESSAGE_LENGTH                     3
                      00497 #define         CONTROL_CHANGE_MESSAGE_LENGTH           3
                      00498 #define         PROGRAM_CHANGE_MESSAGE_LENGTH           2
                      00499 #define         CHANNEL_PRESSURE_MESSAGE_LENGTH         2
                      00500 #define         PITCH_WHEEL_MESSAGE_LENGTH                      3
                      00501 
                      00502 ; SysEx Sub Types
                      00503 ;----------------------------
                      00504 #define         NON_REAL_TIME                                           0x7E
                      00505 #define         GENERAL_INFORMATION                                     0x06
                      00506 #define         IDENTITY_REQUEST                                        0x01
                      00507 #define         IDENTITY_REPLY                                          0x02
                      00508 
                      00509 ; Control Change Data Types
                      00510 ;----------------------------
                      00511 #define         BANK_SELECT_MSB                                         0
                      00512 #define         MODULATION_WHEEL_MSB                            1
                      00513 #define         BREATH_CONTROLLER_MSB                           2
                      00514 #define         UNDEFINED_003                                           3
                      00515 #define         FOOT_CONTROLLER_MSB                                     4
                      00516 #define         PORTAMENTO_TIME                                         5
                      00517 #define         DATA_ENTRY_MSB                                          6
                      00518 #define         CHANNEL_VOLUME_MSB                                      7
                      00519 #define         BALANCE_MSB                                                     8
                      00520 #define         UNDEFINED_MSB                                           9
                      00521 #define         PAN_MSB                                                         10
                      00522 #define         EXPRESSION_MSB                                          11
                      00523 #define         EFFECT_CONTROL_1_MSB                            12
                      00524 #define         EFFECT_CONTROL_2_MSB                            13
                      00525 #define         UNDEFINED_014                                           14
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 73


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00526 #define         UNDEFINED_015                                           15
                      00527 #define         GENERAL_PURPOSE_CONTROLLER_1_MSB        16
                      00528 #define         GENERAL_PURPOSE_CONTROLLER_2_MSB        17
                      00529 #define         GENERAL_PURPOSE_CONTROLLER_3_MSB        18
                      00530 #define         GENERAL_PURPOSE_CONTROLLER_4_MSB        19
                      00531 #define         UNDEFINED_020                                           20
                      00532 #define         UNDEFINED_021                                           21
                      00533 #define         UNDEFINED_022                                           22
                      00534 #define         UNDEFINED_023                                           23
                      00535 #define         UNDEFINED_024                                           24
                      00536 #define         UNDEFINED_025                                           25
                      00537 #define         UNDEFINED_026                                           26
                      00538 #define         UNDEFINED_027                                           27
                      00539 #define         UNDEFINED_028                                           28
                      00540 #define         UNDEFINED_029                                           29
                      00541 #define         UNDEFINED_030                                           30
                      00542 #define         UNDEFINED_031                                           31
                      00543 #define         BANK_SELECT_LSB                                         32
                      00544 #define         MODULATION_WHEEL_LSB                            33
                      00545 #define         BREATH_CONTROLLER_LSB                           34
                      00546 #define         UNDEFINED_035                                           35
                      00547 #define         FOOT_CONTROLLER_LSB                                     36
                      00548 #define         PORTAMENTO_TIME_LSB                                     37
                      00549 #define         DATA_ENTRY_LSB                                          38
                      00550 #define         CHANNEL_VOLUME_LSB                                      39
                      00551 #define         BALANCE_LSB                                                     40
                      00552 #define         UNDEFINED_041                                           41
                      00553 #define         PAN_LSB                                                         42
                      00554 #define         EXPRESSION_LSB                                          43
                      00555 #define         EFFECT_CONTROL_1_LSB                            44
                      00556 #define         EFFECT_CONTROL_2_LSB                            45
                      00557 #define         UNDEFINED_046                                           46
                      00558 #define         UNDEFINED_047                                           47
                      00559 #define         GENERAL_PURPOSE_CONTROLLER_1_LSB        48
                      00560 #define         GENERAL_PURPOSE_CONTROLLER_2_LSB        49
                      00561 #define         GENERAL_PURPOSE_CONTROLLER_3_LSB        50
                      00562 #define         GENERAL_PURPOSE_CONTROLLER_4_LSB        51
                      00563 #define         UNDEFINED_052                                           52
                      00564 #define         UNDEFINED_053                                           53
                      00565 #define         UNDEFINED_054                                           54
                      00566 #define         UNDEFINED_055                                           55
                      00567 #define         UNDEFINED_056                                           56
                      00568 #define         UNDEFINED_057                                           57
                      00569 #define         UNDEFINED_058                                           58
                      00570 #define         UNDEFINED_059                                           59
                      00571 #define         UNDEFINED_060                                           60
                      00572 #define         UNDEFINED_061                                           61
                      00573 #define         UNDEFINED_062                                           62
                      00574 #define         UNDEFINED_063                                           63
                      00575 #define         SUSTAIN_PEDAL                                           64
                      00576 #define         PORTAMENTO_ONOFF                                        65
                      00577 #define         SOSTENUTO                                                       66
                      00578 #define         SOFT_PEDAL                                                      67
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 74


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00579 #define         LEGATO_FOOTSWITCH                                       68
                      00580 #define         HOLD_2                                                          69
                      00581 #define         SOUND_CONTROLLER_1_DEFAULT_SOUND_VARIATION                              70
                      00582 #define         SOUND_CONTROLLER_2_DEFAULT_TIMBRE_HARMONIC_QUALITY              71
                      00583 #define         SOUND_CONTROLLER_3_DEFAULT_RELEASE_TIME                                 72
                      00584 #define         SOUND_CONTROLLER_4_DEFAULT_ATTACK_TIME                                  73
                      00585 #define         SOUND_CONTROLLER_5_DEFAULT_BRIGHTNESS                                   74
                      00586 #define         SOUND_CONTROLLER_6_GM2_DEFAULT_DECAY_TIME                               75
                      00587 #define         SOUND_CONTROLLER_7_GM2_DEFAULT_VIBRATO_RATE                             76
                      00588 #define         SOUND_CONTROLLER_8_GM2_DEFAULT_VIBRATO_DEPTH                    77
                      00589 #define         SOUND_CONTROLLER_9_GM2_DEFAULT_VIBRATO_DELAY                    78
                      00590 #define         SOUND_CONTROLLER_10_GM2_DEFAULT_UNDEFINED                               79
                      00591 #define         GENERAL_PURPOSE_CONTROLLER_5                                                    80
                      00592 #define         GENERAL_PURPOSE_CONTROLLER_6                                                    81
                      00593 #define         GENERAL_PURPOSE_CONTROLLER_7                                                    82
                      00594 #define         GENERAL_PURPOSE_CONTROLLER_8                                                    83
                      00595 #define         PORTAMENTO_CONTROL                                                                      
                                    84
                      00596 #define         UNDEFINED_85                                                                    85
                      00597 #define         UNDEFINED_86                                                                    86
                      00598 #define         UNDEFINED_87                                                                    87
                      00599 #define         UNDEFINED_88                                                                    88
                      00600 #define         UNDEFINED_89                                                                    89
                      00601 #define         UNDEFINED_90                                                                    90
                      00602 #define         EFFECTS_1_DEPTH_DEFAULT_REVERB_SEND                             91
                      00603 #define         EFFECTS_2_DEPTH_DEFAULT_TREMOLO_DEPTH                   92
                      00604 #define         EFFECTS_3_DEPTH_DEFAULT_CHORUS_SEND                             93
                      00605 #define         EFFECTS_4_DEPTH_DEFAULT_CELESTE_[DETUNE]_DEPTH  94
                      00606 #define         EFFECTS_5_DEPTH_DEFAULT_PHASER_DEPTH                    95
                      00607 #define         DATA_INCREMENT                                                                  96
                      00608 #define         DATA_DECREMENT                                                                  97
                      00609 #define         NON_REG_PARAMETER_NUMBER_LSB                            98
                      00610 #define         NON_REG_PARAMETER_NUMBER_MSB                            99
                      00611 #define         REGISTERED_PARAMETER_NUMBER_LSB                                 100
                      00612 #define         REGISTERED_PARAMETER_NUMBERMSB                                  101
                      00613 #define         UNDEFINED_102                                           102
                      00614 #define         UNDEFINED_103                                           103
                      00615 #define         UNDEFINED_104                                           104
                      00616 #define         UNDEFINED_105                                           105
                      00617 #define         UNDEFINED_106                                           106
                      00618 #define         UNDEFINED_107                                           107
                      00619 #define         UNDEFINED_108                                           108
                      00620 #define         UNDEFINED_109                                           109
                      00621 #define         UNDEFINED_110                                           110
                      00622 #define         UNDEFINED_111                                           111
                      00623 #define         UNDEFINED_112                                           112
                      00624 #define         UNDEFINED_113                                           113
                      00625 #define         UNDEFINED_114                                           114
                      00626 #define         UNDEFINED_115                                           115
                      00627 #define         UNDEFINED_116                                           116
                      00628 #define         UNDEFINED_117                                           117
                      00629 #define         UNDEFINED_118                                           118
                      00630 #define         UNDEFINED_119                                           119
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 75


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00631 #define         ALL_SOUND_OFF                                           120
                      00632 #define         RESET_ALL_CONTROLLERS                           121
                      00633 #define         LOCAL_CONTROL_ONOFF                                     122
                      00634 #define         ALL_NOTES_OFF                                           123
                      00635 #define         OMNI_MODE_OFF                                           124
                      00636 #define         OMNI_MODE_ON                                            125
                      00637 #define         POLY_MODE_OFF                                           126
                      00638 #define         POLY_MODE_ON                                            127
                      00639 
                      00640 
                      00641 ; ******************* MIDI MESSAGE STATES ***********************
                      00642 
                      00643 #define CHANNEL                                         0x00
                      00644 #define DATA_BYTE0                                      0x01
                      00645 #define DATA_BYTE1                                      0x02
                      00646 #define MESSAGE_COMPLETE                        0xFF
                      00647 
                      00648 #define NOTE_COMPLETE                           DATA_BYTE1
                      00649 #define AFTERTOUCH_COMPLETE                     DATA_BYTE1
                      00650 #define CONTROL_CHANGE_COMPLETE         DATA_BYTE1
                      00651 #define PROGRAM_CHANGE_COMPLETE         DATA_BYTE0
                      00652 #define PITCH_WHEEL_COMPLETE            DATA_BYTE1
                      00653 
                      00654 
                      00655 ; ******************* FLAG VARIABLE DEFINITIONS ***********************
                      00656 
                      00657 ; midiFlags (bits 3:7 free for use by other modules)
                      00658 #define uartState_rxInProgress                  0
                      00659 #define midiState_messageNeedsMapping   1
                      00660 #define midiThruModeEnabled                             2
                      00661 
                      00662 
                      00663 #endif
                      00027         
                      00028 ;**********************************************************************
                      00029 ; LOCAL VARIABLES
                      00030 ;**********************************************************************
                      00031 
                      00032         CBLOCK
                      00033 
  0000000B            00034                 midiState_lastStatus:1
  0000000C            00035                 midiState_lastLength:1
  0000000D            00036                 uartState_currentRxIndex:1
  0000000E            00037                 midiRxMessage_length:1
  0000000F            00038                 midiLastProgramValue:1
                      00039                         
  00000010            00040                 midiFlags:1
                      00041                 ; Bits defined in midi.h
                      00042                 ; #define uartState_rxInProgress                0
                      00043                 ; #define midiState_messageNeedsMapping 1
                      00044                 ; #define midiThroughMode_enabled               2
                      00045                 ; Bits 3:7 free for use by other modules
                      00046 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 76


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00047                 ; Declared at end of main.asm to ensure that arrays are pushed to end of memory...
                      00048                 ; with smaller variables in ACCESS memory
                      00049                 ; ---------------------------------------
                      00050                 ; midiRxMessage:MAX_MIDI_MESSAGE_SIZE
                      00051                 ; activeNoteTable:ACTIVE_NOTE_TABLE_SIZE
                      00052                                 
                      00053         ENDC
                      00054                         
                      00055 ;**********************************************************************
                      00056 ; LOCAL FUNCTIONS
                      00057 ;**********************************************************************
                      00058 
                      00059 ; [Function Summary]
                      00060 ;
                      00061 ; Function: initMIDI()
                      00062 ; Abstract: initializes MIDI state variables and flags
                      00063 
                      00064 ; Function: processRxAsMIDI()
                      00065 ; Abstract: reads rx byte from UART's RCREG and processes as incoming MIDI transaction
                      00066 ;           calls midiMessageMapper() when last byte of complete MIDI message has been received
                      00067 
                      00068 ; Function: midiMessageMapper()
                      00069 ; Abstract: determines type of received MIDI message and reacts
                      00070 ;           received Note On triggers call to activeNoteTableAdd()
                      00071 ;                       received Note Off triggers call to activeNoteTableRemove()
                      00072 ;                       received Pitch Wheel value is saved to variable pitchWheel
                      00073 
                      00074 
                      00075 ;**********************************************************************
                      00076 ; Function: void midiDebugTriggerHandler()
                      00077 ;**********************************************************************
                      00078 ; since the PIC18LF13K50 doesn't contain debugging hardware,
                      00079 ; I'm using this routine as a crude way to dump memory contents via MIDI output
                      00080 ; this code will only be include if MIDI_DEBUG_TRIGGER_ENABLED is #define(d)
                      00081 
                      00082 #IFDEF MIDI_DEBUG_TRIGGER_ENABLED
                      00083 midiDebugTriggerHandler
                      00084         PUSH_R  r0
                      00085         PUSH_R  FSR0L
                      00086         PUSH_R  FSR0H
                      00087         
                      00088         #define byteCount r0
                      00089 
                      00090         ; dump activeNoteTable
                      00091         ; start SysEx message
                      00092         movlw   SYSEX
                      00093         call    midiDebugTriggerHandler_SendByte
                      00094         ; init
                      00095         lfsr    FSR0, activeNoteTable
                      00096         movlw   ACTIVE_NOTE_TABLE_SIZE
                      00097         movwf   byteCount, ACCESS
                      00098 midiDebugTriggerHandler_antLp
                      00099         movf    byteCount, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 77


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00100         sublw   ACTIVE_NOTE_TABLE_SIZE
                      00101         movf    PLUSW0, w, ACCESS
                      00102         ; empty activeNoteTable entry == 0xff which is not cool to send inside SysEx so compliment
                      00103         ; add 1 to WREG, if result is ZERO then value was 0xff so just send 0 value to port
                      00104         addlw   1
                      00105         btfss   STATUS, Z, ACCESS
                      00106         ; result was not ZERO so value was not 0xff. subtract 1 to restore original value
                      00107         sublw   1
                      00108         call    midiDebugTriggerHandler_SendByte
                      00109         decf    byteCount, f, ACCESS
                      00110         bnz             midiDebugTriggerHandler_antLp
                      00111         ; close SysEx message
                      00112         movlw   EOX
                      00113         call    midiDebugTriggerHandler_SendByte
                      00114 
                      00115         ; dump activeNoteDeltas
                      00116         ; start SysEx message
                      00117         movlw   SYSEX
                      00118         call    midiDebugTriggerHandler_SendByte
                      00119         ; init
                      00120         lfsr    FSR0, activeNoteDeltas
                      00121         movlw   ACTIVE_NOTE_DELTAS_SIZE
                      00122         movwf   byteCount, ACCESS
                      00123 midiDebugTriggerHandler_andLp
                      00124         movf    byteCount, w, ACCESS
                      00125         sublw   ACTIVE_NOTE_TABLE_SIZE
                      00126         movf    PLUSW0, w, ACCESS
                      00127         ; activeNoteDeltas values are not SysEx friendly su just clear bit7 no matter what
                      00128         andlw   0x7f
                      00129         call    midiDebugTriggerHandler_SendByte
                      00130         decf    byteCount, f, ACCESS
                      00131         bnz             midiDebugTriggerHandler_andLp
                      00132         ; close SysEx message
                      00133         movlw   EOX
                      00134         call    midiDebugTriggerHandler_SendByte
                      00135 
                      00136         #undefine       byteCount
                      00137 
                      00138         POP_R   FSR0H
                      00139         POP_R   FSR0L
                      00140         POP_R   r0
                      00141 
                      00142         return
                      00143 
                      00144 
                      00145 midiDebugTriggerHandler_SendByte
                      00146         ; skip if TXREG is ready for writting
                      00147         btfss   PIR1, TXIF, ACCESS
                      00148         ; not ready so keep checking
                      00149         goto    midiDebugTriggerHandler_SendByte
                      00150         ; is ready so write it
                      00151         movwf TXREG, ACCESS
                      00152         return
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 78


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00153 #ENDIF
                      00154 
                      00155 ;**********************************************************************
                      00156 ; Function: void initMIDI(void)
                      00157 ;**********************************************************************
                      00158 
000386                00159 initMIDI
                      00160         ; push working regs onto software stack
                      00161         PUSH_R  r0
000386 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00162         PUSH_R  FSR0L
00038A CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00163         PUSH_R  FSR0H
00038E CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00164         ; define variables to pushed registers
                      00165         #define count                                   r0
                      00166         #define FSR_activeNoteTable             FSR0
                      00167         #define POSTINC_activeNoteTable POSTINC0
                      00168                 
                      00169         ; load fsr
000392 EE00 F058      00170         lfsr    FSR_activeNoteTable, activeNoteTable    
                      00171         
000396 6A0B           00172         clrf    midiState_lastStatus, ACCESS
000398 6A0C           00173         clrf    midiState_lastLength, ACCESS
00039A 6A0D           00174         clrf    uartState_currentRxIndex, ACCESS
00039C 6A0E           00175         clrf    midiRxMessage_length, ACCESS
00039E 6A0F           00176         clrf    midiLastProgramValue, ACCESS
                      00177                                                 
0003A0 9010           00178         bcf             midiFlags, uartState_rxInProgress, ACCESS               
0003A2 9210           00179         bcf             midiFlags, midiState_messageNeedsMapping, ACCESS
                      00180         ; enable MIDI THRU mode
0003A4 8410           00181         bsf             midiFlags, midiThruModeEnabled, ACCESS  
                      00182 
0003A6 0E19           00183         movlw   ACTIVE_NOTE_TABLE_SIZE
0003A8 6E03           00184         movwf   count, ACCESS
0003AA 0EFF           00185         movlw   0xff
0003AC                00186 initMIDI_lp     
0003AC 6EEE           00187         movwf   POSTINC_activeNoteTable, ACCESS
0003AE 2E03           00188         decfsz  count, f, ACCESS
0003B0 D???           00189         bra             initMIDI_lp
                      00190                 
                      00191         ; undefine variables from pushed registers
                      00192         #undefine count
                      00193         #undefine FSR_activeNoteTable
                      00194         #undefine POSTINC_activeNoteTable
                      00195         ; pop working regs from software stack
                      00196         POP_R   FSR0H
0003B2 CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00197         POP_R   FSR0L
0003B6 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00198         POP_R   r0
0003BA CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00199 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 79


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0003BE 0012           00200         return
                      00201 
                      00202 
                      00203 ;**********************************************************************
                      00204 ; Function: void processRxAsMIDI(RCREG)
                      00205 ;**********************************************************************
                      00206 
0003C0                00207 processRxAsMIDI
                      00208         ; push working regs onto software stack
                      00209         PUSH_R  r0
0003C0 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00210         PUSH_R  r1
0003C4 C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00211         PUSH_R  FSR0L
0003C8 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00212         PUSH_R  FSR0H
0003CC CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00213         ; define variables to pushed registers
                      00214         #define rxByte                          r0
                      00215         #define tmpValue                        r1      
                      00216         #define FSR_midiRxMessage       FSR0
                      00217         #define PLUSW_midiRxMessage     PLUSW0
                      00218 
                      00219         ; init FSR
0003D0 EE00 F040      00220         lfsr    FSR_midiRxMessage, midiRxMessage
                      00221         
                      00222         ;**** start procedure: read UART RX byte and check error states ****
0003D4                00223 processRxAsMIDI_readFIFO
                      00224         ; skip if framing error occurred for top unread char in rx FIFO
0003D4 A4AB           00225         btfss   RCSTA, FERR, ACCESS
                      00226         ; no framing error so read the character
0003D6 D???           00227         bra             processRxAsMIDI_readGO
                      00228         ; framing error occurred
                      00229         ; read incorrectly framed character out of FIFO
0003D8 50AE           00230         movf    RCREG, w, ACCESS
                      00231         ; skip if rx FIFO is empty
0003DA BA9E           00232         btfsc   PIR1, RCIF, ACCESS
                      00233         ; FIFO is not empty so try next character
0003DC D???           00234         bra             processRxAsMIDI_readFIFO
                      00235         ; all characters in FIFO were incorrectly framed, no data to process
                      00236         ; attempt to remedy: reset UART receiver by toggling Continous Receive Enable bit
0003DE 98AB           00237         bcf             RCSTA, CREN, ACCESS
0003E0 88AB           00238         bsf             RCSTA, CREN, ACCESS
                      00239         ; exit ISR
0003E2 EF?? F???      00240         goto    processRxAsMIDI_Exit
                      00241         
0003E6                00242 processRxAsMIDI_readGO
                      00243         ; save RX byte / clear RCIF
0003E6 CFAE F003      00244         movff   RCREG, rxByte
                      00245 
                      00246         ; if MIDI THRU mode is enabled then write byte to UART output
0003EA B410           00247         btfsc   midiFlags, midiThruModeEnabled, ACCESS
0003EC C003 FFAD      00248         movff   rxByte, TXREG
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 80


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00249 
                      00250         ; check for rx buffer overrun
                      00251         ; skip if buffer overrun occurred
0003F0 A2AB           00252         btfss   RCSTA, OERR, ACCESS
0003F2 D???           00253         bra             processRxAsMIDI_noErrors
                      00254         ; reset UART receiver by toggling Continous Receive Enable bit
0003F4 98AB           00255         bcf             RCSTA, CREN, ACCESS
0003F6 88AB           00256         bsf             RCSTA, CREN, ACCESS
                      00257 
0003F8                00258 processRxAsMIDI_noErrors
                      00259 
                      00260         ; **** Notes About MIDI Message Handling Implementation ****
                      00261         ; 1. Only the following MIDI message types are currently supported:
                      00262         ;    * 1000nnnn : Note Off
                      00263         ;    * 1001nnnn : Note On
                      00264         ;    * 1011nnnn : Control Change
                      00265         ;    * 1100nnnn : Program Change
                      00266         ;    * 1110nnnn : Pitch Wheel
                      00267         ;    * 11110000 : System Exclusive
                      00268         ;    * 11111111 : Reset
                      00269         ; 2. Status values above SysEx (0xF0) are not currently supported
                      00270         ;    Unsupported common messages include:
                      00271         ;    * 11110001 : MIDI Time Code Quarter Frame
                      00272         ;    * 11110010 : Song Position Pointer
                      00273         ;    * 11110011 : Song Select
                      00274         ;    * 11110110 : Tune Request
                      00275         ;    * 11111000 : Timing Clock
                      00276         ;    * 11111010 : Start
                      00277         ;    * 11111011 : Continue
                      00278         ;    * 11111100 : Stop
                      00279         ;    * 11111110 : Active Sense
                      00280         
                      00281         ;**** start procedure: is STATUS? ****
                      00282         ; if bit 7 is set then received byte is STATUS
0003F8 AE03           00283         btfss   rxByte, 7, ACCESS
0003FA D???           00284         bra             processRxAsMIDI_notStatusOrIsEOX
                      00285         ; ignore > SysEx (0xF0) values as STATUS but continue to process as non-STATUS to capture EOX
                      00286         ; 
0003FC 0EF0           00287         movlw   SYSEX
                      00288         ; compare f with W, skip if f > W
0003FE 6403           00289         cpfsgt  rxByte, ACCESS
000400 D???           00290         bra             processRxAsMIDI_getLength
000402 D???           00291         bra             processRxAsMIDI_notStatusOrIsEOX
                      00292 
                      00293         ;**** start procedure: get message length ****
000404                00294 processRxAsMIDI_getLength
                      00295         ; midiRxMessage_length = length of MIDI message type
                      00296         ; midiRxMessage_length of 0x0 is used to indicate unsupported message types
000404 6A0E           00297         clrf    midiRxMessage_length, ACCESS
                      00298         
                      00299         ; mask out channel data and save in tmpValue
000406 5003           00300         movf    rxByte, w, ACCESS
000408 0BF0           00301         andlw   0xF0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 81


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00040A 6E04           00302         movwf   tmpValue, ACCESS
                      00303         
                      00304         ; Check if STATUS is a 2-byte message type
                      00305         ; case PROGRAM_CHANGE
00040C 0EC0           00306         movlw   PROGRAM_CHANGE
00040E 1804           00307         xorwf   tmpValue, w, ACCESS
000410 E0??           00308         bz              processRxAsMIDI_lengthIs2
                      00309         ; case CHANNEL_PRESSURE
000412 0ED0           00310         movlw   CHANNEL_PRESSURE
000414 1804           00311         xorwf   tmpValue, w, ACCESS
000416 E0??           00312         bz              processRxAsMIDI_lengthIs2
000418 D???           00313         bra             processRxAsMIDI_lengthIsNot2
00041A                00314 processRxAsMIDI_lengthIs2
                      00315         ; midiRxMessage_length = 2
00041A 0E02           00316         movlw   2
00041C 6E0E           00317         movwf   midiRxMessage_length, ACCESS    
00041E D???           00318         bra             processRxAsMIDI_getLengthDone
000420                00319 processRxAsMIDI_lengthIsNot2
                      00320 
                      00321         ; Check if STATUS is a 3-byte message type
                      00322         ; case NOTE_OFF
000420 0E80           00323         movlw   NOTE_OFF
000422 1804           00324         xorwf   tmpValue, w, ACCESS
000424 E0??           00325         bz              processRxAsMIDI_lengthIs3               
                      00326         ; case NOTE_ON
000426 0E90           00327         movlw   NOTE_ON
000428 1804           00328         xorwf   tmpValue, w, ACCESS
00042A E0??           00329         bz              processRxAsMIDI_lengthIs3               
                      00330         ; case KEY_PRESSURE
00042C 0EA0           00331         movlw   KEY_PRESSURE
00042E 1804           00332         xorwf   tmpValue, w, ACCESS
000430 E0??           00333         bz              processRxAsMIDI_lengthIs3               
                      00334         ; case CONTROL_CHANGE
000432 0EB0           00335         movlw   CONTROL_CHANGE
000434 1804           00336         xorwf   tmpValue, w, ACCESS
000436 E0??           00337         bz              processRxAsMIDI_lengthIs3               
                      00338         ; case PITCH_WHEEL
000438 0EE0           00339         movlw   PITCH_WHEEL
00043A 1804           00340         xorwf   tmpValue, w, ACCESS
00043C E0??           00341         bz              processRxAsMIDI_lengthIs3               
00043E D???           00342         bra             processRxAsMIDI_lengthIsNot3
000440                00343 processRxAsMIDI_lengthIs3
                      00344         ; midiRxMessage_length = 3
000440 0E03           00345         movlw   3
000442 6E0E           00346         movwf   midiRxMessage_length, ACCESS    
000444 D???           00347         bra             processRxAsMIDI_getLengthDone
000446                00348 processRxAsMIDI_lengthIsNot3
                      00349 
                      00350         ; Check if STATUS is EOX-byte message type
                      00351         ; case SYSEX
000446 0EF0           00352         movlw   SYSEX
000448 1804           00353         xorwf   tmpValue, w, ACCESS
00044A E1??           00354         bnz             processRxAsMIDI_getLengthDone
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 82


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00044C 0EF7           00355         movlw   EOX
00044E 6E0E           00356         movwf   midiRxMessage_length, ACCESS    
000450                00357 processRxAsMIDI_getLengthDone
                      00358         
                      00359         ;**** start procedure: supported message type? ****
                      00360         ; midiRxMessage_length of 0 indicates unsupported STATUS value
000450 520E           00361         movf    midiRxMessage_length, f, ACCESS
000452 E0??           00362         bz              processRxAsMIDI_resetUartState
                      00363 
                      00364         ;**** start procedure: message supported, init uartState for reception ****
000454 8010           00365         bsf             midiFlags, uartState_rxInProgress, ACCESS
                      00366         ;       midiRxMessage[0] = STATUS including channel data
000456 C003 F040      00367         movff   rxByte, midiRxMessage
                      00368         ;       uartState_currentRxIndex = 1
00045A 0E01           00369         movlw   1
00045C 6E0D           00370         movwf   uartState_currentRxIndex, ACCESS
                      00371         ;       midiState_lastStatus = rxdata
00045E C003 F00B      00372         movff   rxByte, midiState_lastStatus
                      00373         ;       midiState_lastLength = midiRxMessage_length
000462 C00E F00C      00374         movff   midiRxMessage_length, midiState_lastLength
000466 D???           00375         bra             processRxAsMIDI_RxHandlingDone
                      00376 
                      00377         ;**** start procedure: message unsupported, reset uartState ****
000468                00378 processRxAsMIDI_resetUartState
                      00379         ; Fixes logic problem discovered because Axiom 25 streams aftertouch data which was being interp
                            reted as running status Note Ons
                      00380         ; Reception of an unsupported MIDI message will kill any in-progress message rx
                      00381         ; uartState_rxInProgress = FALSE
000468 9010           00382         bcf             midiFlags, uartState_rxInProgress, ACCESS
                      00383         ; Reset midiState.lastStatus so that subsequent non-status values are not interpreted as running
                             status
00046A 6A0B           00384         clrf    midiState_lastStatus, ACCESS
00046C D???           00385         bra             processRxAsMIDI_RxHandlingDone
                      00386 
                      00387         ; process STATUS byte done
                      00388         ;**********************************************************************
                      00389         ; process non-STATUS or EOX byte begin
                      00390 
                      00391         ;**** start procedure: process non-STATUS or EOX byte ****
00046E                00392 processRxAsMIDI_notStatusOrIsEOX
                      00393         ; continue if reception in progress
00046E B010           00394         btfsc   midiFlags, uartState_rxInProgress, ACCESS
000470 D???           00395         bra             processRxAsMIDI_rxInProgress
                      00396 
                      00397         ; no reception in progress so attempt to process as running STATUS if rxByte < SYSEX, otherwise 
                            ignore
000472 0EF0           00398         movlw   SYSEX
000474 6003           00399         cpfslt  rxByte, ACCESS
000476 D???           00400         bra             processRxAsMIDI_RxHandlingDone
000478 D???           00401         bra             processRxAsMIDI_tryRunningStatus
                      00402         
00047A                00403 processRxAsMIDI_rxInProgress
                      00404         ; continue if byte is non-STATUS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 83


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00047A AE03           00405         btfss   rxByte, 7, ACCESS
00047C D???           00406         bra             processRxAsMIDI_notStatusContinue
                      00407 
                      00408         ; byte is STATUS, continue if EOX
00047E 0EF7           00409         movlw   EOX
000480 1803           00410         xorwf   rxByte, w, ACCESS       
                      00411         ; byte is STATUS but not EOX or any other supported STATUS value so ignore
000482 E1??           00412         bnz             processRxAsMIDI_RxHandlingDone
                      00413 
                      00414         ;**** start procedure: save incoming byte to buffer ****
Warning[208]: Label truncated at 32 characters. (processRxAsMIDI_notStatusContinue)
000484                00415 processRxAsMIDI_notStatusContinue
                      00416         ; check buffer capacity
000484 0E18           00417         movlw   MAX_MIDI_MESSAGE_SIZE
000486 600D           00418         cpfslt  uartState_currentRxIndex, ACCESS
                      00419         ; buffer is completely full with incomplete message
                      00420         ; cancel current reception / reset uartState
000488 D???           00421         bra             processRxAsMIDI_resetUartState
                      00422 
                      00423         ;       midiRxMessage[uartState_currentRxIndex] = rxdata
00048A 500D           00424         movf    uartState_currentRxIndex, w, ACCESS
00048C C003 FFEB      00425         movff   rxByte, PLUSW_midiRxMessage
                      00426         ;       uartState_currentRxIndex++;
000490 2A0D           00427         incf    uartState_currentRxIndex, f, ACCESS
                      00428                 
                      00429         ;**** start procedure: check if message is complete ****
                      00430         ; for non-SYSEX messages: message reception is complete if uartState_currentRxIndex == midiRxMes
                            sage_length
000492 500D           00431         movf    uartState_currentRxIndex, w, ACCESS
000494 620E           00432         cpfseq  midiRxMessage_length, ACCESS
000496 D???           00433         bra             processRxAsMIDI_checkEOX
000498 D???           00434         bra             processRxAsMIDI_messageComplete
                      00435 
                      00436         ; for SYSEX messages: message reception is complete if rxByte == EOX
00049A                00437 processRxAsMIDI_checkEOX
00049A 0EF7           00438         movlw   EOX
00049C 6203           00439         cpfseq  rxByte, ACCESS
                      00440         ; message reception is not complete
00049E D???           00441         bra             processRxAsMIDI_RxHandlingDone  
                      00442 
                      00443         ;**** start procedure: midi message reception is complete ****
0004A0                00444 processRxAsMIDI_messageComplete 
                      00445         ; update midiRxMessage_length to reflect actual length of SYSEX message
0004A0 500D           00446         movf    uartState_currentRxIndex, w, ACCESS
0004A2 6E0E           00447         movwf   midiRxMessage_length, ACCESS
                      00448 
                      00449         ; reset uart state
0004A4 9010           00450         bcf             midiFlags, uartState_rxInProgress, ACCESS
                      00451         
                      00452         ; process received message
0004A6 EC?? F???      00453         call    midiMessageMapper
0004AA D???           00454         bra             processRxAsMIDI_RxHandlingDone
                      00455 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 84


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00456         ;**** start procedure: attempt to process non-STATUS byte as running STATUS ****
0004AC                00457 processRxAsMIDI_tryRunningStatus        
                      00458         ; continue if midiState_lastStatus != 0
                      00459         ; midiState_lastStatus is set every time supported STATUS byte is received
                      00460         ; midiState_lastStatus is cleared whenever unsupported STATUS byte is received
0004AC 520B           00461         movf    midiState_lastStatus, f, ACCESS
0004AE E0??           00462         bz              processRxAsMIDI_RxHandlingDone
                      00463 
                      00464         ;**** start procedure: is running STATUS, init uartState for reception ****
0004B0 8010           00465         bsf             midiFlags, uartState_rxInProgress, ACCESS
                      00466         ;       midiRxMessage.message[0] = midiState_lastStatus
0004B2 C00B F040      00467         movff   midiState_lastStatus, midiRxMessage
                      00468         ;       midiRxMessage_length = midiState_lastLength
0004B6 C00C F00E      00469         movff   midiState_lastLength, midiRxMessage_length
                      00470         ;       midiRxMessage.message[1] = rxByte
0004BA 0E01           00471         movlw   1
0004BC C003 FFEB      00472         movff   rxByte, PLUSW_midiRxMessage     
                      00473         ;       uartState_currentRxIndex = 2
0004C0 0E02           00474         movlw   2
0004C2 6E0D           00475         movwf   uartState_currentRxIndex, ACCESS
                      00476 
                      00477 
0004C4                00478 processRxAsMIDI_RxHandlingDone
                      00479 
                      00480         
0004C4                00481 processRxAsMIDI_checkRxFIFO
0004C4 BA9E           00482         btfsc   PIR1, RCIF, ACCESS
0004C6 EF?? F???      00483         goto    processRxAsMIDI_readFIFO
                      00484         
0004CA                00485 processRxAsMIDI_Exit
                      00486 
                      00487         ; undefine variables from pushed registers
                      00488         #undefine       rxByte
                      00489         #undefine       tmpValue
                      00490         #undefine       FSR_midiRxMessage
                      00491         #undefine       PLUSW_midiRxMessage
                      00492         ; pop working regs from software stack
                      00493         POP_R   FSR0H
0004CA CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00494         POP_R   FSR0L
0004CE CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00495         POP_R   r1
0004D2 CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      00496         POP_R   r0
0004D6 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00497                 
0004DA 0012           00498         return
                      00499 
                      00500 
                      00501 ;**********************************************************************
                      00502 ; Function: void midiMessageMapper(midiRxMessage)
                      00503 ;**********************************************************************
                      00504 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 85


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0004DC                00505 midiMessageMapper
                      00506         ; push working regs onto software stack
                      00507         PUSH_R  r0
0004DC C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00508         PUSH_R  r1
0004E0 C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00509         PUSH_R  r2
0004E4 C005 FFDD          M         movff   r2,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00510         PUSH_R  r3
0004E8 C006 FFDD          M         movff   r3,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00511         PUSH_R  FSR0L
0004EC CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00512         PUSH_R  FSR0H           
0004F0 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00513         ; define variables to pushed registers
                      00514         #define tmpValue                        r0
                      00515         #define statusByte                      r1
                      00516         #define noteNumberByte          r2
                      00517         #define programValue            noteNumberByte
                      00518         #define controllerNumber        noteNumberByte
                      00519         #define velocityByte            r3
                      00520         #define controllerValue         velocityByte
                      00521         #define FSR_midiRxMessage       FSR0
                      00522         #define PLUSW_midiRxMessage     PLUSW0
                      00523         
                      00524         ; do work
0004F4 EE00 F040      00525         lfsr    FSR_midiRxMessage, midiRxMessage
                      00526         
                      00527         ;       status = midiRxMessage[0] & 0xf0
0004F8 0E00           00528         movlw   0
0004FA 50EB           00529         movf    PLUSW_midiRxMessage, w, ACCESS
0004FC 0BF0           00530         andlw   0xf0
0004FE 6E04           00531         movwf   statusByte, ACCESS      
                      00532 
                      00533         ;       noteNumber = midiRxMessage[1]
000500 0E01           00534         movlw   1
000502 50EB           00535         movf    PLUSW_midiRxMessage, w, ACCESS
000504 6E05           00536         movwf   noteNumberByte, ACCESS  
                      00537 
                      00538         ;       velocity = midiRxMessage[2]
000506 0E02           00539         movlw   2
000508 50EB           00540         movf    PLUSW_midiRxMessage, w, ACCESS
00050A 6E06           00541         movwf   velocityByte, ACCESS    
                      00542 
                      00543         ;       if((status == NOTE_ON) && (velocity == 0))
                      00544         ;               status = NOTE_OFF;
00050C 0E90           00545         movlw   NOTE_ON
00050E 6204           00546         cpfseq  statusByte, ACCESS
000510 D???           00547         bra             midiMessageMapper_notNoteOnWithZeroVel
000512 5206           00548         movf    velocityByte, f, ACCESS
000514 E1??           00549         bnz             midiMessageMapper_notNoteOnWithZeroVel  
000516 0E80           00550         movlw   NOTE_OFF
000518 6E04           00551         movwf   statusByte, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 86


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

Warning[208]: Label truncated at 32 characters. (midiMessageMapper_notNoteOnWithZeroVel)
00051A                00552 midiMessageMapper_notNoteOnWithZeroVel
                      00553 
                      00554         ; case NOTE_ON
00051A 0E90           00555         movlw   NOTE_ON
00051C 6204           00556         cpfseq  statusByte, ACCESS
00051E D???           00557         bra             midiMessageMapper_notNoteOn
                      00558 
000520 5005           00559         movf    noteNumberByte, w, ACCESS
000522 EC?? F???      00560         call    activeNoteTableAdd
                      00561 
000526 D???           00562         bra             midiMessageMapper_exit
                      00563         ; break
000528                00564 midiMessageMapper_notNoteOn
                      00565         
                      00566         
                      00567         ; case NOTE_OFF
000528 0E80           00568         movlw   NOTE_OFF
00052A 6204           00569         cpfseq  statusByte, ACCESS
00052C D???           00570         bra             midiMessageMapper_notNoteOff
                      00571 
00052E 5005           00572         movf    noteNumberByte, w, ACCESS
000530 EC?? F???      00573         call    activeNoteTableRemove
                      00574 
000534 D???           00575         bra             midiMessageMapper_exit
                      00576         ; break
000536                00577 midiMessageMapper_notNoteOff
                      00578 
                      00579 
                      00580         ; case PITCH_WHEEL
000536 0EE0           00581         movlw   PITCH_WHEEL
000538 6204           00582         cpfseq  statusByte, ACCESS
00053A D???           00583         bra             midiMessageMapper_notPitchWheel
                      00584 
                      00585         ; if sustain is active then ignore pitch
00053C 0E01           00586         movlw   SUSTAIN
00053E 1820           00587         xorwf   modeLevel, w, ACCESS
000540 E0??           00588         bz              midiMessageMapper_notPitchWheel
                      00589         
                      00590         ; pitchWheel == pitch wheel value
000542 C041 F019      00591         movff   midiRxMessage + 1, pitchWheel + 0
                      00592         ; pitchWheel + 0 is only a 7-bit value
                      00593         ; so concatenate received pitch wheel MSB and LSB into contiguous 16-bit value
                      00594         ; roll least significant bit out of received pitch wheel high byte
000546 90D8           00595         bcf             STATUS, C, ACCESS
000548 3042           00596         rrcf    midiRxMessage + 2, w
                      00597         ; if rolled out bit was set then set bit 7 of pitchWheel + 0
00054A B0D8           00598         btfsc   STATUS, C, ACCESS
00054C 8E19           00599         bsf             pitchWheel + 0, 7, ACCESS
                      00600         ; write high byte into pitchWheel
00054E 6E1A           00601         movwf   pitchWheel + 1, ACCESS
000550 6A1B           00602         clrf    pitchWheel + 2, ACCESS
000552 6A1C           00603         clrf    pitchWheel + 3, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 87


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00604         ; value has been concatenated into contiguous 16-bit value
                      00605         
                      00606         ; calulate offset from 0x2000 (center)
000554 0E20           00607         movlw   0x20
000556 601A           00608         cpfslt  pitchWheel + 1, ACCESS
000558 D???           00609         bra             midiMessageMapper_pitchPos
                      00610 
                      00611         ; pitch wheel is negative
00055A 0E20           00612         movlw   0x20
00055C 5E1A           00613         subwf   pitchWheel + 1, f, ACCESS
00055E A0D8           00614         btfss   STATUS, C, ACCESS
000560 061B           00615         decf    pitchWheel + 2, f, ACCESS       
000562 A0D8           00616         btfss   STATUS, C, ACCESS
000564 061C           00617         decf    pitchWheel + 3, f, ACCESS       
000566 D???           00618         bra             midiMessageMapper_exit
                      00619 
000568                00620 midiMessageMapper_pitchPos
                      00621         ; pitch wheel is positive
000568 0E20           00622         movlw   0x20
00056A 5E1A           00623         subwf   pitchWheel + 1, f, ACCESS
00056C D???           00624         bra             midiMessageMapper_exit
                      00625 
00056E                00626 midiMessageMapper_notPitchWheel
                      00627 
                      00628 
                      00629         ; case CONTROL_CHANGE
00056E 0EB0           00630         movlw   CONTROL_CHANGE
000570 6204           00631         cpfseq  statusByte, ACCESS
000572 D???           00632         bra             midiMessageMapper_notControlChange
                      00633 
                      00634         ;       switch(midiRxPoppedMessage.message[1])  // controller #
                      00635         ;       {
                      00636         ;               case ALL_SOUND_OFF:
                      00637         ;               case RESET_ALL_CONTROLLERS:
                      00638         ;               case ALL_NOTES_OFF:
                      00639         ;                       for(=0; count<ACTIVE_NOTE_TABLE_SIZE; count++)
                      00640         ;                               activeNoteTable[count];
                      00641         ;                       initSoundGen();
                      00642         ;               break;
                      00643         ;       }
                      00644 
                      00645         ; **** check for Panic! condition ****
                      00646         ; noteNumber == midiRxMessage[1]
000574 5005           00647         movf    controllerNumber, w, ACCESS
000576 0A78           00648         xorlw   ALL_SOUND_OFF
000578 E0??           00649         bz              midiMessageMapper_doPanic
00057A 5005           00650         movf    controllerNumber, w, ACCESS
00057C 0A7B           00651         xorlw   ALL_NOTES_OFF
00057E E1??           00652         bnz             midiMessageMapper_notPanic
000580                00653 midiMessageMapper_doPanic
                      00654         ; passing 0xff to activeNoteTableRemove() will flush table
000580 0EFF           00655         movlw   0xff
000582 EC?? F???      00656         call    activeNoteTableRemove
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 88


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000586 D???           00657         bra             midiMessageMapper_exit
000588                00658 midiMessageMapper_notPanic
                      00659 
                      00660         ; **** check for controller reset ****
000588 5005           00661         movf    controllerNumber, w, ACCESS
00058A 0A79           00662         xorlw   RESET_ALL_CONTROLLERS
00058C E1??           00663         bnz             midiMessageMapper_notControllerReset
                      00664         ; easiest option is straight-up software reset, so do it!
00058E 00FF           00665         reset
Warning[208]: Label truncated at 32 characters. (midiMessageMapper_notControllerReset)
000590                00666 midiMessageMapper_notControllerReset
                      00667 
                      00668         ; **** check for Sustain ****
                      00669         ; noteNumber == midiRxMessage[1]
000590 5005           00670         movf    controllerNumber, w, ACCESS
000592 0A40           00671         xorlw   SUSTAIN_PEDAL
000594 E1??           00672         bnz             midiMessageMapper_notSustain
                      00673         ; sustain message: <63 means sustain off, >64 mean sustain on
                      00674         ; controllerValue == midiRxMessage[2]
000596 0E3F           00675         movlw   63
000598 6406           00676         cpfsgt  controllerValue, ACCESS
00059A D???           00677         bra             midiMessageMapper_sustainOff
                      00678         ; turn sustain on. Spec says >64 but I'm just doing >63
                      00679         ; set modeLevel to MONO and call userInterface_incMode()
00059C 0E00           00680         movlw   POLY
00059E 6E20           00681         movwf   modeLevel, ACCESS
0005A0 EC?? F???      00682         call    userInterface_incMode
0005A4 D???           00683         bra             midiMessageMapper_exit
0005A6                00684 midiMessageMapper_sustainOff
                      00685         ; turn sustain off
                      00686         ; set modeLevel to SUSTAIN and call userInterface_incMode()
0005A6 0E02           00687         movlw   MONO
0005A8 6E20           00688         movwf   modeLevel, ACCESS
0005AA EC?? F???      00689         call    userInterface_incMode
0005AE D???           00690         bra             midiMessageMapper_exit
0005B0                00691 midiMessageMapper_notSustain
                      00692         
                      00693         ; **** check for POLY MODE OFF ****
0005B0 5005           00694         movf    controllerNumber, w, ACCESS
0005B2 0A7E           00695         xorlw   POLY_MODE_OFF
0005B4 E1??           00696         bnz             midiMessageMapper_notPolyOff
0005B6 0E01           00697         movlw   SUSTAIN
0005B8 6E20           00698         movwf   modeLevel, ACCESS
0005BA EC?? F???      00699         call    userInterface_incMode
0005BE D???           00700         bra             midiMessageMapper_exit
0005C0                00701 midiMessageMapper_notPolyOff
                      00702         
                      00703         ; **** check for POLY MODE ON ****
0005C0 5005           00704         movf    controllerNumber, w, ACCESS
0005C2 0A7F           00705         xorlw   POLY_MODE_ON
0005C4 E1??           00706         bnz             midiMessageMapper_notPolyOn
0005C6 0E02           00707         movlw   MONO
0005C8 6E20           00708         movwf   modeLevel, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 89


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0005CA EC?? F???      00709         call    userInterface_incMode
0005CE D???           00710         bra             midiMessageMapper_exit
0005D0                00711 midiMessageMapper_notPolyOn
                      00712         
                      00713         
                      00714         ; **** check for Mod Wheel ****
                      00715         ; noteNumber == midiRxMessage[1]
0005D0 5005           00716         movf    controllerNumber, w, ACCESS
0005D2 0A01           00717         xorlw   MODULATION_WHEEL_MSB
0005D4 E1??           00718         bnz             midiMessageMapper_notMod
                      00719 
                      00720         ; if sustain is active then ignore modulation
0005D6 0E01           00721         movlw   SUSTAIN
0005D8 1820           00722         xorwf   modeLevel, w, ACCESS
0005DA E0??           00723         bz              midiMessageMapper_notMod
                      00724 
                      00725         ; save current modulation value
0005DC C006 F01D      00726         movff   controllerValue, modulation
                      00727         ; in Sample mode: mainline eeprom read call code uses modulation variable       
                      00728         ; in Sine/Square modes: always modify table base addresses in response to modulation
                      00729         ; init table addresses
                      00730 
0005E0 0E??           00731         movlw   low(sineTable)
0005E2 6E24           00732         movwf   sineTableBaseAddress + 0
0005E4 0E??           00733         movlw   high(sineTable)
0005E6 6E25           00734         movwf   sineTableBaseAddress + 1
0005E8 0E??           00735         movlw   upper(sineTable)
0005EA 6E26           00736         movwf   sineTableBaseAddress + 2
                      00737         
0005EC 0E??           00738         movlw   low(squareTable)
0005EE 6E27           00739         movwf   squareTableBaseAddress + 0
0005F0 0E??           00740         movlw   high(squareTable)
0005F2 6E28           00741         movwf   squareTableBaseAddress + 1
0005F4 0E??           00742         movlw   upper(squareTable)
0005F6 6E29           00743         movwf   squareTableBaseAddress + 2
                      00744         
                      00745         ; push sine backward into modulationBlendTable
0005F8 5006           00746         movf    controllerValue, w, ACCESS
0005FA 5E24           00747         subwf   sineTableBaseAddress + 0, f
0005FC A0D8           00748         btfss   STATUS, C, ACCESS
0005FE 0625           00749         decf    sineTableBaseAddress + 1, f
000600 A0D8           00750         btfss   STATUS, C, ACCESS
000602 0626           00751         decf    sineTableBaseAddress + 2, f
                      00752 
                      00753         ; push square forward into modulationBlendTable
000604 5006           00754         movf    controllerValue, w, ACCESS
000606 2627           00755         addwf   squareTableBaseAddress + 0, f
000608 B0D8           00756         btfsc   STATUS, C, ACCESS
00060A 2A28           00757         incf    squareTableBaseAddress + 1, f
00060C B0D8           00758         btfsc   STATUS, C, ACCESS
00060E 2A29           00759         incf    squareTableBaseAddress + 2, f
000610 D???           00760         bra             midiMessageMapper_exit  
000612                00761 midiMessageMapper_notMod
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 90


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00762         
                      00763         ; **** check for Attack ****
000612 5005           00764         movf    controllerNumber, w, ACCESS
000614 0A49           00765         xorlw   73
000616 E1??           00766         bnz             midiMessageMapper_notAttack
                      00767         ; load tmpValue with 64 for later inversion op
000618 0E40           00768         movlw   64
00061A 6E03           00769         movwf   tmpValue, ACCESS
                      00770         ; do (adsrAttackRate = (controllerValue+1)/2) to scale max range to 0 - 64
00061C 2806           00771         incf    controllerValue, w, ACCESS
00061E 90D8           00772         bcf             STATUS, C, ACCESS
000620 30E8           00773         rrcf    WREG, w, ACCESS
                      00774         ; do (64 - midiAttackTime) to invert value and make adsrAttackRate logically time-correlated
000622 5C03           00775         subwf   tmpValue, w, ACCESS
                      00776         ; save it
000624 6E37           00777         movwf   adsrAttackRate, ACCESS
000626                00778 midiMessageMapper_notAttack
                      00779 
                      00780         ; **** check for Release ****
000626 5005           00781         movf    controllerNumber, w, ACCESS
000628 0A48           00782         xorlw   72
00062A E1??           00783         bnz             midiMessageMapper_notRelease
                      00784         ; load tmpValue with 64 for later inversion op
00062C 0E40           00785         movlw   64
00062E 6E03           00786         movwf   tmpValue, ACCESS
                      00787         ; do (adsrReleaseRate = (controllerValue+1)/2) to scale max range to 0 - 64
000630 2806           00788         incf    controllerValue, w, ACCESS
000632 90D8           00789         bcf             STATUS, C, ACCESS
000634 30E8           00790         rrcf    WREG, w, ACCESS
                      00791         ; do (64 - midiRelease) to invert value and make adsrReleaseRate logically time-correlated
000636 5C03           00792         subwf   tmpValue, w, ACCESS
                      00793         ; save it
000638 6E38           00794         movwf   adsrReleaseRate, ACCESS
00063A                00795 midiMessageMapper_notRelease
                      00796 
                      00797 
                      00798 #IFDEF  MIDI_DEBUG_TRIGGER_ENABLED
                      00799 ; DEBUG - assign CC General Purpose 7 as variable dump trigger
                      00800         ; **** check for General Purpose Controller 7 (EDIROL Stop Key default function) ****
                      00801         movf    controllerNumber, w, ACCESS
                      00802         xorlw   MIDI_DEBUG_CC_NAME
                      00803         bnz             midiMessageMapper_notDebugTrigger
                      00804 ;       only call trigger on button down
                      00805         movlw   127
                      00806         cpfslt controllerValue, ACCESS
                      00807         call    midiDebugTriggerHandler
                      00808 midiMessageMapper_notDebugTrigger
                      00809 #ENDIF ; #IFDEF MIDI_DEBUG_TRIGGER_ENABLED
                      00810 
Warning[208]: Label truncated at 32 characters. (midiMessageMapper_notControlChange)
00063A                00811 midiMessageMapper_notControlChange
                      00812 
                      00813 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 91


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00814         ; case PROGRAM_CHANGE
00063A 0EC0           00815         movlw   PROGRAM_CHANGE
00063C 6204           00816         cpfseq  statusByte, ACCESS
00063E D???           00817         bra             midiMessageMapper_notPG
                      00818         
                      00819         ; Program Change increases will cycle waveform mode in the following direction SINE -> SQUARE ->
                             SAMPLE -> SINE
                      00820         ; Program Change decreases will cycle waveform mode in the following direction SINE -> SAMPLE ->
                             SQUARE -> SINE 
                      00821         
                      00822         ; if value is 0, 1 or 2 then hardset to Sine, Square or Sample
000640 5005           00823         movf    programValue, w, ACCESS
                      00824         ; do (2 - programValue)
000642 0802           00825         sublw   2
                      00826         ; if result is negative then do compare
000644 E3??           00827         bnc             midiMessageMapper_pgCompare
                      00828         ; otherwise result is positive so waveShape = programValue
000646 C005 F01E      00829         movff   programValue, waveShape
                      00830         ; waveShape is changing so set needDelgator flag
00064A 8418           00831         bsf             soundGenFlags, needRefresh, ACCESS
00064C D???           00832         bra             midiMessageMapper_pgDone        
                      00833 
00064E                00834 midiMessageMapper_pgCompare
                      00835         ; value > 2 so compare current program change value against previous
00064E 500F           00836         movf    midiLastProgramValue, w, ACCESS
000650 6405           00837         cpfsgt  programValue, ACCESS
                      00838         ; set decrement flag
000652 8218           00839         bsf             soundGenFlags, pgDec, ACCESS
                      00840         ; increment waveform
000654 EC?? F???      00841         call    userInterface_incWaveform
000658                00842 midiMessageMapper_pgDone
                      00843         ; save current as previous
000658 C005 F00F      00844         movff   programValue, midiLastProgramValue
00065C                00845 midiMessageMapper_notPG
                      00846 
                      00847         ; case SYSEX
00065C 0EF0           00848         movlw   SYSEX
00065E 6204           00849         cpfseq  statusByte, ACCESS
000660 D???           00850         bra             midiMessageMapper_notSysEx
                      00851         ; check for terminal ascii packet
                      00852         ; check Vendor ID
000662 0E01           00853         movlw 1
000664 50EB           00854         movf    PLUSW_midiRxMessage, w, ACCESS
000666 0A77           00855         xorlw VENDOR_ID
000668 E1??           00856         bnz             midiMessageMapper_notSysEx
                      00857         ; check Device ID
00066A 0E02           00858         movlw 2
00066C 50EB           00859         movf    PLUSW_midiRxMessage, w, ACCESS
00066E 0A1D           00860         xorlw DEVICE_ID
000670 E1??           00861         bnz             midiMessageMapper_notSysEx
                      00862         ; check Command
000672 0E03           00863         movlw 3
000674 50EB           00864         movf    PLUSW_midiRxMessage, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 92


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000676 0A1E           00865         xorlw TERMINAL_PACKET_COMMAND_VALUE
000678 E1??           00866         bnz             midiMessageMapper_notSysEx
                      00867         ; packet is terminal ascii so send to terminal
                      00868 #ifdef ENABLE_MIDI_TERMINAL
                      00869         call    midiTerminal_receive
                      00870 #endif
00067A                00871 midiMessageMapper_notSysEx
                      00872 
00067A                00873 midiMessageMapper_exit
                      00874         ; undefine variables from pushed registers
                      00875         #undefine       tmpValue
                      00876         #undefine       statusByte
                      00877         #undefine       noteNumberByte
                      00878         #undefine       velocityByte
                      00879         #undefine       FSR_midiRxMessage
                      00880         #undefine       PLUSW_midiRxMessage
                      00881         ; pop working regs from software stack
                      00882         POP_R   FSR0H   
00067A CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00883         POP_R   FSR0L
00067E CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00884         POP_R   r3
000682 CFDC F006          M         movff   softwareStackPointerPREINC, r3          ; ++softwareStackPointerINDF = regName
                      00885         POP_R   r2
000686 CFDC F005          M         movff   softwareStackPointerPREINC, r2          ; ++softwareStackPointerINDF = regName
                      00886         POP_R   r1
00068A CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      00887         POP_R   r0
00068E CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00888 
000692 0012           00889         return
                      00890         
                      00891         
                      00307         #include        "../source/eeprom.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      eeprom.asm                                        *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 93


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00020 
                      00021 ; Target EEPROM is On Semiconductor CAT25128 or compatible
                      00022 ; Functions perform no address boundry checking
                      00023 ; Functions do not poll EEPROM for Ready so period between EEPROM write requests must be >5mS per CAT251
                            28 datasheet
                      00024 
                      00025 ;**********************************************************************
                      00026 ; INCLUDES
                      00027 ;**********************************************************************
                      00028 
                      00029         #include "../header/eeprom.h"
                      00215 
                      00216 ;**********************************************************************
                      00217 ;                                                                     *
                      00218 ;    Project:       deMIDulator                                       *
                      00219 ;    Filename:      eeprom.h                                          *
                      00220 ;    Date:                                                            *
                      00221 ;    File Version:                                                    *
                      00222 ;                                                                     *
                      00223 ;    Author:        Derek Enos                                        *
                      00224 ;    Company:                                                         *
                      00225 ;                                                                     * 
                      00226 ;                                                                     *
                      00227 ;**********************************************************************
                      00228 ;                                                                     *
                      00229 ;    Files required:                                                  *
                      00230 ;                                                                     *
                      00231 ;                                                                     *
                      00232 ;                                                                     *
                      00233 ;**********************************************************************
                      00234 
                      00235 #ifndef _EEPROMH_
                      00236 #define _EEPROMH_
                      00237 
                      00238 ; ******************* FLAG VARIABLE DEFINITIONS ***********************
                      00239 
                      00240 ; eepromFlags
                      00241 #define sampleChunkReady        0
                      00242 #define samplesLoaded                   1
                      00243 #define intState                                        2
                      00244 #define ready                                           3
                      00245 
                      00246 ; CAT25128 Status reg flags
                      00247 #define NOT_RDY 0
                      00248 #define WEL                     1
                      00249 #define BP0                     2
                      00250 #define BP1                     3
                      00251 #define WPEN            7
                      00252 
                      00253 ; ******************* COMMAND DEFINES ***********************
                      00254 #define EE_WREN         B'00000110'     ; Enable Write Operations
                      00255 #define EE_WRDI         B'00000100'     ; Disable Write Operations
                      00256 #define EE_RDSR         B'00000101'     ; Read Status Register
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 94


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00257 #define EE_WRSR         B'00000001'     ; Write Status Register
                      00258 #define EE_READ         B'00000011'     ; Read Data from Memory
                      00259 #define EE_WRITE        B'00000010'     ; Write Data to Memory
                      00260 
                      00261 ; ******************* GENERAL DEFINES ***********************
                      00262 #define SAMPLE_DATA_BUFFER_SIZE 64
                      00263 #define EEPROM_SIZE_BITS 128000
                      00264 #define NEXT_SAMPLE_ADDRESSES_EL_SIZE   2
                      00265 
                      00266 ;**********************************************************************
                      00267 ; MACROS
                      00268 ;**********************************************************************
                      00269 
                      00270 
                      00271 ;**********************************************************************
                      00272 ASSERT_SS       MACRO
                      00273         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00274         ENDM
                      00275 
                      00276 ;**********************************************************************
                      00277 DEASSERT_SS     MACRO
                      00278         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00279         ENDM
                      00280 
                      00281 ;**********************************************************************
                      00282 EE_DISABLE_INTS MACRO
                      00283         bcf             eepromFlags, intState, ACCESS
                      00284         btfsc   INTCON, GIE, ACCESS
                      00285         bsf             eepromFlags, intState, ACCESS
                      00286         bcf             INTCON, GIE, ACCESS
                      00287         ENDM
                      00288 
                      00289 ;**********************************************************************
                      00290 EE_RESTORE_INTS MACRO
                      00291         btfsc   eepromFlags, intState, ACCESS
                      00292         bsf             INTCON, GIE, ACCESS
                      00293         ENDM
                      00294 
                      00295 ;**********************************************************************
                      00296 WRITE_INTERNAL_EEPROM   MACRO   literal_address, register_value
                      00297         local   writeIntEE_loop
                      00298         
                      00299         ; load address
                      00300         movlw   literal_address
                      00301         movwf   EEADR, ACCESS
                      00302         ; load value
                      00303         movff   register_value, EEDATA
                      00304         ; configure eeprom
                      00305         ; point to EEPROM DATA memory
                      00306         bcf             EECON1, EEPGD, ACCESS
                      00307         ; Access EEPROM/Program
                      00308         bcf             EECON1, CFGS, ACCESS    
                      00309         ; Enable writes
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 95


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00310         bsf             EECON1, WREN, ACCESS
                      00311 
                      00312         ; don't have to disable interrupts because I'm only calling this
                      00313         ; from within the high-priority ISR
                      00314 
                      00315         ; required write enable sequence
                      00316         movlw   0x55
                      00317         movwf   EECON2, ACCESS
                      00318         movlw   0xAA
                      00319         movwf   EECON2, ACCESS
                      00320 
                      00321         ; set WR bit to begin write
                      00322         bsf             EECON1, WR, ACCESS
                      00323 writeIntEE_loop
                      00324         ; wait for write to complete
                      00325         btfsc   EECON1, WR, ACCESS
                      00326         bra             writeIntEE_loop
                      00327         ; disable writes
                      00328         bcf             EECON1, WREN, ACCESS
                      00329 
                      00330         ; point to Program memory
                      00331         bsf             EECON1, EEPGD, ACCESS
                      00332 
                      00333         ENDM
                      00334 
                      00335 ;**********************************************************************
                      00336 WRITE_INTERNAL_EEPROM_FROM_REGS MACRO   address, data
                      00337         local   writeIntEE_loop
                      00338         
                      00339         ; load address
                      00340         movff   address, EEADR
                      00341         ; load value
                      00342         movff   data, EEDATA
                      00343         ; configure eeprom
                      00344         ; point to EEPROM DATA memory
                      00345         bcf             EECON1, EEPGD, ACCESS
                      00346         ; Access EEPROM/Program
                      00347         bcf             EECON1, CFGS, ACCESS    
                      00348         ; Enable writes
                      00349         bsf             EECON1, WREN, ACCESS
                      00350 
                      00351         ; don't have to disable interrupts because I'm only calling this
                      00352         ; from within the high-priority ISR
                      00353 
                      00354         ; required write enable sequence
                      00355         movlw   0x55
                      00356         movwf   EECON2, ACCESS
                      00357         movlw   0xAA
                      00358         movwf   EECON2, ACCESS
                      00359 
                      00360         ; set WR bit to begin write
                      00361         bsf             EECON1, WR, ACCESS
                      00362 writeIntEE_loop
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 96


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00363         ; wait for write to complete
                      00364         btfsc   EECON1, WR, ACCESS
                      00365         bra             writeIntEE_loop
                      00366         ; disable writes
                      00367         bcf             EECON1, WREN, ACCESS
                      00368 
                      00369         ; point to Program memory
                      00370         bsf             EECON1, EEPGD, ACCESS
                      00371 
                      00372         ENDM
                      00373 
                      00374 ;;**********************************************************************
                      00375 ;;SPI_TX_LITERAL_RX_IN_WREG     MACRO   value
                      00376 ;       local   waitLoop
                      00377 ;
                      00378 ;; routine as recommended in Microchip PIC18F2458/2553/4458/4553 errata
                      00379 ;
                      00380 ;       ; clear interrupt flag
                      00381 ;       bcf             PIR1, SSPIF, ACCESS
                      00382 ;
                      00383 ;       ; perform read, even if the data in SSPBUF is not important 
                      00384 ;       movf    SSPBUF, w, ACCESS
                      00385 ;
                      00386 ;       ; SSPBUF = value
                      00387 ;       movlw   value
                      00388 ;       movwf   SSPBUF, ACCESS
                      00389 ;
                      00390 ;       ; wait fro transfer to complete
                      00391 ;waitLoop
                      00392 ;       btfss   PIR1, SSPIF, ACCESS
                      00393 ;       bra             waitLoop
                      00394 ;
                      00395 ;       ; the data received should be valid
                      00396 ;       movf    SSPBUF, w, ACCESS
                      00397 ;
                      00398 ;       ENDM
                      00399                                                 
                      00400 ;;**********************************************************************
                      00401 ;SPI_TX_WREG_RX_IN_WREG MACRO
                      00402 ;       local   waitLoop
                      00403 ;
                      00404 ;       ; save WREG to software stack
                      00405 ;       PUSH_R  WREG
                      00406 ;       
                      00407 ;; routine as recommended in Microchip PIC18F2458/2553/4458/4553 errata
                      00408 ;       ; clear interrupt flag
                      00409 ;       bcf             PIR1, SSPIF, ACCESS
                      00410 ;
                      00411 ;       ; perform read, even if the data in SSPBUF is not important 
                      00412 ;       movf    SSPBUF, w, ACCESS
                      00413 ;
                      00414 ;       ; SSPBUF = restored WREG from software stack
                      00415 ;       POP_R   WREG
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 97


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00416 ;       movwf   SSPBUF, ACCESS
                      00417 ;
                      00418 ;       ; wait for transfer to complete
                      00419 ;waitLoop
                      00420 ;       btfss   PIR1, SSPIF, ACCESS
                      00421 ;       bra             waitLoop
                      00422 ;
                      00423 ;       ; the data received should be valid
                      00424 ;       movf    SSPBUF, w, ACCESS
                      00425 ;
                      00426 ;       ENDM
                      00427 
                      00428 #endif
                      00030         #include "../header/softwareStack.h"
                      00042 
                      00043 ;**********************************************************************
                      00044 ;                                                                     *
                      00045 ;    Project:       deMIDulator                                       *
                      00046 ;    Filename:      softwareStack.h                                   *
                      00047 ;    Date:                                                            *
                      00048 ;    File Version:                                                    *
                      00049 ;                                                                     *
                      00050 ;    Author:        Derek Enos                                        *
                      00051 ;    Company:                                                         *
                      00052 ;                                                                     * 
                      00053 ;                                                                     *
                      00054 ;**********************************************************************
                      00055 ;                                                                     *
                      00056 ;    Files required:                                                  *
                      00057 ;                                                                     *
                      00058 ;                                                                     *
                      00059 ;                                                                     *
                      00060 ;**********************************************************************
                      00061 
                      00062 #ifndef SOFTWARESTACK_H
                      00063 #define SOFTWARESTACK_H
                      00064 
                      00065         #define softwareStackPointerFSR         FSR2
                      00066         #define softwareStackPointerINDF        INDF2
                      00067         #define softwareStackPointerPOSTINC     POSTINC2
                      00068         #define softwareStackPointerPOSTDEC     POSTDEC2
                      00069         #define softwareStackPointerPREINC      PREINC2 
                      00070         #define softwareStackPointerPLUSW       PLUSW2  
                      00071 
                      00072 ; **** MACRO: PUSH_R    regName
                      00073 PUSH_R  MACRO   regName
                      00074         movff   regName, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00075                 ENDM
                      00076                 
                      00077 ; **** MACRO: POP_R     regName
                      00078 POP_R   MACRO   regName
                      00079         movff   softwareStackPointerPREINC, regName     ; ++softwareStackPointerINDF = regName
                      00080                 ENDM
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 98


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00081 
                      00082 #endif
                      00031         
                      00032 
                      00033 ;**********************************************************************
                      00034 ; LOCAL VARIABLES
                      00035 ;**********************************************************************
                      00036 
                      00037         CBLOCK
  00000011            00038                 sampleDataBufferIndex:1
  00000012            00039                 sampleChunkCount:1
  00000013            00040                 sampleEndAddress:2
  00000015            00041                 nextSampleAddress:2
                      00042                 
  00000017            00043                 eepromFlags:1
                      00044                 ; bits defined in eeprom.h
                      00045                 ; #define sampleChunkReady      0
                      00046                 ; #define samplesLoaded                 1
                      00047                 ; #define intState                                      2
                      00048                 ; #define       ready                                           3
                      00049 
                      00050                 ; Declared at end of main.asm to ensure that arrays are pushed to end of memory...
                      00051                 ; with smaller variables in ACCESS memory
                      00052                 ; ---------------------------------------
                      00053                 ; sampleDataBuffer:SAMPLE_DATA_BUFFER_SIZE
                      00054                 ; nextSampleAddresses:MAX_POLY_DEPTH * NEXT_SAMPLE_ADDRESSES_EL_SIZE
                      00055 
                      00056         ENDC
                      00057                         
                      00058 
                      00059 ;**********************************************************************
                      00060 ; LOCAL FUNCTIONS
                      00061 ;**********************************************************************
                      00062 
                      00063 ;**********************************************************************
                      00064 ; Function: wreg eepromXferSingleByte(byte wreg)
                      00065 ;**********************************************************************
                      00066         ; !! Function does not assert Slave Select signal and so should not be called directly
                      00067         ; !! Function is called by other EEPROM functions
000694                00068 eepromXferSingleByte
                      00069 
                      00070         ; save current global interrupt enable state, disable global interrupts
                      00071         EE_DISABLE_INTS
000694 9417               M         bcf             eepromFlags, intState, ACCESS
000696 BEF2               M         btfsc   INTCON, GIE, ACCESS
000698 8417               M         bsf             eepromFlags, intState, ACCESS
00069A 9EF2               M         bcf             INTCON, GIE, ACCESS
                      00072 
                      00073         ;**** start procedure: SPI transfer. TX value = WREG, WREG = RX value ****
                      00074         ; push WREG to software stack
                      00075         PUSH_R  WREG
00069C CFE8 FFDD          M         movff   WREG,    softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00076 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 99


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00077         ; perform read, even if the data in SSPBUF is not important 
0006A0 50C9           00078         movf    SSPBUF, w, ACCESS
                      00079 
                      00080         ; clear Write Collision flag
0006A2 9EC6           00081         bcf             SSPCON1, WCOL, ACCESS
                      00082 
                      00083         ; SSPBUF = restored WREG from software stack
                      00084         POP_R   WREG
0006A4 CFDC FFE8          M         movff   softwareStackPointerPREINC, WREG        ; ++softwareStackPointerINDF = regName
0006A8 6EC9           00085         movwf   SSPBUF, ACCESS
                      00086 
                      00087         ; skip if no Write Collision occurred 
0006AA BEC6           00088         btfsc   SSPCON1, WCOL, ACCESS
                      00089         ; collision occured, return WREG
0006AC D???           00090         bra             eepromXferSingleByte_exit
                      00091 
                      00092         ; clear interrupt flag
0006AE 969E           00093         bcf             PIR1, SSPIF, ACCESS
                      00094 
0006B0                00095 eepromXferSingleByte_lp
                      00096         ; wait for transfer to complete
                      00097 #ifndef __DEBUG
0006B0 A69E           00098         btfss   PIR1, SSPIF, ACCESS
0006B2 D???           00099         bra             eepromXferSingleByte_lp 
                      00100 #else
                      00101         ; if DEBUG then simulate worst case transaction time
                      00102         ; SPI Clock = 4MHz = Instruction Clock so it should take 8 instruction cycles per byte transfer
                      00103         ; 3 cycles elapsed since SSPBUF load so make up the 5 cycle balance + loop error of ~5 cycles
                      00104         ; balance
                      00105         nop
                      00106         nop
                      00107         nop
                      00108         nop
                      00109         nop
                      00110         ; potential error
                      00111         nop
                      00112         nop
                      00113         nop
                      00114         nop
                      00115         nop
                      00116 #endif
                      00117 
                      00118         ; the data received should be valid
0006B4 50C9           00119         movf    SSPBUF, w, ACCESS
                      00120         
0006B6                00121 eepromXferSingleByte_exit
                      00122 
                      00123         ; restore global interrupt enable state
                      00124         EE_RESTORE_INTS
0006B6 B417               M         btfsc   eepromFlags, intState, ACCESS
0006B8 8EF2               M         bsf             INTCON, GIE, ACCESS
                      00125 
0006BA 0012           00126         return
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 100


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00127 
                      00128 
                      00129 ;**********************************************************************
                      00130 ; Function: void initExternalEEPROM(void)
                      00131 ;**********************************************************************
                      00132 
0006BC                00133 initExternalEEPROM
                      00134         ; enable EEPROM writes
0006BC EC?? F???      00135         call    eepromWriteEnable
                      00136 
                      00137         ; init Status register
                      00138         ; Bank Protect bits, BP1:0, = 0
                      00139         ; Write Protect Enable bit, WPEN, = 0
                      00140         ; !WP pin on IC is pulled HIGH so WPEN would have no effect either way 
0006C0 0E00           00141         movlw   0
0006C2 EC?? F???      00142         call    eepromWriteStatusReg
                      00143 
                      00144         ; init EEPROM variables 
0006C6 6A11           00145         clrf    sampleDataBufferIndex, ACCESS
0006C8 6A12           00146         clrf    sampleChunkCount, ACCESS
0006CA 6A15           00147         clrf    nextSampleAddress, ACCESS
0006CC 6A16           00148         clrf    nextSampleAddress + 1, ACCESS
0006CE 9017           00149         bcf             eepromFlags, sampleChunkReady, ACCESS
0006D0 9217           00150         bcf             eepromFlags, samplesLoaded, ACCESS
                      00151 
                      00152         ; recall saved sampleEndAddress from uC's internal EEPROM in little endian format
0006D2 0E00           00153         movlw   0
0006D4 EC?? F???      00154         call    eepromInternalRead
0006D8 6E13           00155         movwf   sampleEndAddress, ACCESS
0006DA 0E01           00156         movlw   1
0006DC EC?? F???      00157         call    eepromInternalRead
0006E0 6E14           00158         movwf   sampleEndAddress + 1, ACCESS
                      00159         
0006E2 0012           00160         return
                      00161 
                      00162 
                      00163 ;**********************************************************************
                      00164 ; Function: void eepromWriteEnable(void)
                      00165 ;**********************************************************************
                      00166 
0006E4                00167 eepromWriteEnable
                      00168 
                      00169         ; assert SLave Select signal
                      00170         ASSERT_SS
0006E4 9C8B               M         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00171 
                      00172         ; first write to SSPBUF in routine so we need to check for collision
                      00173         ; if collision then continue to attempt write
0006E6                00174 eepromWriteEnable_lp
0006E6 0E06           00175         movlw   EE_WREN
0006E8 EC?? F???      00176         call    eepromXferSingleByte
0006EC BEC6           00177         btfsc   SSPCON1, WCOL, ACCESS
0006EE D???           00178         bra             eepromWriteEnable_lp
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 101


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00179 
                      00180         ; deassert Slave Select signal
                      00181         DEASSERT_SS
0006F0 8C8B               M         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00182         
0006F2 0012           00183         return
                      00184 
                      00185 
                      00186 ;**********************************************************************
                      00187 ; Function: void eepromReadStatusReg(byte wreg)
                      00188 ;**********************************************************************
                      00189 
0006F4                00190 eepromReadStatusReg
                      00191         
                      00192         ; assert Slave Select signal
                      00193         ASSERT_SS
0006F4 9C8B               M         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00194 
                      00195         ; first write to SSPBUF in routine so we need to check for collision
                      00196         ; if collision then continue to attempt write
0006F6                00197 eepromReadStatusReg_doLp1
0006F6 0E05           00198         movlw   EE_RDSR
0006F8 EC?? F???      00199         call    eepromXferSingleByte
0006FC BEC6           00200         btfsc   SSPCON1, WCOL, ACCESS
0006FE D???           00201         bra             eepromReadStatusReg_doLp1
                      00202         
                      00203         ; routine is now synchronized with SSP operation so no need to check WCOl
                      00204 
                      00205         ; send dummy value while receiving Status register
000700 0E00           00206         movlw   0
000702 EC?? F???      00207         call    eepromXferSingleByte
                      00208 
                      00209         ; read Status Reg complete
                      00210         ; WREG = EEPROM Status
                      00211 
                      00212         ; deassert Slave Select signal
                      00213         DEASSERT_SS
000706 8C8B               M         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00214 
000708 0012           00215         return
                      00216 
                      00217 
                      00218 ;**********************************************************************
                      00219 ; Function: void eepromWriteStatusReg(byte wreg)
                      00220 ;**********************************************************************
                      00221 
00070A                00222 eepromWriteStatusReg
                      00223 
                      00224         ; push working regs onto software stack
                      00225         PUSH_R  r0
00070A C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00226         ; define variables to pushed registers
                      00227         #define statusRegValue  r0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 102


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00228 
                      00229         ; save argument passed in WREG
00070E 6E03           00230         movwf   statusRegValue, ACCESS
                      00231         
                      00232         ; assert Slave Select signal
                      00233         ASSERT_SS
000710 9C8B               M         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00234 
                      00235         ; first write to SSPBUF in routine so we need to check for collision
                      00236         ; if collision then continue to attempt write
000712                00237 eepromWriteStatusReg_doLp1
000712 0E01           00238         movlw   EE_WRSR
000714 EC?? F???      00239         call    eepromXferSingleByte
000718 BEC6           00240         btfsc   SSPCON1, WCOL, ACCESS
00071A D???           00241         bra             eepromWriteStatusReg_doLp1
                      00242         
                      00243         ; routine is now synchronized with SSP operation so no need to check WCOl
                      00244 
                      00245         ; send Status register value to write
00071C 5003           00246         movf    statusRegValue, w, ACCESS
00071E EC?? F???      00247         call    eepromXferSingleByte
                      00248 
                      00249         ; write Status Reg complete
                      00250 
                      00251         ; deassert Slave Select signal
                      00252         DEASSERT_SS
000722 8C8B               M         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00253 
                      00254         ; pop working regs onto software stack
                      00255         POP_R   r0
000724 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00256         ; undefine variables from popped registers
                      00257         #undefine       statusRegValue
                      00258 
000728 0012           00259         return
                      00260 
                      00261 
                      00262 ;**********************************************************************
                      00263 ; Function: sampleDataBuffer[0] = eepromReadSingleByte(nextSampleAddress)
                      00264 ;**********************************************************************
                      00265 
00072A                00266 eepromReadSingleByte
                      00267 
                      00268         ; push working regs onto software stack
                      00269         PUSH_R  r0
00072A C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00270         PUSH_R  FSR0L
00072E CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00271         PUSH_R  FSR0H
000732 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00272         ; define variables to pushed registers
                      00273         #define tmpValue                                r0
                      00274         #define FSR_sampleDataBuffer    FSR0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 103


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00275         #define PLUSW_sampleDataBuffer  PLUSW0  
                      00276                 
                      00277         ; load pointer
000736 EE00 F071      00278         lfsr    FSR_sampleDataBuffer, sampleDataBuffer
                      00279 
                      00280         ; assert Slave Select signal
                      00281         ASSERT_SS
00073A 9C8B               M         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00282         
                      00283         ; first write to SSPBUF in routine so we need to check for collision
                      00284         ; if collision then continue to attempt write
00073C                00285 eepromReadSingleByte_lp1
00073C 0E03           00286         movlw   EE_READ
00073E EC?? F???      00287         call    eepromXferSingleByte
000742 BEC6           00288         btfsc   SSPCON1, WCOL, ACCESS
000744 D???           00289         bra             eepromReadSingleByte_lp1
                      00290         
                      00291         ; send address HIGH byte
000746 5016           00292         movf    nextSampleAddress + 1, w, ACCESS
000748 EC?? F???      00293         call    eepromXferSingleByte
                      00294 
                      00295         ; send address LOW byte
00074C 5015           00296         movf    nextSampleAddress, w, ACCESS
00074E EC?? F???      00297         call    eepromXferSingleByte
                      00298 
                      00299         ; send dummy 0x00 value, get byte from EEPROM
000752 0E00           00300         movlw   0
000754 EC?? F???      00301         call    eepromXferSingleByte
                      00302         
                      00303         ; deassert Slave Select signal
                      00304         DEASSERT_SS
000758 8C8B               M         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00305 
                      00306         ; pop working regs from software stack
                      00307         POP_R   FSR0H
00075A CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00308         POP_R   FSR0L
00075E CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00309         POP_R   r0
000762 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00310         ; undefine variables from popped registers
                      00311         #undefine       tmpValue
                      00312         #undefine       FSR_sampleDataBuffer
                      00313         #undefine       PLUSW_sampleDataBuffer
                      00314 
000766 0012           00315         return
                      00316 
                      00317 
                      00318 ;**********************************************************************
                      00319 ; Function: void eepromWrite64(void)
                      00320 ;**********************************************************************
                      00321 
000768                00322 eepromWrite64
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 104


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00323         ; push working regs onto software stack
                      00324         PUSH_R  r0
000768 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00325         PUSH_R  FSR0L
00076C CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00326         PUSH_R  FSR0H
000770 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00327         PUSH_R  PRODL   
000774 CFF3 FFDD          M         movff   PRODL,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00328         PUSH_R  PRODH
000778 CFF4 FFDD          M         movff   PRODH,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00329         ; define variables to pushed registers
                      00330         #define index                                           r0
                      00331         #define FSR_sampleDataBuffer            FSR0
                      00332         #define PLUSW_sampleDataBuffer          PLUSW0  
                      00333 
                      00334         ; load fsr
00077C EE00 F071      00335         lfsr    FSR_sampleDataBuffer, sampleDataBuffer  
                      00336         
                      00337         ;**** start procedure: send 'WRITE ENABLE' command to EEPROM ****
                      00338         ; eepromWriteEnable function takes care of waiting for collision-free write
000780 EC?? F???      00339         call    eepromWriteEnable
                      00340 
                      00341         ; routine is now synchronized with SSP operation so no need to check WCOl
                      00342         
                      00343         ;**** start procedure: send 'WRITE' command to EEPROM ****
                      00344         ; assert Slave Select signal
                      00345         ASSERT_SS
000784 9C8B               M         bcf             LATC, RC6, ACCESS       ; Chip select is active
                      00346 
                      00347         ; load EEPROM WRITE command value into WREG
000786 0E02           00348         movlw   EE_WRITE
                      00349         ; write command value into SSPBUF
000788 EC?? F???      00350         call    eepromXferSingleByte
                      00351 
                      00352         ; load EEPROM WRITE ADDRESS into SSPBUF
                      00353         ; calculate EEPROM write address for current sample data chunk
                      00354         ; address = ((sampleChunkCount - 1) * SAMPLE_DATA_BUFFER_SIZE);
                      00355         ; after multiply, registers PRODH:L = address
00078C 0412           00356         decf    sampleChunkCount, w, ACCESS
00078E 0D40           00357         mullw   SAMPLE_DATA_BUFFER_SIZE
                      00358 
                      00359         ; load EEPROM WRITE ADDRESS HIGH BYTE into SSPBUF
                      00360 
                      00361 ; [Problem Code Begin]
                      00362 ; this code breaks EEPROM write
                      00363 ;       movff   PRODH, SSPBUF
                      00364 ; DEBUG
                      00365 ; but this code works
000790 50F4           00366         movf    PRODH, w, ACCESS
                      00367         ; write command value into SSPBUF
000792 EC?? F???      00368         call    eepromXferSingleByte
                      00369 ; [Problem Code End]
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 105


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00370 
                      00371         ; load EEPROM WRITE ADDRESS LOW BYTE into SSPBUF
                      00372 
                      00373 ; [Problem Code Begin]
                      00374 ; this code breaks EEPROM write
                      00375 ;       movff   PRODL, SSPBUF
                      00376 ; DEBUG
                      00377 ; but this code works
000796 50F3           00378         movf    PRODL, w, ACCESS
                      00379         ; write command value into SSPBUF
000798 EC?? F???      00380         call    eepromXferSingleByte
                      00381 ; [Problem Code End]
                      00382         
                      00383         ; write 64-byte sampleDataBuffer to EEPROM
                      00384         ; init index to point at first element in buffer
00079C 6A03           00385         clrf    index, ACCESS
00079E                00386 eepromWrite64_sendBuffer
                      00387         ; SSPBUF = sampleDataBuffer(index)
                      00388 
                      00389 ; [Problem Code Begin]
                      00390 ; this code breaks EEPROM writing
                      00391 ;       movf    index, w, ACCESS
                      00392 ;       movff   PLUSW_sampleDataBuffer, SSPBUF
                      00393 ; DEBUG
                      00394 ; but this code works
00079E 5003           00395         movf    index, w, ACCESS
0007A0 50EB           00396         movf    PLUSW_sampleDataBuffer, w, ACCESS
                      00397         ; write data into SSPBUF
0007A2 EC?? F???      00398         call    eepromXferSingleByte
                      00399 ; [Problem Code End]
                      00400 
                      00401         ; increment index
0007A6 2A03           00402         incf    index, f, ACCESS
                      00403         ; if index is == SAMPLE_DATA_BUFFER_SIZE then entire buffer has been sent
0007A8 0E40           00404         movlw   SAMPLE_DATA_BUFFER_SIZE
0007AA 6203           00405         cpfseq  index, ACCESS
                      00406         ; not done so continue
0007AC D???           00407         bra             eepromWrite64_sendBuffer
                      00408         
                      00409         ; entire buffer has been sent
                      00410         ; buffer write request complete
                      00411 
                      00412         ; clear eeprom ready flag to signal that eeprom will be unavailable for a bit while the write co
                            mpletes
0007AE 9617           00413         bcf             eepromFlags, ready, ACCESS
                      00414 
                      00415         ; deassert Slave Select signal
                      00416         DEASSERT_SS                                                     
0007B0 8C8B               M         bsf             LATC, RC6, ACCESS       ; Chip select is idle
                      00417 
                      00418         ; undefine variables from pushed registers
                      00419         #undefine       index
                      00420         #undefine       FSR_sampleDataBuffer
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 106


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00421         #undefine       PLUSW_sampleDataBuffer
                      00422         ; pop working regs from software stack
                      00423         POP_R   PRODH   
0007B2 CFDC FFF4          M         movff   softwareStackPointerPREINC, PRODH       ; ++softwareStackPointerINDF = regName
                      00424         POP_R   PRODL
0007B6 CFDC FFF3          M         movff   softwareStackPointerPREINC, PRODL       ; ++softwareStackPointerINDF = regName
                      00425         POP_R   FSR0H   
0007BA CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00426         POP_R   FSR0L
0007BE CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00427         POP_R   r0
0007C2 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00428 
0007C6 0012           00429         return
                      00430         
                      00431         
                      00432 ;**********************************************************************
                      00433 ; Function: void initInternalEEPROM(void)
                      00434 ;**********************************************************************
                      00435 
0007C8                00436 initInternalEEPROM
                      00437         ; ensure that access is always to Program Memory aside from inside EEPROM functions
                      00438         ; EEPGD (1 = Access Program Memory, 0 = Access EEPROM)
0007C8 8EA6           00439         bsf             EECON1, EEPGD, ACCESS
                      00440         ; CFGS (1 = Access Configuration Registers, 0 = Access Program Memory or EEPROM)
0007CA 9CA6           00441         bcf             EECON1, CFGS, ACCESS
                      00442 
0007CC 0012           00443         return
                      00444         
                      00445 
                      00446 ;**********************************************************************
                      00447 ; Function: wreg eepromInternalRead(wreg address)
                      00448 ;**********************************************************************
                      00449 
0007CE                00450 eepromInternalRead
                      00451         ; load address
0007CE 6EA9           00452         movwf   EEADR, ACCESS
                      00453         ; EEPGD (1 = Access Program Memory, 0 = Access EEPROM)
0007D0 9EA6           00454         bcf             EECON1, EEPGD, ACCESS
                      00455         ; start read
0007D2 80A6           00456         bsf             EECON1, RD, ACCESS
                      00457         ; save read value to wreg
0007D4 50A8           00458         movf    EEDATA, w, ACCESS
                      00459         ; ensure that access is always to Program Memory aside from inside EEPROM functions
                      00460         ; EEPGD (1 = Access Program Memory, 0 = Access EEPROM)
0007D6 8EA6           00461         bsf             EECON1, EEPGD, ACCESS
                      00462 
0007D8 0012           00463         return
                      00464 
                      00465 
                      00466 
                      00467 
                      00308         #include        "../source/soundGen.asm"
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 107


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001         
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      soundGen.asm                                      *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 ;**********************************************************************
                      00022 ; INCLUDE FILES
                      00023 ;**********************************************************************
                      00024 
                      00025         #include        "../header/soundGen.h"
                      01055 
                      01056 ;**********************************************************************
                      01057 ;                                                                     *
                      01058 ;    Project:       deMIDulator                                       *
                      01059 ;    Filename:      soundGen.h                                        *
                      01060 ;    Date:                                                            *
                      01061 ;    File Version:                                                    *
                      01062 ;                                                                     *
                      01063 ;    Author:        Derek Enos                                        *
                      01064 ;    Company:                                                         *
                      01065 ;                                                                     * 
                      01066 ;                                                                     *
                      01067 ;**********************************************************************
                      01068 ;                                                                     *
                      01069 ;    Files required:                                                  *
                      01070 ;                                                                     *
                      01071 ;                                                                     *
                      01072 ;                                                                     *
                      01073 ;**********************************************************************
                      01074 
                      01075 #ifndef _SOUNDGENH_
                      01076 #define _SOUNDGENH_
                      01077 
                      01078 ;**********************************************************************
                      01079 ; GENERAL
                      01080 ;**********************************************************************
                      01081 
                      01082 ; Current code structure requires that MAX_POLY_DEPTH be set to 4!
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 108


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01083 #define MAX_POLY_DEPTH                                  4       
                      01084 
                      01085 #define ACTIVE_NOTE_DELTAS_ELEMENT_SIZE 2
                      01086 #define ACTIVE_NOTE_DELTAS_SIZE                 MAX_POLY_DEPTH * ACTIVE_NOTE_DELTAS_ELEMENT_SIZE
                      01087 
                      01088 #define DELEGATED_DELTAS_ELEMENT_SIZE   2
                      01089 #define DELEGATED_DELTAS_SIZE                   MAX_POLY_DEPTH * DELEGATED_DELTAS_ELEMENT_SIZE
                      01090 
                      01091 #define OSC_DELTAS_ELEMENT_SIZE                 2
                      01092 #define OSC_DELTAS_SIZE                                 MAX_POLY_DEPTH * OSC_DELTAS_ELEMENT_SIZE
                      01093 
                      01094 #define ACCUMULATORS_ELEMENT_SIZE               4
                      01095 #define ACCUMULATORS_SIZE                               MAX_POLY_DEPTH * ACCUMULATORS_ELEMENT_SIZE
                      01096 
                      01097 #define ACTIVE_OUTPUT_VALUES_EL_SIZE    1
                      01098 #define ACTIVE_OUTPUT_VALUES_SIZE               MAX_POLY_DEPTH * ACTIVE_OUTPUT_VALUES_EL_SIZE
                      01099 
                      01100 #define LED_BLINK_RATE_VOICE_THROUGH    20
                      01101 #define LED_BLINK_RATE_VOICE_RECORD             6
                      01102 
                      01103 ; set soundGen timebase prescales for wave and sample modes
                      01104 ; Timer2 interrupt period is currently 32uS
                      01105 ; set sample timebase period to 192uS (5208 Hz)
                      01106 #define SAMPLE_PRESCALE 6
                      01107 ; wave sine/square timebase period to 64uS (15.625 kHz)
                      01108 #define WAVE_PRESCALE   2
                      01109 
                      01110 #define MAX_MODE_LEVEL  MONO
                      01111 
                      01112 ; set power-up Attack and Release parameters
                      01113 ; adsrAttackRate and adsrReleaseRate variables have a range of 0 - 64
                      01114 ; rate of 0 == MIDI Attack/Release Time of 127
                      01115 ; rate of 64 == MIDI Attack/Release Time of 0
                      01116 #define ADSR_ATTACK_RATE        63
                      01117 #define ADSR_RELEASE_RATE       16
                      01118 
                      01119 ; set adsr prescale target to increment adsrLimiterRegs value every 19.52mS
                      01120 ; 19.52mS gives a max individual attack/release time of 4.99712 Seconds
                      01121 ; the "increment" value is set by adsrAttackRate and adsrReleaseRate
                      01122 #define ADSR_PRESCALE 610
                      01123 
                      01124 ; changing from 0x00 reference to 0x80 to improve Attack/Release waveform quality
                      01125 #define PWM_IDLE_OUTPUT_VALUE 0x80
                      01126 
                      01127 ; In SINE mode, this values sets the range (+/- PWM_IDLE_OUTPUT_VALUE) of activeOutputValue within which
                             an oscillator will be
                      01128 ; ungated for changes to its delegatedDelta value.  Only allowing changes when activeOutputValue is appr
                            oximately == PWM_IDLE_OUTPUT_VALUE
                      01129 ; greatly reduces popping caused by Sine wave cycle clipping
                      01130 #define OSC_TRANSITION_OUTPUT_THRESHOLD 0x04
                      01131 
                      01132 ; Audio input DC Bias measurement, 253 ADC sample average:
                      01133 ;   (VDD == 3.2V / 256 = 0.0125V per ADC increment)
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 109


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01134 ;   on-board mic selected, MIC connceted      = 0x47 (@ VDD = 3.2V, 0x47 correlates to 0.8875V)
                      01135 ;   external mic selected, input floating     = 0x38 (@ VDD = 3.2V, 0x38 correlates to 0.7000V)
                      01136 ;   line-in selected, input floating          = 0x53 (@ VDD = 3.2V, 0x53 correlates to 1.0375V)
                      01137 ; Should have balanced these offsets in the hardware. oh well.
                      01138 ; Sine and Square outputs idle at 0x80, so compensate for difference in Sample bias to mitigate popping
                      01139 ; average of above measurement is 0x46, 0x80 - 0x46 = 0x3A
                      01140 ;#define SAMPLE_DC_OFFSET (PWM_IDLE_OUTPUT_VALUE - 0x46)
                      01141 ; DEBUG - sample dc offset will change with component tolerances.  need to set manually for each PCB
                      01142 ; measured 0.930V RMS, 0.930 / 0.0125 = 74.4
                      01143 #define SAMPLE_DC_OFFSET (PWM_IDLE_OUTPUT_VALUE - 74)
                      01144 
                      01145 ; define the time to wait from record button release to start of sample recording
                      01146 ; this is an attempt to eliminate the record button's physical noise from the sample
                      01147 ;   Calculation Method:
                      01148 ;     timer2 int period == 32uS
                      01149 ;     samplePrescaleCounter == 6
                      01150 ;     32uS * 6 = 192uS
                      01151 ;     RECORD_BUTTON_RELEASE_WAIT_TIME = waitTimeInMs / 0.192
                      01152 ;                 maxTime = 192uS * 256 = 49.152mS
                      01153 ;
                      01154 ; load for delay of 5mS. (5 / 0.192 = 26.0417)
                      01155 #define RECORD_BUTTON_RELEASE_WAIT_TIME 26
                      01156 
                      01157 ;**********************************************************************
                      01158 ; ENUM TYPE DEFINITIONS
                      01159 ;**********************************************************************
                      01160 
                      01161 ; waveShape
                      01162 #define SINE 0
                      01163 #define SQUARE 1
                      01164 #define SAMPLE 2
                      01165 
                      01166 ; recordOrPlayback
                      01167 #define VOICE_THROUGH 0
                      01168 #define RECORD 1
                      01169 #define PLAYBACK 2
                      01170 
                      01171 ; modeLevels
                      01172 #define POLY 0
                      01173 #define SUSTAIN 1
                      01174 #define MONO 2
                      01175 
                      01176 
                      01177 ;**********************************************************************
                      01178 ; FLAG VARIABLE DEFINITIONS
                      01179 ;**********************************************************************
                      01180 
                      01181 ; midiFlags
                      01182 #define turnSoundOn 3
                      01183 #define turnSoundOff 4
                      01184 #define keyPressed 5
                      01185 #define soundOn 6
                      01186 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 110


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01187 ; soundGenFlags
                      01188 #define delegatorBusy 0
                      01189 #define pgDec 1
                      01190 #define needRefresh 2
                      01191 #define activeNoteTableModified 3
                      01192 
                      01193 ; oscResetFlags
                      01194 #define osc0    0
                      01195 #define osc1    1
                      01196 #define osc2    2
                      01197 #define osc3    3
                      01198 
                      01199 ; oscStateFlags
                      01200 #define release 0
                      01201 #define sustain 1
                      01202 #define decay 2
                      01203 #define attack 3
                      01204 
                      01205 
                      01206 ;**********************************************************************
                      01207 ; MACROS
                      01208 ;**********************************************************************
                      01209 
                      01210 ;**********************************************************************
                      01211 CLEAR_ACCUMULATORS      MACRO
                      01212         local   loop
                      01213 
                      01214         ; init local variables
                      01215         PUSH_R  r0
                      01216         PUSH_R  FSR0L
                      01217         PUSH_R  FSR0H
                      01218         
                      01219         ; load fsr
                      01220         lfsr    FSR0, accumulators
                      01221 
                      01222         ; init count
                      01223         movf    polyDepth, w, ACCESS
                      01224         movwf   r0, ACCESS
                      01225 loop    
                      01226         ; each accumulator is 4 bytes wide
                      01227         clrf    POSTINC0, ACCESS        
                      01228         clrf    POSTINC0, ACCESS        
                      01229         clrf    POSTINC0, ACCESS        
                      01230         clrf    POSTINC0, ACCESS        
                      01231         ; decrement count, skip if done
                      01232         decfsz  r0, f, ACCESS
                      01233         bra             loop
                      01234 
                      01235         ; restore variables
                      01236         POP_R   FSR0H
                      01237         POP_R   FSR0L
                      01238         POP_R   r0
                      01239         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 111


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01240         ENDM
                      01241         
                      01242 
                      01243 ;**********************************************************************
                      01244 ENABLE_SUSTAIN  MACRO
                      01245         comf    oscResetFlags, w, ACCESS
                      01246         andlw   0x0f
                      01247         movwf   sustainFlags, ACCESS
                      01248         ENDM
                      01249         
                      01250 ;**********************************************************************
                      01251 DISABLE_SUSTAIN MACRO
                      01252         clrf    sustainFlags, ACCESS
                      01253         ENDM
                      01254 
                      01255 ;**********************************************************************
                      01256 REVERSE_SAMPLE_IF_MOD_OVER_63   MACRO
                      01257         local exitMacro
                      01258         ; if modulation > 63 then reverse sample
                      01259         movlw   63
                      01260         cpfsgt  modulation, ACCESS
                      01261         bra             exitMacro
                      01262         ; modulation > 63 so do nextSampleAddress = (sampleEndAddress - nextSampleAddress)
                      01263         movf    nextSampleAddress, w, ACCESS
                      01264         subwf   sampleEndAddress, w, ACCESS
                      01265         movwf   nextSampleAddress, ACCESS
                      01266         movf    nextSampleAddress + 1, w, ACCESS
                      01267         subwfb  sampleEndAddress + 1, w, ACCESS
                      01268         movwf   nextSampleAddress + 1, ACCESS
                      01269 exitMacro
                      01270         ENDM
                      01271 
                      01272 ;**********************************************************************
                      01273 OSC_READ_ADSR_FLAG      MACRO   FLAG
                      01274 ; oscillator number passed in WREG
                      01275 ; boolean value is returned in WREG and ZERO flag is set accordingly
                      01276 
                      01277         ; push working regs onto software stack
                      01278         PUSH_R  FSR0L
                      01279         PUSH_R  FSR0H
                      01280         
                      01281         ; load fsr
                      01282         lfsr    FSR0, oscStateFlags
                      01283         ; read the register into WREG
                      01284         movf    PLUSW0, w, ACCESS
                      01285         andlw   1<<FLAG
                      01286         
                      01287         ; restore working regs from stack
                      01288         POP_R   FSR0H
                      01289         POP_R   FSR0L   
                      01290         
                      01291         ENDM
                      01292 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 112


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01293 ;**********************************************************************
                      01294 OSC_ADVANCE_ADSR        MACRO   OSC_NUMBER
                      01295         local   macroDone, doAttack, attackDone, doRelease, releaseDone
                      01296 
                      01297         ; ignore advance if oscillator is sustained
                      01298         btfsc   sustainFlags, OSC_NUMBER, ACCESS
                      01299         bra             macroDone
                      01300         
                      01301         btfsc   oscStateFlags + OSC_NUMBER, attack, ACCESS
                      01302         bra             doAttack
                      01303         btfsc   oscStateFlags + OSC_NUMBER, release, ACCESS
                      01304         bra             doRelease
                      01305         bra             macroDone
                      01306         
                      01307 doAttack
                      01308         ; osc is attacking
                      01309 
                      01310         ; test condition ((adsrLimiterRegs -= ADSR_ATTACK_RATE) <=0)
                      01311         movf    adsrAttackRate, w, ACCESS
                      01312         subwf   adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      01313         bnc             attackDone
                      01314         bz              attackDone
                      01315 
                      01316         ; condition is FALSE so do the subtraction and exit
                      01317         ; (adsrLimiterRegs -= ADSR_ATTACK_RATE)
                      01318         movf    adsrAttackRate, w, ACCESS
                      01319         subwf   adsrLimiterRegs + OSC_NUMBER, f, ACCESS
                      01320         bra             macroDone
                      01321 
                      01322 attackDone
                      01323         ; clear attack flag
                      01324         bcf             oscStateFlags + OSC_NUMBER, attack, ACCESS
                      01325         clrf    adsrLimiterRegs + OSC_NUMBER, ACCESS
                      01326         bra     macroDone
                      01327 
                      01328 doRelease
                      01329         ; osc is releasing
                      01330 
                      01331         ; test condition: ((adsrLimiterRegs + ADSR_ATTACK_RATE) >= 255)
                      01332         movf    adsrReleaseRate, w, ACCESS
                      01333         addwf   adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      01334         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
                      01335         bc              releaseDone
                      01336         comf    WREG, w, ACCESS
                      01337         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
                      01338         bz              releaseDone
                      01339 
                      01340         ; condition is FALSE so do the addition and exit
                      01341         ; do (adsrLimiterRegs += ADSR_ATTACK_RATE)      
                      01342         movf    adsrReleaseRate, w, ACCESS
                      01343         addwf   adsrLimiterRegs + OSC_NUMBER, f, ACCESS
                      01344         bra             macroDone
                      01345         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 113


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01346 releaseDone
                      01347         ; clear release flag
                      01348         bcf             oscStateFlags + OSC_NUMBER, release, ACCESS
                      01349         ; set limit reg to max
                      01350         setf    adsrLimiterRegs + OSC_NUMBER, ACCESS
                      01351         ; clear oscillator's delegatedDelta
                      01352         clrf    delegatedDeltas + OSC_NUMBER * 2;
                      01353         clrf    delegatedDeltas + (OSC_NUMBER * 2) + 1; 
                      01354         bra     macroDone
                      01355         
                      01356 macroDone
                      01357         ENDM
                      01358         
                      01359 ;**********************************************************************
                      01360 OSC_MIX MACRO   OSC_NUMBER
                      01361         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                      01362                 
                      01363         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
                      01364         movlw   PWM_IDLE_OUTPUT_VALUE
                      01365         subwf   activeOutputValues + OSC_NUMBER, w
                      01366         bnc             mixDoNeg
                      01367 mixDoPos
                      01368         ; WREG = adsrLimiterRegs/2
                      01369         bcf             STATUS, C, ACCESS
                      01370         rrcf    adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      01371         subwf   activeOutputValues + OSC_NUMBER, w
                      01372         bra             mixDoDone
                      01373 mixDoNeg
                      01374         ; WREG = adsrLimiterRegs/2
                      01375         bcf             STATUS, C, ACCESS
                      01376         rrcf    adsrLimiterRegs + OSC_NUMBER, w, ACCESS
                      01377         addwf   activeOutputValues + OSC_NUMBER, w      
                      01378 mixDoDone
                      01379         ; overflow indicates that last operation toggled bit 7
                      01380         btfsc   STATUS, OV, ACCESS
                      01381         movlw   PWM_IDLE_OUTPUT_VALUE
                      01382 
                      01383 mixDone
                      01384         ; add WREG to mixedOutputL/H
                      01385         addwf   mixedOutputL, f, ACCESS
                      01386         btfsc   STATUS, C, ACCESS
                      01387         incf    mixedOutputH, f, ACCESS
                      01388         
                      01389         ENDM
                      01390 
                      01391 ;**********************************************************************
                      01392 OSC_STATE_BLOCK MACRO   OSC_NUMBER
                      01393         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
                      01394         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                      01395                 
                      01396         ; if oscillator is locked for sustain then leave it alone
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 114


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01397         btfsc   sustainFlags, OSC_NUMBER, ACCESS
                      01398         bra             oscActive
                      01399                         
                      01400 checkDelegating
                      01401         ; don't update if delegator is busy because delegatedDelta value is volatile
                      01402         btfsc   soundGenFlags, delegatorBusy, ACCESS
                      01403         ; delegator is busy so just keep spinning
                      01404         bra             oscCheckActive
                      01405         
                      01406         ; THRESHOLD METHOD WORKS WELL
                      01407         movlw   SINE
                      01408         cpfseq waveShape, ACCESS
                      01409         bra             oscCheckNotSine
                      01410         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
                      01411         movlw   PWM_IDLE_OUTPUT_VALUE
                      01412         subwf   activeOutputValues + OSC_NUMBER, w
                      01413         ; invert if negative
                      01414         btfss   STATUS, C, ACCESS
                      01415         negf    WREG, ACCESS
                      01416         ; check if offset is below threshold value
                      01417         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
                      01418         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                      01419         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
                      01420         bnc             oscCheckActive
                      01421 
                      01422 oscCheckNotSine
                      01423 
                      01424         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
                      01425         movff   delegatedDeltas + (OSC_NUMBER * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (OSC_NUM
                            BER * OSC_DELTAS_ELEMENT_SIZE) + 0
                      01426         movff   delegatedDeltas + (OSC_NUMBER * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (OSC_NUM
                            BER * OSC_DELTAS_ELEMENT_SIZE) + 1
                      01427 
                      01428 oscCheckActive
                      01429         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                      01430         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
                      01431         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
                      01432         bnz             oscActive
                      01433         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
                      01434         bz              resetOscillator
                      01435         
                      01436 oscActive
                      01437         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
                      01438         btfsc   oscResetFlags, OSC_NUMBER, ACCESS
                      01439         bra             zeroAcc
                      01440 
                      01441         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                      01442         ; accumulator += activeNoteDelta
                      01443         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
                      01444         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 115


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                                    + 0, w
                      01445         addwf   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
                      01446         movf    oscDeltas                       + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
                      01447         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
                      01448         movlw   0
                      01449         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
                      01450         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                      01451         
                      01452 zeroAcc
                      01453         ; we're done with oscResetFlags flag so ensure that it's clear
                      01454         bcf             oscResetFlags, OSC_NUMBER, ACCESS
                      01455         
                      01456         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                      01457         ; accumulator += pitchWheel
                      01458         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
                      01459         addwf   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
                      01460         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
                      01461         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
                      01462         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
                      01463         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
                      01464         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
                      01465         addwfc  accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                      01466         
                      01467         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                      01468         ; branch to waveform specific table address load
                      01469         movlw   SAMPLE
                      01470         cpfseq  waveShape, ACCESS
                      01471         bra             waveIsNotSample
                      01472 waveIsSample
                      01473 
                      01474         ; if samplesLoaded flag is set then load next EEPROM read address
                      01475         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                      01476         ; being able to load the samples in time, cause audio chopping rather than detuning
                      01477         btfss   eepromFlags, samplesLoaded, ACCESS
                      01478         bra             macroDone
                      01479         
                      01480         ; check for note transition
                      01481         ; keyPressed flag is set every time a MIDI Note On message is received
                      01482         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 116


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                             beginning...
                      01483         ; whenever a Note On message is received.
                      01484         btfss   midiFlags, keyPressed, ACCESS
                      01485         bra             noTransition
                      01486         ; is modeLevel == POLY
                      01487         movlw   POLY
                      01488         xorwf   modeLevel, w, ACCESS
                      01489         ; mode is POLY so reset accumulator to restart sample from beginning
                      01490         bz              clrSampleAcc
                      01491 
                      01492 noTransition    
                      01493         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                      01494         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
                      01495         ; is waveTableIndex > sampleEndAddress?
                      01496         movf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
                      01497         subwf   sampleEndAddress, w, ACCESS
                      01498         movf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
                      01499         subwfb  sampleEndAddress + 1, w, ACCESS
                      01500         ; result is positive so waveTableIndex is within valid range
                      01501         bc              addressOk
                      01502         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                      01503         ; reset accumulator
                      01504 clrSampleAcc
                      01505         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
                      01506         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
                      01507         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
                      01508         clrf    accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
                      01509 addressOk
                      01510         
                      01511         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
                      01512         movff   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (OSC_NUMBER * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
                      01513         movff   accumulators            + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (OSC_NUMBER * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                      01514         
                      01515         bra             macroDone
                      01516         
                      01517 waveIsNotSample
                      01518         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                      01519         ; branch to waveform specific table address load
                      01520         movlw   SINE
                      01521         cpfseq  waveShape, ACCESS
                      01522         bra             waveIsSquare
                      01523 
                      01524 waveIsSine      
                      01525         ; 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 117


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01526         ; load address of SINE table read
                      01527         ; offset = ((accumulator >> 8) & 0xff)
                      01528         movf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1, w
                      01529         addwf   sineTableBaseAddress + 0, w
                      01530         movwf   TBLPTRL, ACCESS
                      01531         movf    sineTableBaseAddress + 1, w
                      01532         btfsc   STATUS, C, ACCESS
                      01533         addlw   1
                      01534         movwf   TBLPTRH, ACCESS
                      01535         movf    sineTableBaseAddress + 2, w
                      01536         btfsc   STATUS, C, ACCESS
                      01537         addlw   1
                      01538         movwf   TBLPTRU, ACCESS
                      01539         bra             tableAddressLoaded
                      01540 
                      01541 waveIsSquare
                      01542         ; load address of SQUARE table read
                      01543         ; offset = ((accumulator >> 8) & 0xff)
                      01544         movf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1, w
                      01545         addwf   squareTableBaseAddress + 0, w
                      01546         movwf   TBLPTRL, ACCESS
                      01547         movf    squareTableBaseAddress + 1, w
                      01548         btfsc   STATUS, C, ACCESS
                      01549         addlw   1
                      01550         movwf   TBLPTRH, ACCESS
                      01551         movf    squareTableBaseAddress + 2, w
                      01552         btfsc   STATUS, C, ACCESS
                      01553         addlw   1
                      01554         movwf   TBLPTRU, ACCESS
                      01555 
                      01556 tableAddressLoaded
                      01557         ; read value from program memory
                      01558         tblrd*
                      01559         movff   TABLAT, activeOutputValues + (OSC_NUMBER * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
                      01560         bra             macroDone
                      01561         
                      01562 resetOscillator
                      01563         ; set oscillator reset flag
                      01564         bsf             oscResetFlags, OSC_NUMBER, ACCESS
                      01565         movlw   PWM_IDLE_OUTPUT_VALUE
                      01566         movwf   activeOutputValues + (OSC_NUMBER * ACTIVE_OUTPUT_VALUES_EL_SIZE)
                      01567         clrf    oscDeltas + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE) + 0
                      01568         clrf    oscDeltas + (OSC_NUMBER * OSC_DELTAS_ELEMENT_SIZE) + 1
                      01569         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 0
                      01570         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 1
                      01571         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 2
                      01572         clrf    accumulators + (OSC_NUMBER * ACCUMULATORS_ELEMENT_SIZE) + 3
                      01573 
                      01574 macroDone
                      01575 
                      01576         ENDM
                      01577         
                      01578         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 118


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01579 #endif
                      01580 
                      01581 
                      00026         #include        "../header/midi.h"
                      00664 
                      00665 ;**********************************************************************
                      00666 ;                                                                     *
                      00667 ;    Project:       deMIDulator                                       *
                      00668 ;    Filename:      midi.h                                            *
                      00669 ;    Date:                                                            *
                      00670 ;    File Version:                                                    *
                      00671 ;                                                                     *
                      00672 ;    Author:        Derek Enos                                        *
                      00673 ;    Company:                                                         *
                      00674 ;                                                                     * 
                      00675 ;                                                                     *
                      00676 ;**********************************************************************
                      00677 ;                                                                     *
                      00678 ;    Files required:                                                  *
                      00679 ;                                                                     *
                      00680 ;                                                                     *
                      00681 ;                                                                     *
                      00682 ;**********************************************************************
                      00683 
                      00684 #ifndef _MIDIH_
                      00685 #define _MIDIH_
                      00686 
                      00687 
                      00688 ; ******************* MIDI SYSEX DEFINES ***********************
                      00689 #define         VENDOR_ID       0x77
                      00690 #define         DEVICE_ID       0x1D
                      00691 #define         TERMINAL_PACKET_COMMAND_VALUE   0x1E
                      00692 
                      00693 ; ******************* MIDI BUFFER SIZES ***********************
                      00694 
                      00695 #define         MAX_MIDI_MESSAGE_SIZE   24
                      00696 #define         ACTIVE_NOTE_TABLE_SIZE  25
                      00697 
                      00698 
                      00699 ; ******************* STATUS BYTE DEFINITONS ***********************
                      00700 
                      00701 ; Note that lower nybble (channel) should be masked out for comparison
                      00702 ;------------------------
                      00703 #define         NOTE_OFF                                0x80
                      00704 #define         NOTE_ON                                 0x90
                      00705 #define         KEY_PRESSURE                    0xA0
                      00706 #define         CONTROL_CHANGE                  0xB0
                      00707 #define         PROGRAM_CHANGE                  0xC0
                      00708 #define         CHANNEL_PRESSURE                0xD0
                      00709 #define         PITCH_WHEEL                             0xE0
                      00710 
                      00711 ; Sysex Status Byte Definitions
                      00712 #define         SYSEX                                   0xF0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 119


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00713 #define         EOX                                             0xF7
                      00714 
                      00715 #define         NOTE_OFF_MESSAGE_LENGTH                         3
                      00716 #define         NOTE_ON_MESSAGE_LENGTH                          3
                      00717 #define         KEY_PRESSURE_MESSAGE_LENGTH                     3
                      00718 #define         CONTROL_CHANGE_MESSAGE_LENGTH           3
                      00719 #define         PROGRAM_CHANGE_MESSAGE_LENGTH           2
                      00720 #define         CHANNEL_PRESSURE_MESSAGE_LENGTH         2
                      00721 #define         PITCH_WHEEL_MESSAGE_LENGTH                      3
                      00722 
                      00723 ; SysEx Sub Types
                      00724 ;----------------------------
                      00725 #define         NON_REAL_TIME                                           0x7E
                      00726 #define         GENERAL_INFORMATION                                     0x06
                      00727 #define         IDENTITY_REQUEST                                        0x01
                      00728 #define         IDENTITY_REPLY                                          0x02
                      00729 
                      00730 ; Control Change Data Types
                      00731 ;----------------------------
                      00732 #define         BANK_SELECT_MSB                                         0
                      00733 #define         MODULATION_WHEEL_MSB                            1
                      00734 #define         BREATH_CONTROLLER_MSB                           2
                      00735 #define         UNDEFINED_003                                           3
                      00736 #define         FOOT_CONTROLLER_MSB                                     4
                      00737 #define         PORTAMENTO_TIME                                         5
                      00738 #define         DATA_ENTRY_MSB                                          6
                      00739 #define         CHANNEL_VOLUME_MSB                                      7
                      00740 #define         BALANCE_MSB                                                     8
                      00741 #define         UNDEFINED_MSB                                           9
                      00742 #define         PAN_MSB                                                         10
                      00743 #define         EXPRESSION_MSB                                          11
                      00744 #define         EFFECT_CONTROL_1_MSB                            12
                      00745 #define         EFFECT_CONTROL_2_MSB                            13
                      00746 #define         UNDEFINED_014                                           14
                      00747 #define         UNDEFINED_015                                           15
                      00748 #define         GENERAL_PURPOSE_CONTROLLER_1_MSB        16
                      00749 #define         GENERAL_PURPOSE_CONTROLLER_2_MSB        17
                      00750 #define         GENERAL_PURPOSE_CONTROLLER_3_MSB        18
                      00751 #define         GENERAL_PURPOSE_CONTROLLER_4_MSB        19
                      00752 #define         UNDEFINED_020                                           20
                      00753 #define         UNDEFINED_021                                           21
                      00754 #define         UNDEFINED_022                                           22
                      00755 #define         UNDEFINED_023                                           23
                      00756 #define         UNDEFINED_024                                           24
                      00757 #define         UNDEFINED_025                                           25
                      00758 #define         UNDEFINED_026                                           26
                      00759 #define         UNDEFINED_027                                           27
                      00760 #define         UNDEFINED_028                                           28
                      00761 #define         UNDEFINED_029                                           29
                      00762 #define         UNDEFINED_030                                           30
                      00763 #define         UNDEFINED_031                                           31
                      00764 #define         BANK_SELECT_LSB                                         32
                      00765 #define         MODULATION_WHEEL_LSB                            33
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 120


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00766 #define         BREATH_CONTROLLER_LSB                           34
                      00767 #define         UNDEFINED_035                                           35
                      00768 #define         FOOT_CONTROLLER_LSB                                     36
                      00769 #define         PORTAMENTO_TIME_LSB                                     37
                      00770 #define         DATA_ENTRY_LSB                                          38
                      00771 #define         CHANNEL_VOLUME_LSB                                      39
                      00772 #define         BALANCE_LSB                                                     40
                      00773 #define         UNDEFINED_041                                           41
                      00774 #define         PAN_LSB                                                         42
                      00775 #define         EXPRESSION_LSB                                          43
                      00776 #define         EFFECT_CONTROL_1_LSB                            44
                      00777 #define         EFFECT_CONTROL_2_LSB                            45
                      00778 #define         UNDEFINED_046                                           46
                      00779 #define         UNDEFINED_047                                           47
                      00780 #define         GENERAL_PURPOSE_CONTROLLER_1_LSB        48
                      00781 #define         GENERAL_PURPOSE_CONTROLLER_2_LSB        49
                      00782 #define         GENERAL_PURPOSE_CONTROLLER_3_LSB        50
                      00783 #define         GENERAL_PURPOSE_CONTROLLER_4_LSB        51
                      00784 #define         UNDEFINED_052                                           52
                      00785 #define         UNDEFINED_053                                           53
                      00786 #define         UNDEFINED_054                                           54
                      00787 #define         UNDEFINED_055                                           55
                      00788 #define         UNDEFINED_056                                           56
                      00789 #define         UNDEFINED_057                                           57
                      00790 #define         UNDEFINED_058                                           58
                      00791 #define         UNDEFINED_059                                           59
                      00792 #define         UNDEFINED_060                                           60
                      00793 #define         UNDEFINED_061                                           61
                      00794 #define         UNDEFINED_062                                           62
                      00795 #define         UNDEFINED_063                                           63
                      00796 #define         SUSTAIN_PEDAL                                           64
                      00797 #define         PORTAMENTO_ONOFF                                        65
                      00798 #define         SOSTENUTO                                                       66
                      00799 #define         SOFT_PEDAL                                                      67
                      00800 #define         LEGATO_FOOTSWITCH                                       68
                      00801 #define         HOLD_2                                                          69
                      00802 #define         SOUND_CONTROLLER_1_DEFAULT_SOUND_VARIATION                              70
                      00803 #define         SOUND_CONTROLLER_2_DEFAULT_TIMBRE_HARMONIC_QUALITY              71
                      00804 #define         SOUND_CONTROLLER_3_DEFAULT_RELEASE_TIME                                 72
                      00805 #define         SOUND_CONTROLLER_4_DEFAULT_ATTACK_TIME                                  73
                      00806 #define         SOUND_CONTROLLER_5_DEFAULT_BRIGHTNESS                                   74
                      00807 #define         SOUND_CONTROLLER_6_GM2_DEFAULT_DECAY_TIME                               75
                      00808 #define         SOUND_CONTROLLER_7_GM2_DEFAULT_VIBRATO_RATE                             76
                      00809 #define         SOUND_CONTROLLER_8_GM2_DEFAULT_VIBRATO_DEPTH                    77
                      00810 #define         SOUND_CONTROLLER_9_GM2_DEFAULT_VIBRATO_DELAY                    78
                      00811 #define         SOUND_CONTROLLER_10_GM2_DEFAULT_UNDEFINED                               79
                      00812 #define         GENERAL_PURPOSE_CONTROLLER_5                                                    80
                      00813 #define         GENERAL_PURPOSE_CONTROLLER_6                                                    81
                      00814 #define         GENERAL_PURPOSE_CONTROLLER_7                                                    82
                      00815 #define         GENERAL_PURPOSE_CONTROLLER_8                                                    83
                      00816 #define         PORTAMENTO_CONTROL                                                                      
                                    84
                      00817 #define         UNDEFINED_85                                                                    85
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 121


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00818 #define         UNDEFINED_86                                                                    86
                      00819 #define         UNDEFINED_87                                                                    87
                      00820 #define         UNDEFINED_88                                                                    88
                      00821 #define         UNDEFINED_89                                                                    89
                      00822 #define         UNDEFINED_90                                                                    90
                      00823 #define         EFFECTS_1_DEPTH_DEFAULT_REVERB_SEND                             91
                      00824 #define         EFFECTS_2_DEPTH_DEFAULT_TREMOLO_DEPTH                   92
                      00825 #define         EFFECTS_3_DEPTH_DEFAULT_CHORUS_SEND                             93
                      00826 #define         EFFECTS_4_DEPTH_DEFAULT_CELESTE_[DETUNE]_DEPTH  94
                      00827 #define         EFFECTS_5_DEPTH_DEFAULT_PHASER_DEPTH                    95
                      00828 #define         DATA_INCREMENT                                                                  96
                      00829 #define         DATA_DECREMENT                                                                  97
                      00830 #define         NON_REG_PARAMETER_NUMBER_LSB                            98
                      00831 #define         NON_REG_PARAMETER_NUMBER_MSB                            99
                      00832 #define         REGISTERED_PARAMETER_NUMBER_LSB                                 100
                      00833 #define         REGISTERED_PARAMETER_NUMBERMSB                                  101
                      00834 #define         UNDEFINED_102                                           102
                      00835 #define         UNDEFINED_103                                           103
                      00836 #define         UNDEFINED_104                                           104
                      00837 #define         UNDEFINED_105                                           105
                      00838 #define         UNDEFINED_106                                           106
                      00839 #define         UNDEFINED_107                                           107
                      00840 #define         UNDEFINED_108                                           108
                      00841 #define         UNDEFINED_109                                           109
                      00842 #define         UNDEFINED_110                                           110
                      00843 #define         UNDEFINED_111                                           111
                      00844 #define         UNDEFINED_112                                           112
                      00845 #define         UNDEFINED_113                                           113
                      00846 #define         UNDEFINED_114                                           114
                      00847 #define         UNDEFINED_115                                           115
                      00848 #define         UNDEFINED_116                                           116
                      00849 #define         UNDEFINED_117                                           117
                      00850 #define         UNDEFINED_118                                           118
                      00851 #define         UNDEFINED_119                                           119
                      00852 #define         ALL_SOUND_OFF                                           120
                      00853 #define         RESET_ALL_CONTROLLERS                           121
                      00854 #define         LOCAL_CONTROL_ONOFF                                     122
                      00855 #define         ALL_NOTES_OFF                                           123
                      00856 #define         OMNI_MODE_OFF                                           124
                      00857 #define         OMNI_MODE_ON                                            125
                      00858 #define         POLY_MODE_OFF                                           126
                      00859 #define         POLY_MODE_ON                                            127
                      00860 
                      00861 
                      00862 ; ******************* MIDI MESSAGE STATES ***********************
                      00863 
                      00864 #define CHANNEL                                         0x00
                      00865 #define DATA_BYTE0                                      0x01
                      00866 #define DATA_BYTE1                                      0x02
                      00867 #define MESSAGE_COMPLETE                        0xFF
                      00868 
                      00869 #define NOTE_COMPLETE                           DATA_BYTE1
                      00870 #define AFTERTOUCH_COMPLETE                     DATA_BYTE1
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 122


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00871 #define CONTROL_CHANGE_COMPLETE         DATA_BYTE1
                      00872 #define PROGRAM_CHANGE_COMPLETE         DATA_BYTE0
                      00873 #define PITCH_WHEEL_COMPLETE            DATA_BYTE1
                      00874 
                      00875 
                      00876 ; ******************* FLAG VARIABLE DEFINITIONS ***********************
                      00877 
                      00878 ; midiFlags (bits 3:7 free for use by other modules)
                      00879 #define uartState_rxInProgress                  0
                      00880 #define midiState_messageNeedsMapping   1
                      00881 #define midiThruModeEnabled                             2
                      00882 
                      00883 
                      00884 #endif
                      00027 
                      00028 
                      00029 ;**********************************************************************
                      00030 ; LOCAL VARIABLES
                      00031 ;**********************************************************************
                      00032 
                      00033         CBLOCK
                      00034 
  00000018            00035                 soundGenFlags:1
                      00036                 ; bits defined in soundGen.h
                      00037                 ;       #define delegatorBusy 0
                      00038                 ;       #define pgDec 1
                      00039                 ;       #define needRefresh 2
  00000019            00040                 pitchWheel:4
  0000001D            00041                 modulation:1
  0000001E            00042                 waveShape:1
  0000001F            00043                 recordOrPlayback:1
  00000020            00044                 modeLevel:1
  00000021            00045                 samplePrescaleCounter:1
  00000022            00046                 wavePrescaleCounter:1
                      00047                 ; polyDepth (assigned from MAX_POLY_DEPTH during init) needs to be > 2 and a multiple of
                             2
  00000023            00048                 polyDepth:1
                      00049                 ; adding table addresses as variable to allow for roaming program memory samples
  00000024            00050                 sineTableBaseAddress:3
  00000027            00051                 squareTableBaseAddress:3
  0000002A            00052                 oscResetFlags:1
                      00053                 ; bits defined in soundGen.h
                      00054                 ; #define       osc0    0
                      00055                 ; #define       osc1    1
                      00056                 ; #define       osc2    2
                      00057                 ; #define       osc3    3
                      00058 
                      00059                 ; making these variables global to save time during processSoundState ISR call
  0000002B            00060                 sustainFlags:1
  0000002C            00061                 sample:1
  0000002D            00062                 mixedOutputL:1
  0000002E            00063                 mixedOutputH:1
  0000002F            00064                 oscStateFlags:4
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 123


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00065                 ; bits defined in soundGen.h
                      00066                 ; #define       release 0
                      00067                 ; #define       sustain 1
                      00068                 ; #define       decay 2
                      00069                 ; #define       attack 3
  00000033            00070                 adsrLimiterRegs:4
  00000037            00071                 adsrAttackRate:1
  00000038            00072                 adsrReleaseRate:1
  00000039            00073                 adsrPrescaleCounter:2
                      00074                 
  0000003B            00075                 recordWaitCountdown:1
                      00076                 
                      00077                 ; Declared at end of main.asm to ensure that arrays are pushed to end of memory...
                      00078                 ; with smaller variables in ACCESS memory
                      00079                 ; ---------------------------------------
                      00080                 ; activeNoteDeltas:ACTIVE_NOTE_DELTAS_SIZE
                      00081                 ; delegatedDeltas:DELEGATED_DELTAS_SIZE
                      00082                 ; oscDeltas:OSC_DELTAS_SIZE
                      00083                 ; accumulators:ACCUMULATORS_SIZE
                      00084                 ; activeOutputValues:ACTIVE_OUTPUT_VALUES_SIZE
                      00085 
                      00086         ENDC
                      00087 
                      00088 
                      00089 ;**********************************************************************
                      00090 ; LOCAL FUNCTIONS
                      00091 ;**********************************************************************
                      00092 
                      00093 ; [Function Summary]
                      00094 ;
                      00095 ; Function: initSoundGen()
                      00096 ; Abstract: initialize sound sound generation state variables
                      00097 ;
                      00098 ; Function: activeNoteTableAdd(WREG)
                      00099 ; Abstract: shift all values in activeNoteTable one level deeper and write note value passed in WREG to 
                            index 0
                      00100 ;           call refreshActiveNoteState()
                      00101 ;
                      00102 ; Function: activeNoteTableRemove(WREG)
                      00103 ; Abstract: look for index of note value passed in WREG in activeNoteTable and wipe location to 0xff if 
                            found
                      00104 ;           bubble sort all non-0xff values toward index 0
                      00105 ;           call refreshActiveNoteState()
                      00106 ;
                      00107 ; Function: refreshActiveNoteState()
                      00108 ; Abstract: check status of activeNoteTable entries and set turnSoundOn, turnSoundOff and notTransition 
                            flags appropriately
                      00109 ;           call getActiveNoteDeltas()
                      00110 ;
                      00111 ; Function: getActiveNoteDeltas()
                      00112 ; Abstract: for all active entries (non-0xff) in activeNoteTable from index 0 - polyDepth...
                      00113 ;           read accumulator delta value from Flash Program Memory table and save to corresponding index
                             in activeNoteDeltas table
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 124


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00114 ;
                      00115 ; Function: processSoundState()
                      00116 ; Abstract: called by Timer2 ISR
                      00117 ;           handles audio sampling/recording, calls eepromWrite64() when 64-byte sample buffer is full
                      00118 ;           handles all sound generation.  reading from Program Mem or EEPROM and writing to PWM
                      00119 
                      00120 
                      00121         ; ***********************************************************************
                      00122         ; Function: void initSoundGen(void)
                      00123         ; ***********************************************************************
0007DA                00124 initSoundGen
                      00125         ; push working regs onto software stack
                      00126         PUSH_R  r0
0007DA C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00127         PUSH_R  FSR0L
0007DE CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00128         PUSH_R  FSR0H
0007E2 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00129         ; define variables to pushed registers
                      00130         #define count   r0
                      00131         
                      00132         ; using FSR0 for all inits, no need for fancy defines
                      00133 
0007E6 6A19           00134         clrf    pitchWheel, ACCESS
0007E8 6A1A           00135         clrf    pitchWheel + 1, ACCESS
0007EA 6A1B           00136         clrf    pitchWheel + 2, ACCESS
0007EC 6A1C           00137         clrf    pitchWheel + 3, ACCESS
                      00138         
0007EE 6A1D           00139         clrf    modulation, ACCESS
                      00140                 
0007F0 0E00           00141         movlw   SINE
0007F2 6E1E           00142         movwf   waveShape, ACCESS
0007F4 0E02           00143         movlw   PLAYBACK
0007F6 6E1F           00144         movwf   recordOrPlayback, ACCESS        
0007F8 0E00           00145         movlw   POLY
0007FA 6E20           00146         movwf   modeLevel, ACCESS
                      00147         
0007FC 0E04           00148         movlw   MAX_POLY_DEPTH
0007FE 6E23           00149         movwf   polyDepth, ACCESS
                      00150 
000800 6A21           00151         clrf    samplePrescaleCounter, ACCESS
000802 6A22           00152         clrf    wavePrescaleCounter, ACCESS
                      00153 
000804 9610           00154         bcf             midiFlags, turnSoundOn, ACCESS          
000806 9810           00155         bcf             midiFlags, turnSoundOff, ACCESS         
000808 9A10           00156         bcf             midiFlags, keyPressed, ACCESS           
00080A 9C10           00157         bcf             midiFlags, soundOn, ACCESS
                      00158 
00080C 9018           00159         bcf             soundGenFlags, delegatorBusy, ACCESS
00080E 9218           00160         bcf             soundGenFlags, pgDec, ACCESS    
000810 9418           00161         bcf             soundGenFlags, needRefresh, ACCESS
000812 9618           00162         bcf             soundGenFlags, activeNoteTableModified, ACCESS
                      00163         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 125


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000814 0E??           00164         movlw   low(sineTable)
000816 6E24           00165         movwf   sineTableBaseAddress + 0
000818 0E??           00166         movlw   high(sineTable)
00081A 6E25           00167         movwf   sineTableBaseAddress + 1
00081C 0E??           00168         movlw   upper(sineTable)
00081E 6E26           00169         movwf   sineTableBaseAddress + 2
                      00170         
000820 0E??           00171         movlw   low(squareTable)
000822 6E27           00172         movwf   squareTableBaseAddress + 0
000824 0E??           00173         movlw   high(squareTable)
000826 6E28           00174         movwf   squareTableBaseAddress + 1
000828 0E??           00175         movlw   upper(squareTable)
00082A 6E29           00176         movwf   squareTableBaseAddress + 2
                      00177         
00082C 802A           00178         bsf             oscResetFlags, osc0, ACCESS             
00082E 822A           00179         bsf             oscResetFlags, osc1, ACCESS             
000830 842A           00180         bsf             oscResetFlags, osc2, ACCESS             
000832 862A           00181         bsf             oscResetFlags, osc3, ACCESS             
                      00182         
000834 6A2B           00183         clrf    sustainFlags, ACCESS
                      00184 
                      00185         ; init ADSR variables
000836 6A2F           00186         clrf    oscStateFlags + 0, ACCESS
000838 6A30           00187         clrf    oscStateFlags + 1, ACCESS
00083A 6A31           00188         clrf    oscStateFlags + 2, ACCESS
00083C 6A32           00189         clrf    oscStateFlags + 3, ACCESS
                      00190         
00083E 6833           00191         setf    adsrLimiterRegs + 0, ACCESS
000840 6834           00192         setf    adsrLimiterRegs + 1, ACCESS
000842 6835           00193         setf    adsrLimiterRegs + 2, ACCESS
000844 6836           00194         setf    adsrLimiterRegs + 3, ACCESS
000846 6A39           00195         clrf    adsrPrescaleCounter + 0, ACCESS
000848 6A3A           00196         clrf    adsrPrescaleCounter + 1, ACCESS
                      00197         
00084A 6A3B           00198         clrf    recordWaitCountdown, ACCESS
                      00199                 
                      00200         ; load default adsr attack and release rates
00084C 0E3F           00201         movlw   ADSR_ATTACK_RATE
00084E 6E37           00202         movwf   adsrAttackRate, ACCESS
000850 0E10           00203         movlw   ADSR_RELEASE_RATE       
000852 6E38           00204         movwf   adsrReleaseRate, ACCESS
                      00205                         
                      00206         ; load fsr
000854 EE00 F0B9      00207         lfsr    FSR0, activeNoteDeltas
                      00208 
000858 0E08           00209         movlw   ACTIVE_NOTE_DELTAS_SIZE
00085A 6E03           00210         movwf   count, ACCESS
00085C                00211 initSoundGen_lp1                
00085C 6AEE           00212         clrf    POSTINC0, ACCESS
00085E 2E03           00213         decfsz  count, f, ACCESS
000860 D???           00214         bra             initSoundGen_lp1
                      00215 
                      00216         ; load fsr
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 126


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000862 EE00 F0D1      00217         lfsr    FSR0, accumulators
                      00218 
000866 0E10           00219         movlw   ACCUMULATORS_SIZE
000868 6E03           00220         movwf   count, ACCESS
00086A                00221 initSoundGen_lp2        
00086A 6AEE           00222         clrf    POSTINC0, ACCESS
00086C 2E03           00223         decfsz  count, f, ACCESS
00086E D???           00224         bra             initSoundGen_lp2
                      00225 
                      00226         ; load fsr
000870 EE00 F0E1      00227         lfsr    FSR0, activeOutputValues
                      00228 
000874 0E04           00229         movlw   ACTIVE_OUTPUT_VALUES_SIZE
000876 6E03           00230         movwf   count, ACCESS
000878                00231 initSoundGen_lp3
000878 0E80           00232         movlw   PWM_IDLE_OUTPUT_VALUE
00087A 6EEE           00233         movwf   POSTINC0, ACCESS
                      00234 
00087C 2E03           00235         decfsz  count, f, ACCESS
00087E D???           00236         bra             initSoundGen_lp3
                      00237 
                      00238         ; load fsr
000880 EE00 F0C1      00239         lfsr    FSR0, delegatedDeltas
                      00240 
000884 0E08           00241         movlw   DELEGATED_DELTAS_SIZE
000886 6E03           00242         movwf   count, ACCESS
000888                00243 initSoundGen_lp4
                      00244         ; 0xff indicates that delta is unowned
000888 6AEE           00245         clrf    POSTINC0, ACCESS
00088A 2E03           00246         decfsz  count, f, ACCESS
00088C D???           00247         bra             initSoundGen_lp4
                      00248 
                      00249         ; load fsr
00088E EE00 F0C9      00250         lfsr    FSR0, oscDeltas
                      00251 
000892 0E08           00252         movlw   OSC_DELTAS_SIZE
000894 6E03           00253         movwf   count, ACCESS
000896                00254 initSoundGen_lp5
000896 6AEE           00255         clrf    POSTINC0, ACCESS
000898 2E03           00256         decfsz  count, f, ACCESS
00089A D???           00257         bra             initSoundGen_lp5
                      00258 
                      00259         ; undefine variables from pushed registers
                      00260         #undefine count
                      00261         ; pop working regs from software stack
                      00262         POP_R   FSR0H
00089C CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00263         POP_R   FSR0L
0008A0 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00264         POP_R   r0
0008A4 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00265         
0008A8 0012           00266         return
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 127


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00267 
                      00268 
                      00269         ; ***********************************************************************
                      00270         ; Function: void activeNoteTableAdd(byte note)
                      00271         ; ***********************************************************************
0008AA                00272 activeNoteTableAdd
                      00273         ; push working regs onto software stack
                      00274         PUSH_R  r0
0008AA C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00275         PUSH_R  r1
0008AE C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00276         PUSH_R  r2
0008B2 C005 FFDD          M         movff   r2,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00277         PUSH_R  FSR0L
0008B6 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00278         PUSH_R  FSR0H
0008BA CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00279         ; define variables to pushed registers
                      00280         #define note                                    r0
                      00281         #define index                                   r1
                      00282         #define tmpValue                                r2
                      00283         #define FSR_activeNoteTable             FSR0
                      00284         #define PLUSW_activeNoteTable   PLUSW0
                      00285 
                      00286         ; load fsr
0008BE EE00 F058      00287         lfsr    FSR_activeNoteTable, activeNoteTable
                      00288 
                      00289         ; saved argument passed in WREG
0008C2 6E03           00290         movwf   note, ACCESS
                      00291                 
                      00292         ;**** start procedure: add note to activeNoteTable index 0 ****
                      00293         ; start at end of table and shift all entries 1 level deeper
                      00294         ; note that if all activeNoteTable entries are active then note at index ACTIVE_NOTE_TABLE_SIZE 
                            - 1 will be lost
                      00295 
                      00296         ; initialize index to end of table
0008C4 0E18           00297         movlw   ACTIVE_NOTE_TABLE_SIZE - 1
0008C6 6E04           00298         movwf   index, ACCESS
0008C8                00299 activeNoteTableAdd_lp1
                      00300         ; tmpValue = activeNoteTable[index - 1]
0008C8 0404           00301         decf    index, w, ACCESS
0008CA 50EB           00302         movf    PLUSW_activeNoteTable, w, ACCESS
0008CC 6E05           00303         movwf   tmpValue, ACCESS
                      00304         ; activeNoteTable[index] = activeNoteTable[index - 1]
0008CE 5004           00305         movf    index, w, ACCESS
0008D0 C005 FFEB      00306         movff   tmpValue, PLUSW_activeNoteTable
                      00307         ; decrement index and abort if we've reach the beginning of the table
0008D4 2E04           00308         decfsz  index, f, ACCESS
0008D6 D???           00309         bra             activeNoteTableAdd_lp1
                      00310 
                      00311         ; save note value to activeNoteTable index 0
0008D8 C003 F058      00312         movff   note, activeNoteTable
                      00313 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 128


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0008DC                00314 activeNoteTableAdd_exit
                      00315         ; undefine variables from pushed registers
                      00316         #undefine       note
                      00317         #undefine       index
                      00318         #undefine       tmpValue
                      00319         #undefine       FSR_activeNoteTable
                      00320         #undefine       PLUSW_activeNoteTable
                      00321         ; pop working regs from software stack
                      00322         POP_R   FSR0H
0008DC CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00323         POP_R   FSR0L
0008E0 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00324         POP_R   r2
0008E4 CFDC F005          M         movff   softwareStackPointerPREINC, r2          ; ++softwareStackPointerINDF = regName
                      00325         POP_R   r1
0008E8 CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      00326         POP_R   r0
0008EC CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00327 
                      00328         ; set MIDI keyPressed flag to indicate Note On message received
                      00329         ; this flag is checked and then cleared in processSoundState() to determine when to terminate an
                             audio sample recording
                      00330         ; and whether or not to retrigger sample playback from beginning
0008F0 8A10           00331         bsf             midiFlags, keyPressed, ACCESS           
                      00332 
0008F2 EC?? F???      00333         call    refreshActiveNoteState
                      00334         
0008F6 0012           00335         return
                      00336         
                      00337         ; ***********************************************************************
                      00338         ; Function: void activeNoteTableRemove(byte note)
                      00339         ; ***********************************************************************
0008F8                00340 activeNoteTableRemove
                      00341         ; push working regs onto software stack
                      00342         PUSH_R  r0
0008F8 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00343         PUSH_R  r1
0008FC C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00344         PUSH_R  r2
000900 C005 FFDD          M         movff   r2,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00345         PUSH_R  r3
000904 C006 FFDD          M         movff   r3,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00346         PUSH_R  FSR0L
000908 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00347         PUSH_R  FSR0H
00090C CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00348         ; define variables to pushed registers
                      00349         #define note                                    r0
                      00350         #define index                                   r1
                      00351         #define tmpValue                                r2
                      00352         #define sorting                                 r3
                      00353         #define FSR_activeNoteTable             FSR0
                      00354         #define PLUSW_activeNoteTable   PLUSW0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 129


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00355 
                      00356         ; load fsr
000910 EE00 F058      00357         lfsr    FSR_activeNoteTable, activeNoteTable
                      00358 
                      00359         ; save argument passed in WREG
000914 6E03           00360         movwf   note, ACCESS
                      00361                 
                      00362         ;**** start procedure: find all activeNoteTable entries equal to note value and wipe to 0xff ***
                            *
                      00363         ; init index
000916 6A04           00364         clrf    index, ACCESS
                      00365 
000918                00366 activeNoteTableRemove_lp1
                      00367         ; if passed noteNumber is 0xff then ignore compare and just wipe location
000918 1C03           00368         comf    note, w, ACCESS
00091A E0??           00369         bz              activeNoteTableRemove_lp1Wipe
                      00370 
                      00371         ; WREG = activeNoteTable[index]
00091C 5004           00372         movf    index, w, ACCESS
00091E 50EB           00373         movf    PLUSW_activeNoteTable, w, ACCESS
                      00374         ; skip if activeNoteTable[index] == note
000920 6203           00375         cpfseq  note, ACCESS
                      00376         ; activeNoteTable[index] is != note so bypass wipe
000922 D???           00377         bra             activeNoteTableRemove_lp1Jmp1
                      00378 
000924                00379 activeNoteTableRemove_lp1Wipe
                      00380         ; activeNoteTable[index] is == note or passed noteNumber was 0xff so wipe location value to 0xff
000924 5004           00381         movf    index, w, ACCESS
000926 68EB           00382         setf    PLUSW_activeNoteTable, ACCESS
                      00383         ; previously was aborting operation at this point but doing so provides...
                      00384         ; less robust Note Off handling. In event of missed Note Off, note value can occupy multiple ind
                            exes
000928                00385 activeNoteTableRemove_lp1Jmp1
                      00386         ; increment index indexer
000928 2A04           00387         incf    index, f, ACCESS
                      00388         ; compare to ACTIVE_NOTE_TABLE_SIZE, skip if equal
00092A 0E19           00389         movlw   ACTIVE_NOTE_TABLE_SIZE
00092C 6204           00390         cpfseq  index, ACCESS
00092E D???           00391         bra             activeNoteTableRemove_lp1
                      00392 
                      00393         
                      00394         ;**** start procedure: bubble sort all non-0xff values toward index 0 ****
                      00395         ; logic of routine in C:
                      00396         ;
                      00397         ;       sorting = TRUE; 
                      00398         ;       while(sorting)
                      00399         ;       {
                      00400         ;               sorting = FALSE;
                      00401         ;
                      00402         ;               for(index = 0; index < ACTIVE_NOTE_TABLE_SIZE - 1; index++)
                      00403         ;               {
                      00404         ;                       if((activeNoteTable[index] == 0xff) && (activeNoteTable[index + 1] != 0x
                            ff))
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 130


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00405         ;                       {
                      00406         ;                               activeNoteTable[index] = activeNoteTable[index + 1];
                      00407         ;                               activeNoteTable[index + 1] = 0xff;
                      00408         ;                               sorting = TRUE;
                      00409         ;                       }
                      00410         ;               }
                      00411         ;       }
                      00412 
                      00413         ; using entire register for single bit sorting flag, set to TRUE to start first cycle
000930 6806           00414         setf    sorting, ACCESS
                      00415         
000932                00416 activeNoteTableRemove_sortLoop
                      00417         ; are we still sorting?
000932 5206           00418         movf    sorting, f, ACCESS
                      00419         ; no so abort
000934 E0??           00420         bz              activeNoteTableRemove_sortDone
                      00421         
                      00422         ; reset sorting flag to FALSE. will be set by following code if we're not actually done
000936 6A06           00423         clrf    sorting, ACCESS
                      00424 
                      00425         ; init index
000938 6A04           00426         clrf    index, ACCESS
00093A                00427 activeNoteTableRemove_bubbleLoop
                      00428         ; is activeNoteTable[index] == 0xff?
00093A 5004           00429         movf    index, w, ACCESS
00093C 1CEB           00430         comf    PLUSW_activeNoteTable, w, ACCESS
                      00431         ; no so increment index and continue
00093E E1??           00432         bnz             activeNoteTableRemove_bubbleContinue
                      00433 
                      00434         ; is activeNoteTable[i+1] != 0xff?
000940 2804           00435         incf    index, w, ACCESS
000942 1CEB           00436         comf    PLUSW_activeNoteTable, w, ACCESS
                      00437         ; no so increment index and continue
000944 E0??           00438         bz              activeNoteTableRemove_bubbleContinue
                      00439                 
                      00440         ; sorting condition was met so set flag
000946 6806           00441         setf    sorting, ACCESS         
                      00442 
                      00443         ; activeNoteTable[index] = activeNoteTable[index+1]
000948 2804           00444         incf    index, w, ACCESS
00094A 50EB           00445         movf    PLUSW_activeNoteTable, w, ACCESS
00094C 6E05           00446         movwf   tmpValue, ACCESS
00094E 5004           00447         movf    index, w, ACCESS
000950 C005 FFEB      00448         movff   tmpValue, PLUSW_activeNoteTable
                      00449         
                      00450         ; activeNoteTable[index+1] = 0xff
000954 2804           00451         incf    index, w, ACCESS
000956 68EB           00452         setf    PLUSW_activeNoteTable, ACCESS
                      00453         
Warning[208]: Label truncated at 32 characters. (activeNoteTableRemove_bubbleContinue)
000958                00454 activeNoteTableRemove_bubbleContinue
                      00455         ; increment index and save in self
000958 2A04           00456         incf    index, f, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 131


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00095A 0E18           00457         movlw   ACTIVE_NOTE_TABLE_SIZE - 1
                      00458         ; if index is == ACTIVE_NOTE_TABLE_SIZE - 1 then we've reach the end of the table so skip loop b
                            ranch
00095C 6204           00459         cpfseq  index, ACCESS
                      00460         ; not done stepping through activeNoteTable so continue
00095E D???           00461         bra             activeNoteTableRemove_bubbleLoop        
                      00462         
                      00463         ; done stepping through activeNoteTable
                      00464         ; branch to check if any sorting action was taken
                      00465         ; process will keep looping until stepping through entire activeNoteTable causes no data swappin
                            g to occur
000960 D???           00466         bra             activeNoteTableRemove_sortLoop
                      00467 
000962                00468 activeNoteTableRemove_sortDone
                      00469 
                      00470         ; undefine variables from pushed registers
                      00471         #undefine       note
                      00472         #undefine       index
                      00473         #undefine       tmpValue
                      00474         #undefine       sorting
                      00475         #undefine       FSR_activeNoteTable
                      00476         #undefine       PLUSW_activeNoteTable
                      00477         ; pop working regs from software stack
                      00478         POP_R   FSR0H
000962 CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00479         POP_R   FSR0L
000966 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00480         POP_R   r3
00096A CFDC F006          M         movff   softwareStackPointerPREINC, r3          ; ++softwareStackPointerINDF = regName
                      00481         POP_R   r2
00096E CFDC F005          M         movff   softwareStackPointerPREINC, r2          ; ++softwareStackPointerINDF = regName
                      00482         POP_R   r1
000972 CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      00483         POP_R   r0
000976 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00484 
00097A EC?? F???      00485         call    refreshActiveNoteState
                      00486         
00097E 0012           00487         return
                      00488 
                      00489 
                      00490 ;**********************************************************************
                      00491 ; Function: void refreshActiveNoteState(void)
                      00492 ;**********************************************************************
000980                00493 refreshActiveNoteState
                      00494         ; check if there are any active notes
                      00495         ; if activeNoteTable[0] == 0xff then there are no active notes
000980 1C58           00496         comf    activeNoteTable + 0, w
                      00497         ; at least one note is active so keep sound on
000982 E1??           00498         bnz             refreshActiveNoteState_active
                      00499         ; no notes are active so request sound off
000984 8810           00500         bsf             midiFlags, turnSoundOff, ACCESS
000986 9610           00501         bcf             midiFlags, turnSoundOn, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 132


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000988 D???           00502         bra             refreshActiveNoteState_exit
                      00503 
00098A                00504 refreshActiveNoteState_active           
                      00505         ; check if sound is on  
00098A AC10           00506         btfss   midiFlags, soundOn, ACCESS
00098C D???           00507         bra             refreshActiveNoteState_soundIsOff
                      00508 
                      00509         ; sound is on so request transition
00098E 9810           00510         bcf             midiFlags, turnSoundOff, ACCESS
000990 9610           00511         bcf             midiFlags, turnSoundOn, ACCESS
000992 D???           00512         bra             refreshActiveNoteState_exit
                      00513 
Warning[208]: Label truncated at 32 characters. (refreshActiveNoteState_soundIsOff)
000994                00514 refreshActiveNoteState_soundIsOff
                      00515         ; sound is off so request sound on
000994 9810           00516         bcf             midiFlags, turnSoundOff, ACCESS
000996 8610           00517         bsf             midiFlags, turnSoundOn, ACCESS
                      00518         
000998                00519 refreshActiveNoteState_exit
                      00520         ; calling getActiveNoteDeltas() is a big task which includes theDelegator()
                      00521         ; so just try setting the refresh flag since we're inside the UART ISR right now
000998 8418           00522         bsf             soundGenFlags, needRefresh, ACCESS
                      00523 
                      00524         ; set flag to indicate to getActiveNoteDeltas() that activeNoteTable has been modified
00099A 8618           00525         bsf             soundGenFlags, activeNoteTableModified, ACCESS
                      00526 
00099C 0012           00527         return
                      00528 
                      00529 
                      00530 ;**********************************************************************
                      00531 ; Function: void getActiveNoteDeltas(void)
                      00532 ;**********************************************************************
00099E                00533 getActiveNoteDeltas
                      00534 
                      00535         ; push working regs onto software stack
                      00536         PUSH_R  r0
00099E C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00537         PUSH_R  FSR0L
0009A2 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00538         PUSH_R  FSR0H
0009A6 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00539         PUSH_R  FSR1L
0009AA CFE1 FFDD          M         movff   FSR1L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00540         PUSH_R  FSR1H
0009AE CFE2 FFDD          M         movff   FSR1H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00541         PUSH_R  TBLPTRL
0009B2 CFF6 FFDD          M         movff   TBLPTRL, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00542         PUSH_R  TBLPTRH
0009B6 CFF7 FFDD          M         movff   TBLPTRH, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00543         PUSH_R  TBLPTRU
0009BA CFF8 FFDD          M         movff   TBLPTRU, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00544         PUSH_R  TABLAT
0009BE CFF5 FFDD          M         movff   TABLAT,  softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 133


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00545         ; define variables to pushed registers
                      00546         #define index                                           r0
                      00547         #define FSR_activeNoteTable                     FSR0
                      00548         #define PLUSW_activeNoteTable           PLUSW0
                      00549         #define FSR_activeNoteDeltas            FSR1
                      00550         #define PLUSW_activeNoteDeltas          PLUSW1
                      00551 
                      00552         ; load FSR
0009C2 EE00 F058      00553         lfsr    FSR_activeNoteTable, activeNoteTable
0009C6 EE10 F0B9      00554         lfsr    FSR_activeNoteDeltas, activeNoteDeltas
                      00555 
0009CA                00556 getActiveNoteDeltasAgain
                      00557         ; activeNoteTable is modified by ISR so is VOLATILE!
                      00558         ; clear activeNoteTableModified flag so that we can check it again once we're done updating acti
                            veNoteDeltas
                      00559         ; if the flag is set upon routine completion, then there's a chance that activeNoteDeltas are co
                            rrupt so do it again
0009CA 9618           00560         bcf             soundGenFlags, activeNoteTableModified, ACCESS
                      00561 
                      00562         ; init index
0009CC 6A03           00563         clrf    index, ACCESS
                      00564 
0009CE                00565 getActiveNoteDeltas_loop        
                      00566         ; check if reading note or sample delta table
0009CE 0E02           00567         movlw   SAMPLE
0009D0 181E           00568         xorwf   waveShape, w, ACCESS
0009D2 E0??           00569         bz              getActiveNoteDeltas_loadSampleDelta
                      00570 
                      00571         ; **** load value from midi delta table ****
                      00572         ; load table pointer address
                      00573         ; shift activeNote left once to get proper program memory offset since noteDelta values are word
                            -sized
                      00574         ; w = activeNoteTable[index]
0009D4 5003           00575         movf    index, w, ACCESS
                      00576         ; if bit 7 is set then note at index is not valid
0009D6 BEEB           00577         btfsc   PLUSW_activeNoteTable, 7, ACCESS
0009D8 D???           00578         bra             getActiveNoteDeltas_zeroDelta
                      00579         ; note at index is valid so continue
0009DA 90D8           00580         bcf             STATUS, C, ACCESS
0009DC 34EB           00581         rlcf    PLUSW_activeNoteTable, w, ACCESS
0009DE 0F??           00582         addlw   low(midiNoteDeltaTable)
0009E0 6EF6           00583         movwf   TBLPTRL, ACCESS
0009E2 0E??           00584         movlw   high(midiNoteDeltaTable)
0009E4 B0D8           00585         btfsc   STATUS, C, ACCESS
0009E6 0F01           00586         addlw   1
0009E8 6EF7           00587         movwf   TBLPTRH, ACCESS
0009EA 0E??           00588         movlw   upper(midiNoteDeltaTable)
0009EC B0D8           00589         btfsc   STATUS, C, ACCESS
0009EE 0F01           00590         addlw   1
0009F0 6EF8           00591         movwf   TBLPTRU, ACCESS
0009F2 D???           00592         bra             getActiveNoteDeltas_readTableAndSave
                      00593 
                      00594         ; **** load value from sample delta table ****
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 134


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

Warning[208]: Label truncated at 32 characters. (getActiveNoteDeltas_loadSampleDelta)
0009F4                00595 getActiveNoteDeltas_loadSampleDelta
                      00596         ; load table pointer address
                      00597         ; shift activeNote left once to get proper program memory offset since noteDelta values are word
                            -sized
                      00598         ; w = activeNoteTable[index]
0009F4 5003           00599         movf    index, w, ACCESS
                      00600         ; if bit 7 is set then note at index is not valid
0009F6 BEEB           00601         btfsc   PLUSW_activeNoteTable, 7, ACCESS
0009F8 D???           00602         bra             getActiveNoteDeltas_zeroDelta
                      00603         ; note at index is valid so continue
0009FA 90D8           00604         bcf             STATUS, C, ACCESS
0009FC 34EB           00605         rlcf    PLUSW_activeNoteTable, w, ACCESS
0009FE 0F??           00606         addlw   low(sampleMidiNoteDeltaTable)
000A00 6EF6           00607         movwf   TBLPTRL, ACCESS
000A02 0E??           00608         movlw   high(sampleMidiNoteDeltaTable)
000A04 B0D8           00609         btfsc   STATUS, C, ACCESS
000A06 0F01           00610         addlw   1
000A08 6EF7           00611         movwf   TBLPTRH, ACCESS
000A0A 0E??           00612         movlw   upper(sampleMidiNoteDeltaTable)
000A0C B0D8           00613         btfsc   STATUS, C, ACCESS
000A0E 0F01           00614         addlw   1
000A10 6EF8           00615         movwf   TBLPTRU, ACCESS
000A12 D???           00616         bra             getActiveNoteDeltas_readTableAndSave
                      00617 
000A14                00618 getActiveNoteDeltas_zeroDelta
                      00619         ; w = index * 2
000A14 90D8           00620         bcf             STATUS, C, ACCESS
000A16 3403           00621         rlcf    index, w, ACCESS
                      00622 
                      00623         ; Critical Section Begin
                      00624         ; **************************
                      00625         ; clear global interrupt to avoid ISR reading partial delta value
000A18 9EF2           00626         bcf             INTCON, GIE, ACCESS
                      00627 
000A1A 6AE3           00628         clrf    PLUSW_activeNoteDeltas, ACCESS
                      00629         ; w = (index * 2) + 1
000A1C 0F01           00630         addlw   1
000A1E 6AE3           00631         clrf    PLUSW_activeNoteDeltas, ACCESS
                      00632 
                      00633         ; re-enable interrupts
000A20 8EF2           00634         bsf             INTCON, GIE, ACCESS
                      00635         ; **************************
                      00636         ; Critical Section End
                      00637 
000A22 D???           00638         bra             getActiveNoteDeltas_next
                      00639 
Warning[208]: Label truncated at 32 characters. (getActiveNoteDeltas_readTableAndSave)
000A24                00640 getActiveNoteDeltas_readTableAndSave
                      00641         ; read low byte into TBLAT
000A24 0009           00642         tblrd*+
                      00643         ; w = index * 2
000A26 90D8           00644         bcf             STATUS, C, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 135


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000A28 3403           00645         rlcf    index, w, ACCESS
                      00646 
                      00647         ; Critical Section Begin
                      00648         ; **************************
                      00649         ; clear global interrupt to avoid ISR reading partial delta value
000A2A 9EF2           00650         bcf             INTCON, GIE, ACCESS
                      00651         
000A2C CFF5 FFE3      00652         movff   TABLAT, PLUSW_activeNoteDeltas
                      00653         ; read high byte into TBLAT
000A30 0009           00654         tblrd*+
                      00655         ; w = (index * 2) + 1
000A32 0F01           00656         addlw   1
000A34 CFF5 FFE3      00657         movff   TABLAT, PLUSW_activeNoteDeltas
                      00658 
                      00659         ; re-enable interrupts
000A38 8EF2           00660         bsf             INTCON, GIE, ACCESS
                      00661         ; **************************
                      00662         ; Critical Section End
                      00663 
000A3A                00664 getActiveNoteDeltas_next        
                      00665         ; increment index
000A3A 2A03           00666         incf    index, f, ACCESS
                      00667         ; compare against polyDepth to check if done
000A3C 0E04           00668         movlw   MAX_POLY_DEPTH
000A3E 1803           00669         xorwf   index, w, ACCESS
000A40 E1??           00670         bnz             getActiveNoteDeltas_loop
                      00671 
000A42                00672 getActiveNoteDeltas_exit
                      00673         ; activeNoteTable is modified by ISR so is VOLATILE!
                      00674         ; if activeNoteTableModified flag is set, there's a chance that activeNoteDeltas are corrupt so 
                            do it again
000A42 B618           00675         btfsc   soundGenFlags, activeNoteTableModified, ACCESS
000A44 D???           00676         bra             getActiveNoteDeltasAgain
                      00677 
                      00678         ; undefine variables from pushed registers
                      00679         #undefine       index
                      00680         #undefine       FSR_activeNoteTable
                      00681         #undefine       PLUSW_activeNoteTable
                      00682         #undefine       FSR_activeNoteDeltas
                      00683         #undefine       PLUSW_activeNoteDeltas
                      00684         ; pop working regs from software stack
                      00685         POP_R   TABLAT
000A46 CFDC FFF5          M         movff   softwareStackPointerPREINC, TABLAT      ; ++softwareStackPointerINDF = regName
                      00686         POP_R   TBLPTRU
000A4A CFDC FFF8          M         movff   softwareStackPointerPREINC, TBLPTRU     ; ++softwareStackPointerINDF = regName
                      00687         POP_R   TBLPTRH
000A4E CFDC FFF7          M         movff   softwareStackPointerPREINC, TBLPTRH     ; ++softwareStackPointerINDF = regName
                      00688         POP_R   TBLPTRL
000A52 CFDC FFF6          M         movff   softwareStackPointerPREINC, TBLPTRL     ; ++softwareStackPointerINDF = regName
                      00689         POP_R   FSR1H
000A56 CFDC FFE2          M         movff   softwareStackPointerPREINC, FSR1H       ; ++softwareStackPointerINDF = regName
                      00690         POP_R   FSR1L
000A5A CFDC FFE1          M         movff   softwareStackPointerPREINC, FSR1L       ; ++softwareStackPointerINDF = regName
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 136


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00691         POP_R   FSR0H
000A5E CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00692         POP_R   FSR0L
000A62 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      00693         POP_R   r0
000A66 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      00694 
                      00695         ; deltas have been updated so call the DelagatOr
                      00696         ; need this here because getActiveNoteDeltas is called when waveShape is change by user
000A6A EC?? F???      00697         call    theDelegatOr
                      00698 
000A6E 0012           00699         return
                      00700 
                      00701 
                      00702         ; ***********************************************************************
                      00703         ; Function: void theDelegatOr(void)
                      00704         ; ***********************************************************************
000A70                00705 theDelegatOr
                      00706 
                      00707         PUSH_R  r0
000A70 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00708         PUSH_R  r1
000A74 C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00709         PUSH_R  r2
000A78 C005 FFDD          M         movff   r2,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00710         PUSH_R  r3
000A7C C006 FFDD          M         movff   r3,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00711         PUSH_R  r4
000A80 C007 FFDD          M         movff   r4,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00712         PUSH_R  r5
000A84 C008 FFDD          M         movff   r5,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00713         PUSH_R  r6
000A88 C009 FFDD          M         movff   r6,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00714         PUSH_R  FSR0L
000A8C CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00715         PUSH_R  FSR0H
000A90 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00716         PUSH_R  FSR1L
000A94 CFE1 FFDD          M         movff   FSR1L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00717         PUSH_R  FSR1H
000A98 CFE2 FFDD          M         movff   FSR1H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00718         
                      00719         #define ddLockedFlags                           r0
                      00720         #define ddIndex                                 r1
                      00721         #define ddIndexMask                             r2
                      00722         #define andIndex                                r3
                      00723         #define andIndexMask                    r4
                      00724         #define tmpValue                                r5
                      00725         #define andLockedFlags  r6
                      00726         #define FSR_activeNoteDeltas    FSR0
                      00727         #define PLUSW_activeNoteDeltas  PLUSW0
                      00728         #define FSR_delegatedDeltas             FSR1
                      00729         #define PLUSW_delegatedDeltas   PLUSW1
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 137


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00730         
000A9C EE00 F0B9      00731         lfsr    FSR_activeNoteDeltas, activeNoteDeltas
000AA0 EE10 F0C1      00732         lfsr    FSR_delegatedDeltas, delegatedDeltas
                      00733 
                      00734         ; set flag to indicate to oscillators that delegatedDeltas are volatile
000AA4 8018           00735         bsf             soundGenFlags, delegatorBusy, ACCESS
                      00736         
                      00737         ; check if poly or mono mode
000AA6 0E01           00738         movlw   1
000AA8 6423           00739         cpfsgt  polyDepth, ACCESS
000AAA D???           00740         bra             theDelgatOr_doMono
                      00741         
                      00742         ;**** start procedure: free up any oscillator whose current delta is no longer present in active
                            NoteDeltas ****
                      00743 
                      00744         ; corresponding ddLockedFlags and andLockedFlags will be set for each delegatedDelta that matche
                            s an activeNoteDelta
                      00745         ; so clear em
000AAC 6A03           00746         clrf    ddLockedFlags, ACCESS
000AAE 6A09           00747         clrf    andLockedFlags, ACCESS
                      00748         
                      00749         ; the purpose of the following routine is to check each oscillator's delegatedDelta value agains
                            t the activeNoteDelta array
                      00750         ; and free any oscillator up that is no longer valid
                      00751         ; "ddLockedFlags" is used locally to indicate if an oscillator is locked to a current activeNote
                            Delta element
                      00752         
                      00753         ; start looking through delegatedDeltas[0...3] for a match in the activeNoteTable[0...polyDepth-
                            1]
                      00754         ; reset delegatedDeltas index count
000AB0 6A04           00755         clrf    ddIndex, ACCESS
                      00756         ; reset delegatedDeltas index mask
000AB2 0E01           00757         movlw   1
000AB4 6E05           00758         movwf   ddIndexMask, ACCESS
                      00759         ; start delegatedDelta iteration loop
000AB6                00760 theDelegatOr_undelOutLp
                      00761         ; check for delegatedDeltas[ddIndex] == 0x0000
000AB6 90D8           00762         bcf             STATUS, C, ACCESS
000AB8 3404           00763         rlcf    ddIndex, w, ACCESS
000ABA 52E3           00764         movf    PLUSW_delegatedDeltas, f, ACCESS
000ABC E1??           00765         bnz             theDelegatOr_undelDdNonZero
000ABE 0F01           00766         addlw   1
000AC0 52E3           00767         movf    PLUSW_delegatedDeltas, f, ACCESS
                      00768         ; delegatedDeltas[ddIndex] value is nonZero so continue
000AC2 E1??           00769         bnz     theDelegatOr_undelDdNonZero
                      00770         
                      00771         ; delegatedDeltas[ddIndex] value is 0x0000 so...
                      00772         ; iterate to next delegatedDelta
000AC4 D???           00773         bra             theDelegatOr_undelNextDD
                      00774 
000AC6                00775 theDelegatOr_undelDdNonZero
                      00776         ; reset activeNoteTable index count
000AC6 6A06           00777         clrf    andIndex, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 138


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00778         ; reset activeNoteTable index mask
000AC8 0E01           00779         movlw   1
000ACA 6E07           00780         movwf   andIndexMask, ACCESS
                      00781 
                      00782         ; start activeNoteTable iteration loop
000ACC                00783 theDelegatOr_undelInLp
                      00784         ; try to match low byte
                      00785         ; elements are 2-bytes wide so WREG = index * 2
000ACC 90D8           00786         bcf             STATUS, C, ACCESS
000ACE 3404           00787         rlcf    ddIndex, w, ACCESS
000AD0 50E3           00788         movf    PLUSW_delegatedDeltas, w, ACCESS
000AD2 6E08           00789         movwf   tmpValue, ACCESS
000AD4 90D8           00790         bcf             STATUS, C, ACCESS
000AD6 3406           00791         rlcf    andIndex, w, ACCESS
000AD8 50EB           00792         movf    PLUSW_activeNoteDeltas, w, ACCESS
000ADA 1808           00793         xorwf   tmpValue, w, ACCESS
                      00794         ; low byte does not match so iterate to next activeNoteDeltas index
000ADC E1??           00795         bnz             theDelegatOr_undelNextAnd
                      00796         ; low byte matches, try to match high byte
000ADE 90D8           00797         bcf             STATUS, C, ACCESS
000AE0 3404           00798         rlcf    ddIndex, w, ACCESS
000AE2 0F01           00799         addlw   1
000AE4 50E3           00800         movf    PLUSW_delegatedDeltas, w, ACCESS
000AE6 6E08           00801         movwf   tmpValue, ACCESS
000AE8 90D8           00802         bcf             STATUS, C, ACCESS
000AEA 3406           00803         rlcf    andIndex, w, ACCESS
000AEC 0F01           00804         addlw   1
000AEE 50EB           00805         movf    PLUSW_activeNoteDeltas, w, ACCESS
000AF0 1808           00806         xorwf   tmpValue, w, ACCESS
                      00807         ; elements do not match so iterate to next activeNoteDeltas index
000AF2 E1??           00808         bnz             theDelegatOr_undelNextAnd
                      00809 
                      00810         ; nonZero element in delegatedDeltas matches an element in activeNoteDeltas
                      00811         ; set activeNoteDelta and delegatedDelta locked flags
000AF4 5005           00812         movf    ddIndexMask, w, ACCESS
000AF6 1203           00813         iorwf   ddLockedFlags, f, ACCESS        
000AF8 5007           00814         movf    andIndexMask, w, ACCESS
000AFA 1209           00815         iorwf   andLockedFlags, f, ACCESS       
                      00816 
                      00817         ; if it's releasing then reattack
000AFC 5004           00818         movf    ddIndex, w, ACCESS
                      00819         ; macro returns boolean value in WREG and also sets ZERO flag accordingly
                      00820         OSC_READ_ADSR_FLAG release
                          M ; oscillator number passed in WREG
                          M ; boolean value is returned in WREG and ZERO flag is set accordingly
                          M 
                          M         ; push working regs onto software stack
                          M         PUSH_R  FSR0L
000AFE CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                          M         PUSH_R  FSR0H
000B02 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                          M         
                          M         ; load fsr
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 139


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000B06 EE00 F02F          M         lfsr    FSR0, oscStateFlags
                          M         ; read the register into WREG
000B0A 50EB               M         movf    PLUSW0, w, ACCESS
000B0C 0B01               M         andlw   1<<0
                          M         
                          M         ; restore working regs from stack
                          M         POP_R   FSR0H
000B0E CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                          M         POP_R   FSR0L   
000B12 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                          M         
                      00821         ; don't reattack if it's not releasing
000B16 E0??           00822         bz              theDelegatOr_undelNextDD
                      00823         ; oscillator is releasing so reattack
000B18 5004           00824         movf    ddIndex, w, ACCESS
000B1A EC?? F???      00825         call    oscAdsrTriggerAttack
                      00826         
000B1E D???           00827         bra             theDelegatOr_undelNextDD        
                      00828         
000B20                00829 theDelegatOr_undelNextAnd
                      00830         ; current activeNoteDelta does not match current delegatedDelta so iterate to next
                      00831         ; increment activeNoteDeltas index mask value
000B20 90D8           00832         bcf             STATUS, C, ACCESS
000B22 3607           00833         rlcf    andIndexMask, f, ACCESS
                      00834         ; increment activeNoteDeltas index
000B24 2A06           00835         incf    andIndex, f, ACCESS
                      00836         ; we're done if andIndex == MAX_POLY_DEPTH
000B26 5006           00837         movf    andIndex, w, ACCESS
000B28 0A04           00838         xorlw   MAX_POLY_DEPTH
                      00839         ; still have more activeNoteDelta elements to check for match so keep going
000B2A E1??           00840         bnz             theDelegatOr_undelInLp
                      00841 
000B2C                00842 theDelegatOr_undelAndLoopDone
                      00843         ; done trying to match delegatedDeltas[ddIndex] to activeNoteDeltas[0 - polyDepth]
                      00844         ; did not find a match (any match would've branched to theDelegatOr_undelNextDD)
                      00845 
                      00846         ; delatedDeltas[ddIndex] is nonZero and has no match in activeNoteDeltas[0polyDepth-1] so kil
                            l it with adsr-release  
                      00847         ; set the release flag
000B2C 5004           00848         movf    ddIndex, w, ACCESS
000B2E EC?? F???      00849         call    oscAdsrTriggerRelease
                      00850 
                      00851         ; check next delegatedDelta
000B32                00852 theDelegatOr_undelNextDD
000B32 90D8           00853         bcf             STATUS, C, ACCESS
000B34 3605           00854         rlcf    ddIndexMask, f, ACCESS
000B36 2A04           00855         incf    ddIndex, f, ACCESS
000B38 5004           00856         movf    ddIndex, w, ACCESS
000B3A 0A04           00857         xorlw   MAX_POLY_DEPTH
000B3C E1??           00858         bnz             theDelegatOr_undelOutLp
                      00859                 
                      00860 
                      00861         ;**** start procedure: delegate any unlocked activeNoteDeltas to a free oscillator **** 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 140


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00862         ; this procedure is reversed from the previous in that it tries to match an unmatch activeNoteDe
                            lta to
                      00863         ; the first available unmatched oscillator
                      00864         
                      00865         ; reset activeNoteDelta index count
000B3E 6A06           00866         clrf    andIndex, ACCESS
                      00867         ; reset activeNoteDelta index mask
000B40 0E01           00868         movlw   1
000B42 6E07           00869         movwf   andIndexMask, ACCESS
000B44                00870 theDelegatOr_delOutLp
                      00871         ; ignore activeNoteDelta if it's locked
000B44 5007           00872         movf    andIndexMask, w, ACCESS
000B46 1409           00873         andwf   andLockedFlags, w, ACCESS
000B48 E1??           00874         bnz             theDelegatOr_delOutLpNext
                      00875         
                      00876         ; only attempt match if activeNoteDelta != 0x0000
                      00877         ; WREG = ddIndex * 2
000B4A 90D8           00878         bcf             STATUS, C, ACCESS
000B4C 3406           00879         rlcf    andIndex, w, ACCESS
000B4E 52EB           00880         movf    PLUSW_activeNoteDeltas, f, ACCESS
000B50 E1??           00881         bnz             theDelegatOr_andNotZero
000B52 0F01           00882         addlw   1
000B54 52EB           00883         movf    PLUSW_activeNoteDeltas, f, ACCESS
000B56 E0??           00884         bz              theDelegatOr_delOutLpNext
                      00885 
000B58                00886 theDelegatOr_andNotZero                 
                      00887         ; if possible, we want to leave releasing oscillators alone and assign unmatch activeNoteDeltas 
                            to a completely
                      00888         ; idle oscillator.  If no idle oscillator is found then force assignment to a releasing oscillat
                            or
                      00889         ; ddLockedFlags bit 7 == 0 for available
                      00890         ; ddLockedFlags bit 7 == 1 for force assign to releasing        
000B58 9E03           00891         bcf             ddLockedFlags, 7, ACCESS
                      00892 
000B5A                00893 theDelegatOr_delInLpInit
                      00894         ; found unmatched activeNoteDelta, so assign to first available oscillator's delegatedDelta
                      00895         ; reset delegatedDeltas index count
000B5A 6A04           00896         clrf    ddIndex, ACCESS
                      00897         ; reset delegatedDeltas index mask
000B5C 0E01           00898         movlw   1
000B5E 6E05           00899         movwf   ddIndexMask, ACCESS
                      00900 
000B60                00901 theDelegatOr_delInLp
                      00902         ; WREG = ddIndex * 2
000B60 90D8           00903         bcf             STATUS, C, ACCESS
000B62 3404           00904         rlcf    ddIndex, w, ACCESS
                      00905 
                      00906         ; IF YOU"RE GONNA HIJACK a releasing osc then maybe choose the one that the most released?
                      00907         
                      00908         ; check if we're still looking for idle oscillators or forcing assignment to a releasing osc
000B64 BE03           00909         btfsc   ddLockedFlags, 7, ACCESS
000B66 D???           00910         bra             theDelegatOr_delInLpForceAssign
                      00911 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 141


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00912         ; check low byte for zero
000B68 52E3           00913         movf    PLUSW_delegatedDeltas, f, ACCESS
000B6A E1??           00914         bnz             theDelegatOr_delInLpNext
                      00915         ; check high byte for zero
000B6C 0F01           00916         addlw   1
000B6E 52E3           00917         movf    PLUSW_delegatedDeltas, f, ACCESS
000B70 E1??           00918         bnz             theDelegatOr_delInLpNext
                      00919         ; found idle oscillator so assign it
000B72 D???           00920         bra             theDelegatOr_delInLpAssignOsc
                      00921         
000B74                00922 theDelegatOr_delInLpForceAssign
                      00923         ; if oscillator is not locked then it may be releasing so force assignment
000B74 5005           00924         movf    ddIndexMask, w, ACCESS
000B76 1403           00925         andwf   ddLockedFlags, w, ACCESS
                      00926         ; oscillator is locked so don't touch it
000B78 E1??           00927         bnz             theDelegatOr_delInLpNext
                      00928 
000B7A                00929 theDelegatOr_delInLpAssignOsc
                      00930         ; found suitable oscillator, ignore if locked for sustain
000B7A 5005           00931         movf    ddIndexMask, w, ACCESS
000B7C 142B           00932         andwf   sustainFlags, w, ACCESS
                      00933         ; oscillator is locked for sustain so consider it ineligible
000B7E E1??           00934         bnz             theDelegatOr_delInLpNext
                      00935 
                      00936         ; oscillator is not locked for sustain so do delegatedDeltas[ddIndex] = activeNoteDeltas[andInde
                            x]
                      00937         ; copy low byte
000B80 90D8           00938         bcf             STATUS, C, ACCESS
000B82 3406           00939         rlcf    andIndex, w, ACCESS
000B84 50EB           00940         movf    PLUSW_activeNoteDeltas, w, ACCESS
000B86 6E08           00941         movwf   tmpValue, ACCESS
000B88 90D8           00942         bcf             STATUS, C, ACCESS
000B8A 3404           00943         rlcf    ddIndex, w, ACCESS
000B8C C008 FFE3      00944         movff   tmpValue, PLUSW_delegatedDeltas
                      00945         ; copy high byte
000B90 90D8           00946         bcf             STATUS, C, ACCESS
000B92 3406           00947         rlcf    andIndex, w, ACCESS
000B94 0F01           00948         addlw   1
000B96 50EB           00949         movf    PLUSW_activeNoteDeltas, w, ACCESS
000B98 6E08           00950         movwf   tmpValue, ACCESS
000B9A 90D8           00951         bcf             STATUS, C, ACCESS
000B9C 3404           00952         rlcf    ddIndex, w, ACCESS
000B9E 0F01           00953         addlw   1
000BA0 C008 FFE3      00954         movff   tmpValue, PLUSW_delegatedDeltas
                      00955 
                      00956         ; oscillator is starting up so set attack flag
000BA4 5004           00957         movf    ddIndex, w, ACCESS
000BA6 EC?? F???      00958         call    oscAdsrTriggerAttack
                      00959         
                      00960         ; skip to next unlocked activeNoteDelta
000BAA D???           00961         bra             theDelegatOr_delOutLpNext
                      00962         
000BAC                00963 theDelegatOr_delInLpNext
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 142


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000BAC 90D8           00964         bcf             STATUS, C, ACCESS
000BAE 3605           00965         rlcf    ddIndexMask, f, ACCESS
000BB0 2A04           00966         incf    ddIndex, f, ACCESS
000BB2 5004           00967         movf    ddIndex, w, ACCESS
000BB4 0A04           00968         xorlw   MAX_POLY_DEPTH
000BB6 E1??           00969         bnz             theDelegatOr_delInLp
                      00970         
                      00971         ; toggle idle/forceOnReleasing flag if necessary
000BB8 BE03           00972         btfsc   ddLockedFlags, 7, ACCESS
                      00973         ; just completed force on releasing cycle so continue
000BBA D???           00974         bra             theDelegatOr_delOutLpNext
                      00975         ; just complete idle assign loop so toggle to force
000BBC 8E03           00976         bsf             ddLockedFlags, 7, ACCESS
                      00977         ; go try to find a releasing oscillator to snag
000BBE D???           00978         bra             theDelegatOr_delInLpInit
                      00979 
000BC0                00980 theDelegatOr_delOutLpNext
000BC0 90D8           00981         bcf             STATUS, C, ACCESS
000BC2 3607           00982         rlcf    andIndexMask, f, ACCESS
000BC4 2A06           00983         incf    andIndex, f, ACCESS
000BC6 5006           00984         movf    andIndex, w, ACCESS
000BC8 0A04           00985         xorlw   MAX_POLY_DEPTH
000BCA E1??           00986         bnz             theDelegatOr_delOutLp
                      00987         
000BCC D???           00988         bra             theDelegatOr_done
                      00989 
000BCE                00990 theDelgatOr_doMono
                      00991         ; kill adsr for monophonic mode
000BCE 6A33           00992         clrf    adsrLimiterRegs + 0, ACCESS
000BD0 C0B9 F0C1      00993         movff   activeNoteDeltas + 0, delegatedDeltas + 0       
000BD4 C0BA F0C2      00994         movff   activeNoteDeltas + 1, delegatedDeltas + 1
000BD8 6BC3           00995         clrf    delegatedDeltas + 2
000BDA 6BC4           00996         clrf    delegatedDeltas + 3
000BDC 6BC5           00997         clrf    delegatedDeltas + 4
000BDE 6BC6           00998         clrf    delegatedDeltas + 5
000BE0 6BC7           00999         clrf    delegatedDeltas + 6
000BE2 6BC8           01000         clrf    delegatedDeltas + 7
                      01001 
000BE4                01002 theDelegatOr_done
                      01003         ; clear flag to indicate to oscillators that delegatedDeltas are no longer volatile
000BE4 9018           01004         bcf             soundGenFlags, delegatorBusy, ACCESS
                      01005 
                      01006         POP_R   FSR1H
000BE6 CFDC FFE2          M         movff   softwareStackPointerPREINC, FSR1H       ; ++softwareStackPointerINDF = regName
                      01007         POP_R   FSR1L
000BEA CFDC FFE1          M         movff   softwareStackPointerPREINC, FSR1L       ; ++softwareStackPointerINDF = regName
                      01008         POP_R   FSR0H
000BEE CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      01009         POP_R   FSR0L
000BF2 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      01010         POP_R   r6
000BF6 CFDC F009          M         movff   softwareStackPointerPREINC, r6          ; ++softwareStackPointerINDF = regName
                      01011         POP_R   r5
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 143


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000BFA CFDC F008          M         movff   softwareStackPointerPREINC, r5          ; ++softwareStackPointerINDF = regName
                      01012         POP_R   r4
000BFE CFDC F007          M         movff   softwareStackPointerPREINC, r4          ; ++softwareStackPointerINDF = regName
                      01013         POP_R   r3
000C02 CFDC F006          M         movff   softwareStackPointerPREINC, r3          ; ++softwareStackPointerINDF = regName
                      01014         POP_R   r2
000C06 CFDC F005          M         movff   softwareStackPointerPREINC, r2          ; ++softwareStackPointerINDF = regName
                      01015         POP_R   r1
000C0A CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      01016         POP_R   r0
000C0E CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      01017         
                      01018         #undefine       ddLockedFlags
                      01019         #undefine       ddIndex
                      01020         #undefine       ddIndexMask
                      01021         #undefine       andIndex
                      01022         #undefine       andIndexMask
                      01023         #undefine       tmpValue
                      01024         #undefine       andLockedFlags
                      01025         #undefine       FSR_activeNoteDeltas
                      01026         #undefine       PLUSW_activeNoteDeltas
                      01027         #undefine       FSR_delegatedDeltas
                      01028         #undefine       PLUSW_delegatedDeltas
                      01029 
000C12 0012           01030         return
                      01031 
                      01032 
                      01033         ; ***********************************************************************
                      01034         ; Function: void processSoundState(void)
                      01035         ; ***********************************************************************
000C14                01036 processSoundState
                      01037         ; push working regs onto software stack
                      01038         PUSH_R  FSR0L
000C14 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01039         PUSH_R  FSR0H
000C18 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01040         PUSH_R  FSR1L
000C1C CFE1 FFDD          M         movff   FSR1L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01041         PUSH_R  FSR1H
000C20 CFE2 FFDD          M         movff   FSR1H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01042         PUSH_R  TBLPTRL
000C24 CFF6 FFDD          M         movff   TBLPTRL, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01043         PUSH_R  TBLPTRH
000C28 CFF7 FFDD          M         movff   TBLPTRH, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01044         PUSH_R  TBLPTRU
000C2C CFF8 FFDD          M         movff   TBLPTRU, softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01045         PUSH_R  TABLAT
000C30 CFF5 FFDD          M         movff   TABLAT,  softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01046         PUSH_R  PRODL
000C34 CFF3 FFDD          M         movff   PRODL,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01047         PUSH_R  PRODH
000C38 CFF4 FFDD          M         movff   PRODH,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01048         ; Define FSR(s) for recording, playback pointers will be redefined as needed
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 144


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01049         #define FSR_sampleDataBuffer            FSR0
                      01050         #define PLUSW_sampleDataBuffer          PLUSW0  
                      01051 
                      01052         ; load fsr
000C3C EE00 F071      01053         lfsr    FSR_sampleDataBuffer, sampleDataBuffer
                      01054 
                      01055         ;**** start procedure: sample audio if mode is VOICE_THROUGH or RECORD ****
000C40 0E00           01056         movlw   VOICE_THROUGH
000C42 181F           01057         xorwf   recordOrPlayback, w, ACCESS
000C44 E0??           01058         bz              processSoundState_StartADC
000C46 0E01           01059         movlw   RECORD
000C48 181F           01060         xorwf   recordOrPlayback, w, ACCESS
000C4A E0??           01061         bz              processSoundState_StartADC
000C4C EF?? F???      01062         goto    processSoundState_Playback      
                      01063 
                      01064         ;**** start procedure: sample audio ****
000C50                01065 processSoundState_StartADC
                      01066         ; start ADC conversion
000C50 82C2           01067         bsf             ADCON0, GO, ACCESS
                      01068         ; wait for conversion to finish
000C52                01069 processSoundState_ADCWait
000C52 B2C2           01070         btfsc   ADCON0, DONE, ACCESS
000C54 D???           01071         bra             processSoundState_ADCWait
                      01072                 
                      01073         ; sample complete, save ADC value
000C56 50C4           01074         movf    ADRESH, w, ACCESS
                      01075         ; add op-amp DC OFFSET
                      01076         ; REMEBER that DC-OFFSET will be affected by component tolerances so measure each circuit!
000C58 0F36           01077         addlw   SAMPLE_DC_OFFSET 
                      01078         ; if overflow then clip at 0xff
000C5A B0D8           01079         btfsc   STATUS, C, ACCESS
000C5C 0EFF           01080         movlw 0xff
                      01081         ; save value
000C5E 6E2C           01082         movwf   sample, ACCESS
                      01083                 
                      01084 ; DEBUG - sample mix
                      01085         ; amplify incoming sample volume by 3
000C60 0E80           01086         movlw   PWM_IDLE_OUTPUT_VALUE
000C62 5C2C           01087         subwf   sample, w, ACCESS
000C64 E3??           01088         bnc             processSoundState_sampAmpNeg
                      01089         ; result was positive so increase value
000C66 90D8           01090         bcf             STATUS, C, ACCESS
000C68 34E8           01091         rlcf    WREG, w, ACCESS
000C6A 242C           01092         addwf   sample, w, ACCESS
                      01093         ; if overflow then clip at 0xff
000C6C B0D8           01094         btfsc   STATUS, C, ACCESS
000C6E 0EFF           01095         movlw 0xff
000C70 D???           01096         bra             processSoundState_sampAmpExit
000C72                01097 processSoundState_sampAmpNeg
                      01098         ; result was negative so decrease value
                      01099         ; invert difference so it's positive
000C72 6CE8           01100         negf    WREG, ACCESS
000C74 90D8           01101         bcf             STATUS, C, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 145


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000C76 34E8           01102         rlcf    WREG, w, ACCESS
000C78 5C2C           01103         subwf   sample, w, ACCESS
                      01104         ; if overflow then clip at 0x00
000C7A A0D8           01105         btfss   STATUS, C, ACCESS
000C7C 0E00           01106         movlw   0
000C7E                01107 processSoundState_sampAmpExit
000C7E 6E2C           01108         movwf   sample, ACCESS
                      01109 
                      01110         ; write sample value to PWM for immediate playback
                      01111         ; /4 and add (PWM_IDLE_OUTPUT_VALUE/4 * 3) to simulate final single voice sound mix
000C80 90D8           01112   bcf           STATUS, C, ACCESS
000C82 302C           01113         rrcf    sample, w, ACCESS
000C84 90D8           01114   bcf           STATUS, C, ACCESS
000C86 30E8           01115         rrcf    WREG, w, ACCESS
000C88 0F60           01116         addlw   PWM_IDLE_OUTPUT_VALUE/4 * 3
000C8A 6EBE           01117         movwf   CCPR1L, ACCESS
                      01118                 
                      01119         ;**** start procedure: should we be recording this? ****
                      01120         ; has RECORD button been released?
                      01121 #ifndef __DEBUG
                      01122         ; if debugging then assume that button has been released and we want to record
000C8C A282           01123         btfss   PORTC, RC1, ACCESS
                      01124         ; RECORD button is still depressed so don't record
000C8E EF?? F???      01125         goto    processSoundState_exit
                      01126 #endif
                      01127 
                      01128         ; RECORD button has been released
                      01129         
                      01130         ; is waveShape == SAMPLE?
000C92 0E02           01131         movlw   SAMPLE
000C94 621E           01132         cpfseq  waveShape, ACCESS
                      01133         ; waveShape is != SAMPLE so don't record
000C96 EF?? F???      01134         goto    processSoundState_cancelVoiceThru
000C9A D???           01135         bra             processSoundState_recordGo
                      01136 
                      01137         ; waveShape != SAMPLE so cancel VOICE_THROUGH and return to PLAYBACK
Warning[208]: Label truncated at 32 characters. (processSoundState_cancelVoiceThru)
000C9C                01138 processSoundState_cancelVoiceThru
000C9C 0E02           01139         movlw   PLAYBACK
000C9E 6E1F           01140         movwf   recordOrPlayback, ACCESS
000CA0 0E80           01141         movlw   PWM_IDLE_OUTPUT_VALUE
000CA2 6EBE           01142         movwf   CCPR1L, ACCESS
000CA4 EF?? F???      01143         goto    processSoundState_exit
                      01144 
                      01145         ;**********************************************************************
                      01146         ; Record Begin
                      01147 
000CA8                01148 processSoundState_recordGo
                      01149         ;**** start procedure: record sample ****
                      01150 
                      01151         ; don't start recording until recordWaitCountdown == 0x00
                      01152         ; recordWaitCountdown value is set by INT1 (record button) ISR
000CA8 523B           01153         movf    recordWaitCountdown, f, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 146


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000CAA E0??           01154         bz              processSoundState_recordGoForRealz
000CAC 063B           01155         decf    recordWaitCountdown, f, ACCESS
000CAE EF?? F???      01156         goto    processSoundState_exit
                      01157 
Warning[208]: Label truncated at 32 characters. (processSoundState_recordGoForRealz)
000CB2                01158 processSoundState_recordGoForRealz
                      01159 
                      01160         ; update recordOrPlayback state to RECORD
000CB2 0E01           01161         movlw   RECORD
000CB4 6E1F           01162         movwf   recordOrPlayback, ACCESS
                      01163 
                      01164         ;**** start procedure: write sample into data buffer ****
                      01165         ; sampleDataBuffer[sampleDataBufferIndex] = sample
000CB6 5011           01166         movf    sampleDataBufferIndex, w, ACCESS
000CB8 C02C FFEB      01167         movff   sample, PLUSW_sampleDataBuffer
                      01168         
                      01169         ; increment index
000CBC 2A11           01170         incf    sampleDataBufferIndex, f, ACCESS
                      01171 
                      01172         ; check buffer capacity
                      01173         ; buffer is full if sampleDataBufferIndex is == SAMPLE_DATA_BUFFER_SIZE
000CBE 0E40           01174         movlw   SAMPLE_DATA_BUFFER_SIZE
000CC0 6211           01175         cpfseq  sampleDataBufferIndex, ACCESS
                      01176         ; buffer is not full, our work here is done
000CC2 D???           01177         bra             processSoundState_exit
                      01178 
                      01179         ; reset sampleDataBufferIndex to 0x0
000CC4 6A11           01180         clrf    sampleDataBufferIndex, ACCESS
                      01181         ; set sampleChunkReady flag to indicate that sample buffer is ready for EEPEROM write
000CC6 8017           01182         bsf             eepromFlags, sampleChunkReady, ACCESS
                      01183         ; sampleChunkCount indicates how many times the sample buffer has been filled, increment it
000CC8 2A12           01184         incf    sampleChunkCount, f, ACCESS
                      01185 
                      01186         ; buffer is full and ready for writing
                      01187 
                      01188         ; not using 'sample' to hold sample data anymore so change variable alias to 'tmpValue'
                      01189         #define         tmpValue        sample
                      01190         
                      01191         ; MOVED THIS TO MAINLINE WHICH WAITS FOR SAMPLECHUNKREADY TO BE SET
                      01192         ; write sampleDataBuffer to EEPROM. Call takes 548uS @ 16MHz clock and 4MHz SPI clock
                      01193 ;       call    eepromWrite64
                      01194         ; sample chunk has been written so clear sampleChunkReadyFlag
                      01195 ;       bcf             eepromFlags, sampleChunkReady, ACCESS
                      01196 
                      01197         ;**** start procedure: should we stop recording? ****
                      01198         ; if EEPROM is full then stop recording
000CCA 0EFA           01199         movlw   ((EEPROM_SIZE_BITS/8) / SAMPLE_DATA_BUFFER_SIZE)
000CCC 1812           01200         xorwf   sampleChunkCount, w, ACCESS
000CCE B4D8           01201         btfsc   STATUS, Z, ACCESS
000CD0 D???           01202         bra             processSoundState_stopRecording
                      01203 
                      01204         ; if turnSoundOn or keyPressed is set then stop recording
                      01205         ; either flag being set indicates that a new Note On message has been received since record star
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 147


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            t
                      01206         ; this allows for using MIDI Note On message to set sample length
000CD2 B610           01207         btfsc   midiFlags, turnSoundOn, ACCESS
000CD4 D???           01208         bra             processSoundState_stopRecording
000CD6 AA10           01209         btfss   midiFlags, keyPressed, ACCESS
                      01210 
                      01211         ; EEPROM is not full and no Note On has been received since record start so keep recording, exit
                             ISR
000CD8 EF?? F???      01212         goto    processSoundState_exit
                      01213 
                      01214         ;**** start procedure: stop recording ****
000CDC                01215 processSoundState_stopRecording
                      01216         ; set mode back to Playback
000CDC 0E02           01217         movlw   PLAYBACK
000CDE 6E1F           01218         movwf   recordOrPlayback, ACCESS
                      01219 
                      01220         ; leave PWM output at PWM_IDLE_OUTPUT_VALUE
000CE0 0E80           01221         movlw   PWM_IDLE_OUTPUT_VALUE
000CE2 6EBE           01222         movwf   CCPR1L, ACCESS
                      01223         
                      01224         ; use sampleChunkCount to calculate EEPROM end address
                      01225         ; sampleEndAddress = (sampleChunkCount * SAMPLE_DATA_BUFFER_SIZE) - 1
000CE4 0E40           01226         movlw   SAMPLE_DATA_BUFFER_SIZE
000CE6 0212           01227         mulwf   sampleChunkCount, ACCESS
000CE8 0E01           01228         movlw   1
000CEA 5EF3           01229         subwf   PRODL, f, ACCESS
000CEC A0D8           01230         btfss   STATUS, C, ACCESS
000CEE 06F4           01231         decf    PRODH, f, ACCESS
                      01232 
                      01233         ; save sample end address to RAM for immediate playback
000CF0 CFF3 F013      01234         movff   PRODL, sampleEndAddress
000CF4 CFF4 F014      01235         movff   PRODH, sampleEndAddress + 1
                      01236 
                      01237         ; save sample end address to on-chip EEPROM
                      01238         ; during power-up device init, initExternalEeprom() reads on-chip EEPROM address into RAM variab
                            le sampleEndAddress
                      01239         ; write address low byte
                      01240         WRITE_INTERNAL_EEPROM   0, sampleEndAddress
  0000                    M         local   writeIntEE_loop
                          M         
                          M         ; load address
000CF8 0E00               M         movlw   0
000CFA 6EA9               M         movwf   EEADR, ACCESS
                          M         ; load value
000CFC C013 FFA8          M         movff   sampleEndAddress, EEDATA
                          M         ; configure eeprom
                          M         ; point to EEPROM DATA memory
000D00 9EA6               M         bcf             EECON1, EEPGD, ACCESS
                          M         ; Access EEPROM/Program
000D02 9CA6               M         bcf             EECON1, CFGS, ACCESS    
                          M         ; Enable writes
000D04 84A6               M         bsf             EECON1, WREN, ACCESS
                          M 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 148


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; don't have to disable interrupts because I'm only calling this
                          M         ; from within the high-priority ISR
                          M 
                          M         ; required write enable sequence
000D06 0E55               M         movlw   0x55
000D08 6EA7               M         movwf   EECON2, ACCESS
000D0A 0EAA               M         movlw   0xAA
000D0C 6EA7               M         movwf   EECON2, ACCESS
                          M 
                          M         ; set WR bit to begin write
000D0E 82A6               M         bsf             EECON1, WR, ACCESS
000D10                    M writeIntEE_loop
                          M         ; wait for write to complete
000D10 B2A6               M         btfsc   EECON1, WR, ACCESS
000D12 D???               M         bra             writeIntEE_loop
                          M         ; disable writes
000D14 94A6               M         bcf             EECON1, WREN, ACCESS
                          M 
                          M         ; point to Program memory
000D16 8EA6               M         bsf             EECON1, EEPGD, ACCESS
                          M 
                      01241         ; write address high byte
                      01242         WRITE_INTERNAL_EEPROM   1, (sampleEndAddress + 1)
  0000                    M         local   writeIntEE_loop
                          M         
                          M         ; load address
000D18 0E01               M         movlw   1
000D1A 6EA9               M         movwf   EEADR, ACCESS
                          M         ; load value
000D1C C014 FFA8          M         movff   (sampleEndAddress + 1), EEDATA
                          M         ; configure eeprom
                          M         ; point to EEPROM DATA memory
000D20 9EA6               M         bcf             EECON1, EEPGD, ACCESS
                          M         ; Access EEPROM/Program
000D22 9CA6               M         bcf             EECON1, CFGS, ACCESS    
                          M         ; Enable writes
000D24 84A6               M         bsf             EECON1, WREN, ACCESS
                          M 
                          M         ; don't have to disable interrupts because I'm only calling this
                          M         ; from within the high-priority ISR
                          M 
                          M         ; required write enable sequence
000D26 0E55               M         movlw   0x55
000D28 6EA7               M         movwf   EECON2, ACCESS
000D2A 0EAA               M         movlw   0xAA
000D2C 6EA7               M         movwf   EECON2, ACCESS
                          M 
                          M         ; set WR bit to begin write
000D2E 82A6               M         bsf             EECON1, WR, ACCESS
000D30                    M writeIntEE_loop
                          M         ; wait for write to complete
000D30 B2A6               M         btfsc   EECON1, WR, ACCESS
000D32 D???               M         bra             writeIntEE_loop
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 149


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; disable writes
000D34 94A6               M         bcf             EECON1, WREN, ACCESS
                          M 
                          M         ; point to Program memory
000D36 8EA6               M         bsf             EECON1, EEPGD, ACCESS
                          M 
                      01243 
                      01244         ; reset accumulators for good measure
                      01245         CLEAR_ACCUMULATORS
  0000                    M         local   loop
                          M 
                          M         ; init local variables
                          M         PUSH_R  r0
000D38 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                          M         PUSH_R  FSR0L
000D3C CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                          M         PUSH_R  FSR0H
000D40 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                          M         
                          M         ; load fsr
000D44 EE00 F0D1          M         lfsr    FSR0, accumulators
                          M 
                          M         ; init count
000D48 5023               M         movf    polyDepth, w, ACCESS
000D4A 6E03               M         movwf   r0, ACCESS
000D4C                    M loop    
                          M         ; each accumulator is 4 bytes wide
000D4C 6AEE               M         clrf    POSTINC0, ACCESS        
000D4E 6AEE               M         clrf    POSTINC0, ACCESS        
000D50 6AEE               M         clrf    POSTINC0, ACCESS        
000D52 6AEE               M         clrf    POSTINC0, ACCESS        
                          M         ; decrement count, skip if done
000D54 2E03               M         decfsz  r0, f, ACCESS
000D56 D???               M         bra             loop
                          M 
                          M         ; restore variables
                          M         POP_R   FSR0H
000D58 CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                          M         POP_R   FSR0L
000D5C CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                          M         POP_R   r0
000D60 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                          M         
                      01246 
                      01247         ; fixes bug if key was held during record start
000D64 9810           01248         bcf             midiFlags, turnSoundOff, ACCESS
                      01249 
000D66 D???           01250         bra             processSoundState_exit
                      01251 
                      01252         ; undefine local FSRs
                      01253         #undefine       FSR_sampleDataBuffer
                      01254         #undefine       PLUSW_sampleDataBuffer
                      01255 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 150


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01256         ;**********************************************************************
                      01257         ; Playback Begin
                      01258 
000D68                01259 processSoundState_Playback      
                      01260         ;**** start procedure: playback waveform or sample ****
                      01261 
                      01262         ; not using 'tmpValue' to hold anymore so change variable alias to 'count'
                      01263         #undefine       tmpValue
                      01264         #define         count   sample
                      01265                 
                      01266         ;**** start procedure: should we make any noise? ****
                      01267         ; if soundOn is set then continue to generate sound
000D68 BC10           01268         btfsc   midiFlags, soundOn, ACCESS
000D6A D???           01269         bra             processSoundState_SoundOn
                      01270 
                      01271         ; if turnSoundOn is set then start generating sound
000D6C A610           01272         btfss   midiFlags, turnSoundOn, ACCESS
                      01273         ; neither is set so reset sound gen state and exit ISR
                      01274 ;       bra             processSoundState_reset
000D6E D???           01275         bra             processSoundState_SoundOn
                      01276         ; request has been made for sound to turn on so do it
000D70 9610           01277         bcf             midiFlags, turnSoundOn, ACCESS
000D72 8C10           01278         bsf             midiFlags, soundOn, ACCESS
                      01279         ; for SAMPLE mode, clear the samplesLoaded flag to tell the mainline that you need a new sample
000D74 9217           01280         bcf             eepromFlags, samplesLoaded, ACCESS
                      01281         
                      01282         ;**** start procedure: make some noise ****
000D76                01283 processSoundState_SoundOn
                      01284         ;**** start procedure: update oscillator states ****
                      01285         ; if waveShape is == SINE or SQUARE then macro will update oscillator's activeOutputValue regist
                            er
                      01286         ; if waveShape is == SAMPLE and samplesLoaded flag is set then macro will clear flag and load ne
                            xtSampleAddress register
                      01287         OSC_STATE_BLOCK 0
  0000                    M         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
  0000                    M         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                          M                 
                          M         ; if oscillator is locked for sustain then leave it alone
000D76 B02B               M         btfsc   sustainFlags, 0,          ACCESS
000D78 D???               M         bra             oscActive
                          M                         
000D7A                    M checkDelegating
                          M         ; don't update if delegator is busy because delegatedDelta value is volatile
000D7A B018               M         btfsc   soundGenFlags, delegatorBusy, ACCESS
                          M         ; delegator is busy so just keep spinning
000D7C D???               M         bra             oscCheckActive
                          M         
                          M         ; THRESHOLD METHOD WORKS WELL
000D7E 0E00               M         movlw   SINE
000D80 621E               M         cpfseq waveShape, ACCESS
000D82 D???               M         bra             oscCheckNotSine
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 151


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
000D84 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000D86 5DE1               M         subwf   activeOutputValues + 0,          w
                          M         ; invert if negative
000D88 A0D8               M         btfss   STATUS, C, ACCESS
000D8A 6CE8               M         negf    WREG, ACCESS
                          M         ; check if offset is below threshold value
                          M         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
000D8C 0804               M         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                          M         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
000D8E E3??               M         bnc             oscCheckActive
                          M 
000D90                    M oscCheckNotSine
                          M 
                          M         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
000D90 C0C1 F0C9          M         movff   delegatedDeltas + (0          * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (0      
                                * OSC_DELTAS_ELEMENT_SIZE) + 0
000D94 C0C2 F0CA          M         movff   delegatedDeltas + (0          * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (0      
                                * OSC_DELTAS_ELEMENT_SIZE) + 1
                          M 
000D98                    M oscCheckActive
                          M         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                          M         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
000D98 53C9               M         movf    oscDeltas                       + (0          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
000D9A E1??               M         bnz             oscActive
000D9C 53CA               M         movf    oscDeltas                       + (0          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
000D9E E0??               M         bz              resetOscillator
                          M         
000DA0                    M oscActive
                          M         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
000DA0 B02A               M         btfsc   oscResetFlags, 0,          ACCESS
000DA2 D???               M         bra             zeroAcc
                          M 
                          M         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += activeNoteDelta
                          M         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
000DA4 51C9               M         movf    oscDeltas                       + (0          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, w
000DA6 27D1               M         addwf   accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
000DA8 51CA               M         movf    oscDeltas                       + (0          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
000DAA 23D2               M         addwfc  accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
000DAC 0E00               M         movlw   0
000DAE 23D3               M         addwfc  accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
000DB0 23D4               M         addwfc  accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 152


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000DB2                    M zeroAcc
                          M         ; we're done with oscResetFlags flag so ensure that it's clear
000DB2 902A               M         bcf             oscResetFlags, 0,          ACCESS
                          M         
                          M         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += pitchWheel
000DB4 5019               M         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
000DB6 27D1               M         addwf   accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
000DB8 501A               M         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
000DBA 23D2               M         addwfc  accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
000DBC 501B               M         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
000DBE 23D3               M         addwfc  accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
000DC0 501C               M         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
000DC2 23D4               M         addwfc  accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
                          M         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                          M         ; branch to waveform specific table address load
000DC4 0E02               M         movlw   SAMPLE
000DC6 621E               M         cpfseq  waveShape, ACCESS
000DC8 D???               M         bra             waveIsNotSample
000DCA                    M waveIsSample
                          M 
                          M         ; if samplesLoaded flag is set then load next EEPROM read address
                          M         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                          M         ; being able to load the samples in time, cause audio chopping rather than detuning
000DCA A217               M         btfss   eepromFlags, samplesLoaded, ACCESS
000DCC D???               M         bra             macroDone
                          M         
                          M         ; check for note transition
                          M         ; keyPressed flag is set every time a MIDI Note On message is received
                          M         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
                             beginning...
                          M         ; whenever a Note On message is received.
000DCE AA10               M         btfss   midiFlags, keyPressed, ACCESS
000DD0 D???               M         bra             noTransition
                          M         ; is modeLevel == POLY
000DD2 0E00               M         movlw   POLY
000DD4 1820               M         xorwf   modeLevel, w, ACCESS
                          M         ; mode is POLY so reset accumulator to restart sample from beginning
000DD6 E0??               M         bz              clrSampleAcc
                          M 
000DD8                    M noTransition    
                          M         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                          M         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 153


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; is waveTableIndex > sampleEndAddress?
000DD8 51D2               M         movf    accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
000DDA 5C13               M         subwf   sampleEndAddress, w, ACCESS
000DDC 51D3               M         movf    accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
000DDE 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
                          M         ; result is positive so waveTableIndex is within valid range
000DE0 E2??               M         bc              addressOk
                          M         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                          M         ; reset accumulator
000DE2                    M clrSampleAcc
000DE2 6BD1               M         clrf    accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
000DE4 6BD2               M         clrf    accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
000DE6 6BD3               M         clrf    accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
000DE8 6BD4               M         clrf    accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
000DEA                    M addressOk
                          M         
                          M         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
000DEA C0D2 F0B1          M         movff   accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (0          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
000DEE C0D3 F0B2          M         movff   accumulators            + (0          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (0          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                          M         
000DF2 D???               M         bra             macroDone
                          M         
000DF4                    M waveIsNotSample
                          M         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                          M         ; branch to waveform specific table address load
000DF4 0E00               M         movlw   SINE
000DF6 621E               M         cpfseq  waveShape, ACCESS
000DF8 D???               M         bra             waveIsSquare
                          M 
000DFA                    M waveIsSine      
                          M         ; 
                          M         ; load address of SINE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
000DFA 51D2               M         movf    accumulators + (0          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
000DFC 2424               M         addwf   sineTableBaseAddress + 0, w
000DFE 6EF6               M         movwf   TBLPTRL, ACCESS
000E00 5025               M         movf    sineTableBaseAddress + 1, w
000E02 B0D8               M         btfsc   STATUS, C, ACCESS
000E04 0F01               M         addlw   1
000E06 6EF7               M         movwf   TBLPTRH, ACCESS
000E08 5026               M         movf    sineTableBaseAddress + 2, w
000E0A B0D8               M         btfsc   STATUS, C, ACCESS
000E0C 0F01               M         addlw   1
000E0E 6EF8               M         movwf   TBLPTRU, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 154


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000E10 D???               M         bra             tableAddressLoaded
                          M 
000E12                    M waveIsSquare
                          M         ; load address of SQUARE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
000E12 51D2               M         movf    accumulators + (0          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
000E14 2427               M         addwf   squareTableBaseAddress + 0, w
000E16 6EF6               M         movwf   TBLPTRL, ACCESS
000E18 5028               M         movf    squareTableBaseAddress + 1, w
000E1A B0D8               M         btfsc   STATUS, C, ACCESS
000E1C 0F01               M         addlw   1
000E1E 6EF7               M         movwf   TBLPTRH, ACCESS
000E20 5029               M         movf    squareTableBaseAddress + 2, w
000E22 B0D8               M         btfsc   STATUS, C, ACCESS
000E24 0F01               M         addlw   1
000E26 6EF8               M         movwf   TBLPTRU, ACCESS
                          M 
000E28                    M tableAddressLoaded
                          M         ; read value from program memory
000E28 0008               M         tblrd*
000E2A CFF5 F0E1          M         movff   TABLAT, activeOutputValues + (0          * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
000E2E D???               M         bra             macroDone
                          M         
000E30                    M resetOscillator
                          M         ; set oscillator reset flag
000E30 802A               M         bsf             oscResetFlags, 0,          ACCESS
000E32 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000E34 6FE1               M         movwf   activeOutputValues + (0          * ACTIVE_OUTPUT_VALUES_EL_SIZE)
000E36 6BC9               M         clrf    oscDeltas + (0          * OSC_DELTAS_ELEMENT_SIZE) + 0
000E38 6BCA               M         clrf    oscDeltas + (0          * OSC_DELTAS_ELEMENT_SIZE) + 1
000E3A 6BD1               M         clrf    accumulators + (0          * ACCUMULATORS_ELEMENT_SIZE) + 0
000E3C 6BD2               M         clrf    accumulators + (0          * ACCUMULATORS_ELEMENT_SIZE) + 1
000E3E 6BD3               M         clrf    accumulators + (0          * ACCUMULATORS_ELEMENT_SIZE) + 2
000E40 6BD4               M         clrf    accumulators + (0          * ACCUMULATORS_ELEMENT_SIZE) + 3
                          M 
000E42                    M macroDone
                          M 
                      01288         OSC_STATE_BLOCK 1
  0000                    M         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
  0000                    M         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                          M                 
                          M         ; if oscillator is locked for sustain then leave it alone
000E42 B22B               M         btfsc   sustainFlags, 1,          ACCESS
000E44 D???               M         bra             oscActive
                          M                         
000E46                    M checkDelegating
                          M         ; don't update if delegator is busy because delegatedDelta value is volatile
000E46 B018               M         btfsc   soundGenFlags, delegatorBusy, ACCESS
                          M         ; delegator is busy so just keep spinning
000E48 D???               M         bra             oscCheckActive
                          M         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 155


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; THRESHOLD METHOD WORKS WELL
000E4A 0E00               M         movlw   SINE
000E4C 621E               M         cpfseq waveShape, ACCESS
000E4E D???               M         bra             oscCheckNotSine
                          M         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
000E50 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000E52 5DE2               M         subwf   activeOutputValues + 1,          w
                          M         ; invert if negative
000E54 A0D8               M         btfss   STATUS, C, ACCESS
000E56 6CE8               M         negf    WREG, ACCESS
                          M         ; check if offset is below threshold value
                          M         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
000E58 0804               M         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                          M         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
000E5A E3??               M         bnc             oscCheckActive
                          M 
000E5C                    M oscCheckNotSine
                          M 
                          M         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
000E5C C0C3 F0CB          M         movff   delegatedDeltas + (1          * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (1      
                                * OSC_DELTAS_ELEMENT_SIZE) + 0
000E60 C0C4 F0CC          M         movff   delegatedDeltas + (1          * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (1      
                                * OSC_DELTAS_ELEMENT_SIZE) + 1
                          M 
000E64                    M oscCheckActive
                          M         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                          M         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
000E64 53CB               M         movf    oscDeltas                       + (1          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
000E66 E1??               M         bnz             oscActive
000E68 53CC               M         movf    oscDeltas                       + (1          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
000E6A E0??               M         bz              resetOscillator
                          M         
000E6C                    M oscActive
                          M         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
000E6C B22A               M         btfsc   oscResetFlags, 1,          ACCESS
000E6E D???               M         bra             zeroAcc
                          M 
                          M         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += activeNoteDelta
                          M         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
000E70 51CB               M         movf    oscDeltas                       + (1          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, w
000E72 27D5               M         addwf   accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
000E74 51CC               M         movf    oscDeltas                       + (1          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
000E76 23D6               M         addwfc  accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
000E78 0E00               M         movlw   0
000E7A 23D7               M         addwfc  accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 156


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            + 2, f
000E7C 23D8               M         addwfc  accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
000E7E                    M zeroAcc
                          M         ; we're done with oscResetFlags flag so ensure that it's clear
000E7E 922A               M         bcf             oscResetFlags, 1,          ACCESS
                          M         
                          M         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += pitchWheel
000E80 5019               M         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
000E82 27D5               M         addwf   accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
000E84 501A               M         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
000E86 23D6               M         addwfc  accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
000E88 501B               M         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
000E8A 23D7               M         addwfc  accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
000E8C 501C               M         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
000E8E 23D8               M         addwfc  accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
                          M         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                          M         ; branch to waveform specific table address load
000E90 0E02               M         movlw   SAMPLE
000E92 621E               M         cpfseq  waveShape, ACCESS
000E94 D???               M         bra             waveIsNotSample
000E96                    M waveIsSample
                          M 
                          M         ; if samplesLoaded flag is set then load next EEPROM read address
                          M         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                          M         ; being able to load the samples in time, cause audio chopping rather than detuning
000E96 A217               M         btfss   eepromFlags, samplesLoaded, ACCESS
000E98 D???               M         bra             macroDone
                          M         
                          M         ; check for note transition
                          M         ; keyPressed flag is set every time a MIDI Note On message is received
                          M         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
                             beginning...
                          M         ; whenever a Note On message is received.
000E9A AA10               M         btfss   midiFlags, keyPressed, ACCESS
000E9C D???               M         bra             noTransition
                          M         ; is modeLevel == POLY
000E9E 0E00               M         movlw   POLY
000EA0 1820               M         xorwf   modeLevel, w, ACCESS
                          M         ; mode is POLY so reset accumulator to restart sample from beginning
000EA2 E0??               M         bz              clrSampleAcc
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 157


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M 
000EA4                    M noTransition    
                          M         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                          M         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
                          M         ; is waveTableIndex > sampleEndAddress?
000EA4 51D6               M         movf    accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
000EA6 5C13               M         subwf   sampleEndAddress, w, ACCESS
000EA8 51D7               M         movf    accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
000EAA 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
                          M         ; result is positive so waveTableIndex is within valid range
000EAC E2??               M         bc              addressOk
                          M         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                          M         ; reset accumulator
000EAE                    M clrSampleAcc
000EAE 6BD5               M         clrf    accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
000EB0 6BD6               M         clrf    accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
000EB2 6BD7               M         clrf    accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
000EB4 6BD8               M         clrf    accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
000EB6                    M addressOk
                          M         
                          M         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
000EB6 C0D6 F0B3          M         movff   accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (1          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
000EBA C0D7 F0B4          M         movff   accumulators            + (1          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (1          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                          M         
000EBE D???               M         bra             macroDone
                          M         
000EC0                    M waveIsNotSample
                          M         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                          M         ; branch to waveform specific table address load
000EC0 0E00               M         movlw   SINE
000EC2 621E               M         cpfseq  waveShape, ACCESS
000EC4 D???               M         bra             waveIsSquare
                          M 
000EC6                    M waveIsSine      
                          M         ; 
                          M         ; load address of SINE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
000EC6 51D6               M         movf    accumulators + (1          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
000EC8 2424               M         addwf   sineTableBaseAddress + 0, w
000ECA 6EF6               M         movwf   TBLPTRL, ACCESS
000ECC 5025               M         movf    sineTableBaseAddress + 1, w
000ECE B0D8               M         btfsc   STATUS, C, ACCESS
000ED0 0F01               M         addlw   1
000ED2 6EF7               M         movwf   TBLPTRH, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 158


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000ED4 5026               M         movf    sineTableBaseAddress + 2, w
000ED6 B0D8               M         btfsc   STATUS, C, ACCESS
000ED8 0F01               M         addlw   1
000EDA 6EF8               M         movwf   TBLPTRU, ACCESS
000EDC D???               M         bra             tableAddressLoaded
                          M 
000EDE                    M waveIsSquare
                          M         ; load address of SQUARE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
000EDE 51D6               M         movf    accumulators + (1          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
000EE0 2427               M         addwf   squareTableBaseAddress + 0, w
000EE2 6EF6               M         movwf   TBLPTRL, ACCESS
000EE4 5028               M         movf    squareTableBaseAddress + 1, w
000EE6 B0D8               M         btfsc   STATUS, C, ACCESS
000EE8 0F01               M         addlw   1
000EEA 6EF7               M         movwf   TBLPTRH, ACCESS
000EEC 5029               M         movf    squareTableBaseAddress + 2, w
000EEE B0D8               M         btfsc   STATUS, C, ACCESS
000EF0 0F01               M         addlw   1
000EF2 6EF8               M         movwf   TBLPTRU, ACCESS
                          M 
000EF4                    M tableAddressLoaded
                          M         ; read value from program memory
000EF4 0008               M         tblrd*
000EF6 CFF5 F0E2          M         movff   TABLAT, activeOutputValues + (1          * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
000EFA D???               M         bra             macroDone
                          M         
000EFC                    M resetOscillator
                          M         ; set oscillator reset flag
000EFC 822A               M         bsf             oscResetFlags, 1,          ACCESS
000EFE 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000F00 6FE2               M         movwf   activeOutputValues + (1          * ACTIVE_OUTPUT_VALUES_EL_SIZE)
000F02 6BCB               M         clrf    oscDeltas + (1          * OSC_DELTAS_ELEMENT_SIZE) + 0
000F04 6BCC               M         clrf    oscDeltas + (1          * OSC_DELTAS_ELEMENT_SIZE) + 1
000F06 6BD5               M         clrf    accumulators + (1          * ACCUMULATORS_ELEMENT_SIZE) + 0
000F08 6BD6               M         clrf    accumulators + (1          * ACCUMULATORS_ELEMENT_SIZE) + 1
000F0A 6BD7               M         clrf    accumulators + (1          * ACCUMULATORS_ELEMENT_SIZE) + 2
000F0C 6BD8               M         clrf    accumulators + (1          * ACCUMULATORS_ELEMENT_SIZE) + 3
                          M 
000F0E                    M macroDone
                          M 
                      01289         OSC_STATE_BLOCK 2
  0000                    M         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
  0000                    M         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                          M                 
                          M         ; if oscillator is locked for sustain then leave it alone
000F0E B42B               M         btfsc   sustainFlags, 2,          ACCESS
000F10 D???               M         bra             oscActive
                          M                         
000F12                    M checkDelegating
                          M         ; don't update if delegator is busy because delegatedDelta value is volatile
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 159


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000F12 B018               M         btfsc   soundGenFlags, delegatorBusy, ACCESS
                          M         ; delegator is busy so just keep spinning
000F14 D???               M         bra             oscCheckActive
                          M         
                          M         ; THRESHOLD METHOD WORKS WELL
000F16 0E00               M         movlw   SINE
000F18 621E               M         cpfseq waveShape, ACCESS
000F1A D???               M         bra             oscCheckNotSine
                          M         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
000F1C 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000F1E 5DE3               M         subwf   activeOutputValues + 2,          w
                          M         ; invert if negative
000F20 A0D8               M         btfss   STATUS, C, ACCESS
000F22 6CE8               M         negf    WREG, ACCESS
                          M         ; check if offset is below threshold value
                          M         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
000F24 0804               M         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                          M         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
000F26 E3??               M         bnc             oscCheckActive
                          M 
000F28                    M oscCheckNotSine
                          M 
                          M         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
000F28 C0C5 F0CD          M         movff   delegatedDeltas + (2          * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (2      
                                * OSC_DELTAS_ELEMENT_SIZE) + 0
000F2C C0C6 F0CE          M         movff   delegatedDeltas + (2          * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (2      
                                * OSC_DELTAS_ELEMENT_SIZE) + 1
                          M 
000F30                    M oscCheckActive
                          M         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                          M         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
000F30 53CD               M         movf    oscDeltas                       + (2          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
000F32 E1??               M         bnz             oscActive
000F34 53CE               M         movf    oscDeltas                       + (2          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
000F36 E0??               M         bz              resetOscillator
                          M         
000F38                    M oscActive
                          M         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
000F38 B42A               M         btfsc   oscResetFlags, 2,          ACCESS
000F3A D???               M         bra             zeroAcc
                          M 
                          M         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += activeNoteDelta
                          M         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
000F3C 51CD               M         movf    oscDeltas                       + (2          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, w
000F3E 27D9               M         addwf   accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
000F40 51CE               M         movf    oscDeltas                       + (2          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 160


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000F42 23DA               M         addwfc  accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
000F44 0E00               M         movlw   0
000F46 23DB               M         addwfc  accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
000F48 23DC               M         addwfc  accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
000F4A                    M zeroAcc
                          M         ; we're done with oscResetFlags flag so ensure that it's clear
000F4A 942A               M         bcf             oscResetFlags, 2,          ACCESS
                          M         
                          M         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += pitchWheel
000F4C 5019               M         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
000F4E 27D9               M         addwf   accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
000F50 501A               M         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
000F52 23DA               M         addwfc  accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
000F54 501B               M         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
000F56 23DB               M         addwfc  accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
000F58 501C               M         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
000F5A 23DC               M         addwfc  accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
                          M         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                          M         ; branch to waveform specific table address load
000F5C 0E02               M         movlw   SAMPLE
000F5E 621E               M         cpfseq  waveShape, ACCESS
000F60 D???               M         bra             waveIsNotSample
000F62                    M waveIsSample
                          M 
                          M         ; if samplesLoaded flag is set then load next EEPROM read address
                          M         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                          M         ; being able to load the samples in time, cause audio chopping rather than detuning
000F62 A217               M         btfss   eepromFlags, samplesLoaded, ACCESS
000F64 D???               M         bra             macroDone
                          M         
                          M         ; check for note transition
                          M         ; keyPressed flag is set every time a MIDI Note On message is received
                          M         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
                             beginning...
                          M         ; whenever a Note On message is received.
000F66 AA10               M         btfss   midiFlags, keyPressed, ACCESS
000F68 D???               M         bra             noTransition
                          M         ; is modeLevel == POLY
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 161


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000F6A 0E00               M         movlw   POLY
000F6C 1820               M         xorwf   modeLevel, w, ACCESS
                          M         ; mode is POLY so reset accumulator to restart sample from beginning
000F6E E0??               M         bz              clrSampleAcc
                          M 
000F70                    M noTransition    
                          M         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                          M         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
                          M         ; is waveTableIndex > sampleEndAddress?
000F70 51DA               M         movf    accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
000F72 5C13               M         subwf   sampleEndAddress, w, ACCESS
000F74 51DB               M         movf    accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
000F76 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
                          M         ; result is positive so waveTableIndex is within valid range
000F78 E2??               M         bc              addressOk
                          M         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                          M         ; reset accumulator
000F7A                    M clrSampleAcc
000F7A 6BD9               M         clrf    accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
000F7C 6BDA               M         clrf    accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
000F7E 6BDB               M         clrf    accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
000F80 6BDC               M         clrf    accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
000F82                    M addressOk
                          M         
                          M         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
000F82 C0DA F0B5          M         movff   accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (2          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
000F86 C0DB F0B6          M         movff   accumulators            + (2          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (2          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                          M         
000F8A D???               M         bra             macroDone
                          M         
000F8C                    M waveIsNotSample
                          M         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                          M         ; branch to waveform specific table address load
000F8C 0E00               M         movlw   SINE
000F8E 621E               M         cpfseq  waveShape, ACCESS
000F90 D???               M         bra             waveIsSquare
                          M 
000F92                    M waveIsSine      
                          M         ; 
                          M         ; load address of SINE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
000F92 51DA               M         movf    accumulators + (2          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
000F94 2424               M         addwf   sineTableBaseAddress + 0, w
000F96 6EF6               M         movwf   TBLPTRL, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 162


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000F98 5025               M         movf    sineTableBaseAddress + 1, w
000F9A B0D8               M         btfsc   STATUS, C, ACCESS
000F9C 0F01               M         addlw   1
000F9E 6EF7               M         movwf   TBLPTRH, ACCESS
000FA0 5026               M         movf    sineTableBaseAddress + 2, w
000FA2 B0D8               M         btfsc   STATUS, C, ACCESS
000FA4 0F01               M         addlw   1
000FA6 6EF8               M         movwf   TBLPTRU, ACCESS
000FA8 D???               M         bra             tableAddressLoaded
                          M 
000FAA                    M waveIsSquare
                          M         ; load address of SQUARE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
000FAA 51DA               M         movf    accumulators + (2          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
000FAC 2427               M         addwf   squareTableBaseAddress + 0, w
000FAE 6EF6               M         movwf   TBLPTRL, ACCESS
000FB0 5028               M         movf    squareTableBaseAddress + 1, w
000FB2 B0D8               M         btfsc   STATUS, C, ACCESS
000FB4 0F01               M         addlw   1
000FB6 6EF7               M         movwf   TBLPTRH, ACCESS
000FB8 5029               M         movf    squareTableBaseAddress + 2, w
000FBA B0D8               M         btfsc   STATUS, C, ACCESS
000FBC 0F01               M         addlw   1
000FBE 6EF8               M         movwf   TBLPTRU, ACCESS
                          M 
000FC0                    M tableAddressLoaded
                          M         ; read value from program memory
000FC0 0008               M         tblrd*
000FC2 CFF5 F0E3          M         movff   TABLAT, activeOutputValues + (2          * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
000FC6 D???               M         bra             macroDone
                          M         
000FC8                    M resetOscillator
                          M         ; set oscillator reset flag
000FC8 842A               M         bsf             oscResetFlags, 2,          ACCESS
000FCA 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000FCC 6FE3               M         movwf   activeOutputValues + (2          * ACTIVE_OUTPUT_VALUES_EL_SIZE)
000FCE 6BCD               M         clrf    oscDeltas + (2          * OSC_DELTAS_ELEMENT_SIZE) + 0
000FD0 6BCE               M         clrf    oscDeltas + (2          * OSC_DELTAS_ELEMENT_SIZE) + 1
000FD2 6BD9               M         clrf    accumulators + (2          * ACCUMULATORS_ELEMENT_SIZE) + 0
000FD4 6BDA               M         clrf    accumulators + (2          * ACCUMULATORS_ELEMENT_SIZE) + 1
000FD6 6BDB               M         clrf    accumulators + (2          * ACCUMULATORS_ELEMENT_SIZE) + 2
000FD8 6BDC               M         clrf    accumulators + (2          * ACCUMULATORS_ELEMENT_SIZE) + 3
                          M 
000FDA                    M macroDone
                          M 
                      01290         OSC_STATE_BLOCK 3
  0000                    M         local   checkDelegating, oscCheckActive, zeroAcc, oscActive, waveIsSample, noTransition, oscChec
                            kNotSine
  0000                    M         local   clrSampleAcc, addressOk, waveIsNotSample, waveIsSine, waveIsSquare, tableAddressLoaded, 
                            resetOscillator, macroDone
                          M                 
                          M         ; if oscillator is locked for sustain then leave it alone
000FDA B62B               M         btfsc   sustainFlags, 3,          ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 163


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

000FDC D???               M         bra             oscActive
                          M                         
000FDE                    M checkDelegating
                          M         ; don't update if delegator is busy because delegatedDelta value is volatile
000FDE B018               M         btfsc   soundGenFlags, delegatorBusy, ACCESS
                          M         ; delegator is busy so just keep spinning
000FE0 D???               M         bra             oscCheckActive
                          M         
                          M         ; THRESHOLD METHOD WORKS WELL
000FE2 0E00               M         movlw   SINE
000FE4 621E               M         cpfseq waveShape, ACCESS
000FE6 D???               M         bra             oscCheckNotSine
                          M         ; calculate absolute offset between PWM_IDLE_OUTPUT_VALUE and current activeOutputValue
000FE8 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
000FEA 5DE4               M         subwf   activeOutputValues + 3,          w
                          M         ; invert if negative
000FEC A0D8               M         btfss   STATUS, C, ACCESS
000FEE 6CE8               M         negf    WREG, ACCESS
                          M         ; check if offset is below threshold value
                          M         ; do (WREG = OSC_OUTPUT_GATE_THRESHOLD - WREG)
000FF0 0804               M         sublw   OSC_TRANSITION_OUTPUT_THRESHOLD
                          M         ; if result is positive then activeOutputValue offset from IDLE is <= THRESHOLD so allow changes
000FF2 E3??               M         bnc             oscCheckActive
                          M 
000FF4                    M oscCheckNotSine
                          M 
                          M         ; delegator is idle and oscillator is enabled so copy delegated delta as internal
000FF4 C0C7 F0CF          M         movff   delegatedDeltas + (3          * DELEGATED_DELTAS_ELEMENT_SIZE) + 0, oscDeltas + (3      
                                * OSC_DELTAS_ELEMENT_SIZE) + 0
000FF8 C0C8 F0D0          M         movff   delegatedDeltas + (3          * DELEGATED_DELTAS_ELEMENT_SIZE) + 1, oscDeltas + (3      
                                * OSC_DELTAS_ELEMENT_SIZE) + 1
                          M 
000FFC                    M oscCheckActive
                          M         ; if oscDeltas[OSC_NUMBER] == 0x00 then oscillator is not really active so reset
                          M         ; this check is required in event that (activeOutput == 0 && delegatorBusy == TRUE && oscDelta =
                            = 0)
000FFC 53CF               M         movf    oscDeltas                       + (3          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, f
000FFE E1??               M         bnz             oscActive
001000 53D0               M         movf    oscDeltas                       + (3          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, f
001002 E0??               M         bz              resetOscillator
                          M         
001004                    M oscActive
                          M         ; if oscillator is starting from reset state then begin with 0x0000 accumulator
001004 B62A               M         btfsc   oscResetFlags, 3,          ACCESS
001006 D???               M         bra             zeroAcc
                          M 
                          M         ;**** start procedure: step Accumulator (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += activeNoteDelta
                          M         ; accumulators are 4 bytes wide, activeNoteDeltas are 2 bytes wide
001008 51CF               M         movf    oscDeltas                       + (3          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 0, w
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 164


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00100A 27DD               M         addwf   accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
00100C 51D0               M         movf    oscDeltas                       + (3          * OSC_DELTAS_ELEMENT_SIZE)                
                                    + 1, w  
00100E 23DE               M         addwfc  accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
001010 0E00               M         movlw   0
001012 23DF               M         addwfc  accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
001014 23E0               M         addwfc  accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
001016                    M zeroAcc
                          M         ; we're done with oscResetFlags flag so ensure that it's clear
001016 962A               M         bcf             oscResetFlags, 3,          ACCESS
                          M         
                          M         ;**** start procedure: handle Pitch Wheel (SINE/SQUARE/SAMPLE) ****
                          M         ; accumulator += pitchWheel
001018 5019               M         movf    pitchWheel                                                                              
                                                                            + 0, w, ACCESS
00101A 27DD               M         addwf   accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0, f
00101C 501A               M         movf    pitchWheel                                                                              
                                                                            + 1, w, ACCESS
00101E 23DE               M         addwfc  accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, f
001020 501B               M         movf    pitchWheel                                                                              
                                                                            + 2, w, ACCESS
001022 23DF               M         addwfc  accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, f
001024 501C               M         movf    pitchWheel                                                                              
                                                                            + 3, w, ACCESS
001026 23E0               M         addwfc  accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3, f
                          M         
                          M         ;**** start procedure: if SAMPLE waveshape then load next read address  (SAMPLE ONLY) ****
                          M         ; branch to waveform specific table address load
001028 0E02               M         movlw   SAMPLE
00102A 621E               M         cpfseq  waveShape, ACCESS
00102C D???               M         bra             waveIsNotSample
00102E                    M waveIsSample
                          M 
                          M         ; if samplesLoaded flag is set then load next EEPROM read address
                          M         ; checking this here as opposed to before accumulator update will, in the event of the mainline 
                            not
                          M         ; being able to load the samples in time, cause audio chopping rather than detuning
00102E A217               M         btfss   eepromFlags, samplesLoaded, ACCESS
001030 D???               M         bra             macroDone
                          M         
                          M         ; check for note transition
                          M         ; keyPressed flag is set every time a MIDI Note On message is received
                          M         ; when a sample is playing back in POLY or SUSTAIN modes, we want the sample to restart from the
                             beginning...
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 165


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; whenever a Note On message is received.
001032 AA10               M         btfss   midiFlags, keyPressed, ACCESS
001034 D???               M         bra             noTransition
                          M         ; is modeLevel == POLY
001036 0E00               M         movlw   POLY
001038 1820               M         xorwf   modeLevel, w, ACCESS
                          M         ; mode is POLY so reset accumulator to restart sample from beginning
00103A E0??               M         bz              clrSampleAcc
                          M 
00103C                    M noTransition    
                          M         ; nextSampleAddress = ((accumulator >> 8) & 0xffff)
                          M         ; reset accumulator if nextSampleAddress value will exceed sampleEndAddress
                          M         ; is waveTableIndex > sampleEndAddress?
00103C 51DE               M         movf    accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, w
00103E 5C13               M         subwf   sampleEndAddress, w, ACCESS
001040 51DF               M         movf    accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, w
001042 5814               M         subwfb  sampleEndAddress + 1, w, ACCESS
                          M         ; result is positive so waveTableIndex is within valid range
001044 E2??               M         bc              addressOk
                          M         ; ((accumulator >> 8) & 0xffff) is out of valid sample range so restart sample from beginning
                          M         ; reset accumulator
001046                    M clrSampleAcc
001046 6BDD               M         clrf    accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 0
001048 6BDE               M         clrf    accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1
00104A 6BDF               M         clrf    accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2
00104C 6BE0               M         clrf    accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 3
00104E                    M addressOk
                          M         
                          M         ; do nextSampleAddress = ((accumulator >> 8) & 0xffff)
00104E C0DE F0B7          M         movff   accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 1, nextSampleAddresses + (3          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 0
001052 C0DF F0B8          M         movff   accumulators            + (3          * ACCUMULATORS_ELEMENT_SIZE)                      
                            + 2, nextSampleAddresses + (3          * NEXT_SAMPLE_ADDRESSES_EL_SIZE) + 1
                          M         
001056 D???               M         bra             macroDone
                          M         
001058                    M waveIsNotSample
                          M         ;**** start procedure: waveshape is SINE or SQUARE so read Program Memory table  (SINE/SQUARE ON
                            LY) ****
                          M         ; branch to waveform specific table address load
001058 0E00               M         movlw   SINE
00105A 621E               M         cpfseq  waveShape, ACCESS
00105C D???               M         bra             waveIsSquare
                          M 
00105E                    M waveIsSine      
                          M         ; 
                          M         ; load address of SINE table read
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 166


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M         ; offset = ((accumulator >> 8) & 0xff)
00105E 51DE               M         movf    accumulators + (3          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
001060 2424               M         addwf   sineTableBaseAddress + 0, w
001062 6EF6               M         movwf   TBLPTRL, ACCESS
001064 5025               M         movf    sineTableBaseAddress + 1, w
001066 B0D8               M         btfsc   STATUS, C, ACCESS
001068 0F01               M         addlw   1
00106A 6EF7               M         movwf   TBLPTRH, ACCESS
00106C 5026               M         movf    sineTableBaseAddress + 2, w
00106E B0D8               M         btfsc   STATUS, C, ACCESS
001070 0F01               M         addlw   1
001072 6EF8               M         movwf   TBLPTRU, ACCESS
001074 D???               M         bra             tableAddressLoaded
                          M 
001076                    M waveIsSquare
                          M         ; load address of SQUARE table read
                          M         ; offset = ((accumulator >> 8) & 0xff)
001076 51DE               M         movf    accumulators + (3          * ACCUMULATORS_ELEMENT_SIZE) + 1, w
001078 2427               M         addwf   squareTableBaseAddress + 0, w
00107A 6EF6               M         movwf   TBLPTRL, ACCESS
00107C 5028               M         movf    squareTableBaseAddress + 1, w
00107E B0D8               M         btfsc   STATUS, C, ACCESS
001080 0F01               M         addlw   1
001082 6EF7               M         movwf   TBLPTRH, ACCESS
001084 5029               M         movf    squareTableBaseAddress + 2, w
001086 B0D8               M         btfsc   STATUS, C, ACCESS
001088 0F01               M         addlw   1
00108A 6EF8               M         movwf   TBLPTRU, ACCESS
                          M 
00108C                    M tableAddressLoaded
                          M         ; read value from program memory
00108C 0008               M         tblrd*
00108E CFF5 F0E4          M         movff   TABLAT, activeOutputValues + (3          * ACTIVE_OUTPUT_VALUES_EL_SIZE) + 0
001092 D???               M         bra             macroDone
                          M         
001094                    M resetOscillator
                          M         ; set oscillator reset flag
001094 862A               M         bsf             oscResetFlags, 3,          ACCESS
001096 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
001098 6FE4               M         movwf   activeOutputValues + (3          * ACTIVE_OUTPUT_VALUES_EL_SIZE)
00109A 6BCF               M         clrf    oscDeltas + (3          * OSC_DELTAS_ELEMENT_SIZE) + 0
00109C 6BD0               M         clrf    oscDeltas + (3          * OSC_DELTAS_ELEMENT_SIZE) + 1
00109E 6BDD               M         clrf    accumulators + (3          * ACCUMULATORS_ELEMENT_SIZE) + 0
0010A0 6BDE               M         clrf    accumulators + (3          * ACCUMULATORS_ELEMENT_SIZE) + 1
0010A2 6BDF               M         clrf    accumulators + (3          * ACCUMULATORS_ELEMENT_SIZE) + 2
0010A4 6BE0               M         clrf    accumulators + (3          * ACCUMULATORS_ELEMENT_SIZE) + 3
                          M 
0010A6                    M macroDone
                          M 
                      01291         
                      01292         ; keyPressed is handled in OSC_STATE_BLOCK macro so clear flag
                      01293         ; if(samplesLoaded && waveShape == SAMPLE){keyPressed = FALSE;}
                      01294         ; else{keyPressed = FALSE;}
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 167


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0010A6 0E02           01295         movlw   SAMPLE
0010A8 181E           01296         xorwf   waveShape, w, ACCESS
                      01297         ; if waveShape != SAMPLE then clear keyPressed flag
0010AA E1??           01298         bnz             processSoundState_clearTransFlag
                      01299         ; waveShape is == SAMPLE so only clear keyPressed if samplesLoaded == TRUE
0010AC B217           01300         btfsc   eepromFlags, samplesLoaded, ACCESS
0010AE                01301 processSoundState_clearTransFlag
0010AE 9A10           01302         bcf             midiFlags, keyPressed, ACCESS
                      01303 
                      01304         ; samplesLoaded is handled in OSC_STATE_BLOCK macro so clear if set
0010B0 9217           01305         bcf             eepromFlags, samplesLoaded, ACCESS
                      01306 
                      01307         ;**** start procedure: send data to PWM ****
0010B2                01308 processSoundState_mixer
                      01309         ; **** averaging signal mixer ****      
                      01310         ; average all active output values into mixedOutput             
                      01311         ; init mixedOutput
0010B2 6A2D           01312         clrf    mixedOutputL, ACCESS
0010B4 6A2E           01313         clrf    mixedOutputH, ACCESS
                      01314 
                      01315         ; mix OSC0
                      01316         OSC_MIX 0       
  0000                    M         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                          M                 
                          M         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
0010B6 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
0010B8 5DE1               M         subwf   activeOutputValues + 0,          w
0010BA E3??               M         bnc             mixDoNeg
0010BC                    M mixDoPos
                          M         ; WREG = adsrLimiterRegs/2
0010BC 90D8               M         bcf             STATUS, C, ACCESS
0010BE 3033               M         rrcf    adsrLimiterRegs + 0,          w, ACCESS
0010C0 5DE1               M         subwf   activeOutputValues + 0,          w
0010C2 D???               M         bra             mixDoDone
0010C4                    M mixDoNeg
                          M         ; WREG = adsrLimiterRegs/2
0010C4 90D8               M         bcf             STATUS, C, ACCESS
0010C6 3033               M         rrcf    adsrLimiterRegs + 0,          w, ACCESS
0010C8 25E1               M         addwf   activeOutputValues + 0,          w      
0010CA                    M mixDoDone
                          M         ; overflow indicates that last operation toggled bit 7
0010CA B6D8               M         btfsc   STATUS, OV, ACCESS
0010CC 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
                          M 
0010CE                    M mixDone
                          M         ; add WREG to mixedOutputL/H
0010CE 262D               M         addwf   mixedOutputL, f, ACCESS
0010D0 B0D8               M         btfsc   STATUS, C, ACCESS
0010D2 2A2E               M         incf    mixedOutputH, f, ACCESS
                          M         
                      01317         
                      01318         ; mix OSC1
                      01319         OSC_MIX 1
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 168


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

  0000                    M         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                          M                 
                          M         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
0010D4 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
0010D6 5DE2               M         subwf   activeOutputValues + 1,          w
0010D8 E3??               M         bnc             mixDoNeg
0010DA                    M mixDoPos
                          M         ; WREG = adsrLimiterRegs/2
0010DA 90D8               M         bcf             STATUS, C, ACCESS
0010DC 3034               M         rrcf    adsrLimiterRegs + 1,          w, ACCESS
0010DE 5DE2               M         subwf   activeOutputValues + 1,          w
0010E0 D???               M         bra             mixDoDone
0010E2                    M mixDoNeg
                          M         ; WREG = adsrLimiterRegs/2
0010E2 90D8               M         bcf             STATUS, C, ACCESS
0010E4 3034               M         rrcf    adsrLimiterRegs + 1,          w, ACCESS
0010E6 25E2               M         addwf   activeOutputValues + 1,          w      
0010E8                    M mixDoDone
                          M         ; overflow indicates that last operation toggled bit 7
0010E8 B6D8               M         btfsc   STATUS, OV, ACCESS
0010EA 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
                          M 
0010EC                    M mixDone
                          M         ; add WREG to mixedOutputL/H
0010EC 262D               M         addwf   mixedOutputL, f, ACCESS
0010EE B0D8               M         btfsc   STATUS, C, ACCESS
0010F0 2A2E               M         incf    mixedOutputH, f, ACCESS
                          M         
                      01320         
                      01321         ; mix OSC2
                      01322         OSC_MIX 2
  0000                    M         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                          M                 
                          M         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
0010F2 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
0010F4 5DE3               M         subwf   activeOutputValues + 2,          w
0010F6 E3??               M         bnc             mixDoNeg
0010F8                    M mixDoPos
                          M         ; WREG = adsrLimiterRegs/2
0010F8 90D8               M         bcf             STATUS, C, ACCESS
0010FA 3035               M         rrcf    adsrLimiterRegs + 2,          w, ACCESS
0010FC 5DE3               M         subwf   activeOutputValues + 2,          w
0010FE D???               M         bra             mixDoDone
001100                    M mixDoNeg
                          M         ; WREG = adsrLimiterRegs/2
001100 90D8               M         bcf             STATUS, C, ACCESS
001102 3035               M         rrcf    adsrLimiterRegs + 2,          w, ACCESS
001104 25E3               M         addwf   activeOutputValues + 2,          w      
001106                    M mixDoDone
                          M         ; overflow indicates that last operation toggled bit 7
001106 B6D8               M         btfsc   STATUS, OV, ACCESS
001108 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
                          M 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 169


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00110A                    M mixDone
                          M         ; add WREG to mixedOutputL/H
00110A 262D               M         addwf   mixedOutputL, f, ACCESS
00110C B0D8               M         btfsc   STATUS, C, ACCESS
00110E 2A2E               M         incf    mixedOutputH, f, ACCESS
                          M         
                      01323         
                      01324         ; mix OSC3
                      01325         OSC_MIX 3
  0000                    M         local   mixDone, mixDoPos, mixDoNeg, mixDoDone
                          M                 
                          M         ; check polarity of current activeOutputValue compared to PWM_IDLE_OUTPUT_VALUE
001110 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
001112 5DE4               M         subwf   activeOutputValues + 3,          w
001114 E3??               M         bnc             mixDoNeg
001116                    M mixDoPos
                          M         ; WREG = adsrLimiterRegs/2
001116 90D8               M         bcf             STATUS, C, ACCESS
001118 3036               M         rrcf    adsrLimiterRegs + 3,          w, ACCESS
00111A 5DE4               M         subwf   activeOutputValues + 3,          w
00111C D???               M         bra             mixDoDone
00111E                    M mixDoNeg
                          M         ; WREG = adsrLimiterRegs/2
00111E 90D8               M         bcf             STATUS, C, ACCESS
001120 3036               M         rrcf    adsrLimiterRegs + 3,          w, ACCESS
001122 25E4               M         addwf   activeOutputValues + 3,          w      
001124                    M mixDoDone
                          M         ; overflow indicates that last operation toggled bit 7
001124 B6D8               M         btfsc   STATUS, OV, ACCESS
001126 0E80               M         movlw   PWM_IDLE_OUTPUT_VALUE
                          M 
001128                    M mixDone
                          M         ; add WREG to mixedOutputL/H
001128 262D               M         addwf   mixedOutputL, f, ACCESS
00112A B0D8               M         btfsc   STATUS, C, ACCESS
00112C 2A2E               M         incf    mixedOutputH, f, ACCESS
                          M         
                      01326                 
                      01327         ; do (mixedOutput /= 4) to evenly mix all oscillators
00112E 90D8           01328         bcf             STATUS, C, ACCESS
001130 322E           01329         rrcf    mixedOutputH, f, ACCESS
001132 322D           01330         rrcf    mixedOutputL, f, ACCESS
001134 90D8           01331         bcf             STATUS, C, ACCESS
001136 322E           01332         rrcf    mixedOutputH, f, ACCESS
001138 322D           01333         rrcf    mixedOutputL, f, ACCESS
                      01334 
                      01335         ; send final mixed signal to PWM!
00113A C02D FFBE      01336         movff   mixedOutputL, CCPR1L
                      01337 
00113E                01338 processSoundState_soundOnDone
                      01339         
00113E                01340 processSoundState_exit
                      01341         ; push working regs onto software stack
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 170


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01342         POP_R   PRODH
00113E CFDC FFF4          M         movff   softwareStackPointerPREINC, PRODH       ; ++softwareStackPointerINDF = regName
                      01343         POP_R   PRODL
001142 CFDC FFF3          M         movff   softwareStackPointerPREINC, PRODL       ; ++softwareStackPointerINDF = regName
                      01344         POP_R   TABLAT
001146 CFDC FFF5          M         movff   softwareStackPointerPREINC, TABLAT      ; ++softwareStackPointerINDF = regName
                      01345         POP_R   TBLPTRU
00114A CFDC FFF8          M         movff   softwareStackPointerPREINC, TBLPTRU     ; ++softwareStackPointerINDF = regName
                      01346         POP_R   TBLPTRH
00114E CFDC FFF7          M         movff   softwareStackPointerPREINC, TBLPTRH     ; ++softwareStackPointerINDF = regName
                      01347         POP_R   TBLPTRL
001152 CFDC FFF6          M         movff   softwareStackPointerPREINC, TBLPTRL     ; ++softwareStackPointerINDF = regName
                      01348         POP_R   FSR1H
001156 CFDC FFE2          M         movff   softwareStackPointerPREINC, FSR1H       ; ++softwareStackPointerINDF = regName
                      01349         POP_R   FSR1L
00115A CFDC FFE1          M         movff   softwareStackPointerPREINC, FSR1L       ; ++softwareStackPointerINDF = regName
                      01350         POP_R   FSR0H
00115E CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      01351         POP_R   FSR0L   
001162 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      01352 
                      01353         ; FSRs all undefined locally in functions
                      01354                 
001166 0012           01355         return          
                      01356         
                      01357 
                      01358         ; ***********************************************************************
                      01359         ; Function: void processSoundState(void)
                      01360         ; ***********************************************************************
001168                01361 serviceADSR     
                      01362         ; test prescale counter to determine if it's time to service adsr
                      01363         ; perform (adsrPrescaleCounter - ADSR_PRESCALE)
                      01364         ; if result is positive, then (adsrPrescaleCounter >= ADSR_PRESCALE) == TRUE
                      01365 
                      01366         PUSH_R  r0
001168 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01367         PUSH_R  r1
00116C C004 FFDD          M         movff   r1,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01368         PUSH_R  r2
001170 C005 FFDD          M         movff   r2,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01369         PUSH_R  FSR0L
001174 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01370         PUSH_R  FSR0H
001178 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01371 
                      01372         #define oscNumber r0
                      01373         #define oscNumberMask r1
                      01374         #define tmpValue r2
                      01375                 
                      01376         ; do subtract
00117C 0E62           01377         movlw   low(ADSR_PRESCALE)
00117E 5C39           01378         subwf   adsrPrescaleCounter + 0, w, ACCESS
001180 0E02           01379         movlw   high(ADSR_PRESCALE)
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 171


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001182 583A           01380         subwfb adsrPrescaleCounter + 1, w, ACCESS
                      01381         ; if result is positive then service adsr
001184 A0D8           01382         btfss   STATUS, C, ACCESS       
                      01383         ; result was negative so exit
001186 D???           01384         bra             serviceADSR_exit
                      01385         
                      01386         ; reset adsrPrescaleCounter
001188 6A39           01387         clrf    adsrPrescaleCounter + 0, ACCESS
00118A 6A3A           01388         clrf    adsrPrescaleCounter + 1, ACCESS
                      01389         
00118C 6A03           01390         clrf    oscNumber, ACCESS
00118E 0E01           01391         movlw   1
001190 6E04           01392         movwf   oscNumberMask, ACCESS
001192                01393 serviceADSRLoop
                      01394         ; ignore advance if oscillator is sustained
001192 5004           01395         movf    oscNumberMask, w, ACCESS
001194 142B           01396         andwf   sustainFlags, w, ACCESS
001196 E1??           01397         bnz             serviceADSR_oscDone
                      01398         
001198 EE00 F02F      01399         lfsr    FSR0, oscStateFlags
00119C 5003           01400         movf    oscNumber, w, ACCESS
00119E B6EB           01401         btfsc   PLUSW0, attack, ACCESS
0011A0 D???           01402         bra             doAttack
0011A2 B0EB           01403         btfsc   PLUSW0, release, ACCESS
0011A4 D???           01404         bra             doRelease
0011A6 D???           01405         bra             serviceADSR_oscDone
                      01406         
0011A8                01407 doAttack
                      01408         ; osc is attacking
                      01409 
                      01410         ; test condition ((adsrLimiterRegs -= ADSR_ATTACK_RATE) <=0)
0011A8 EE00 F033      01411         lfsr    FSR0, adsrLimiterRegs
0011AC 5003           01412         movf    oscNumber, w, ACCESS
                      01413         ; tmpValue = (*(adsrLimiterRegs + OSC_NUMBER))
0011AE CFEB F005      01414         movff   PLUSW0, tmpValue
0011B2 5037           01415         movf    adsrAttackRate, w, ACCESS
0011B4 5C05           01416         subwf   tmpValue, w, ACCESS
0011B6 E3??           01417         bnc             attackDone
0011B8 E0??           01418         bz              attackDone
                      01419 
                      01420         ; condition is FALSE so do the subtraction and exit
                      01421         ; (adsrLimiterRegs -= ADSR_ATTACK_RATE)
0011BA 5003           01422         movf    oscNumber, w, ACCESS
                      01423         ; tmpValue = (*(adsrLimiterRegs + OSC_NUMBER))
0011BC CFEB F005      01424         movff   PLUSW0, tmpValue
0011C0 5037           01425         movf    adsrAttackRate, w, ACCESS
0011C2 5E05           01426         subwf   tmpValue, f, ACCESS
0011C4 5003           01427         movf    oscNumber, w, ACCESS
0011C6 C005 FFEB      01428         movff   tmpValue, PLUSW0
0011CA D???           01429         bra             serviceADSR_oscDone
                      01430 
0011CC                01431 attackDone
0011CC EE00 F02F      01432         lfsr    FSR0, oscStateFlags
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 172


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0011D0 5003           01433         movf    oscNumber, w, ACCESS
                      01434         ; clear attack flag
0011D2 96EB           01435         bcf             PLUSW0, attack, ACCESS
0011D4 EE00 F033      01436         lfsr    FSR0, adsrLimiterRegs
                      01437         ; WREG still == oscNumber
0011D8 6AEB           01438         clrf    PLUSW0, ACCESS
0011DA D???           01439         bra     serviceADSR_oscDone
                      01440 
0011DC                01441 doRelease
                      01442         ; osc is releasing
                      01443 
                      01444         ; test condition: ((adsrLimiterRegs + ADSR_RELEASE_RATE) >= 255)
0011DC EE00 F033      01445         lfsr    FSR0, adsrLimiterRegs
0011E0 5003           01446         movf    oscNumber, w, ACCESS
                      01447         ; tmpValue = (*(adsrLimiterRegs + OSC_NUMBER))
0011E2 CFEB F005      01448         movff   PLUSW0, tmpValue
0011E6 5038           01449         movf    adsrReleaseRate, w, ACCESS
0011E8 2405           01450         addwf   tmpValue, w, ACCESS
                      01451         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
0011EA E2??           01452         bc              releaseDone
0011EC 1CE8           01453         comf    WREG, w, ACCESS
                      01454         ; condition is TRUE so skip the addition and leave adsrLimiterRegs at its current value
0011EE E0??           01455         bz              releaseDone
                      01456 
                      01457         ; condition is FALSE so do the addition and exit
                      01458         ; do (adsrLimiterRegs += ADSR_RELEASE_RATE)     
                      01459         ; FSR0 still == adsrLimiterRegs
0011F0 5003           01460         movf    oscNumber, w, ACCESS
                      01461         ; tmpValue = (*(adsrLimiterRegs + OSC_NUMBER))
0011F2 CFEB F005      01462         movff   PLUSW0, tmpValue
0011F6 5038           01463         movf    adsrReleaseRate, w, ACCESS
0011F8 2605           01464         addwf   tmpValue, f, ACCESS
0011FA 5003           01465         movf    oscNumber, w, ACCESS
0011FC C005 FFEB      01466         movff   tmpValue, PLUSW0        
001200 D???           01467         bra             serviceADSR_oscDone
                      01468         
001202                01469 releaseDone
                      01470         ; clear release flag
001202 EE00 F02F      01471         lfsr    FSR0, oscStateFlags
001206 5003           01472         movf    oscNumber, w, ACCESS
001208 90EB           01473         bcf             PLUSW0, release, ACCESS
                      01474         ; set limit reg to max
00120A EE00 F033      01475         lfsr    FSR0, adsrLimiterRegs
                      01476         ; WREG still == oscNumber
00120E 68EB           01477         setf    PLUSW0, ACCESS
                      01478         ; clear oscillator's delegatedDelta
001210 EE00 F0C1      01479         lfsr    FSR0, delegatedDeltas
001214 90D8           01480         bcf             STATUS, C, ACCESS
001216 3403           01481         rlcf    oscNumber, w, ACCESS
001218 6AEB           01482         clrf    PLUSW0;
00121A 0F01           01483         addlw   1
00121C 6AEB           01484         clrf    PLUSW0; 
                      01485 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 173


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00121E                01486 serviceADSR_oscDone
                      01487         ; increment oscNumber mask
00121E 90D8           01488         bcf             STATUS, C, ACCESS
001220 3604           01489         rlcf    oscNumberMask, f, ACCESS
                      01490         ; increment oscNumber and check if done
001222 2A03           01491         incf    oscNumber, f, ACCESS
001224 5023           01492         movf    polyDepth, w, ACCESS
001226 6203           01493         cpfseq oscNumber, ACCESS
                      01494         ; not done so continue
001228 D???           01495         bra             serviceADSRLoop
                      01496 
00122A                01497 serviceADSR_exit
                      01498         #undefine       oscNumber
                      01499         #undefine       oscNumberMask
                      01500         #undefine       tmpValue
                      01501 
                      01502         POP_R   FSR0H
00122A CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      01503         POP_R   FSR0L
00122E CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      01504         POP_R   r2
001232 CFDC F005          M         movff   softwareStackPointerPREINC, r2          ; ++softwareStackPointerINDF = regName
                      01505         POP_R   r1
001236 CFDC F004          M         movff   softwareStackPointerPREINC, r1          ; ++softwareStackPointerINDF = regName
                      01506         POP_R   r0
00123A CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      01507 
00123E 0012           01508         return
                      01509 
                      01510         ; ***********************************************************************
                      01511         ; Function: void oscAdsrTriggerAttack(void)
                      01512         ; ***********************************************************************
                      01513         ; This function is called only by theDelegator() for one of the following reasons:
                      01514         ; - An activeNoteDeltas element has just been assigned to an oscillator that satisfies one of th
                            e following conditions:
                      01515         ;   -- The oscillator's delegatedDelta value == 0 and has no match in activeNoteDeltas[] (oscill
                            ator is idle)
                      01516         ;   -- The oscillator's delegatedDelta value does not match any element in activeNoteDeltas (may
                             be releasing)
                      01517         ; - An oscillator's delegatedDelta matches an element in activeNoteDeltas, and the oscillator is
                             releasing
                      01518         ;
001240                01519 oscAdsrTriggerAttack
                      01520 ; oscillator number passed in WREG
                      01521 
                      01522         ; push working regs onto software stack
                      01523         PUSH_R  r0
001240 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01524         PUSH_R  FSR0L
001244 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01525         PUSH_R  FSR0H
001248 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01526         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 174


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      01527         ; r0 = oscillator #
00124C 6E03           01528         movwf           r0, ACCESS
                      01529         
                      01530         ; load fsr to first deal with adsrLimiterRegs
00124E EE00 F033      01531         lfsr    FSR0, adsrLimiterRegs
                      01532 
                      01533         ; if adsrAttackRate == 64 then attack is disabled
001252 0E40           01534         movlw           64
001254 6237           01535         cpfseq  adsrAttackRate, ACCESS
001256 D???           01536         bra                     oscAdsrTriggerAttackActive
                      01537 
                      01538         ; ADSR IS DISABLED
                      01539         ; WREG = oscillator #
001258 5003           01540         movf    r0, w, ACCESS
                      01541         ; clear limiterReg to ensure that waveform amplitude is not attenuated
00125A 6AEB           01542         clrf    PLUSW0, ACCESS
                      01543         ; load fsr to modify adsr flags
00125C EE00 F02F      01544         lfsr    FSR0, oscStateFlags
                      01545         ; clear attack flag
001260 96EB           01546         bcf     PLUSW0, attack, ACCESS  
                      01547         ; clear attack flag
001262 90EB           01548         bcf     PLUSW0, release, ACCESS 
                      01549 
001264 D???           01550         bra             oscAdsrTriggerAttackExit
                      01551         
                      01552         ; ADSR IS ACTIVE
001266                01553 oscAdsrTriggerAttackActive
                      01554         ; if release is disabled, set limiterReg to start with full-attenuation of waveform amplitude
                      01555         ; otherwise, leave it alone to reduce reattack popping
001266 0E40           01556         movlw   64
001268 1838           01557         xorwf   adsrReleaseRate, w, ACCESS
00126A E1??           01558         bnz             oscAdsrTriggerAttackNoReAttack
                      01559         ; set adsrLimiterReg to 0xff on attack if releaseRate == 64 (releaseTime == 0)
                      01560         ; WREG = oscillator #
00126C 5003           01561         movf    r0, w, ACCESS
00126E 68EB           01562         setf    PLUSW0, ACCESS
                      01563 
001270                01564 oscAdsrTriggerAttackNoReAttack
                      01565 
                      01566         ; load fsr to modify adsr flags
001270 EE00 F02F      01567         lfsr    FSR0, oscStateFlags
                      01568         ; WREG = oscillator #
001274 5003           01569         movf    r0, w, ACCESS
                      01570         ; set attack flag
001276 86EB           01571         bsf     PLUSW0, attack, ACCESS
                      01572         ; clear release flag
001278 90EB           01573         bcf     PLUSW0, release, ACCESS
                      01574                 
00127A                01575 oscAdsrTriggerAttackExit
                      01576         ; restore working regs from stack
                      01577         POP_R   FSR0H
00127A CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      01578         POP_R   FSR0L
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 175


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00127E CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      01579         POP_R   r0
001282 CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      01580         
001286 0012           01581         return
                      01582         
                      01583 
                      01584         ; ***********************************************************************
                      01585         ; Function: void oscAdsrTriggerRelease(void)
                      01586         ; ***********************************************************************
                      01587         ; This function is called only by theDelegator() for the following reason:
                      01588         ; - An oscillator's delegatedDelta != 0 and does not match any element in activeNoteDeltas
                      01589         ; Note, that theDelegator does not currently check whether the oscillator is already releasing b
                            efore call
001288                01590 oscAdsrTriggerRelease
                      01591 ; oscillator number passed in WREG
                      01592 
                      01593         ; push working regs onto software stack
                      01594         PUSH_R  r0
001288 C003 FFDD          M         movff   r0,      softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01595         PUSH_R  FSR0L
00128C CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01596         PUSH_R  FSR0H
001290 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      01597         
                      01598         ; r0 = oscillator #
001294 6E03           01599         movwf           r0, ACCESS
                      01600 
                      01601         ; if adsrReleaseRate == 64 then leave limiterReg where it is and clear delegatedDeltas to signal
                             stop to delegator
001296 0E40           01602         movlw   64
                      01603         ; if adsrReleaseRate == 64 then release is disabled
001298 6238           01604         cpfseq  adsrReleaseRate, ACCESS
00129A D???           01605         bra             oscAdsrTriggerReleaseActive
                      01606 
                      01607         ; RELEASE IS DISABLED
                      01608         ; load fsr to modify adsr flag
00129C EE00 F02F      01609         lfsr    FSR0, oscStateFlags
                      01610         ; WREG = oscillator #
0012A0 5003           01611         movf    r0, w, ACCESS
                      01612         ; clear release flag
0012A2 90EB           01613         bcf     PLUSW0, release, ACCESS
                      01614         ; clear attack flag
0012A4 96EB           01615         bcf     PLUSW0, attack, ACCESS
                      01616 
                      01617         ; clear oscillator's delegatedDelta
                      01618         ; load fsr with base address of delegatedDeltas array
0012A6 EE00 F0C1      01619         lfsr    FSR0, delegatedDeltas
                      01620         ; add oscillator offset to fsr
                      01621         ; delegatedDeltas are two-bytes wide so WREG = r0*2
0012AA 90D8           01622         bcf     STATUS, C, ACCESS
0012AC 3403           01623         rlcf    r0, w, ACCESS
                      01624         ; add offset to low byte of FSR
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 176


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0012AE 26E9           01625         addwf FSR0L, f, ACCESS
                      01626         ; increment high byte of FSR if CARRY is set
0012B0 B0D8           01627         btfsc   STATUS, C, ACCESS
0012B2 2AEA           01628         incf    FSR0H, f, ACCESS
                      01629         ; clear low byte
0012B4 6AEE           01630         clrf    POSTINC0, ACCESS
                      01631         ; clear high byte
0012B6 6AEF           01632         clrf    INDF0, ACCESS
                      01633 
0012B8 D???           01634         bra             oscAdsrTriggerReleaseExit
                      01635         
                      01636         ; RELEASE IS ACTIVE
0012BA                01637 oscAdsrTriggerReleaseActive
                      01638         ; load fsr to modify adsr flag
0012BA EE00 F02F      01639         lfsr    FSR0, oscStateFlags
                      01640         ; WREG = oscillator #
0012BE 5003           01641         movf    r0, w, ACCESS
                      01642         ; set release flag
0012C0 80EB           01643         bsf     PLUSW0, release, ACCESS
                      01644         ; clear attack flag
0012C2 96EB           01645         bcf     PLUSW0, attack, ACCESS
                      01646                 
0012C4                01647 oscAdsrTriggerReleaseExit
                      01648         ; restore working regs from stack
                      01649         POP_R   FSR0H
0012C4 CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      01650         POP_R   FSR0L
0012C8 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
                      01651         POP_R   r0
0012CC CFDC F003          M         movff   softwareStackPointerPREINC, r0          ; ++softwareStackPointerINDF = regName
                      01652 
0012D0 0012           01653         return
                      00309         #include        "../source/userInterface.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      userInterface.asm                                 *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 177


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00021         
                      00022 ;**********************************************************************
                      00023 ; INCLUDES
                      00024 ;**********************************************************************
                      00025 
                      00026 ;**********************************************************************
                      00027 ; DEFINITIONS
                      00028 ;**********************************************************************
                      00029 
                      00030 ;**********************************************************************
                      00031 ; LOCAL VARIABLES
                      00032 ;**********************************************************************
                      00033 
                      00034         CBLOCK
  0000003C            00035                 ledBlinkRate:1
  0000003D            00036                 ledBlinkCounter:1
  0000003E            00037                 ledOnOffFlags:1
                      00038         ENDC
                      00039 
                      00040 
                      00041 ;**********************************************************************
                      00042 ; LOCAL FUNCTIONS
                      00043 ;**********************************************************************
                      00044 
                      00045 ;**********************************************************************
                      00046 ; Function: void initUserInterface(void)
                      00047 ;**********************************************************************
                      00048 
0012D2                00049 initUserInterface:
                      00050 
                      00051                 ; init with steady state LED
0012D2 6A3C           00052                 clrf    ledBlinkRate, ACCESS
0012D4 6A3D           00053                 clrf    ledBlinkCounter, ACCESS
                      00054         
0012D6 0012           00055         return
                      00056         
                      00057 
                      00058 ;**********************************************************************
                      00059 ; Function: void userInterface_incMode(void)
                      00060 ;**********************************************************************
0012D8                00061 userInterface_incMode
                      00062         ; mode is changing so set needDelgator flag
0012D8 8418           00063         bsf             soundGenFlags, needRefresh, ACCESS
                      00064         
                      00065         ; increment modeLevel, reset if > MAX_MODE_LEVEL
0012DA 2A20           00066         incf    modeLevel, f, ACCESS
0012DC 0E03           00067         movlw   MAX_MODE_LEVEL + 1
                      00068         ; skip if modeLevel < MAX_MODE_LEVEL + 1
0012DE 6020           00069         cpfslt  modeLevel, ACCESS
0012E0 6A20           00070         clrf    modeLevel, ACCESS
                      00071         
                      00072         ; if(modeLevel == POLY)
                      00073         ; {
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 178


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00074         ;   polyDepth = MAX_POLY_DEPTH
                      00075         ;   ledBlinkRate = LEVEL_POLY_LED_BLINK_RATE
                      00076         ;   ledBlinkCounter = LEVEL_POLY_LED_BLINK_RATE
                      00077         ;       sustainFlags = 0
                      00078         ; }
0012E2 0E00           00079         movlw   POLY
0012E4 6220           00080         cpfseq  modeLevel, ACCESS
0012E6 D???           00081         bra             userInterface_incModeCheckSustain
0012E8 0E04           00082         movlw   MAX_POLY_DEPTH
0012EA 6E23           00083         movwf   polyDepth, ACCESS
                      00084         ; set LED blink rate
0012EC 0E00           00085         movlw   LEVEL_POLY_LED_BLINK_RATE
0012EE 6E3C           00086         movwf   ledBlinkRate
0012F0 6E3D           00087         movwf   ledBlinkCounter
                      00088         ; clear sustain flags
                      00089         DISABLE_SUSTAIN
0012F2 6A2B               M         clrf    sustainFlags, ACCESS
0012F4 D???           00090         bra             userInterface_incModeDone
                      00091 
Warning[208]: Label truncated at 32 characters. (userInterface_incModeCheckSustain)
0012F6                00092 userInterface_incModeCheckSustain
                      00093         ; if(modeLevel == SUSTAIN)
                      00094         ; {
                      00095         ;   polyDepth = MAX_POLY_DEPTH
                      00096         ;   ledBlinkRate = LEVEL_SUSTAIN_LED_BLINK_RATE
                      00097         ;   ledBlinkCounter = LEVEL_SUSTAIN_LED_BLINK_RATE
                      00098         ;       sustainFlags = (~oscResetFlags) & 0x0f
                      00099         ; }
0012F6 0E01           00100         movlw   SUSTAIN
0012F8 6220           00101         cpfseq  modeLevel, ACCESS
0012FA D???           00102         bra             userInterface_incModeDoMono
0012FC 0E04           00103         movlw   MAX_POLY_DEPTH
0012FE 6E23           00104         movwf   polyDepth, ACCESS
001300 0E02           00105         movlw   LEVEL_SUSTAIN_LED_BLINK_RATE
001302 6E3C           00106         movwf   ledBlinkRate
001304 6E3D           00107         movwf   ledBlinkCounter
                      00108         ; set sustain lock flags for all active oscillators
                      00109         ENABLE_SUSTAIN
001306 1C2A               M         comf    oscResetFlags, w, ACCESS
001308 0B0F               M         andlw   0x0f
00130A 6E2B               M         movwf   sustainFlags, ACCESS
00130C D???           00110         bra             userInterface_incModeDone       
                      00111         
00130E                00112 userInterface_incModeDoMono
                      00113         ; if(modeLevel == MONO)
                      00114         ; {
                      00115         ;   polyDepth = 1
                      00116         ;   ledBlinkRate = LEVEL_MONO_LED_BLINK_RATE
                      00117         ;   ledBlinkCounter = LEVEL_MONO_LED_BLINK_RATE
                      00118         ;       sustainFlags = 0
                      00119         ; }
00130E 0E01           00120         movlw   1
001310 6E23           00121         movwf   polyDepth, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 179


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00122         ; set LED blink rate
001312 0E01           00123         movlw   LEVEL_MONO_LED_BLINK_RATE
001314 6E3C           00124         movwf   ledBlinkRate
001316 6E3D           00125         movwf   ledBlinkCounter
                      00126         ; clear sustain flags
                      00127         DISABLE_SUSTAIN
001318 6A2B               M         clrf    sustainFlags, ACCESS
00131A                00128 userInterface_incModeDone
00131A 0012           00129         return
                      00130 
                      00131 
                      00132 ;**********************************************************************
                      00133 ; Function: void userInterface_incWaveform(void)
                      00134 ;**********************************************************************
00131C                00135 userInterface_incWaveform
                      00136         ; waveShape is changing so set needDelgator flag
00131C 8418           00137         bsf             soundGenFlags, needRefresh, ACCESS
                      00138 
                      00139         ; check if decrement is being request from MIDI Program Change
00131E A218           00140         btfss   soundGenFlags, pgDec, ACCESS
001320 D???           00141         bra             userInterface_incWaveformInc
                      00142         ; clear Program Change decrement flag
001322 9218           00143         bcf             soundGenFlags, pgDec, ACCESS    
001324 061E           00144         decf    waveShape, f, ACCESS
                      00145         ; branch if result was positive
001326 E2??           00146         bc              userInterface_incWaveformDone
                      00147         ; result was negative so set to SAMPLE
001328 0E02           00148         movlw   SAMPLE
00132A 6E1E           00149         movwf   waveShape, ACCESS
00132C D???           00150         bra             userInterface_incWaveformDone
                      00151 
00132E                00152 userInterface_incWaveformInc
                      00153         ;       if(++waveShape > SAMPLE)
                      00154         ;               waveShape = SINE;
00132E 2A1E           00155         incf    waveShape, f, ACCESS
001330 0E02           00156         movlw   SAMPLE
001332 641E           00157         cpfsgt  waveShape, ACCESS
001334 D???           00158         bra             userInterface_incWaveformDone
001336 0E00           00159         movlw   SINE
001338 6E1E           00160         movwf   waveShape, ACCESS
00133A                00161 userInterface_incWaveformDone
00133A 0012           00162         return
                      00163         
                      00164 
                      00165 
                      00166 
                      00167 
                      00310 
                      00311 ;**********************************************************************
                      00312 
                      00313         ; include CBLOCK defines for arrays here to ensure that smaller variables are within ACCESS memo
                            ry
                      00314         CBLOCK
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 180


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00315                 ; visual marker of allocated memory when viewing file registers in debug
  0000003F            00316                 endOfVariables:1
                      00317                 ; from midi.asm
  00000040            00318                 midiRxMessage:          MAX_MIDI_MESSAGE_SIZE
  00000058            00319                 activeNoteTable:        ACTIVE_NOTE_TABLE_SIZE
                      00320                 ; from eeprom.asm
  00000071            00321                 sampleDataBuffer:       SAMPLE_DATA_BUFFER_SIZE
  000000B1            00322                 nextSampleAddresses:MAX_POLY_DEPTH * NEXT_SAMPLE_ADDRESSES_EL_SIZE
                      00323                 ; from soundGen.asm
  000000B9            00324                 activeNoteDeltas:               ACTIVE_NOTE_DELTAS_SIZE
  000000C1            00325                 delegatedDeltas:                DELEGATED_DELTAS_SIZE
  000000C9            00326                 oscDeltas:                              OSC_DELTAS_SIZE
  000000D1            00327                 accumulators:                   ACCUMULATORS_SIZE
  000000E1            00328                 activeOutputValues:             ACTIVE_OUTPUT_VALUES_SIZE
                      00329         ENDC
                      00330 
                      00331         ; set stack base address as last data mem address
                      00332 
                      00333 #ifdef PIC18LF13K50
                      00334         CBLOCK 0x2ff
  000002FF            00335                 softwareStackBaseAddress:1
                      00336         ENDC
                      00337 #endif
                      00338 #ifdef PIC18LF14K22
                      00339         CBLOCK 0x1ff
                      00340                 softwareStackBaseAddress:1
                      00341         ENDC
                      00342 #endif
                      00343                 
                      00344         #include        "../include/noteDeltaTables.inc"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      noteDeltaTables.inc                               *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 ; **** MIDI Note Delta Tables ****
                      00022 ;
                      00023 ; These tables define the "activeNoteDelta" values for all possible
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 181


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00024 ; MIDI notes, 0 - 127 (in that order).  Defining sample values
                      00025 ; separately to save cycles 
                      00026 
00133C                00027 midiNoteDeltaTable
00133C 0022           00028         dw      34
00133E 0024           00029         dw      36
001340 0026           00030         dw      38
001342 0029           00031         dw      41
001344 002B           00032         dw      43
001346 002E           00033         dw      46
001348 0030           00034         dw      48
00134A 0033           00035         dw      51
00134C 0036           00036         dw      54
00134E 003A           00037         dw      58
001350 003D           00038         dw      61
001352 0041           00039         dw      65
001354 0045           00040         dw      69
001356 0049           00041         dw      73
001358 004D           00042         dw      77
00135A 0052           00043         dw      82
00135C 0056           00044         dw      86
00135E 005C           00045         dw      92
001360 0061           00046         dw      97
001362 0067           00047         dw      103
001364 006D           00048         dw      109
001366 0073           00049         dw      115
001368 007A           00050         dw      122
00136A 0081           00051         dw      129
00136C 0089           00052         dw      137
00136E 0091           00053         dw      145
001370 009A           00054         dw      154
001372 00A3           00055         dw      163
001374 00AD           00056         dw      173
001376 00B7           00057         dw      183
001378 00C2           00058         dw      194
00137A 00CE           00059         dw      206
00137C 00DA           00060         dw      218
00137E 00E7           00061         dw      231
001380 00F4           00062         dw      244
001382 0103           00063         dw      259
001384 0112           00064         dw      274
001386 0123           00065         dw      291
001388 0134           00066         dw      308
00138A 0146           00067         dw      326
00138C 015A           00068         dw      346
00138E 016E           00069         dw      366
001390 0184           00070         dw      388
001392 019B           00071         dw      411
001394 01B3           00072         dw      435
001396 01CD           00073         dw      461
001398 01E9           00074         dw      489
00139A 0206           00075         dw      518
00139C 0225           00076         dw      549
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 182


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00139E 0245           00077         dw      581
0013A0 0268           00078         dw      616
0013A2 028C           00079         dw      652
0013A4 02B3           00080         dw      691
0013A6 02DC           00081         dw      732
0013A8 0308           00082         dw      776
0013AA 0336           00083         dw      822
0013AC 0367           00084         dw      871
0013AE 039B           00085         dw      923
0013B0 03D2           00086         dw      978
0013B2 040C           00087         dw      1036
0013B4 0449           00088         dw      1097
0013B6 048B           00089         dw      1163
0013B8 04D0           00090         dw      1232
0013BA 0519           00091         dw      1305
0013BC 0567           00092         dw      1383
0013BE 05B9           00093         dw      1465
0013C0 0610           00094         dw      1552
0013C2 066C           00095         dw      1644
0013C4 06CE           00096         dw      1742
0013C6 0735           00097         dw      1845
0013C8 07A3           00098         dw      1955
0013CA 0817           00099         dw      2071
0013CC 0893           00100         dw      2195
0013CE 0915           00101         dw      2325
0013D0 099F           00102         dw      2463
0013D2 0A32           00103         dw      2610
0013D4 0ACD           00104         dw      2765
0013D6 0B72           00105         dw      2930
0013D8 0C20           00106         dw      3104
0013DA 0CD8           00107         dw      3288
0013DC 0D9C           00108         dw      3484
0013DE 0E6B           00109         dw      3691
0013E0 0F46           00110         dw      3910
0013E2 102F           00111         dw      4143
0013E4 1125           00112         dw      4389
0013E6 122A           00113         dw      4650
0013E8 133F           00114         dw      4927
0013EA 1464           00115         dw      5220
0013EC 159A           00116         dw      5530
0013EE 16E3           00117         dw      5859
0013F0 183F           00118         dw      6207
0013F2 19B1           00119         dw      6577
0013F4 1B38           00120         dw      6968
0013F6 1CD6           00121         dw      7382
0013F8 1E8D           00122         dw      7821
0013FA 205E           00123         dw      8286
0013FC 224B           00124         dw      8779
0013FE 2455           00125         dw      9301
001400 267E           00126         dw      9854
001402 28C8           00127         dw      10440
001404 2B34           00128         dw      11060
001406 2DC6           00129         dw      11718
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 183


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001408 307F           00130         dw      12415
00140A 3361           00131         dw      13153
00140C 366F           00132         dw      13935
00140E 39AC           00133         dw      14764
001410 3D1A           00134         dw      15642
001412 40BC           00135         dw      16572
001414 4495           00136         dw      17557
001416 48A9           00137         dw      18601
001418 4CFC           00138         dw      19708
00141A 518F           00139         dw      20879
00141C 5669           00140         dw      22121
00141E 5B8C           00141         dw      23436
001420 60FE           00142         dw      24830
001422 66C2           00143         dw      26306
001424 6CDF           00144         dw      27871
001426 7358           00145         dw      29528
001428 7A34           00146         dw      31284
00142A 8178           00147         dw      33144
00142C 892B           00148         dw      35115
00142E 9153           00149         dw      37203
001430 99F7           00150         dw      39415
001432 A31F           00151         dw      41759
001434 ACD2           00152         dw      44242
001436 B719           00153         dw      46873
001438 C1FC           00154         dw      49660
00143A CD85           00155         dw      52613
                      00156 
00143C                00157 sampleMidiNoteDeltaTable
00143C 0008           00158         dw      8
00143E 0008           00159         dw      8
001440 0009           00160         dw      9
001442 000A           00161         dw      10
001444 000A           00162         dw      10
001446 000B           00163         dw      11
001448 000B           00164         dw      11
00144A 000C           00165         dw      12
00144C 000D           00166         dw      13
00144E 000D           00167         dw      13
001450 000E           00168         dw      14
001452 000F           00169         dw      15
001454 0010           00170         dw      16
001456 0011           00171         dw      17
001458 0012           00172         dw      18
00145A 0013           00173         dw      19
00145C 0014           00174         dw      20
00145E 0015           00175         dw      21
001460 0017           00176         dw      23
001462 0018           00177         dw      24
001464 0019           00178         dw      25
001466 001B           00179         dw      27
001468 001D           00180         dw      29
00146A 001E           00181         dw      30
00146C 0020           00182         dw      32
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 184


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00146E 0022           00183         dw      34
001470 0024           00184         dw      36
001472 0026           00185         dw      38
001474 0028           00186         dw      40
001476 002B           00187         dw      43
001478 002D           00188         dw      45
00147A 0030           00189         dw      48
00147C 0033           00190         dw      51
00147E 0036           00191         dw      54
001480 0039           00192         dw      57
001482 003C           00193         dw      60
001484 0040           00194         dw      64
001486 0044           00195         dw      68
001488 0048           00196         dw      72
00148A 004C           00197         dw      76
00148C 0051           00198         dw      81
00148E 0055           00199         dw      85
001490 005B           00200         dw      91
001492 0060           00201         dw      96
001494 0066           00202         dw      102
001496 006C           00203         dw      108
001498 0072           00204         dw      114
00149A 0079           00205         dw      121
00149C 0080           00206         dw      128
00149E 0088           00207         dw      136
0014A0 0090           00208         dw      144
0014A2 0098           00209         dw      152
0014A4 00A1           00210         dw      161
0014A6 00AB           00211         dw      171
0014A8 00B5           00212         dw      181
0014AA 00C0           00213         dw      192
0014AC 00CB           00214         dw      203
0014AE 00D7           00215         dw      215
0014B0 00E4           00216         dw      228
0014B2 00F2           00217         dw      242
0014B4 0100           00218         dw      256
0014B6 010F           00219         dw      271
0014B8 011F           00220         dw      287
0014BA 0130           00221         dw      304
0014BC 0143           00222         dw      323
0014BE 0156           00223         dw      342
0014C0 016A           00224         dw      362
0014C2 0180           00225         dw      384
0014C4 0196           00226         dw      406
0014C6 01AF           00227         dw      431
0014C8 01C8           00228         dw      456
0014CA 01E3           00229         dw      483
0014CC 0200           00230         dw      512
0014CE 021E           00231         dw      542
0014D0 023F           00232         dw      575
0014D2 0261           00233         dw      609
0014D4 0285           00234         dw      645
0014D6 02AB           00235         dw      683
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 185


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0014D8 02D4           00236         dw      724
0014DA 02FF           00237         dw      767
0014DC 032D           00238         dw      813
0014DE 035D           00239         dw      861
0014E0 0390           00240         dw      912
0014E2 03C7           00241         dw      967
0014E4 0400           00242         dw      1024
0014E6 043D           00243         dw      1085
0014E8 047D           00244         dw      1149
0014EA 04C2           00245         dw      1218
0014EC 050A           00246         dw      1290
0014EE 0557           00247         dw      1367
0014F0 05A8           00248         dw      1448
0014F2 05FE           00249         dw      1534
0014F4 0659           00250         dw      1625
0014F6 06BA           00251         dw      1722
0014F8 0721           00252         dw      1825
0014FA 078D           00253         dw      1933
0014FC 0800           00254         dw      2048
0014FE 087A           00255         dw      2170
001500 08FB           00256         dw      2299
001502 0983           00257         dw      2435
001504 0A14           00258         dw      2580
001506 0AAE           00259         dw      2734
001508 0B50           00260         dw      2896
00150A 0BFD           00261         dw      3069
00150C 0CB3           00262         dw      3251
00150E 0D74           00263         dw      3444
001510 0E41           00264         dw      3649
001512 0F1A           00265         dw      3866
001514 1000           00266         dw      4096
001516 10F4           00267         dw      4340
001518 11F6           00268         dw      4598
00151A 1307           00269         dw      4871
00151C 1429           00270         dw      5161
00151E 155C           00271         dw      5468
001520 16A1           00272         dw      5793
001522 17F9           00273         dw      6137
001524 1966           00274         dw      6502
001526 1AE9           00275         dw      6889
001528 1C82           00276         dw      7298
00152A 1E34           00277         dw      7732
00152C 2000           00278         dw      8192
00152E 21E7           00279         dw      8679
001530 23EB           00280         dw      9195
001532 260E           00281         dw      9742
001534 2851           00282         dw      10321
001536 2AB7           00283         dw      10935
001538 2D41           00284         dw      11585
00153A 2FF2           00285         dw      12274
                      00286         
                      00345         #include        "../include/waveTables.inc"
                      00001 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 186


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      waveTables.inc                                    *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 ; **** Sine and Square Wave Tables ****
                      00022 
00153C                00023 squareTable
00153C 0000           00024         db 0,0
00153E 0000           00025         db 0,0
001540 0000           00026         db 0,0
001542 0000           00027         db 0,0
001544 0000           00028         db 0,0
001546 0000           00029         db 0,0
001548 0000           00030         db 0,0
00154A 0000           00031         db 0,0
00154C 0000           00032         db 0,0
00154E 0000           00033         db 0,0
001550 0000           00034         db 0,0
001552 0000           00035         db 0,0
001554 0000           00036         db 0,0
001556 0000           00037         db 0,0
001558 0000           00038         db 0,0
00155A 0000           00039         db 0,0
00155C 0000           00040         db 0,0
00155E 0000           00041         db 0,0
001560 0000           00042         db 0,0
001562 0000           00043         db 0,0
001564 0000           00044         db 0,0
001566 0000           00045         db 0,0
001568 0000           00046         db 0,0
00156A 0000           00047         db 0,0
00156C 0000           00048         db 0,0
00156E 0000           00049         db 0,0
001570 0000           00050         db 0,0
001572 0000           00051         db 0,0
001574 0000           00052         db 0,0
001576 0000           00053         db 0,0
001578 0000           00054         db 0,0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 187


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00157A FFFF           00055         db 255,255
00157C FFFF           00056         db 255,255
00157E FFFF           00057         db 255,255
001580 FFFF           00058         db 255,255
001582 FFFF           00059         db 255,255
001584 FFFF           00060         db 255,255
001586 FFFF           00061         db 255,255
001588 FFFF           00062         db 255,255
00158A FFFF           00063         db 255,255
00158C FFFF           00064         db 255,255
00158E FFFF           00065         db 255,255
001590 FFFF           00066         db 255,255
001592 FFFF           00067         db 255,255
001594 FFFF           00068         db 255,255
001596 FFFF           00069         db 255,255
001598 FFFF           00070         db 255,255
00159A FFFF           00071         db 255,255
00159C FFFF           00072         db 255,255
00159E FFFF           00073         db 255,255
0015A0 FFFF           00074         db 255,255
0015A2 FFFF           00075         db 255,255
0015A4 FFFF           00076         db 255,255
0015A6 FFFF           00077         db 255,255
0015A8 FFFF           00078         db 255,255
0015AA FFFF           00079         db 255,255
0015AC FFFF           00080         db 255,255
0015AE FFFF           00081         db 255,255
0015B0 FFFF           00082         db 255,255
0015B2 FFFF           00083         db 255,255
0015B4 FFFF           00084         db 255,255
0015B6 FFFF           00085         db 255,255
0015B8 FFFF           00086         db 255,255
0015BA FFFF           00087         db 255,255
0015BC FFFF           00088         db 255,255
0015BE FFFF           00089         db 255,255
0015C0 FFFF           00090         db 255,255
0015C2 FFFF           00091         db 255,255
0015C4 FFFF           00092         db 255,255
0015C6 FFFF           00093         db 255,255
0015C8 FFFF           00094         db 255,255
0015CA FFFF           00095         db 255,255
0015CC FFFF           00096         db 255,255
0015CE FFFF           00097         db 255,255
0015D0 FFFF           00098         db 255,255
0015D2 FFFF           00099         db 255,255
0015D4 FFFF           00100         db 255,255
0015D6 FFFF           00101         db 255,255
0015D8 FFFF           00102         db 255,255
0015DA FFFF           00103         db 255,255
0015DC FFFF           00104         db 255,255
0015DE FFFF           00105         db 255,255
0015E0 FFFF           00106         db 255,255
0015E2 FFFF           00107         db 255,255
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 188


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0015E4 FFFF           00108         db 255,255
0015E6 FFFF           00109         db 255,255
0015E8 FFFF           00110         db 255,255
0015EA FFFF           00111         db 255,255
0015EC FFFF           00112         db 255,255
0015EE FFFF           00113         db 255,255
0015F0 FFFF           00114         db 255,255
0015F2 FFFF           00115         db 255,255
0015F4 FFFF           00116         db 255,255
0015F6 FFFF           00117         db 255,255
0015F8 FFFF           00118         db 255,255
0015FA 0000           00119         db 0,0
0015FC 0000           00120         db 0,0
0015FE 0000           00121         db 0,0
001600 0000           00122         db 0,0
001602 0000           00123         db 0,0
001604 0000           00124         db 0,0
001606 0000           00125         db 0,0
001608 0000           00126         db 0,0
00160A 0000           00127         db 0,0
00160C 0000           00128         db 0,0
00160E 0000           00129         db 0,0
001610 0000           00130         db 0,0
001612 0000           00131         db 0,0
001614 0000           00132         db 0,0
001616 0000           00133         db 0,0
001618 0000           00134         db 0,0
00161A 0000           00135         db 0,0
00161C 0000           00136         db 0,0
00161E 0000           00137         db 0,0
001620 0000           00138         db 0,0
001622 0000           00139         db 0,0
001624 0000           00140         db 0,0
001626 0000           00141         db 0,0
001628 0000           00142         db 0,0
00162A 0000           00143         db 0,0
00162C 0000           00144         db 0,0
00162E 0000           00145         db 0,0
001630 0000           00146         db 0,0
001632 0000           00147         db 0,0
001634 0000           00148         db 0,0
001636 0000           00149         db 0,0
001638 0000           00150         db 0,0
00163A 0000           00151         db 0,0
                      00152 
00163C                00153 modulationBlendTable
00163C FFFF           00154         dw      0xffff
00163E 8080           00155         dw      0x8080
001640 4040           00156         dw      0x4040
001642 2020           00157         dw      0x2020
001644 1010           00158         dw      0x1010
001646 0808           00159         dw      0x0808
001648 0404           00160         dw      0x0404
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 189


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00164A 0202           00161         dw      0x0202
00164C FFFF           00162         dw      0xffff
00164E 8080           00163         dw      0x8080
001650 4040           00164         dw      0x4040
001652 2020           00165         dw      0x2020
001654 1010           00166         dw      0x1010
001656 0808           00167         dw      0x0808
001658 0404           00168         dw      0x0404
00165A 0202           00169         dw      0x0202
00165C FFFF           00170         dw      0xffff
00165E 8080           00171         dw      0x8080
001660 4040           00172         dw      0x4040
001662 2020           00173         dw      0x2020
001664 1010           00174         dw      0x1010
001666 0808           00175         dw      0x0808
001668 0404           00176         dw      0x0404
00166A 0202           00177         dw      0x0202
00166C FFFF           00178         dw      0xffff
00166E 8080           00179         dw      0x8080
001670 4040           00180         dw      0x4040
001672 2020           00181         dw      0x2020
001674 1010           00182         dw      0x1010
001676 0808           00183         dw      0x0808
001678 0404           00184         dw      0x0404
00167A 0202           00185         dw      0x0202
00167C FFFF           00186         dw      0xffff
00167E 8080           00187         dw      0x8080
001680 4040           00188         dw      0x4040
001682 2020           00189         dw      0x2020
001684 1010           00190         dw      0x1010
001686 0808           00191         dw      0x0808
001688 0404           00192         dw      0x0404
00168A 0202           00193         dw      0x0202
00168C FFFF           00194         dw      0xffff
00168E 8080           00195         dw      0x8080
001690 4040           00196         dw      0x4040
001692 2020           00197         dw      0x2020
001694 1010           00198         dw      0x1010
001696 0808           00199         dw      0x0808
001698 0404           00200         dw      0x0404
00169A 0202           00201         dw      0x0202
00169C FFFF           00202         dw      0xffff
00169E 8080           00203         dw      0x8080
0016A0 4040           00204         dw      0x4040
0016A2 2020           00205         dw      0x2020
0016A4 1010           00206         dw      0x1010
0016A6 0808           00207         dw      0x0808
0016A8 0404           00208         dw      0x0404
0016AA 0202           00209         dw      0x0202
0016AC FFFF           00210         dw      0xffff
0016AE 8080           00211         dw      0x8080
0016B0 4040           00212         dw      0x4040
0016B2 2020           00213         dw      0x2020
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 190


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0016B4 1010           00214         dw      0x1010
0016B6 0808           00215         dw      0x0808
0016B8 0404           00216         dw      0x0404
0016BA 0202           00217         dw      0x0202
                      00218                 
0016BC                00219 sineTable
0016BC 8380           00220         db 128,131
0016BE 8986           00221         db 134,137
0016C0 8F8C           00222         db 140,143
0016C2 9592           00223         db 146,149
0016C4 9B98           00224         db 152,155
0016C6 A29E           00225         db 158,162
0016C8 A7A5           00226         db 165,167
0016CA ADAA           00227         db 170,173
0016CC B3B0           00228         db 176,179
0016CE B9B6           00229         db 182,185
0016D0 BEBC           00230         db 188,190
0016D2 C4C1           00231         db 193,196
0016D4 C9C6           00232         db 198,201
0016D6 CECB           00233         db 203,206
0016D8 D3D0           00234         db 208,211
0016DA D7D5           00235         db 213,215
0016DC DCDA           00236         db 218,220
0016DE E0DE           00237         db 222,224
0016E0 E4E2           00238         db 226,228
0016E2 E8E6           00239         db 230,232
0016E4 EBEA           00240         db 234,235
0016E6 EEED           00241         db 237,238
0016E8 F1F0           00242         db 240,241
0016EA F4F3           00243         db 243,244
0016EC F6F5           00244         db 245,246
0016EE F9F8           00245         db 248,249
0016F0 FAFA           00246         db 250,250
0016F2 FCFB           00247         db 251,252
0016F4 FDFD           00248         db 253,253
0016F6 FEFE           00249         db 254,254
0016F8 FFFE           00250         db 254,255
0016FA FFFF           00251         db 255,255
0016FC FFFF           00252         db 255,255
0016FE FFFF           00253         db 255,255
001700 FEFE           00254         db 254,254
001702 FDFE           00255         db 254,253
001704 FCFD           00256         db 253,252
001706 FAFB           00257         db 251,250
001708 F9FA           00258         db 250,249
00170A F6F8           00259         db 248,246
00170C F4F5           00260         db 245,244
00170E F1F3           00261         db 243,241
001710 EEF0           00262         db 240,238
001712 EBED           00263         db 237,235
001714 E8EA           00264         db 234,232
001716 E4E6           00265         db 230,228
001718 E0E2           00266         db 226,224
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 191


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00171A DCDE           00267         db 222,220
00171C D7DA           00268         db 218,215
00171E D3D5           00269         db 213,211
001720 CED0           00270         db 208,206
001722 C9CB           00271         db 203,201
001724 C4C6           00272         db 198,196
001726 BEC1           00273         db 193,190
001728 B9BC           00274         db 188,185
00172A B3B6           00275         db 182,179
00172C ADB0           00276         db 176,173
00172E A7AA           00277         db 170,167
001730 A2A5           00278         db 165,162
001732 9B9E           00279         db 158,155
001734 9598           00280         db 152,149
001736 8F92           00281         db 146,143
001738 898C           00282         db 140,137
00173A 8386           00283         db 134,131
00173C 7C80           00284         db 128,124
00173E 7679           00285         db 121,118
001740 7073           00286         db 115,112
001742 6A6D           00287         db 109,106
001744 6467           00288         db 103,100
001746 5D61           00289         db 97,93
001748 585A           00290         db 90,88
00174A 5255           00291         db 85,82
00174C 4C4F           00292         db 79,76
00174E 4649           00293         db 73,70
001750 4143           00294         db 67,65
001752 3B3E           00295         db 62,59
001754 3639           00296         db 57,54
001756 3134           00297         db 52,49
001758 2C2F           00298         db 47,44
00175A 282A           00299         db 42,40
00175C 2325           00300         db 37,35
00175E 1F21           00301         db 33,31
001760 1B1D           00302         db 29,27
001762 1719           00303         db 25,23
001764 1415           00304         db 21,20
001766 1112           00305         db 18,17
001768 0E0F           00306         db 15,14
00176A 0B0C           00307         db 12,11
00176C 090A           00308         db 10,9
00176E 0607           00309         db 7,6
001770 0505           00310         db 5,5
001772 0304           00311         db 4,3
001774 0202           00312         db 2,2
001776 0101           00313         db 1,1
001778 0001           00314         db 1,0
00177A 0000           00315         db 0,0
00177C 0000           00316         db 0,0
00177E 0000           00317         db 0,0
001780 0101           00318         db 1,1
001782 0201           00319         db 1,2
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 192


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001784 0302           00320         db 2,3
001786 0504           00321         db 4,5
001788 0605           00322         db 5,6
00178A 0907           00323         db 7,9
00178C 0B0A           00324         db 10,11
00178E 0E0C           00325         db 12,14
001790 110F           00326         db 15,17
001792 1412           00327         db 18,20
001794 1715           00328         db 21,23
001796 1B19           00329         db 25,27
001798 1F1D           00330         db 29,31
00179A 2321           00331         db 33,35
00179C 2825           00332         db 37,40
00179E 2C2A           00333         db 42,44
0017A0 312F           00334         db 47,49
0017A2 3634           00335         db 52,54
0017A4 3B39           00336         db 57,59
0017A6 413E           00337         db 62,65
0017A8 4643           00338         db 67,70
0017AA 4C49           00339         db 73,76
0017AC 524F           00340         db 79,82
0017AE 5855           00341         db 85,88
0017B0 5D5A           00342         db 90,93
0017B2 6461           00343         db 97,100
0017B4 6A67           00344         db 103,106
0017B6 706D           00345         db 109,112
0017B8 7673           00346         db 115,118
0017BA 7C79           00347         db 121,124
                      00348 
                      00349         
                      00346 
                      00347         ; ensure that bootLoader reads/writes all program mem from USER_CODE_START_ADDRESS to bootloader
                      00348 #ifdef PIC18LF13K50
                      00349         ; bootBlockStartAddres - 2
                      00350         ORG             0x17FE
Warning[208]: Label truncated at 32 characters. (lastApplicationProgramMemoryAddress)
0017FE                00351 lastApplicationProgramMemoryAddress
0017FE 0000           00352         nop
                      00353         
                      00354         ; (Program Memory Size - Boot Block Size)
                      00355         ;       4kW (8192 bytes) - 1kW (2048 bytes)
                      00356         ; 0x2000 - 0x0800 = 0x1800
                      00357         ORG             0x1800
                      00358         #include        "../source/mootLoader.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      mootLoader.asm                                    *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 193


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 
                      00015 
                      00016 ;**********************************************************************
                      00017 ; INCLUDE FILES
                      00018 ;**********************************************************************
                      00019         
                      00020         #include        "../header/mootloader.h"
                      00001 ;**********************************************************************
                      00002 ;                                                                     *
                      00003 ;    Project:       deMIDulator                                       *
                      00004 ;    Filename:      eeprom.h                                          *
                      00005 ;    Date:                                                            *
                      00006 ;    File Version:                                                    *
                      00007 ;                                                                     *
                      00008 ;    Author:        Derek Enos                                        *
                      00009 ;    Company:                                                         *
                      00010 ;                                                                     * 
                      00011 ;                                                                     *
                      00012 ;**********************************************************************
                      00013 ;                                                                     *
                      00014 ;    Files required:                                                  *
                      00015 ;                                                                     *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;**********************************************************************
                      00019 
                      00020 #ifndef _MOOTLOADERH_
                      00021 #define _MOOTLOADERH_
                      00022 
                      00023 
                      00024 ; ******************* MOOTLOADER TRANSACTION DEFINES ***********************
                      00025 
                      00026 #define ML_BLOCK_ERASE_BYTE_SIZE                        64      ; must be multiple of ML_DATA_PAYLOAD_BY
                            TE_SIZE
                      00027 #define ML_DATA_PACKET_PAYLOAD_BYTE_SIZE        8
                      00028 
                      00029 #define ML_BLOCK_ERASE_IDLE_TIME_MS                     8
                      00030 #define ML_WRITE_IDLE_TIME_MS                           8
                      00031 #define ML_TRANS_SYNC_IDLE_TIME_MS                      32
                      00032 
                      00033 
                      00034 ; ******************* MOOTLOADER COMMAND BYTE DEFINES ***********************
                      00035 
                      00036 #define MIDI_VENDOR_ID                                          0x77
                      00037 #define MIDI_DEVICE_ID                                          0x1D
                      00038 
                      00039 #define ML_COMMAND_WRITE_PROGRAM_MEMORY         0x03
                      00040 #define ML_COMMAND_DATA_PAYLOAD                         0x01
                      00041 #define ML_COMMAND_DATA_PAYLOAD_COMPLETE        0x02
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 194


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00042 #define ML_TRANSMITTER_RESETTING                        0x10
                      00043 #define ML_RECEIVER_RESET                                       0x11
                      00044 
                      00045 
                      00046 ; ******************* MOOTLOADER PACKET DEFINES ***********************
                      00047 
                      00048 #define ML_LARGE_PACKET_BYTE_SIZE               22
                      00049 
                      00050 
                      00051 ; ******************* mlFlags BIT DEFINES ***********************
                      00052 
                      00053 #define mlRxTransSyncFlag                                       0
                      00054 #define mlRxChecksumOk                                          1
                      00055 
                      00056 
                      00057 ;**********************************************************************
                      00058 ; MACROS
                      00059 ;**********************************************************************
                      00060 
                      00061 SEND_SYSEX_INTRO_NO_CHECK       MACRO
                      00062         movlw   0xF0
                      00063         call    mootLoader_sendByte
                      00064         movlw   MIDI_VENDOR_ID
                      00065         call    mootLoader_sendByte
                      00066         movlw   MIDI_DEVICE_ID
                      00067         call    mootLoader_sendByte
                      00068         ENDM
                      00069 
                      00070 SEND_BYTE_START_CHECKSUM        MACRO
                      00071         movwf   mlChecksum, ACCESS
                      00072         call    mootLoader_sendByte
                      00073         ENDM
                      00074 
                      00075 SEND_BYTE_DO_CHECKSUM           MACRO
                      00076         xorwf   mlChecksum, f, ACCESS
                      00077         call    mootLoader_sendByte
                      00078         ENDM
                      00079 
                      00080 SPLIT_BYTE_THEN_SEND_DO_CHECKSUM        MACRO
                      00081         xorwf   mlChecksum, f, ACCESS
                      00082         call    mootLoader_sendAsNybbles
                      00083         ENDM
                      00084 
                      00085 SEND_CHECKSUM_CLEAR_RUN         MACRO
                      00086         movf    mlChecksum, w, ACCESS
                      00087         ; ensure that bit 7 is clear
                      00088         andlw   0x7f
                      00089         clrf    mlRunningChecksum, ACCESS
                      00090         call    mootLoader_sendByte
                      00091         ENDM
                      00092         
                      00093 SEND_CHECKSUM_DO_RUN            MACRO
                      00094         movf    mlChecksum, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 195


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00095         ; ensure that bit 7 is clear
                      00096         andlw   0x7f
                      00097         xorwf   mlRunningChecksum, f, ACCESS
                      00098         call    mootLoader_sendByte
                      00099         ENDM
                      00100 
                      00101 SEND_RUNNING_CHECKSUM           MACRO
                      00102         movf    mlRunningChecksum, w, ACCESS
                      00103         ; ensure that bit 7 is clear
                      00104         andlw   0x7f
                      00105         call    mootLoader_sendByte
                      00106         ENDM
                      00107 
                      00108 IDLE_BLOCK_ERASE                        MACRO
                      00109         movlw   ML_BLOCK_ERASE_IDLE_TIME_MS
                      00110         call    mootLoader_wait
                      00111         ENDM
                      00112 
                      00113 IDLE_WRITE_WAIT                         MACRO
                      00114         movlw   ML_WRITE_IDLE_TIME_MS
                      00115         call    mootLoader_wait
                      00116         ENDM
                      00117 
                      00118         
                      00119 #endif
                      00120 
                      00021 
                      00022         
                      00023 ;**********************************************************************
                      00024 ; LOCAL VARIABLES
                      00025 ;**********************************************************************
                      00026 
                      00027         CBLOCK 0
                      00028 
                      00029                 ; global
  00000000            00030                 mlButtonState:1
  00000001            00031                 mlChecksum:1
  00000002            00032                 mlRunningChecksum:1
  00000003            00033                 mlStartAddress:4
  00000007            00034                 mlPayloadLength:4
  0000000B            00035                 mlDataPayloadBuffer:ML_DATA_PACKET_PAYLOAD_BYTE_SIZE
  00000013            00036                 mlCount:2
  00000015            00037                 mlFlags:1
                      00038                 ; sendNybble()
  00000016            00039                 mlNybbleSplitTmp:1
                      00040                 ; sendByte()
  00000017            00041                 mlCurrentTxByte:1
                      00042                 ; writeProgramMemory()
  00000018            00043                 mlBlockEraseBytesRemaining:1
                      00044                 ; sendDataPayloadPacket()
  00000019            00045                 mlDatPackIntByteCount:1
                      00046                 ; rxListenForPrelude()
  0000001A            00047                 mlPerfectPreludeCount:1
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 196


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00048                 ; mootLoader_rxReceiveNextPacket()
  0000001B            00049                 mlRxReceivedPacket:ML_LARGE_PACKET_BYTE_SIZE
  00000031            00050                 mlRxReceivedPacketByteCount:1
                      00051                 ; rxReceiveNextByte()
  00000032            00052                 mlRxReceivedByte:1
                      00053                 ; rxReceiveNextSymbol()
  00000033            00054                 mlRxPreviousSymbolBucket:1
  00000034            00055                 mlConsecutiveSymbolCount:1
                      00056                 ; convertPeriodToSymbol()
  00000035            00057                 mlRxSymbolBucket:1
  00000036            00058                 mlPeriodBucketLowLimit:1
  00000037            00059                 mlPeriodBucketHighLimit:1
  00000038            00060                 mlSymbolBucketCount:1
                      00061                 ; measureInputCyclePeriod()
  00000039            00062                 mlRA4CompareReg:1
  0000003A            00063                 mlRxCyclePeriodL:1
  0000003B            00064                 mlRxCyclePeriodH:1
  0000003C            00065                 mlSchmittReadValue:1
  0000003D            00066                 mlTransitionCount:1
                      00067                 ; rxDecodeReceivedSymbol()
  0000003E            00068                 mlDecodedNybble:1
                      00069                 ; debug
  0000003F            00070                 mlEepromAddress:1
  00000040            00071                 mlEepromByteCount:1
                      00072                 
                      00073         ENDC
                      00074 
                      00075 
                      00076 ;**********************************************************************
                      00077 ; LOCAL DEFINES
                      00078 ;**********************************************************************
                      00079 
                      00080 ;#define        DEBUG_TOGGLE_SQUARE_ON_SAMPLE
                      00081 ;#define        DEBUG_TOGGLE_SQUARE_ON_EDGE_DETECT
                      00082 ;#define        DEBUG_SQUARE_FOLLOWS_SCHMITT_VALUE
                      00083 ;#define        DEBUG_TOGGLE_SQUARE_ON_MEASURE_BOUNDS
                      00084 ;#define        DEBUG_TOGGLE_SQUARE_ON_NEW_SYMBOL_DETECT
                      00085 
                      00086 
                      00087 ;**********************************************************************
                      00088 ; mootLoader BEGIN
                      00089 ;**********************************************************************
                      00090 
001800                00091 mootLoader
                      00092         
001800 EC?? F???      00093         call    mootLoader_initCore
                      00094         
                      00095         ; use BANK0
001804 0100           00096         BANKSEL 0
                      00097                 
                      00098         ; turn on all LEDs
                      00099         LED_ALL_ON
                          M         LED_SINE_ON
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 197


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
001806 868B               M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
001808 888B               M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_ON
                          M #ifndef LED_POLARITY_REVERSED
                          M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
00180A 8A89               M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
                      00100 
                      00101         ; check if boot action is being requested
                      00102         ; enter mootLoader Trasmitter mode if waveform(RC0) & record(RC1) switches held for 2 second
                      00103         ; enter mootLoader Receiver mode if record(RC1) & mode(RC2) switches held for 2 second
                      00104         ; enter Flash restore from EEPROM mode if waveform(RC0), record(RC1) & mode(RC2) switches held f
                            or 2 second
                      00105 
                      00106         ;**** start procedure: check button state ****
                      00107         ; if any buttons (RC0 - RC2) are pressed then wait for button state to remain unchanged for 2 se
                            conds
00180C 1C82           00108         comf    PORTC, w, ACCESS
00180E 0B07           00109         andlw   0x07
                      00110         ; no buttons are active so exit
001810 E0??           00111         bz              mootLoader_exit
                      00112         ; at least one button is active so wait to make sure that state doesn't change for 2 seconds
                      00113         ; mlTmpValue = compliment of initial RC2:0 value
001812 6E00           00114         movwf   mlButtonState, ACCESS
001814 6ACC           00115         clrf    TMR2, ACCESS
001816 0E24           00116         movlw   0x24
001818 6E13           00117         movwf   mlCount, ACCESS
00181A 0EF4           00118         movlw   0xf4
00181C 6E14           00119         movwf   mlCount + 1, ACCESS
00181E                00120 mootLoader_stateWaitLp
00181E 1C82           00121         comf    PORTC, w, ACCESS
001820 0B07           00122         andlw   0x07
001822 6200           00123         cpfseq  mlButtonState, ACCESS
                      00124         ; button state has changed before timer expiration so exit mootLoader
001824 D???           00125         bra             mootLoader_exit
                      00126         ; state has not changed so wait for timer overflow
001826 929E           00127         bcf             PIR1, TMR2IF, ACCESS    
001828                00128 mootLoader_stateWaitOvLp
001828 A29E           00129         btfss   PIR1, TMR2IF, ACCESS
00182A D???           00130         bra             mootLoader_stateWaitOvLp        
                      00131         ; timer has overflowed so decrement overflow counter
00182C 0613           00132         decf    mlCount, f, ACCESS
00182E A0D8           00133         btfss   STATUS, C, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 198


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001830 0614           00134         decf    mlCount + 1, f, ACCESS
001832 5213           00135         movf    mlCount, f, ACCESS
                      00136         ; count != so continue loop
001834 E1??           00137         bnz             mootLoader_stateWaitLp
001836 5214           00138         movf    mlCount + 1, f, ACCESS
                      00139         ; count != so continue loop
001838 E1??           00140         bnz             mootLoader_stateWaitLp
                      00141 
                      00142         ; button state remained unchanged for 2 seconds. yay
                      00143 
                      00144         ;**** start procedure: check button combo value ****
                      00145         ; remeber, mlButtonState is reversed logic
00183A 0E03           00146         movlw   0<<RC2 ^ 1<<RC1 ^ 1<<RC0
00183C 6200           00147         cpfseq  mlButtonState, ACCESS
00183E D???           00148         bra             mootLoader_checkReceive
001840 D???           00149         bra             mootLoader_transmitter          
001842                00150 mootLoader_checkReceive
001842 0E06           00151         movlw   1<<RC2 ^ 1<<RC1 ^ 0<<RC0
001844 6200           00152         cpfseq  mlButtonState, ACCESS
001846 D???           00153         bra             mootLoader_checkRestore
001848 D???           00154         bra             mootLoader_receiver
00184A                00155 mootLoader_checkRestore
00184A 0E07           00156         movlw   1<<RC2 ^ 1<<RC1 ^ 1<<RC0
00184C 6200           00157         cpfseq  mlButtonState, ACCESS
00184E D???           00158         bra             mootLoader_exit
001850 D???           00159         bra             mootLoader_restore
                      00160 
001852                00161 mootLoader_exit
001852 EF?? F???      00162         goto    main_redirect
                      00163                         
                      00164         ; include code for mootLoader functions
                      00165         #include        "mootLoader_init.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      mootLoader_init_v0_2.asm                          *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 ;                                                                     *
                      00015 ;    Files required:                                                  *
                      00016 ;                                                                     *
                      00017 ;                                                                     *
                      00018 ;                                                                     *
                      00019 ;**********************************************************************
                      00020 
                      00021 ;**********************************************************************
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 199


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00022 ; INCLUDE FILES
                      00023 ;**********************************************************************
                      00024 
                      00025 ;**********************************************************************
                      00026 ; LOCAL FUNCTIONS
                      00027 ;**********************************************************************
                      00028 
                      00029 ;**********************************************************************
                      00030 ; Function: void mootLoader_initCore()
                      00031 ;**********************************************************************
                      00032 
001856                00033 mootLoader_initCore
001856 EC?? F???      00034         call mootLoader_initOsc
00185A EC?? F???      00035         call mootLoader_initIO
00185E EC?? F???      00036         call mootLoader_initUART
001862 EC?? F???      00037         call mootLoader_initTimer0
001866 EC?? F???      00038         call mootLoader_initTimer1
00186A EC?? F???      00039         call mootLoader_initTimer2
00186E EC?? F???      00040         call mootLoader_initCCP
001872 EC?? F???      00041         call mootLoader_initSPI
001876 EC?? F???      00042         call mootLoader_initADC
00187A EC?? F???      00043         call mootLoader_initInterrupts
00187E EC?? F???      00044         call mootLoader_initRAM
001882 EC?? F???      00045         call mootLoader_initHeap
001886 0012           00046         return
                      00047                 
                      00048         
                      00049 ;**********************************************************************
                      00050 ; Function: void mootLoader_initOsc()
                      00051 ;**********************************************************************
                      00052 
001888                00053 mootLoader_initOsc
                      00054         ; configure for internal clock at 8Mhz & 4x PLL = 32Mhz
                      00055         ; primary clock determined by FOSC<3:0>
                      00056         ; confirgure internal osc for 8Mhz
001888 8CD3           00057         bsf             OSCCON, IRCF2, ACCESS
00188A 8AD3           00058         bsf             OSCCON, IRCF1, ACCESS
00188C 98D3           00059         bcf             OSCCON, IRCF0, ACCESS
                      00060 
                      00061 #ifdef  PIC18LF13K50
                      00062 
00188E                00063 mootLoader_initOsc_lp1
                      00064         ; wait for internal high freq osc to stabilize
                      00065         ; "pic18lf13k50.inc" lists bit as "IOFS" but datasheet calls it "HFIOFS"
00188E A4D3           00066         btfss   OSCCON, IOFS, ACCESS
001890 D???           00067         bra             mootLoader_initOsc_lp1
                      00068 
                      00069         ; enable PLL
001892 8C9B           00070         bsf             OSCTUNE, SPLLEN, ACCESS
                      00071 #endif
                      00072 
                      00073 #ifdef  PIC18LF14K22
                      00074 mootLoader_initOsc_lp1
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 200


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00075         ; wait for internal high freq osc to stabilize
                      00076         btfss   OSCCON, HFIOFS, ACCESS
                      00077         bra             mootLoader_initOsc_lp1
                      00078 
                      00079         ; enable PLL
                      00080         bsf             OSCTUNE, PLLEN, ACCESS
                      00081 #endif  
                      00082 
001894 0012           00083         return
                      00084 
                      00085 
                      00086 ;**********************************************************************
                      00087 ; Function: void mootLoader_initIO()
                      00088 ;**********************************************************************
                      00089 
001896                00090 mootLoader_initIO
                      00091         ; IO Summary
                      00092         ; 
                      00093         ; (organized by pin #)
                      00094         ; Pin   Port    Assignment
                      00095         ; ---  ----     ----------
                      00096         ; 1             VDD             VDD
                      00097         ; 2             RA5             LED (Sine)
                      00098         ; 3             RA4             Audio In
                      00099         ; 4             RA3             ICSP
                      00100         ; 5             RC5             Audio Out
                      00101         ; 6             RC4             LED (Square)
                      00102         ; 7             RC3             LED (Sample)
                      00103         ; 8             RC6             EEPROM Chip Select
                      00104         ; 9             RC7             EEPROM Slave In
                      00105         ; 10    RB7             [Not Connected]
                      00106         ; 11    RB6             EEPROM Clock
                      00107         ; 12    RB5             MIDI In
                      00108         ; 13    RB4             EEPROM Slave Out
                      00109         ; 14    RC2             Switch (MIDI Record / Playback)
                      00110         ; 15    RC1             Switch (Voice Through / Record)
                      00111         ; 16    RC0             Switch (Waveform)
                      00112         ; 17    VUSB    [Not Connected]
                      00113         ; 18    RA1             ICSP
                      00114         ; 19    RA0             ICSP
                      00115         ; 20    VSS             VSS
                      00116         ;
                      00117         ; [PORT A]
                      00118         ; Pin   Port    Assignment                                                      Direction
                      00119         ; ---  ----             ----------                                                      --------
                            -
                      00120         ; 19    RA0             ICSP                                                            IN
                      00121         ; 18    RA1             ICSP                                                            IN
                      00122         ; 4             RA3             ICSP                                                            
                            IN
                      00123         ; 3             RA4             Audio In                                                        
                            IN
                      00124         ; 2             RA5             LED (Sine)                                                      
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 201


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                            OUT
                      00125 
001896 8A89           00126         bsf             LATA, RA5, ACCESS       ; LED is off
001898 0EDF           00127         movlw   0xff ^ 1<<RA5
00189A 6E92           00128         movwf   TRISA, ACCESS
                      00129 
                      00130         ; [PORT B]
                      00131         ; Pin   Port    Assignment                                                      Direction
                      00132         ; ---  ----             ----------                                                      --------
                            -
                      00133         ; 13    RB4             EEPROM Slave Out                                        IN
                      00134         ; 12    RB5             MIDI In                                                         IN
                      00135         ; 11    RB6             EEPROM Clock                                            OUT
                      00136         ; 10    RB7             [Not Connected]                                         IN
                      00137 
00189C 0EBF           00138         movlw   0xff ^ 1<<RB6   ; EEPROM clock is LOW
00189E 6E8A           00139         movwf   LATB, ACCESS
0018A0 0EBF           00140         movlw   0xff ^ 1<<RB6
0018A2 6E93           00141         movwf   TRISB, ACCESS
                      00142         
                      00143         ; [PORT C]
                      00144         ; Pin   Port    Assignment                                                      Direction
                      00145         ; ---  ----             ----------                                                      --------
                            -
                      00146         ; 16    RC0             Switch (Waveform)                                       IN
                      00147         ; 15    RC1             Switch (Voice Through / Record)         IN
                      00148         ; 14    RC2             Switch (MIDI Record / Playback)         IN
                      00149         ; 7             RC3             LED (Sample)                                            OUT
                      00150         ; 6             RC4             LED (Square)                                            OUT
                      00151         ; 5             RC5             Audio Out                                                       
                            OUT
                      00152         ; 8             RC6             EEPROM Chip Select                                      OUT
                      00153         ; 9             RC7             EEPROM Slave In                                         OUT
                      00154         
0018A4 868B           00155         bsf             LATC, RC3, ACCESS       ; LED is off
0018A6 888B           00156         bsf             LATC, RC4, ACCESS       ; LED is off
0018A8 9A8B           00157         bcf             LATC, RC5, ACCESS       ; Audio out is low
0018AA 8C8B           00158         bsf             LATC, RC6, ACCESS       ; Chip select is idle
0018AC 0E07           00159         movlw   0x07
0018AE 6E94           00160         movwf   TRISC, ACCESS
                      00161         
                      00162         ; [General IO]
0018B0 9EF1           00163         bcf             INTCON2, NOT_RABPU, ACCESS      ; enable PORT A & B pullups per WPU registers
0018B2 0E08           00164         movlw   1<<ANS3 ; ANS3 = RA4(Audio In)
0018B4 6E7E           00165         movwf   ANSEL, ACCESS   ; enable digital input buffers for all non-analog inputs
0018B6 6A7F           00166         clrf    ANSELH, ACCESS  ; enable digital input buffers for all non-analog inputs        
0018B8 0012           00167         return
                      00168         
                      00169         
                      00170 ;**********************************************************************
                      00171 ; Function: void mootLoader_initUART()
                      00172 ;**********************************************************************
                      00173 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 202


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0018BA                00174 mootLoader_initUART
0018BA 0E0F           00175         movlw   15      ; 31.25K baud rate @ 32Mhz clock
0018BC 6EAF           00176         movwf   SPBRG, ACCESS
                      00177         ; Enable serial port
                      00178         ; Enable reception
0018BE 8EAB           00179         bsf             RCSTA, SPEN, ACCESS
0018C0 88AB           00180         bsf             RCSTA, CREN, ACCESS
                      00181         ; Enable transmission
0018C2 8AAC           00182         bsf             TXSTA, TXEN, ACCESS
0018C4 0012           00183         return
                      00184 
                      00185 
                      00186 ;**********************************************************************
                      00187 ; Function: void mootLoader_initTimer0()
                      00188 ;**********************************************************************
                      00189 
0018C6                00190 mootLoader_initTimer0
                      00191         ; timer is on
                      00192         ; 16-bit mode
0018C6 9CD5           00193         bcf     T0CON, T08BIT, ACCESS
                      00194         ; clock = internal
0018C8 9AD5           00195         bcf             T0CON, T0CS, ACCESS
                      00196         ; timer0 using prescaler
                      00197         ; prescale = 1:8
                      00198         ; Fosc = 32Mhz. 1/((32Mhz/4)/ 8) * overflowValue(==65536) = overflow every 65.536mS)
0018CA 96D5           00199         bcf             T0CON, PSA, ACCESS
0018CC 94D5           00200         bcf             T0CON, T0PS2, ACCESS
0018CE 90D5           00201         bcf             T0CON, T0PS0, ACCESS    
0018D0 0012           00202         return
                      00203 
                      00204 
                      00205 ;**********************************************************************
                      00206 ; Function: void mootLoader_initTimer1()
                      00207 ;**********************************************************************
                      00208 
0018D2                00209 mootLoader_initTimer1
                      00210         ; DO NOT ENABLE TIMER1 OR SDO WILL NOT WORK!
0018D2 0012           00211         return
                      00212 
                      00213 
                      00214 ;**********************************************************************
                      00215 ; Function: void mootLoader_initTimer2()
                      00216 ;**********************************************************************
                      00217 
0018D4                00218 mootLoader_initTimer2
                      00219 
                      00220         ; Prescale 1:1
                      00221         ; Turn on Timer2
0018D4 84CA           00222         bsf             T2CON, TMR2ON, ACCESS
                      00223         ; Reset and interrupt on match value
0018D6 0EFF           00224         movlw   255
0018D8 6ECB           00225         movwf   PR2, ACCESS
0018DA 0012           00226         return
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 203


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00227         
                      00228 
                      00229 ;**********************************************************************
                      00230 ; Function: void mootLoader_initCCP()
                      00231 ;**********************************************************************
                      00232 
0018DC                00233 mootLoader_initCCP
                      00234         ; PWM single output
                      00235         ; PWM mode; P1A, P1C active-high; P1B, P1D active-high
                      00236         ; 10-bit PWM bits [1:0] = 0b11
0018DC 86BD           00237         bsf             CCP1CON, CCP1M3, ACCESS
0018DE 84BD           00238         bsf             CCP1CON, CCP1M2, ACCESS
                      00239 
0018E0 6ABE           00240         clrf    CCPR1L, ACCESS  
0018E2 0012           00241         return
                      00242 
                      00243 
                      00244 ;**********************************************************************
                      00245 ; Function: void mootLoader_initSPI()
                      00246 ;**********************************************************************
                      00247 
0018E4                00248 mootLoader_initSPI
                      00249         ; serial port enabled
                      00250         ; idle clock is LOW
                      00251         ; mode is SPI master, clock = Fosc/4 = 8MHz
0018E4 8AC6           00252         bsf             SSPCON1, SSPEN, ACCESS
                      00253 
                      00254         ; input data latched on idle->active
                      00255         ; output data latched on active->idle clock
0018E6 8CC7           00256         bsf             SSPSTAT, CKE, ACCESS
0018E8 0012           00257         return
                      00258         
                      00259 
                      00260 ;**********************************************************************
                      00261 ; Function: void mootLoader_initADC()
                      00262 ;**********************************************************************
                      00263 
0018EA                00264 mootLoader_initADC
                      00265         ; channel = AN3
                      00266         ; ADC is on
0018EA 86C2           00267         bsf             ADCON0, CHS1, ACCESS    
0018EC 84C2           00268         bsf             ADCON0, CHS0, ACCESS    
0018EE 80C2           00269         bsf             ADCON0, ADON, ACCESS    
                      00270         
                      00271         ; positive reference is internal VDD
                      00272         ; negative reference is internal VSS
                      00273 
                      00274         ; left justify result
                      00275         ; acquisition time = 4 tad
                      00276         ; clock source = Fosc/32 = 32Mhz/32 = 1Mhz, TAD = 1uS
0018F0 88C0           00277         bsf             ADCON2, ACQT1, ACCESS
0018F2 82C0           00278         bsf             ADCON2, ADCS1, ACCESS
0018F4 0012           00279         return
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 204


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00280 
                      00281 
                      00282 ;**********************************************************************
                      00283 ; Function: void mootLoader_initInterrupts()
                      00284 ;**********************************************************************
                      00285 
0018F6                00286 mootLoader_initInterrupts
                      00287         ; Enable interrupt priorities           
0018F6 8ED0           00288         bsf             RCON, IPEN, ACCESS
                      00289         
                      00290         ; unmask peripheral interrupts
                      00291         ; enable timer0 interrupts
                      00292         ; enable INT0 interrupts
                      00293         ; clear timer0 int flag
                      00294         ; clear INT0 int flag
0018F8 8CF2           00295         bsf             INTCON, PEIE, ACCESS
0018FA 8AF2           00296         bsf             INTCON, TMR0IE, ACCESS
0018FC 88F2           00297         bsf             INTCON, INT0IE, ACCESS
0018FE 94F2           00298         bcf             INTCON, TMR0IF, ACCESS
001900 92F2           00299         bcf             INTCON, INT0IF, ACCESS
                      00300         
                      00301         ; INT0 interrupt on falling edge
                      00302         ; INT1 interrupt on falling edge
                      00303         ; INT2 interrupt on falling edge
                      00304         ; Interrupt priority is low
001902 9CF1           00305         bcf             INTCON2, INTEDG0, ACCESS
001904 9AF1           00306         bcf             INTCON2, INTEDG1, ACCESS
001906 98F1           00307         bcf             INTCON2, INTEDG2, ACCESS
001908 94F1           00308         bcf             INTCON2, TMR0IP, ACCESS
                      00309                 
                      00310         ; INT2 is low Priority interrupt
                      00311         ; INT1 is low Priority interrupt
                      00312         ; enable INT2 interrupts
                      00313         ; enable INT1 interrupts
                      00314         ; clear INT2 int flag
                      00315         ; clear INT1 int flag
00190A 9EF0           00316         bcf             INTCON3, INT2IP, ACCESS
00190C 9CF0           00317         bcf             INTCON3, INT1IP, ACCESS
00190E 88F0           00318         bsf             INTCON3, INT2IE, ACCESS
001910 86F0           00319         bsf             INTCON3, INT1IE, ACCESS
001912 92F0           00320         bcf             INTCON3, INT2IF, ACCESS
001914 90F0           00321         bcf             INTCON3, INT1IF, ACCESS
                      00322                         
                      00323         ; UART RX is low priority interrupt     
001916 9A9F           00324         bcf             IPR1, RCIP, ACCESS
                      00325         
                      00326         ; clear timer2 int flag
001918 929E           00327         bcf             PIR1, TMR2IF, ACCESS            
                      00328         
                      00329         ; enable UART rx ints
                      00330         ; enable timer2 interrupts
00191A 8A9D           00331         bsf             PIE1, RCIE, ACCESS
00191C 829D           00332         bsf             PIE1, TMR2IE, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 205


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

00191E 0012           00333         return
                      00334         
                      00335 
                      00336 ;**********************************************************************
                      00337 ; Function: void mootLoader_initRAM()
                      00338 ;**********************************************************************
001920                00339 mootLoader_initRAM
                      00340         ; clear all general purpose RAM locations to 0x00
001920                00341 mootLoader_initRAM_bank0
                      00342         ; mootLoader_init pointer to start of BANK0
001920 6AE9           00343         clrf    FSR0L, ACCESS
001922 6AEA           00344         clrf    FSR0H, ACCESS
001924                00345 mootLoader_initRAM_bank0Lp
001924 6AEE           00346         clrf    POSTINC0, ACCESS
                      00347         ; BANK0 is done when FSR0 == 0x0100
001926 0E01           00348         movlw   1
001928 62EA           00349         cpfseq  FSR0H, ACCESS
00192A D???           00350         bra             mootLoader_initRAM_bank0Lp
                      00351 
00192C                00352 mootLoader_initRAM_bank1
                      00353         ; PIC18LF13K50 does not implement BANK1 so skip it
                      00354 
00192C                00355 mootLoader_initRAM_bank2
                      00356         ; mootLoader_init pointer to start of BANK2
00192C 6AE9           00357         clrf    FSR0L, ACCESS
00192E 0E02           00358         movlw   0x02
001930 6EEA           00359         movwf   FSR0H, ACCESS
001932                00360 mootLoader_initRAM_bank2Lp
001932 6AEE           00361         clrf    POSTINC0, ACCESS
                      00362         ; BANK2 is done when FSR0 == 0x0300
001934 0E03           00363         movlw   3
001936 62EA           00364         cpfseq  FSR0H, ACCESS
001938 D???           00365         bra             mootLoader_initRAM_bank2Lp
                      00366 
                      00367         ; reset fsr address
00193A 6AE9           00368         clrf    FSR0L, ACCESS   
00193C 6AEA           00369         clrf    FSR0H, ACCESS   
00193E 0012           00370         return
                      00371 
                      00372 ;**********************************************************************
                      00373 ; Function: void mootLoader_initHeap()
                      00374 ;**********************************************************************
                      00375 
001940                00376 mootLoader_initHeap
001940 EE22 F0FF      00377         lfsr    softwareStackPointerFSR, softwareStackBaseAddress
001944 0012           00378         return
                      00379         
                      00380 
                      00381         
                      00166         #include        "mootLoader_TX.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 206


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      mootLoader_TX_v0_2.asm                            *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 
                      00015 
                      00016 ;**********************************************************************
                      00017 ; INCLUDE FILES
                      00018 ;**********************************************************************
                      00019         
                      00020         #include        "../header/mootloader.h"
                      00121 ;**********************************************************************
                      00122 ;                                                                     *
                      00123 ;    Project:       deMIDulator                                       *
                      00124 ;    Filename:      eeprom.h                                          *
                      00125 ;    Date:                                                            *
                      00126 ;    File Version:                                                    *
                      00127 ;                                                                     *
                      00128 ;    Author:        Derek Enos                                        *
                      00129 ;    Company:                                                         *
                      00130 ;                                                                     * 
                      00131 ;                                                                     *
                      00132 ;**********************************************************************
                      00133 ;                                                                     *
                      00134 ;    Files required:                                                  *
                      00135 ;                                                                     *
                      00136 ;                                                                     *
                      00137 ;                                                                     *
                      00138 ;**********************************************************************
                      00139 
                      00140 #ifndef _MOOTLOADERH_
                      00141 #define _MOOTLOADERH_
                      00142 
                      00143 
                      00144 ; ******************* MOOTLOADER TRANSACTION DEFINES ***********************
                      00145 
                      00146 #define ML_BLOCK_ERASE_BYTE_SIZE                        64      ; must be multiple of ML_DATA_PAYLOAD_BY
                            TE_SIZE
                      00147 #define ML_DATA_PACKET_PAYLOAD_BYTE_SIZE        8
                      00148 
                      00149 #define ML_BLOCK_ERASE_IDLE_TIME_MS                     8
                      00150 #define ML_WRITE_IDLE_TIME_MS                           8
                      00151 #define ML_TRANS_SYNC_IDLE_TIME_MS                      32
                      00152 
                      00153 
                      00154 ; ******************* MOOTLOADER COMMAND BYTE DEFINES ***********************
                      00155 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 207


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00156 #define MIDI_VENDOR_ID                                          0x77
                      00157 #define MIDI_DEVICE_ID                                          0x1D
                      00158 
                      00159 #define ML_COMMAND_WRITE_PROGRAM_MEMORY         0x03
                      00160 #define ML_COMMAND_DATA_PAYLOAD                         0x01
                      00161 #define ML_COMMAND_DATA_PAYLOAD_COMPLETE        0x02
                      00162 #define ML_TRANSMITTER_RESETTING                        0x10
                      00163 #define ML_RECEIVER_RESET                                       0x11
                      00164 
                      00165 
                      00166 ; ******************* MOOTLOADER PACKET DEFINES ***********************
                      00167 
                      00168 #define ML_LARGE_PACKET_BYTE_SIZE               22
                      00169 
                      00170 
                      00171 ; ******************* mlFlags BIT DEFINES ***********************
                      00172 
                      00173 #define mlRxTransSyncFlag                                       0
                      00174 #define mlRxChecksumOk                                          1
                      00175 
                      00176 
                      00177 ;**********************************************************************
                      00178 ; MACROS
                      00179 ;**********************************************************************
                      00180 
                      00181 SEND_SYSEX_INTRO_NO_CHECK       MACRO
                      00182         movlw   0xF0
                      00183         call    mootLoader_sendByte
                      00184         movlw   MIDI_VENDOR_ID
                      00185         call    mootLoader_sendByte
                      00186         movlw   MIDI_DEVICE_ID
                      00187         call    mootLoader_sendByte
                      00188         ENDM
                      00189 
                      00190 SEND_BYTE_START_CHECKSUM        MACRO
                      00191         movwf   mlChecksum, ACCESS
                      00192         call    mootLoader_sendByte
                      00193         ENDM
                      00194 
                      00195 SEND_BYTE_DO_CHECKSUM           MACRO
                      00196         xorwf   mlChecksum, f, ACCESS
                      00197         call    mootLoader_sendByte
                      00198         ENDM
                      00199 
                      00200 SPLIT_BYTE_THEN_SEND_DO_CHECKSUM        MACRO
                      00201         xorwf   mlChecksum, f, ACCESS
                      00202         call    mootLoader_sendAsNybbles
                      00203         ENDM
                      00204 
                      00205 SEND_CHECKSUM_CLEAR_RUN         MACRO
                      00206         movf    mlChecksum, w, ACCESS
                      00207         ; ensure that bit 7 is clear
                      00208         andlw   0x7f
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 208


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00209         clrf    mlRunningChecksum, ACCESS
                      00210         call    mootLoader_sendByte
                      00211         ENDM
                      00212         
                      00213 SEND_CHECKSUM_DO_RUN            MACRO
                      00214         movf    mlChecksum, w, ACCESS
                      00215         ; ensure that bit 7 is clear
                      00216         andlw   0x7f
                      00217         xorwf   mlRunningChecksum, f, ACCESS
                      00218         call    mootLoader_sendByte
                      00219         ENDM
                      00220 
                      00221 SEND_RUNNING_CHECKSUM           MACRO
                      00222         movf    mlRunningChecksum, w, ACCESS
                      00223         ; ensure that bit 7 is clear
                      00224         andlw   0x7f
                      00225         call    mootLoader_sendByte
                      00226         ENDM
                      00227 
                      00228 IDLE_BLOCK_ERASE                        MACRO
                      00229         movlw   ML_BLOCK_ERASE_IDLE_TIME_MS
                      00230         call    mootLoader_wait
                      00231         ENDM
                      00232 
                      00233 IDLE_WRITE_WAIT                         MACRO
                      00234         movlw   ML_WRITE_IDLE_TIME_MS
                      00235         call    mootLoader_wait
                      00236         ENDM
                      00237 
                      00238         
                      00239 #endif
                      00240 
                      00021 
                      00022         
                      00023 ;**********************************************************************
                      00024 ; LOCAL VARIABLES
                      00025 ;**********************************************************************
                      00026 
                      00027 ; all variables defined in mootLoader.asm
                      00028 
                      00029 
                      00030 ;**********************************************************************
                      00031 ; mootLoader Trasmitter Code Begin
                      00032 ;**********************************************************************
                      00033 
001946                00034 mootLoader_transmitter
                      00035         ; shut off sine LED leaving square and sample LEDs illuminated to communicate current mode to us
                            er
                      00036         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
001946 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 209


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M #endif
                      00037 
                      00038         ; start program memory broadcast from address USER_CODE_START_ADDRESS
                      00039         ; bootloader is not allowed to touch first 64-byte block to ensure that user will not
                      00040         ; corrupt jump to bootloader on reset
001948 0E40           00041         movlw   USER_CODE_START_ADDRESS
00194A 6E03           00042         movwf   mlStartAddress + 0, ACCESS
00194C 6A04           00043         clrf    mlStartAddress + 1, ACCESS
00194E 6A05           00044         clrf    mlStartAddress + 2, ACCESS
001950 6A06           00045         clrf    mlStartAddress + 3, ACCESS
                      00046 
                      00047         ; requesting full user application code Program Memory so...
                      00048         ; length = (lastApplicationProgramMemoryAddress - USER_CODE_START_ADDRESS) aligned to 64-byte bo
                            undary
001952 0E40           00049         movlw   USER_CODE_START_ADDRESS
                      00050         ; WREG = low(lastApplicationProgramMemoryAddress) - USER_CODE_START_ADDRESS
001954 08??           00051         sublw   low(lastApplicationProgramMemoryAddress)
001956 6E07           00052         movwf   mlPayloadLength + 0, ACCESS
                      00053         
001958 0E??           00054         movlw   high(lastApplicationProgramMemoryAddress)
00195A 6E08           00055         movwf   mlPayloadLength + 1, ACCESS
                      00056         ; if result of low(lastApplicationProgramMemoryAddress) - USER_CODE_START_ADDRESS <0 then decrem
                            ent
00195C A0D8           00057         btfss   STATUS, C, ACCESS
00195E 0608           00058         decf    mlPayloadLength + 1, f, ACCESS
                      00059         
001960 0E??           00060         movlw   upper(lastApplicationProgramMemoryAddress)
001962 6E09           00061         movwf   mlPayloadLength + 2, ACCESS
                      00062         ; if result of (decf    mlPayloadLength + 1, f, ACCESS) <0 then decrement
001964 A0D8           00063         btfss   STATUS, C, ACCESS
001966 0609           00064         decf    mlPayloadLength + 2, f, ACCESS
001968 6A0A           00065         clrf    mlPayloadLength + 3, ACCESS
                      00066 
                      00067         ; if mlPayloadLength is not 64-byte aligned then align it
00196A 0E3F           00068         movlw   0x3f
00196C 1407           00069         andwf   mlPayloadLength + 0, w, ACCESS
                      00070         ; it's aligned to skip alignment
00196E E0??           00071         bz              mootLoader_xmitStartWrite
                      00072         ; clear 6 least significant bits
001970 0EC0           00073         movlw   0xC0
001972 1607           00074         andwf   mlPayloadLength + 0, f, ACCESS
                      00075         ; add 64 to mlPayloadLength
001974 0E40           00076         movlw   0x40
001976 2607           00077         addwf   mlPayloadLength + 0, f, ACCESS
001978 0E00           00078         movlw   0
00197A 2208           00079         addwfc  mlPayloadLength + 1, f, ACCESS
00197C 2209           00080         addwfc  mlPayloadLength + 2, f, ACCESS
00197E 220A           00081         addwfc  mlPayloadLength + 3, f, ACCESS
                      00082 
001980                00083 mootLoader_xmitStartWrite
001980 EC?? F???      00084         call    mootLoader_xmitWriteProgramMemory
001984 EF?? F???      00085         goto    mootLoader_exit 
                      00086 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 210


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00087 
                      00088 ;**********************************************************************
                      00089 ; mootLoader Trasmitter: Write Program Memory
                      00090 ;**********************************************************************
Warning[208]: Label truncated at 32 characters. (mootLoader_xmitWriteProgramMemory)
001988                00091 mootLoader_xmitWriteProgramMemory
                      00092         PUSH_R  FSR0L
001988 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00093         PUSH_R  FSR0H
00198C CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00094 
                      00095         ;****************************************
                      00096         ; send Write Program Memory packet
001990 EC?? F???      00097         call    mootLoader_xmitSendWpmPacket
                      00098         ;****************************************
                      00099 
                      00100         ;****************************************
                      00101         ; send Complete Data Payload
                      00102         ; init table pointer with program memory start address
001994 C003 FFF6      00103         movff   mlStartAddress + 0, TBLPTRL
001998 C004 FFF7      00104         movff   mlStartAddress + 1, TBLPTRH
00199C C005 FFF8      00105         movff   mlStartAddress + 2, TBLPTRU
                      00106 
0019A0                00107 mootLoader_xmitWpmBlockErase
                      00108         IDLE_BLOCK_ERASE        
0019A0 0E08               M         movlw   ML_BLOCK_ERASE_IDLE_TIME_MS
0019A2 EC?? F???          M         call    mootLoader_wait
                      00109         ; load erase block size counter
0019A6 0E40           00110         movlw   ML_BLOCK_ERASE_BYTE_SIZE
0019A8 6E18           00111         movwf   mlBlockEraseBytesRemaining, ACCESS
                      00112 
0019AA                00113 mootLoader_xmitWpmNextPayload
                      00114         ;****************************************
                      00115         ; send single Data Payload packet
                      00116         ; load mlDataPayloadBuffer with bytes to send
0019AA EE00 F00B      00117         lfsr    FSR0, mlDataPayloadBuffer
                      00118         ; load counter with num of bytes remaining in payload packet
0019AE 0E08           00119         movlw   ML_DATA_PACKET_PAYLOAD_BYTE_SIZE
0019B0 6E13           00120         movwf   mlCount, ACCESS
0019B2                00121 mootLoader_xmitWpmByteLp
                      00122         ; read program memory location and increment
0019B2 0009           00123         tblrd*+
                      00124         ; save value to mlDataPayloadBuffer
0019B4 CFF5 FFEE      00125         movff   TABLAT, POSTINC0
                      00126         ; check if mlDataPayloadBuffer is ready to go
0019B8 0613           00127         decf    mlCount, f, ACCESS
0019BA E1??           00128         bnz             mootLoader_xmitWpmByteLp
                      00129         ; send the packet
0019BC EC?? F???      00130         call    mootLoader_xmitSendDataPayloadPacket
                      00131         ;****************************************
                      00132 
                      00133         ; do write wait after every packet transfer
                      00134         IDLE_WRITE_WAIT
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 211


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0019C0 0E08               M         movlw   ML_WRITE_IDLE_TIME_MS
0019C2 EC?? F???          M         call    mootLoader_wait
                      00135         
                      00136         ; check if entire payload has been transferred
                      00137         ; do (mlPayloadLength -= ML_DATA_PACKET_PAYLOAD_BYTE_SIZE)
0019C6 0E08           00138         movlw   ML_DATA_PACKET_PAYLOAD_BYTE_SIZE
0019C8 5E07           00139         subwf   mlPayloadLength + 0, f, ACCESS
0019CA 0E00           00140         movlw   0
0019CC 5A08           00141         subwfb  mlPayloadLength + 1, f, ACCESS  
0019CE 5A09           00142         subwfb  mlPayloadLength + 2, f, ACCESS  
0019D0 5A0A           00143         subwfb  mlPayloadLength + 3, f, ACCESS
                      00144         ; if mlPayloadLength == 0 then entire payload has been transferred
                      00145         ; if mlPayloadLength != 0 then check if we have to wait for another block erase
0019D2 5207           00146         movf    mlPayloadLength + 0, f, ACCESS
0019D4 E1??           00147         bnz             mootLoader_xmitWpmCheckBlockErase
0019D6 5208           00148         movf    mlPayloadLength + 1, f, ACCESS
0019D8 E1??           00149         bnz             mootLoader_xmitWpmCheckBlockErase
0019DA 5209           00150         movf    mlPayloadLength + 2, f, ACCESS
0019DC E1??           00151         bnz             mootLoader_xmitWpmCheckBlockErase
0019DE 520A           00152         movf    mlPayloadLength + 3, f, ACCESS
0019E0 E1??           00153         bnz             mootLoader_xmitWpmCheckBlockErase
0019E2 D???           00154         bra             mootLoader_xmitWpmSendPayloadComplete
                      00155 
Warning[208]: Label truncated at 32 characters. (mootLoader_xmitWpmCheckBlockErase)
0019E4                00156 mootLoader_xmitWpmCheckBlockErase
                      00157         ; check if we need to wait for a block erase
                      00158         ; do (mlBlockEraseBytesRemaining - ML_DATA_PACKET_PAYLOAD_BYTE_SIZE)
0019E4 0E08           00159         movlw   ML_DATA_PACKET_PAYLOAD_BYTE_SIZE
0019E6 5E18           00160         subwf   mlBlockEraseBytesRemaining, f, ACCESS
                      00161         ; if 0 then delay for block erase
0019E8 E0??           00162         bz              mootLoader_xmitWpmBlockErase
0019EA D???           00163         bra             mootLoader_xmitWpmNextPayload
                      00164         
Warning[208]: Label truncated at 32 characters. (mootLoader_xmitWpmSendPayloadComplete)
0019EC                00165 mootLoader_xmitWpmSendPayloadComplete
                      00166         ; mlPayloadLength == 0 so send Data Payload Complete packet
                      00167         ;****************************************
                      00168         ; send Data Payload Complete packet
0019EC EC?? F???      00169         call    mootLoader_xmitSendDataPayloadCompletePacket
                      00170         ;****************************************
                      00171 
                      00172         ; transaction complete
                      00173         POP_R   FSR0H
0019F0 CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00174         POP_R   FSR0L
0019F4 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
0019F8 0012           00175         return
                      00176                 
                      00177                         
                      00178 ;**********************************************************************
                      00179 ; mootLoader Trasmitter: send Write Program Memory packet
                      00180 ;**********************************************************************
0019FA                00181 mootLoader_xmitSendWpmPacket
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 212


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00182 
                      00183         ;****************************************
                      00184         ; send SysEx intro (0xF0, vendorID, deviceID)
                      00185         SEND_SYSEX_INTRO_NO_CHECK
0019FA 0EF0               M         movlw   0xF0
0019FC EC?? F???          M         call    mootLoader_sendByte
001A00 0E77               M         movlw   MIDI_VENDOR_ID
001A02 EC?? F???          M         call    mootLoader_sendByte
001A06 0E1D               M         movlw   MIDI_DEVICE_ID
001A08 EC?? F???          M         call    mootLoader_sendByte
                      00186         ;****************************************
                      00187         
                      00188         ;****************************************
                      00189         ; send COMMAND
001A0C 0E03           00190         movlw   ML_COMMAND_WRITE_PROGRAM_MEMORY
                      00191         SEND_BYTE_START_CHECKSUM
001A0E 6E01               M         movwf   mlChecksum, ACCESS
001A10 EC?? F???          M         call    mootLoader_sendByte
                      00192         ;****************************************
                      00193 
                      00194         ;****************************************
                      00195         ; send START ADDRESS
001A14 5003           00196         movf    mlStartAddress + 0, w, ACCESS
                      00197         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A16 1A01               M         xorwf   mlChecksum, f, ACCESS
001A18 EC?? F???          M         call    mootLoader_sendAsNybbles
001A1C 5004           00198         movf    mlStartAddress + 1, w, ACCESS
                      00199         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A1E 1A01               M         xorwf   mlChecksum, f, ACCESS
001A20 EC?? F???          M         call    mootLoader_sendAsNybbles
001A24 5005           00200         movf    mlStartAddress + 2, w, ACCESS
                      00201         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A26 1A01               M         xorwf   mlChecksum, f, ACCESS
001A28 EC?? F???          M         call    mootLoader_sendAsNybbles
001A2C 5006           00202         movf    mlStartAddress + 3, w, ACCESS
                      00203         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A2E 1A01               M         xorwf   mlChecksum, f, ACCESS
001A30 EC?? F???          M         call    mootLoader_sendAsNybbles
                      00204         ;****************************************
                      00205 
                      00206         ;****************************************
                      00207         ; send PAYLOAD LENGTH
001A34 5007           00208         movf    mlPayloadLength + 0, w, ACCESS
                      00209         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A36 1A01               M         xorwf   mlChecksum, f, ACCESS
001A38 EC?? F???          M         call    mootLoader_sendAsNybbles
001A3C 5008           00210         movf    mlPayloadLength + 1, w, ACCESS
                      00211         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A3E 1A01               M         xorwf   mlChecksum, f, ACCESS
001A40 EC?? F???          M         call    mootLoader_sendAsNybbles
001A44 5009           00212         movf    mlPayloadLength + 2, w, ACCESS
                      00213         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A46 1A01               M         xorwf   mlChecksum, f, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 213


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001A48 EC?? F???          M         call    mootLoader_sendAsNybbles
001A4C 500A           00214         movf    mlPayloadLength + 3, w, ACCESS
                      00215         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A4E 1A01               M         xorwf   mlChecksum, f, ACCESS
001A50 EC?? F???          M         call    mootLoader_sendAsNybbles
                      00216         ;****************************************
                      00217         
                      00218         ;****************************************
                      00219         ; send CHECKSUM
                      00220         SEND_CHECKSUM_CLEAR_RUN
001A54 5001               M         movf    mlChecksum, w, ACCESS
                          M         ; ensure that bit 7 is clear
001A56 0B7F               M         andlw   0x7f
001A58 6A02               M         clrf    mlRunningChecksum, ACCESS
001A5A EC?? F???          M         call    mootLoader_sendByte
                      00221         ;****************************************
                      00222 
                      00223         ;****************************************
                      00224         ; send End of SysEx
001A5E 0EF7           00225         movlw   0xF7
001A60 EC?? F???      00226         call    mootLoader_sendByte
                      00227         ;****************************************
                      00228         
001A64 0012           00229         return  
                      00230         
                      00231         
                      00232 ;**********************************************************************
                      00233 ; mootLoader Trasmitter: send Data Payload Packet
                      00234 ;**********************************************************************
Warning[208]: Label truncated at 32 characters. (mootLoader_xmitSendDataPayloadPacket)
001A66                00235 mootLoader_xmitSendDataPayloadPacket
                      00236 
                      00237         PUSH_R  FSR0L
001A66 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00238         PUSH_R  FSR0H
001A6A CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
001A6E EE00 F00B      00239         lfsr    FSR0, mlDataPayloadBuffer
                      00240                 
                      00241         ;****************************************
                      00242         ; send SysEx intro (0xF0, vendorID, deviceID)
                      00243         SEND_SYSEX_INTRO_NO_CHECK
001A72 0EF0               M         movlw   0xF0
001A74 EC?? F???          M         call    mootLoader_sendByte
001A78 0E77               M         movlw   MIDI_VENDOR_ID
001A7A EC?? F???          M         call    mootLoader_sendByte
001A7E 0E1D               M         movlw   MIDI_DEVICE_ID
001A80 EC?? F???          M         call    mootLoader_sendByte
                      00244         ;****************************************
                      00245         
                      00246         ;****************************************
                      00247         ; send COMMAND
001A84 0E01           00248         movlw   ML_COMMAND_DATA_PAYLOAD
                      00249         SEND_BYTE_START_CHECKSUM
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 214


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001A86 6E01               M         movwf   mlChecksum, ACCESS
001A88 EC?? F???          M         call    mootLoader_sendByte
                      00250         ;****************************************
                      00251 
                      00252         ;****************************************
                      00253         ; send PAYLOAD bytes
001A8C 0E08           00254         movlw   ML_DATA_PACKET_PAYLOAD_BYTE_SIZE
001A8E 6E19           00255         movwf   mlDatPackIntByteCount, ACCESS
001A90                00256 mootLoader_xmitSdppLp
                      00257         ; read byte
001A90 50EF           00258         movf    INDF0, w, ACCESS
                      00259         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001A92 1A01               M         xorwf   mlChecksum, f, ACCESS
001A94 EC?? F???          M         call    mootLoader_sendAsNybbles
                      00260         ; increment pointer
001A98 50EE           00261         movf    POSTINC0, w, ACCESS
                      00262         ; check if Data Payload packet is complete
001A9A 0619           00263         decf    mlDatPackIntByteCount, f, ACCESS
001A9C E1??           00264         bnz             mootLoader_xmitSdppLp
                      00265         ;****************************************
                      00266 
                      00267         ;****************************************
                      00268         ; send CHECKSUM
                      00269         SEND_CHECKSUM_DO_RUN
001A9E 5001               M         movf    mlChecksum, w, ACCESS
                          M         ; ensure that bit 7 is clear
001AA0 0B7F               M         andlw   0x7f
001AA2 1A02               M         xorwf   mlRunningChecksum, f, ACCESS
001AA4 EC?? F???          M         call    mootLoader_sendByte
                      00270         ;****************************************
                      00271 
                      00272         ;****************************************
                      00273         ; send End of SysEx
001AA8 0EF7           00274         movlw   0xF7
001AAA EC?? F???      00275         call    mootLoader_sendByte
                      00276         ;****************************************
                      00277 
                      00278         POP_R   FSR0H
001AAE CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00279         POP_R   FSR0L
001AB2 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
001AB6 0012           00280         return
                      00281 
                      00282 
                      00283 ;**********************************************************************
                      00284 ; mootLoader Trasmitter: send Data Payload Complete Packet
                      00285 ;**********************************************************************
Warning[208]: Label truncated at 32 characters. (mootLoader_xmitSendDataPayloadCompletePacket)
001AB8                00286 mootLoader_xmitSendDataPayloadCompletePacket
                      00287         ;****************************************
                      00288         ; send SysEx intro (0xF0, vendorID, deviceID)
                      00289         SEND_SYSEX_INTRO_NO_CHECK
001AB8 0EF0               M         movlw   0xF0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 215


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001ABA EC?? F???          M         call    mootLoader_sendByte
001ABE 0E77               M         movlw   MIDI_VENDOR_ID
001AC0 EC?? F???          M         call    mootLoader_sendByte
001AC4 0E1D               M         movlw   MIDI_DEVICE_ID
001AC6 EC?? F???          M         call    mootLoader_sendByte
                      00290         ;****************************************
                      00291         
                      00292         ;****************************************
                      00293         ; send COMMAND
001ACA 0E02           00294         movlw   ML_COMMAND_DATA_PAYLOAD_COMPLETE
                      00295         SEND_BYTE_START_CHECKSUM
001ACC 6E01               M         movwf   mlChecksum, ACCESS
001ACE EC?? F???          M         call    mootLoader_sendByte
                      00296         ;****************************************
                      00297 
001AD2 0E00           00298         movlw   0x00
                      00299         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001AD4 1A01               M         xorwf   mlChecksum, f, ACCESS
001AD6 EC?? F???          M         call    mootLoader_sendAsNybbles
001ADA 0E00           00300         movlw   0x00
                      00301         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001ADC 1A01               M         xorwf   mlChecksum, f, ACCESS
001ADE EC?? F???          M         call    mootLoader_sendAsNybbles
001AE2 0E00           00302         movlw   0x00
                      00303         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001AE4 1A01               M         xorwf   mlChecksum, f, ACCESS
001AE6 EC?? F???          M         call    mootLoader_sendAsNybbles
001AEA 0E00           00304         movlw   0x00
                      00305         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001AEC 1A01               M         xorwf   mlChecksum, f, ACCESS
001AEE EC?? F???          M         call    mootLoader_sendAsNybbles
001AF2 0E00           00306         movlw   0x00
                      00307         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001AF4 1A01               M         xorwf   mlChecksum, f, ACCESS
001AF6 EC?? F???          M         call    mootLoader_sendAsNybbles
001AFA 0E00           00308         movlw   0x00
                      00309         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001AFC 1A01               M         xorwf   mlChecksum, f, ACCESS
001AFE EC?? F???          M         call    mootLoader_sendAsNybbles
001B02 0E00           00310         movlw   0x00
                      00311         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001B04 1A01               M         xorwf   mlChecksum, f, ACCESS
001B06 EC?? F???          M         call    mootLoader_sendAsNybbles
001B0A 0E00           00312         movlw   0x00
                      00313         SPLIT_BYTE_THEN_SEND_DO_CHECKSUM
001B0C 1A01               M         xorwf   mlChecksum, f, ACCESS
001B0E EC?? F???          M         call    mootLoader_sendAsNybbles
                      00314         SEND_RUNNING_CHECKSUM
001B12 5002               M         movf    mlRunningChecksum, w, ACCESS
                          M         ; ensure that bit 7 is clear
001B14 0B7F               M         andlw   0x7f
001B16 EC?? F???          M         call    mootLoader_sendByte
                      00315 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 216


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00316         ;****************************************
                      00317         ; send End of SysEx
001B1A 0EF7           00318         movlw   0xF7
001B1C EC?? F???      00319         call    mootLoader_sendByte
                      00320         ;****************************************       
                      00321         
001B20 0012           00322         return
                      00323         
                      00324 
                      00325 ;**********************************************************************
                      00326 ; Local Function: void mootLoader_sendAsNybbles(WREG)
                      00327 ;**********************************************************************
001B22                00328 mootLoader_sendAsNybbles
                      00329         ; save to tmp variable
001B22 6E16           00330         movwf   mlNybbleSplitTmp, ACCESS
                      00331         ; mask out low nybble and send
001B24 0B0F           00332         andlw   0x0F
001B26 EC?? F???      00333         call    mootLoader_sendByte
                      00334         ; swap nybbles, mask out low nybble then send
001B2A 3816           00335         swapf   mlNybbleSplitTmp, w, ACCESS
001B2C 0B0F           00336         andlw   0x0F
001B2E EC?? F???      00337         call    mootLoader_sendByte     
001B32 0012           00338         return
                      00339 
                      00340 
                      00341 ;**********************************************************************
                      00342 ; Local Function: void mootLoader_sendByte(WREG)
                      00343 ;**********************************************************************
001B34                00344 mootLoader_sendByte
                      00345         ; check if TXREG is clear, wait if not
001B34 A89E           00346         btfss   PIR1, TXIF, ACCESS
001B36 D???           00347         bra             mootLoader_sendByte
001B38 6EAD           00348         movwf   TXREG, ACCESS
001B3A 0012           00349         return
                      00350 
                      00351 
                      00352 ;**********************************************************************
                      00353 ; mootLoader Trasmitter: Wait(WREG = WAIT_TIME_MS)
                      00354 ;**********************************************************************
001B3C                00355 mootLoader_wait
                      00356         ; exit if delay time request is 0
001B3C 52E8           00357         movf    WREG, f, ACCESS
001B3E E0??           00358         bz              mootLoader_waitExit
                      00359         
                      00360         ; TMR2 overflow period (32uS) * 32 = 1.024mS
                      00361         ; so do PRODH:L = WREG * 32
001B40 6EF3           00362         movwf   PRODL, ACCESS
001B42 0E20           00363         movlw   32
001B44 02F3           00364         mulwf   PRODL, ACCESS
                      00365 
                      00366         ; reset timer
001B46 6ACC           00367         clrf    TMR2, ACCESS
001B48                00368 mootLoader_waitLp
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 217


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00369         ; clear interrupt flag and wait for timer overflow
001B48 929E           00370         bcf             PIR1, TMR2IF, ACCESS    
001B4A                00371 mootLoader_waitIntLp
001B4A A29E           00372         btfss   PIR1, TMR2IF, ACCESS
001B4C D???           00373         bra             mootLoader_waitIntLp
                      00374         ; unintelligently decrement PRODH:L counter
001B4E 06F3           00375         decf    PRODL, f, ACCESS
                      00376         ; skip if result was positive
001B50 A0D8           00377         btfss   STATUS, C, ACCESS
001B52 06F4           00378         decf    PRODH, f, ACCESS
                      00379         ; test PRODH:L, exit if 0
001B54 52F3           00380         movf    PRODL, f, ACCESS
001B56 E1??           00381         bnz             mootLoader_waitLp
001B58 52F4           00382         movf    PRODH, f, ACCESS
001B5A E1??           00383         bnz             mootLoader_waitLp
001B5C                00384 mootLoader_waitExit     
001B5C 0012           00385         return
                      00386 
                      00387 
                      00167         #include        "mootLoader_RX.asm"
                      00001 
                      00002 ;**********************************************************************
                      00003 ;                                                                     *
                      00004 ;    Project:       deMIDulator                                       *
                      00005 ;    Filename:      mootLoader_RX_v0_2.asm                            *
                      00006 ;    Date:                                                            *
                      00007 ;    File Version:                                                    *
                      00008 ;                                                                     *
                      00009 ;    Author:        Derek Enos                                        *
                      00010 ;    Company:                                                         *
                      00011 ;                                                                     * 
                      00012 ;                                                                     *
                      00013 ;**********************************************************************
                      00014 
                      00015 
                      00016 ;**********************************************************************
                      00017 ; INCLUDE FILES
                      00018 ;**********************************************************************
                      00019         
                      00020         #include        "../header/mootloader.h"
                      00241 ;**********************************************************************
                      00242 ;                                                                     *
                      00243 ;    Project:       deMIDulator                                       *
                      00244 ;    Filename:      eeprom.h                                          *
                      00245 ;    Date:                                                            *
                      00246 ;    File Version:                                                    *
                      00247 ;                                                                     *
                      00248 ;    Author:        Derek Enos                                        *
                      00249 ;    Company:                                                         *
                      00250 ;                                                                     * 
                      00251 ;                                                                     *
                      00252 ;**********************************************************************
                      00253 ;                                                                     *
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 218


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00254 ;    Files required:                                                  *
                      00255 ;                                                                     *
                      00256 ;                                                                     *
                      00257 ;                                                                     *
                      00258 ;**********************************************************************
                      00259 
                      00260 #ifndef _MOOTLOADERH_
                      00261 #define _MOOTLOADERH_
                      00262 
                      00263 
                      00264 ; ******************* MOOTLOADER TRANSACTION DEFINES ***********************
                      00265 
                      00266 #define ML_BLOCK_ERASE_BYTE_SIZE                        64      ; must be multiple of ML_DATA_PAYLOAD_BY
                            TE_SIZE
                      00267 #define ML_DATA_PACKET_PAYLOAD_BYTE_SIZE        8
                      00268 
                      00269 #define ML_BLOCK_ERASE_IDLE_TIME_MS                     8
                      00270 #define ML_WRITE_IDLE_TIME_MS                           8
                      00271 #define ML_TRANS_SYNC_IDLE_TIME_MS                      32
                      00272 
                      00273 
                      00274 ; ******************* MOOTLOADER COMMAND BYTE DEFINES ***********************
                      00275 
                      00276 #define MIDI_VENDOR_ID                                          0x77
                      00277 #define MIDI_DEVICE_ID                                          0x1D
                      00278 
                      00279 #define ML_COMMAND_WRITE_PROGRAM_MEMORY         0x03
                      00280 #define ML_COMMAND_DATA_PAYLOAD                         0x01
                      00281 #define ML_COMMAND_DATA_PAYLOAD_COMPLETE        0x02
                      00282 #define ML_TRANSMITTER_RESETTING                        0x10
                      00283 #define ML_RECEIVER_RESET                                       0x11
                      00284 
                      00285 
                      00286 ; ******************* MOOTLOADER PACKET DEFINES ***********************
                      00287 
                      00288 #define ML_LARGE_PACKET_BYTE_SIZE               22
                      00289 
                      00290 
                      00291 ; ******************* mlFlags BIT DEFINES ***********************
                      00292 
                      00293 #define mlRxTransSyncFlag                                       0
                      00294 #define mlRxChecksumOk                                          1
                      00295 
                      00296 
                      00297 ;**********************************************************************
                      00298 ; MACROS
                      00299 ;**********************************************************************
                      00300 
                      00301 SEND_SYSEX_INTRO_NO_CHECK       MACRO
                      00302         movlw   0xF0
                      00303         call    mootLoader_sendByte
                      00304         movlw   MIDI_VENDOR_ID
                      00305         call    mootLoader_sendByte
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 219


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00306         movlw   MIDI_DEVICE_ID
                      00307         call    mootLoader_sendByte
                      00308         ENDM
                      00309 
                      00310 SEND_BYTE_START_CHECKSUM        MACRO
                      00311         movwf   mlChecksum, ACCESS
                      00312         call    mootLoader_sendByte
                      00313         ENDM
                      00314 
                      00315 SEND_BYTE_DO_CHECKSUM           MACRO
                      00316         xorwf   mlChecksum, f, ACCESS
                      00317         call    mootLoader_sendByte
                      00318         ENDM
                      00319 
                      00320 SPLIT_BYTE_THEN_SEND_DO_CHECKSUM        MACRO
                      00321         xorwf   mlChecksum, f, ACCESS
                      00322         call    mootLoader_sendAsNybbles
                      00323         ENDM
                      00324 
                      00325 SEND_CHECKSUM_CLEAR_RUN         MACRO
                      00326         movf    mlChecksum, w, ACCESS
                      00327         ; ensure that bit 7 is clear
                      00328         andlw   0x7f
                      00329         clrf    mlRunningChecksum, ACCESS
                      00330         call    mootLoader_sendByte
                      00331         ENDM
                      00332         
                      00333 SEND_CHECKSUM_DO_RUN            MACRO
                      00334         movf    mlChecksum, w, ACCESS
                      00335         ; ensure that bit 7 is clear
                      00336         andlw   0x7f
                      00337         xorwf   mlRunningChecksum, f, ACCESS
                      00338         call    mootLoader_sendByte
                      00339         ENDM
                      00340 
                      00341 SEND_RUNNING_CHECKSUM           MACRO
                      00342         movf    mlRunningChecksum, w, ACCESS
                      00343         ; ensure that bit 7 is clear
                      00344         andlw   0x7f
                      00345         call    mootLoader_sendByte
                      00346         ENDM
                      00347 
                      00348 IDLE_BLOCK_ERASE                        MACRO
                      00349         movlw   ML_BLOCK_ERASE_IDLE_TIME_MS
                      00350         call    mootLoader_wait
                      00351         ENDM
                      00352 
                      00353 IDLE_WRITE_WAIT                         MACRO
                      00354         movlw   ML_WRITE_IDLE_TIME_MS
                      00355         call    mootLoader_wait
                      00356         ENDM
                      00357 
                      00358         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 220


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00359 #endif
                      00360 
                      00021 
                      00022         
                      00023 ;**********************************************************************
                      00024 ; LOCAL VARIABLES
                      00025 ;**********************************************************************
                      00026 
                      00027 ; all variables defined in mootLoader_v0_2.asm
                      00028 
                      00029 
                      00030 ;**********************************************************************
                      00031 ; mootLoader Receiver Code Begin
                      00032 ;**********************************************************************
001B5E                00033 mootLoader_receiver
                      00034         ; communicate mode to user
                      00035         ; shut off sample LED leaving sine and square LEDs illuminated to communicate current mode to us
                            er
                      00036         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
001B5E 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
                      00037 
Warning[208]: Label truncated at 32 characters. (mootLoader_receiverListenForTrans)
001B60                00038 mootLoader_receiverListenForTrans
001B60 EC?? F???      00039         call    mootLoader_rxReceiveNextPacket
                      00040         ; jump to command handler
001B64 0E03           00041         movlw   ML_COMMAND_WRITE_PROGRAM_MEMORY
001B66 181E           00042         xorwf   mlRxReceivedPacket + 3, w, ACCESS
001B68 E0??           00043         bz              mootLoader_rxWriteProgramMemoryHandler
001B6A 0E11           00044         movlw   ML_RECEIVER_RESET
001B6C 181E           00045         xorwf   mlRxReceivedPacket + 3, w, ACCESS
001B6E EF?? F???      00046         goto    mootLoader_rxReceiverResetHandler
                      00047         ; unhandled command so listen for next trans sync
001B72 D???           00048         bra             mootLoader_receiverListenForTrans
                      00049                 
001B74 EF?? F???      00050         goto    mootLoader_exit
                      00051 
                      00052 
                      00053 ;**********************************************************************
                      00054 ; Local Function: void mootLoader_rxWriteProgramMemoryHandler()
                      00055 ;**********************************************************************
Warning[208]: Label truncated at 32 characters. (mootLoader_rxWriteProgramMemoryHandler)
001B78                00056 mootLoader_rxWriteProgramMemoryHandler
                      00057         ; save write start address
001B78 C01F F003      00058         movff   mlRxReceivedPacket + 4, mlStartAddress + 0
001B7C C021 F004      00059         movff   mlRxReceivedPacket + 6, mlStartAddress + 1
001B80 C023 F005      00060         movff   mlRxReceivedPacket + 8, mlStartAddress + 2
001B84 C025 F006      00061         movff   mlRxReceivedPacket + 10, mlStartAddress + 3
                      00062         ; save payload length
001B88 C027 F007      00063         movff   mlRxReceivedPacket + 12, mlPayloadLength + 0
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 221


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001B8C C029 F008      00064         movff   mlRxReceivedPacket + 14, mlPayloadLength + 1
001B90 C02B F009      00065         movff   mlRxReceivedPacket + 16, mlPayloadLength + 2
001B94 C02D F00A      00066         movff   mlRxReceivedPacket + 18, mlPayloadLength + 3
                      00067         ; test checksum, exit if bad
001B98 EC?? F???      00068         call    mootloader_rxTestSinglePacketChecksum
001B9C A215           00069         btfss   mlFlags, mlRxChecksumOk, ACCESS
001B9E D???           00070         bra             mootLoader_signalErrorA
                      00071         
                      00072         ; load table pointer with start address
001BA0 C003 FFF6      00073         movff   mlStartAddress + 0, TBLPTRL
001BA4 C004 FFF7      00074         movff   mlStartAddress + 1, TBLPTRH
001BA8 C005 FFF8      00075         movff   mlStartAddress + 2, TBLPTRU
                      00076 
001BAC                00077 mootLoader_rxWpmhBlockErase
                      00078         ; point to Flash Program Memory
001BAC 8EA6           00079         bsf             EECON1, EEPGD, ACCESS
                      00080         ; access Flash Program Memory
001BAE 9CA6           00081         bcf             EECON1, CFGS, ACCESS
                      00082         ; enable write to memory
001BB0 84A6           00083         bsf             EECON1, WREN, ACCESS
                      00084         ; enable erase operation
001BB2 88A6           00085         bsf             EECON1, FREE, ACCESS
                      00086         ; do require sequence
001BB4 0E55           00087         movlw   0x55
001BB6 6EA7           00088         movwf   EECON2, ACCESS
001BB8 0EAA           00089         movlw   0xAA
001BBA 6EA7           00090         movwf   EECON2, ACCESS
                      00091         ; start write, CPU will stall
001BBC 82A6           00092         bsf             EECON1, WR, ACCESS
                      00093         ; dummy read decrement to reset TBLPTR. Don't know why this is necessary but sure enough...
                      00094         ; without it all my writes were off by one address. Is included in datasheet example code
001BBE 000A           00095         tblrd*-
                      00096                 
                      00097         ; get next packet
001BC0                00098 mootLoader_rxWpmhGetNextPacket
001BC0 EC?? F???      00099         call    mootLoader_rxReceiveNextPacket
                      00100         
                      00101         ; toggle all LEDs to indicate activity
                      00102         LED_ALL_TOGGLE
                          M         LED_SINE_TOGGLE
001BC4 768B               M         btg             LATC, RC3, ACCESS       ; SINE LED
                          M         LED_SQUARE_TOGGLE
001BC6 788B               M         btg             LATC, RC4, ACCESS       ; SQUARE LED
                          M         LED_SAMPLE_TOGGLE
001BC8 7A89               M         btg             LATA, RA5, ACCESS       ; SAMPLE LED
                      00103         
                      00104         ; if data payload complete then reset device
001BCA 0E02           00105         movlw   ML_COMMAND_DATA_PAYLOAD_COMPLETE
001BCC 181E           00106         xorwf   mlRxReceivedPacket + 3, w, ACCESS
001BCE E0??           00107         bz              mootLoader_rxReceiverResetHandler
                      00108         ; if data payload then confirm checksum and then write data
001BD0 0E01           00109         movlw   ML_COMMAND_DATA_PAYLOAD
001BD2 181E           00110         xorwf   mlRxReceivedPacket + 3, w, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 222


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00111         ; if not data payload then exit with error
001BD4 E1??           00112         bnz             mootLoader_signalErrorB
                      00113         ; is data payload so test checksum
001BD6 EC?? F???      00114         call    mootloader_rxTestSinglePacketChecksum
001BDA A215           00115         btfss   mlFlags, mlRxChecksumOk, ACCESS
                      00116         ; checksum bad so exit with error
001BDC D???           00117         bra             mootLoader_signalErrorC
                      00118         ; everything is ok so write the payload
                      00119         
                      00120         ; write payload to holding registers
001BDE C01F FFF5      00121         movff   mlRxReceivedPacket + 4, TABLAT
001BE2 000F           00122         tblwt+*
001BE4 C021 FFF5      00123         movff   mlRxReceivedPacket + 6, TABLAT
001BE8 000F           00124         tblwt+*
001BEA C023 FFF5      00125         movff   mlRxReceivedPacket + 8, TABLAT
001BEE 000F           00126         tblwt+*
001BF0 C025 FFF5      00127         movff   mlRxReceivedPacket + 10, TABLAT
001BF4 000F           00128         tblwt+*
001BF6 C027 FFF5      00129         movff   mlRxReceivedPacket + 12, TABLAT
001BFA 000F           00130         tblwt+*
001BFC C029 FFF5      00131         movff   mlRxReceivedPacket + 14, TABLAT
001C00 000F           00132         tblwt+*
001C02 C02B FFF5      00133         movff   mlRxReceivedPacket + 16, TABLAT
001C06 000F           00134         tblwt+*
001C08 C02D FFF5      00135         movff   mlRxReceivedPacket + 18, TABLAT
001C0C 000F           00136         tblwt+*
                      00137                 
                      00138         ; write holding register to flash memory
                      00139         ; point to Flash Program Memory
001C0E 8EA6           00140         bsf             EECON1, EEPGD, ACCESS
                      00141         ; access Flash Program Memory
001C10 9CA6           00142         bcf             EECON1, CFGS, ACCESS
                      00143         ; enable write to memory
001C12 84A6           00144         bsf             EECON1, WREN, ACCESS
                      00145         ; do require sequence
001C14 0E55           00146         movlw   0x55
001C16 6EA7           00147         movwf   EECON2, ACCESS
001C18 0EAA           00148         movlw   0xAA
001C1A 6EA7           00149         movwf   EECON2, ACCESS
                      00150         ; start write, CPU will stall
001C1C 82A6           00151         bsf             EECON1, WR, ACCESS      
                      00152         
                      00153 ; DEBUG
                      00154 ;       movlw   0
                      00155 ;       call    mootloader_rxWriteRxPacketToEE
                      00156 ;       bra             mootLoader_rxWpmhExit
                      00157 
                      00158         ; do block erase on every 64-byte boundary
                      00159         ; if(!(TBLPTRL & 0x3f)){doBlockErase();}
001C1E 0E3F           00160         movlw   0x3f
001C20 14F6           00161         andwf   TBLPTRL, w, ACCESS
001C22 E0??           00162         bz              mootLoader_rxWpmhBlockErase
001C24 D???           00163         bra             mootLoader_rxWpmhGetNextPacket
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 223


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00164         
001C26                00165 mootLoader_rxWpmhExit
001C26 EF?? F???      00166         goto    mootLoader_exit
                      00167 
                      00168 
                      00169 ;**********************************************************************
                      00170 ; Local Function: void mootLoader_signalErrorA()
                      00171 ;**********************************************************************
001C2A                00172 mootLoader_signalErrorA
                      00173         LED_SINE_TOGGLE_OTHERS_OFF
                          M         LED_SINE_TOGGLE
001C2A 768B               M         btg             LATC, RC3, ACCESS       ; SINE LED
                          M         LED_SQUARE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
001C2C 988B               M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
001C2E 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #endif
001C30 6A13           00174         clrf    mlCount, ACCESS
001C32 0E10           00175         movlw   0x10
001C34 6E14           00176         movwf   mlCount + 1, ACCESS
001C36                00177 mootLoader_signalErrorALp1
                      00178         ; clear interrupt flag
001C36 929E           00179         bcf             PIR1, TMR2IF, ACCESS    
001C38                00180 mootLoader_signalErrorALp2
                      00181         ; wait for timer2 overflow
001C38 A29E           00182         btfss   PIR1, TMR2IF, ACCESS
001C3A D???           00183         bra             mootLoader_signalErrorALp2
001C3C 0613           00184         decf    mlCount, f, ACCESS
001C3E B4D8           00185         btfsc   STATUS, Z, ACCESS
001C40 2E14           00186         decfsz  mlCount + 1
001C42 D???           00187         bra             mootLoader_signalErrorALp1
                      00188         ; loop forever
001C44 D???           00189         bra             mootLoader_signalErrorA
                      00190 ;**********************************************************************
                      00191 ; Local Function: void mootLoader_signalErrorB()
                      00192 ;**********************************************************************
001C46                00193 mootLoader_signalErrorB
                      00194 ; DEBUG - write received packet to eeprom
001C46 EE10 F01B      00195         lfsr    FSR1, mlRxReceivedPacket
001C4A 6A3F           00196         clrf    mlEepromAddress, ACCESS
Warning[208]: Label truncated at 32 characters. (mootLoader_SebWriteReceivedPacketToEEPROMLp)
001C4C                00197 mootLoader_SebWriteReceivedPacketToEEPROMLp
                      00198         WRITE_INTERNAL_EEPROM_FROM_REGS mlEepromAddress, POSTINC1
  0000                    M         local   writeIntEE_loop
                          M         
                          M         ; load address
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 224


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001C4C C03F FFA9          M         movff   mlEepromAddress, EEADR
                          M         ; load value
001C50 CFE6 FFA8          M         movff   POSTINC1, EEDATA
                          M         ; configure eeprom
                          M         ; point to EEPROM DATA memory
001C54 9EA6               M         bcf             EECON1, EEPGD, ACCESS
                          M         ; Access EEPROM/Program
001C56 9CA6               M         bcf             EECON1, CFGS, ACCESS    
                          M         ; Enable writes
001C58 84A6               M         bsf             EECON1, WREN, ACCESS
                          M 
                          M         ; don't have to disable interrupts because I'm only calling this
                          M         ; from within the high-priority ISR
                          M 
                          M         ; required write enable sequence
001C5A 0E55               M         movlw   0x55
001C5C 6EA7               M         movwf   EECON2, ACCESS
001C5E 0EAA               M         movlw   0xAA
001C60 6EA7               M         movwf   EECON2, ACCESS
                          M 
                          M         ; set WR bit to begin write
001C62 82A6               M         bsf             EECON1, WR, ACCESS
001C64                    M writeIntEE_loop
                          M         ; wait for write to complete
001C64 B2A6               M         btfsc   EECON1, WR, ACCESS
001C66 D???               M         bra             writeIntEE_loop
                          M         ; disable writes
001C68 94A6               M         bcf             EECON1, WREN, ACCESS
                          M 
                          M         ; point to Program memory
001C6A 8EA6               M         bsf             EECON1, EEPGD, ACCESS
                          M 
                      00199         ; write data
001C6C 2A3F           00200         incf    mlEepromAddress, f, ACCESS
001C6E 0E16           00201         movlw   ML_LARGE_PACKET_BYTE_SIZE
001C70 623F           00202         cpfseq  mlEepromAddress, ACCESS
001C72 D???           00203         bra             mootLoader_SebWriteReceivedPacketToEEPROMLp
                      00204 
001C74                00205 mootLoader_signalErrorBLp0
                      00206         LED_SQUARE_TOGGLE_OTHERS_OFF
                          M         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
001C74 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_TOGGLE
001C76 788B               M         btg             LATC, RC4, ACCESS       ; SQUARE LED
                          M         LED_SAMPLE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATA, RA5, ACCESS       ; SAMPLE LED
                          M #else
001C78 9A89               M         bcf             LATA, RA5, ACCESS       ; SAMPLE LED
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 225


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                          M #endif
001C7A 6A13           00207         clrf    mlCount, ACCESS
001C7C 0E10           00208         movlw   0x10
001C7E 6E14           00209         movwf   mlCount + 1, ACCESS
001C80                00210 mootLoader_signalErrorBLp1
                      00211         ; clear interrupt flag
001C80 929E           00212         bcf             PIR1, TMR2IF, ACCESS    
001C82                00213 mootLoader_signalErrorBLp2
                      00214         ; wait for timer2 overflow
001C82 A29E           00215         btfss   PIR1, TMR2IF, ACCESS
001C84 D???           00216         bra             mootLoader_signalErrorBLp2
001C86 0613           00217         decf    mlCount, f, ACCESS
001C88 B4D8           00218         btfsc   STATUS, Z, ACCESS
001C8A 2E14           00219         decfsz  mlCount + 1
001C8C D???           00220         bra             mootLoader_signalErrorBLp1
                      00221         ; loop forever
001C8E D???           00222         bra             mootLoader_signalErrorBLp0
                      00223 ;**********************************************************************
                      00224 ; Local Function: void mootLoader_signalErrorC()
                      00225 ;**********************************************************************
001C90                00226 mootLoader_signalErrorC
                      00227         LED_SAMPLE_TOGGLE_OTHERS_OFF
                          M         LED_SINE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC3, ACCESS       ; SINE LED
                          M #else
001C90 968B               M         bcf             LATC, RC3, ACCESS       ; SINE LED
                          M #endif
                          M         LED_SQUARE_OFF
                          M #ifndef LED_POLARITY_REVERSED
                          M         bsf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #else
001C92 988B               M         bcf             LATC, RC4, ACCESS       ; SQUARE LED
                          M #endif
                          M         LED_SAMPLE_TOGGLE
001C94 7A89               M         btg             LATA, RA5, ACCESS       ; SAMPLE LED
001C96 6A13           00228         clrf    mlCount, ACCESS
001C98 0E10           00229         movlw   0x10
001C9A 6E14           00230         movwf   mlCount + 1, ACCESS
001C9C                00231 mootLoader_signalErrorCLp1
                      00232         ; clear interrupt flag
001C9C 929E           00233         bcf             PIR1, TMR2IF, ACCESS    
001C9E                00234 mootLoader_signalErrorCLp2
                      00235         ; wait for timer2 overflow
001C9E A29E           00236         btfss   PIR1, TMR2IF, ACCESS
001CA0 D???           00237         bra             mootLoader_signalErrorCLp2
001CA2 0613           00238         decf    mlCount, f, ACCESS
001CA4 B4D8           00239         btfsc   STATUS, Z, ACCESS
001CA6 2E14           00240         decfsz  mlCount + 1
001CA8 D???           00241         bra             mootLoader_signalErrorCLp1
                      00242         ; loop forever
001CAA D???           00243         bra             mootLoader_signalErrorC
                      00244         
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 226


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00245 
                      00246 ;**********************************************************************
                      00247 ; Local Function: void mootLoader_rxReceiverResetHandler()
                      00248 ;**********************************************************************
Warning[208]: Label truncated at 32 characters. (mootLoader_rxReceiverResetHandler)
001CAC                00249 mootLoader_rxReceiverResetHandler
                      00250         ; received bytes are forwarded to UART output for chaining devices so
                      00251         ; make sure that you don't reset until last byte is transmitted 
001CAC A89E           00252         btfss   PIR1, TXIF, ACCESS
001CAE D???           00253         bra             mootLoader_rxReceiverResetHandler
001CB0 00FF           00254         reset
                      00255 
                      00256 
                      00257 ;**********************************************************************
                      00258 ; Local Function: void mootloader_rxTestSinglePacketChecksum()
                      00259 ;**********************************************************************
Warning[208]: Label truncated at 32 characters. (mootloader_rxTestSinglePacketChecksum)
001CB2                00260 mootloader_rxTestSinglePacketChecksum
                      00261         ; pre-clear checksumOk flag
001CB2 9215           00262         bcf             mlFlags, mlRxChecksumOk, ACCESS
                      00263         ; calculate checksum for single packet
001CB4 501E           00264         movf    mlRxReceivedPacket + 3, w, ACCESS
001CB6 181F           00265         xorwf   mlRxReceivedPacket + 4, w, ACCESS
001CB8 1821           00266         xorwf   mlRxReceivedPacket + 6, w, ACCESS
001CBA 1823           00267         xorwf   mlRxReceivedPacket + 8, w, ACCESS
001CBC 1825           00268         xorwf   mlRxReceivedPacket + 10, w, ACCESS
001CBE 1827           00269         xorwf   mlRxReceivedPacket + 12, w, ACCESS
001CC0 1829           00270         xorwf   mlRxReceivedPacket + 14, w, ACCESS
001CC2 182B           00271         xorwf   mlRxReceivedPacket + 16, w, ACCESS
001CC4 182D           00272         xorwf   mlRxReceivedPacket + 18, w, ACCESS
                      00273         ; xor mlRxReceivedPacket[8:0] with checksum in mlRxReceivedPacket[9]
001CC6 0B7F           00274         andlw   0x7F
001CC8 182F           00275         xorwf   mlRxReceivedPacket + 20, w, ACCESS
                      00276         ; if result is 0 then checksum if NOT ok so skip
001CCA B4D8           00277         btfsc   STATUS, Z, ACCESS
001CCC 8215           00278         bsf             mlFlags, mlRxChecksumOk, ACCESS
001CCE 0012           00279         return
                      00280 
                      00281 
                      00282 ;**********************************************************************
                      00283 ; Local Function: void mootLoader_rxReceiveNextPacket()
                      00284 ;**********************************************************************
001CD0                00285 mootLoader_rxReceiveNextPacket
                      00286         PUSH_R  FSR0L
001CD0 CFE9 FFDD          M         movff   FSR0L,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
                      00287         PUSH_R  FSR0H   
001CD4 CFEA FFDD          M         movff   FSR0H,   softwareStackPointerPOSTDEC    ; softwareStackPointerINDF-- = regName
001CD8 EE00 F01B      00288         lfsr    FSR0, mlRxReceivedPacket
                      00289 
001CDC 6A31           00290         clrf    mlRxReceivedPacketByteCount, ACCESS
                      00291         
                      00292         ; get next SysEx packet
                      00293 
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 227


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00294         ; mootloader only responds to SysEx so wait for start value of 0xF0
Warning[208]: Label truncated at 32 characters. (mootLoader_rxReceiveNextPacketWaitF0)
001CDE                00295 mootLoader_rxReceiveNextPacketWaitF0
001CDE EC?? F???      00296         call    mootLoader_rxReceiveNextByte
001CE2 0EF0           00297         movlw   0xF0
001CE4 6232           00298         cpfseq  mlRxReceivedByte, ACCESS
001CE6 D???           00299         bra             mootLoader_rxReceiveNextPacketWaitF0
                      00300         ; received 0xF0 so continue
001CE8 C032 FFEE      00301         movff   mlRxReceivedByte, POSTINC0
                      00302         
                      00303         ; continue receiving balance of ML_LARGE_PACKET_BYTE_SIZE number of bytes
                      00304         ; init count
001CEC 0E15           00305         movlw   ML_LARGE_PACKET_BYTE_SIZE - 1
001CEE 6E31           00306         movwf   mlRxReceivedPacketByteCount, ACCESS
001CF0                00307 mootLoader_rxRnpPayloadLp
001CF0 EC?? F???      00308         call    mootLoader_rxReceiveNextByte
001CF4 C032 FFEE      00309         movff   mlRxReceivedByte, POSTINC0
001CF8 2E31           00310         decfsz  mlRxReceivedPacketByteCount, f, ACCESS
001CFA D???           00311         bra             mootLoader_rxRnpPayloadLp
                      00312 
                      00313         ; make each data payload nybble index equal to reconstituted byte value
                      00314         ; point to start of data payload
001CFC EE00 F01F      00315         lfsr    FSR0, mlRxReceivedPacket + 4
                      00316         ; load count to de-nybble 8 bytes
001D00 0E08           00317         movlw   8
001D02 6E31           00318         movwf   mlRxReceivedPacketByteCount, ACCESS
Warning[208]: Label truncated at 32 characters. (mootLoader_rxRnpPayloadDe_nybbleLp)
001D04                00319 mootLoader_rxRnpPayloadDe_nybbleLp
                      00320         ; swap and read high nybble into WREG
001D04 0E01           00321         movlw   1
001D06 38EB           00322         swapf   PLUSW0, w, ACCESS
                      00323         ; or high nybble and low nybble, save in WREG
001D08 10EF           00324         iorwf   INDF0, w, ACCESS
                      00325         ; save complete value in low nybble location and postinc to high nybble
001D0A 6EEE           00326         movwf   POSTINC0, ACCESS
                      00327         ; save complete value in high nybble location and postinc to next low nybble
001D0C 6EEE           00328         movwf   POSTINC0, ACCESS
001D0E 2E31           00329         decfsz  mlRxReceivedPacketByteCount, f, ACCESS
001D10 D???           00330         bra             mootLoader_rxRnpPayloadDe_nybbleLp      
                      00331         
                      00332         POP_R   FSR0H   
001D12 CFDC FFEA          M         movff   softwareStackPointerPREINC, FSR0H       ; ++softwareStackPointerINDF = regName
                      00333         POP_R   FSR0L
001D16 CFDC FFE9          M         movff   softwareStackPointerPREINC, FSR0L       ; ++softwareStackPointerINDF = regName
001D1A 0012           00334         return
                      00335         
                      00336 
                      00337 ;**********************************************************************
                      00338 ; Local Function: void mootloader_rxReceiveNextByte()
                      00339 ;**********************************************************************
001D1C                00340 mootLoader_rxReceiveNextByte
                      00341         ; skip if receive flag is set
001D1C AA9E           00342         btfss   PIR1, RCIF, ACCESS
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 228


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

001D1E D???           00343         bra             mootLoader_rxReceiveNextByte
                      00344         
Warning[208]: Label truncated at 32 characters. (mootLoader_rxReceiveNextByteReadFIFO)
001D20                00345 mootLoader_rxReceiveNextByteReadFIFO
                      00346         ; skip if framing error occurred for top unread char in rx FIFO
001D20 A4AB           00347         btfss   RCSTA, FERR, ACCESS
                      00348         ; no framing error so read the character
001D22 D???           00349         bra             mootLoader_rxReceiveNextByteGO
                      00350         ; framing error occurred
                      00351         ; read incorrectly framed character out of FIFO
001D24 50AE           00352         movf    RCREG, w, ACCESS
                      00353         ; skip if rx FIFO is empty
001D26 BA9E           00354         btfsc   PIR1, RCIF, ACCESS
                      00355         ; FIFO is not empty so try next character
001D28 D???           00356         bra             mootLoader_rxReceiveNextByteReadFIFO
                      00357         ; all characters in FIFO were incorrectly framed, no data to process
                      00358         ; attempt to remedy: reset UART receiver by toggling Continous Receive Enable bit
001D2A 98AB           00359         bcf             RCSTA, CREN, ACCESS
001D2C 88AB           00360         bsf             RCSTA, CREN, ACCESS
                      00361         ; need to receive a good data so try again
001D2E EF?? F???      00362         goto    mootLoader_rxReceiveNextByte
001D32                00363 mootLoader_rxReceiveNextByteGO
                      00364         ; read the byte
001D32 CFAE F032      00365         movff   RCREG, mlRxReceivedByte
                      00366 
                      00367         ; echo received byte to UART output
001D36 C032 FFAD      00368         movff   mlRxReceivedByte, TXREG
                      00369 
001D3A 0012           00370         return
                      00371 
                      00372         
001D3C                00168 mootLoader_restore
001D3C EF?? F???      00169         goto    mootLoader_exit
                      00170         
                      00359 #endif
                      00360 
                      00361 #ifdef PIC18LF14K22
                      00362         ; bootBlockStartAddres - 2
                      00363         ORG             0x37FE
                      00364 lastApplicationProgramMemoryAddress
                      00365         nop
                      00366         
                      00367         ; (Program Memory Size - Boot Block Size)
                      00368         ;       8kW (16384 bytes) - 1kW (2048 bytes)
                      00369         ; 0x4000 - 0x0800 = 0x3800
                      00370         ORG             0x3800
                      00371         #include        "../source/mootLoader.asm"
                      00372 #endif
                      00373 
                      00374         END
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 229


SYMBOL TABLE
  LABEL                             VALUE 

A                                 00000000
ABDEN                             00000000
ABDOVF                            00000007
ACCESS                            00000000
ACCUMULATORS_ELEMENT_SIZE         4
ACCUMULATORS_SIZE                 MAX_POLY_DEPTH * ACCUMULATORS_ELEMENT_SIZE
ACKDT                             00000005
ACKEN                             00000004
ACKSTAT                           00000006
ACQT0                             00000003
ACQT1                             00000004
ACQT2                             00000005
ACTIVE_NOTE_DELTAS_ELEMENT_SIZE   2
ACTIVE_NOTE_DELTAS_SIZE           MAX_POLY_DEPTH * ACTIVE_NOTE_DELTAS_ELEMENT_SIZE
ACTIVE_NOTE_TABLE_SIZE            25
ACTIVE_OUTPUT_VALUES_EL_SIZE      1
ACTIVE_OUTPUT_VALUES_SIZE         MAX_POLY_DEPTH * ACTIVE_OUTPUT_VALUES_EL_SIZE
ACTVIE                            00000002
ACTVIF                            00000002
ADCON0                            00000FC2
ADCON1                            00000FC1
ADCON2                            00000FC0
ADCS0                             00000000
ADCS1                             00000001
ADCS2                             00000002
ADDEN                             00000003
ADDR0                             00000000
ADDR1                             00000001
ADDR2                             00000002
ADDR3                             00000003
ADDR4                             00000004
ADDR5                             00000005
ADDR6                             00000006
ADEN                              00000003
ADFM                              00000007
ADIE                              00000006
ADIF                              00000006
ADIP                              00000006
ADON                              00000000
ADRES                             00000FC3
ADRESH                            00000FC4
ADRESL                            00000FC3
ADSR_ATTACK_RATE                  63
ADSR_PRESCALE                     610
ADSR_RELEASE_RATE                 16
AFTERTOUCH_COMPLETE               DATA_BYTE1
ALL_NOTES_OFF                     123
ALL_SOUND_OFF                     120
AN10                              00000004
AN11                              00000005
AN3                               00000004
AN4                               00000000
AN5                               00000001
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 230


SYMBOL TABLE
  LABEL                             VALUE 

AN6                               00000002
AN7                               00000003
AN8                               00000006
AN9                               00000007
ANS10                             00000002
ANS11                             00000003
ANS3                              00000003
ANS4                              00000004
ANS5                              00000005
ANS6                              00000006
ANS7                              00000007
ANS8                              00000000
ANS9                              00000001
ANSEL                             00000F7E
ANSELH                            00000F7F
ASSERT_SS                         
BALANCE_LSB                       40
BALANCE_MSB                       8
BANKED                            00000001
BANK_SELECT_LSB                   32
BANK_SELECT_MSB                   0
BAUDCON                           00000FB8
BAUDCTL                           00000FB8
BCLIE                             00000003
BCLIF                             00000003
BCLIP                             00000003
BF                                00000000
BOR                               00000000
BP0                               2
BP1                               3
BREATH_CONTROLLER_LSB             34
BREATH_CONTROLLER_MSB             2
BRG16                             00000003
BRGH                              00000002
BSR                               00000FE0
BTOEE                             00000004
BTOEF                             00000004
BTSEE                             00000007
BTSEF                             00000007
C                                 00000000
C12IN1M                           00000001
C12IN2M                           00000002
C12IN3M                           00000003
C12INP                            00000000
C12OUT                            00000004
C1CH0                             00000000
C1CH1                             00000001
C1HYS                             00000003
C1IE                              00000006
C1IF                              00000006
C1IP                              00000006
C1OE                              00000005
C1ON                              00000007
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 231


SYMBOL TABLE
  LABEL                             VALUE 

C1OUT                             00000006
C1POL                             00000004
C1R                               00000002
C1RSEL                            00000005
C1SP                              00000003
C1SYNC                            00000001
C2CH0                             00000000
C2CH1                             00000001
C2HYS                             00000002
C2IE                              00000005
C2IF                              00000005
C2IP                              00000005
C2OE                              00000005
C2ON                              00000007
C2OUT                             00000006
C2POL                             00000004
C2R                               00000002
C2RSEL                            00000004
C2SP                              00000003
C2SYNC                            00000000
CCP1                              00000005
CCP1CON                           00000FBD
CCP1IE                            00000002
CCP1IF                            00000002
CCP1IP                            00000002
CCP1M0                            00000000
CCP1M1                            00000001
CCP1M2                            00000002
CCP1M3                            00000003
CCPR1                             00000FBE
CCPR1H                            00000FBF
CCPR1L                            00000FBE
CFGS                              00000006
CHANNEL                           0x00
CHANNEL_PRESSURE                  0xD0
CHANNEL_PRESSURE_MESSAGE_LENGTH   2
CHANNEL_VOLUME_LSB                39
CHANNEL_VOLUME_MSB                7
CHS0                              00000002
CHS1                              00000003
CHS2                              00000004
CHS3                              00000005
CK                                00000007
CKE                               00000006
CKP                               00000004
CKTXP                             00000004
CLEAR_ACCUMULATORS                
CLKIN                             00000005
CLKOUT                            00000004
CM1CON0                           00000F6D
CM2CON0                           00000F6B
CM2CON1                           00000F6C
CONFIG_INC                        
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 232


SYMBOL TABLE
  LABEL                             VALUE 

CONTROL_CHANGE                    0xB0
CONTROL_CHANGE_COMPLETE           DATA_BYTE1
CONTROL_CHANGE_MESSAGE_LENGTH     3
CRC16EE                           00000002
CRC16EF                           00000002
CRC5EE                            00000001
CRC5EF                            00000001
CREN                              00000004
CSRC                              00000007
CVREF                             00000002
D                                 00000005
D1EN                              00000007
D1LPS                             00000006
D1NSS                             00000000
D1PSS0                            00000002
D1PSS1                            00000003
DAC1OE                            00000005
DAC1R0                            00000000
DAC1R1                            00000001
DAC1R2                            00000002
DAC1R3                            00000003
DAC1R4                            00000004
DATA_BYTE0                        0x01
DATA_BYTE1                        0x02
DATA_DECREMENT                    97
DATA_ENTRY_LSB                    38
DATA_ENTRY_MSB                    6
DATA_INCREMENT                    96
DC                                00000001
DC1B0                             00000004
DC1B1                             00000005
DDRA                              TRISA
DDRB                              TRISB
DDRC                              TRISC
DDRD                              TRISD
DDRE                              TRISE
DEASSERT_SS                       
DELEGATED_DELTAS_ELEMENT_SIZE     2
DELEGATED_DELTAS_SIZE             MAX_POLY_DEPTH * DELEGATED_DELTAS_ELEMENT_SIZE
DEVICE_ID                         0x1D
DFN8EE                            00000003
DFN8EF                            00000003
DIR                               00000002
DISABLE_SUSTAIN                   
DONE                              00000001
DTRXP                             00000005
D_A                               00000005
D_NOT_A                           00000005
ECCP1AS                           00000FB6
ECCPAS0                           00000004
ECCPAS1                           00000005
ECCPAS2                           00000006
ECCPASE                           00000007
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 233


SYMBOL TABLE
  LABEL                             VALUE 

EEADR                             00000FA9
EEADR0                            00000000
EEADR1                            00000001
EEADR2                            00000002
EEADR3                            00000003
EEADR4                            00000004
EEADR5                            00000005
EEADR6                            00000006
EEADR7                            00000007
EECON1                            00000FA6
EECON2                            00000FA7
EEDATA                            00000FA8
EEIE                              00000004
EEIF                              00000004
EEIP                              00000004
EEPGD                             00000007
EEPROM_SIZE_BITS                  128000
EE_DISABLE_INTS                   
EE_RDSR                           B'00000101'
EE_READ                           B'00000011'
EE_RESTORE_INTS                   
EE_WRDI                           B'00000100'
EE_WREN                           B'00000110'
EE_WRITE                          B'00000010'
EE_WRSR                           B'00000001'
EFFECTS_1_DEPTH_DEFAULT_REVERB_S  91
EFFECTS_2_DEPTH_DEFAULT_TREMOLO_  92
EFFECTS_3_DEPTH_DEFAULT_CHORUS_S  93
EFFECTS_4_DEPTH_DEFAULT_CELESTE_  94
EFFECTS_5_DEPTH_DEFAULT_PHASER_D  95
EFFECT_CONTROL_1_LSB              44
EFFECT_CONTROL_1_MSB              12
EFFECT_CONTROL_2_LSB              45
EFFECT_CONTROL_2_MSB              13
ENABLE_SUSTAIN                    
ENDP0                             00000003
ENDP1                             00000004
ENDP2                             00000005
ENDP3                             00000006
EOX                               0xF7
EPCONDIS                          00000003
EPHSHK                            00000004
EPINEN                            00000001
EPOUTEN                           00000002
EPSTALL                           00000000
EXPRESSION_LSB                    43
EXPRESSION_MSB                    11
FAST                              00000001
FERR                              00000002
FOOT_CONTROLLER_LSB               36
FOOT_CONTROLLER_MSB               4
FREE                              00000004
FRM0                              00000000
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 234


SYMBOL TABLE
  LABEL                             VALUE 

FRM1                              00000001
FRM10                             00000002
FRM2                              00000002
FRM3                              00000003
FRM4                              00000004
FRM5                              00000005
FRM6                              00000006
FRM7                              00000007
FRM8                              00000000
FRM9                              00000001
FSEN                              00000002
FSR0                              00000000
FSR0H                             00000FEA
FSR0L                             00000FE9
FSR1                              00000001
FSR1H                             00000FE2
FSR1L                             00000FE1
FSR2                              00000002
FSR2H                             00000FDA
FSR2L                             00000FD9
FVR1EN                            00000007
FVR1S0                            00000004
FVR1S1                            00000005
FVR1ST                            00000006
GCEN                              00000007
GENERAL_INFORMATION               0x06
GENERAL_PURPOSE_CONTROLLER_1_LSB  48
GENERAL_PURPOSE_CONTROLLER_1_MSB  16
GENERAL_PURPOSE_CONTROLLER_2_LSB  49
GENERAL_PURPOSE_CONTROLLER_2_MSB  17
GENERAL_PURPOSE_CONTROLLER_3_LSB  50
GENERAL_PURPOSE_CONTROLLER_3_MSB  18
GENERAL_PURPOSE_CONTROLLER_4_LSB  51
GENERAL_PURPOSE_CONTROLLER_4_MSB  19
GENERAL_PURPOSE_CONTROLLER_5      80
GENERAL_PURPOSE_CONTROLLER_6      81
GENERAL_PURPOSE_CONTROLLER_7      82
GENERAL_PURPOSE_CONTROLLER_8      83
GIE                               00000007
GIEH                              00000007
GIEL                              00000006
GIE_GIEH                          00000007
GO                                00000001
GO_DONE                           00000001
GO_NOT_DONE                       00000001
HFIOFL                            00000001
HOLD_2                            69
IDENTITY_REPLY                    0x02
IDENTITY_REQUEST                  0x01
IDLEIE                            00000004
IDLEIF                            00000004
IDLEN                             00000007
IDLE_BLOCK_ERASE                  
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 235


SYMBOL TABLE
  LABEL                             VALUE 

IDLE_WRITE_WAIT                   
INC_PRESCALE_COUNTERS             
INDF0                             00000FEF
INDF1                             00000FE7
INDF2                             00000FDF
INT0                              00000000
INT0E                             00000004
INT0F                             00000001
INT0IE                            00000004
INT0IF                            00000001
INT1                              00000001
INT1E                             00000003
INT1F                             00000000
INT1IE                            00000003
INT1IF                            00000000
INT1IP                            00000006
INT1P                             00000006
INT2                              00000002
INT2E                             00000004
INT2F                             00000001
INT2IE                            00000004
INT2IF                            00000001
INT2IP                            00000007
INT2P                             00000007
INTCON                            00000FF2
INTCON2                           00000FF1
INTCON3                           00000FF0
INTEDG0                           00000006
INTEDG1                           00000005
INTEDG2                           00000004
INTSRC                            00000007
IOCA                              00000F79
IOCA0                             00000000
IOCA1                             00000001
IOCA3                             00000003
IOCA4                             00000004
IOCA5                             00000005
IOCB                              00000F7A
IOCB4                             00000004
IOCB5                             00000005
IOCB6                             00000006
IOCB7                             00000007
IOFS                              00000002
IPEN                              00000007
IPR1                              00000F9F
IPR2                              00000FA2
IRCF0                             00000004
IRCF1                             00000005
IRCF2                             00000006
KEY_PRESSURE                      0xA0
KEY_PRESSURE_MESSAGE_LENGTH       3
LATA                              00000F89
LATA4                             00000004
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 236


SYMBOL TABLE
  LABEL                             VALUE 

LATA5                             00000005
LATB                              00000F8A
LATB4                             00000004
LATB5                             00000005
LATB6                             00000006
LATB7                             00000007
LATC                              00000F8B
LATC0                             00000000
LATC1                             00000001
LATC2                             00000002
LATC3                             00000003
LATC4                             00000004
LATC5                             00000005
LATC6                             00000006
LATC7                             00000007
LED_ALL_OFF                       
LED_ALL_ON                        
LED_ALL_TOGGLE                    
LED_BLINK_RATE_VOICE_RECORD       6
LED_BLINK_RATE_VOICE_THROUGH      20
LED_ONLY_SAMPLE_ON                
LED_ONLY_SINE_ON                  
LED_ONLY_SQUARE_ON                
LED_POLARITY_REVERSED             
LED_SAMPLE_OFF                    
LED_SAMPLE_ON                     
LED_SAMPLE_TOGGLE                 
LED_SAMPLE_TOGGLE_OTHERS_OFF      
LED_SINE_OFF                      
LED_SINE_ON                       
LED_SINE_TOGGLE                   
LED_SINE_TOGGLE_OTHERS_OFF        
LED_SQUARE_OFF                    
LED_SQUARE_ON                     
LED_SQUARE_TOGGLE                 
LED_SQUARE_TOGGLE_OTHERS_OFF      
LEGATO_FOOTSWITCH                 68
LEVEL_MONO_LED_BLINK_RATE         1
LEVEL_POLY_LED_BLINK_RATE         0
LEVEL_SUSTAIN_LED_BLINK_RATE      2
LFIOFS                            00000000
LOCAL_CONTROL_ONOFF               122
MAX_MIDI_MESSAGE_SIZE             24
MAX_MODE_LEVEL                    MONO
MAX_POLY_DEPTH                    4
MC1OUT                            00000007
MC2OUT                            00000006
MESSAGE_COMPLETE                  0xFF
MIDI_DEVICE_ID                    0x1D
MIDI_VENDOR_ID                    0x77
ML_BLOCK_ERASE_BYTE_SIZE          64
ML_BLOCK_ERASE_IDLE_TIME_MS       8
ML_COMMAND_DATA_PAYLOAD           0x01
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 237


SYMBOL TABLE
  LABEL                             VALUE 

ML_COMMAND_DATA_PAYLOAD_COMPLETE  0x02
ML_COMMAND_WRITE_PROGRAM_MEMORY   0x03
ML_DATA_PACKET_PAYLOAD_BYTE_SIZE  8
ML_LARGE_PACKET_BYTE_SIZE         22
ML_RECEIVER_RESET                 0x11
ML_TRANSMITTER_RESETTING          0x10
ML_TRANS_SYNC_IDLE_TIME_MS        32
ML_WRITE_IDLE_TIME_MS             8
MODULATION_WHEEL_LSB              33
MODULATION_WHEEL_MSB              1
MONO                              2
MSK0                              00000000
MSK1                              00000001
MSK2                              00000002
MSK3                              00000003
MSK4                              00000004
MSK5                              00000005
MSK6                              00000006
MSK7                              00000007
N                                 00000004
NEXT_SAMPLE_ADDRESSES_EL_SIZE     2
NON_REAL_TIME                     0x7E
NON_REG_PARAMETER_NUMBER_LSB      98
NON_REG_PARAMETER_NUMBER_MSB      99
NOTE_COMPLETE                     DATA_BYTE1
NOTE_OFF                          0x80
NOTE_OFF_MESSAGE_LENGTH           3
NOTE_ON                           0x90
NOTE_ON_MESSAGE_LENGTH            3
NOT_A                             00000005
NOT_ADDRESS                       00000005
NOT_BOR                           00000000
NOT_DONE                          00000001
NOT_PD                            00000002
NOT_POR                           00000001
NOT_RABPU                         00000007
NOT_RDY                           0
NOT_RI                            00000004
NOT_SS                            00000006
NOT_T1SYNC                        00000002
NOT_T3SYNC                        00000002
NOT_TO                            00000003
NOT_W                             00000002
NOT_WRITE                         00000002
NVCFG0                            00000000
NVCFG1                            00000001
OERR                              00000001
OMNI_MODE_OFF                     124
OMNI_MODE_ON                      125
OSC1                              00000005
OSC2                              00000004
OSCCON                            00000FD3
OSCCON2                           00000FD2
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 238


SYMBOL TABLE
  LABEL                             VALUE 

OSCFIE                            00000007
OSCFIF                            00000007
OSCFIP                            00000007
OSCTUNE                           00000F9B
OSC_ADVANCE_ADSR                  
OSC_DELTAS_ELEMENT_SIZE           2
OSC_DELTAS_SIZE                   MAX_POLY_DEPTH * OSC_DELTAS_ELEMENT_SIZE
OSC_MIX                           
OSC_READ_ADSR_FLAG                
OSC_STATE_BLOCK                   
OSC_TRANSITION_OUTPUT_THRESHOLD   0x04
OSTS                              00000003
OV                                00000003
P                                 00000004
P1A                               00000005
P1B                               00000004
P1C                               00000003
P1D                               00000002
P1M0                              00000006
P1M1                              00000007
PAN_LSB                           42
PAN_MSB                           10
PC                                00000FF9
PCL                               00000FF9
PCLATH                            00000FFA
PCLATU                            00000FFB
PD                                00000002
PDC0                              00000000
PDC1                              00000001
PDC2                              00000002
PDC3                              00000003
PDC4                              00000004
PDC5                              00000005
PDC6                              00000006
PEIE                              00000006
PEIE_GIEL                         00000006
PEN                               00000002
PGM                               00000003
PIC18LF13K50                      
PIDEE                             00000000
PIDEF                             00000000
PIE1                              00000F9D
PIE2                              00000FA0
PIR1                              00000F9E
PIR2                              00000FA1
PITCH_WHEEL                       0xE0
PITCH_WHEEL_COMPLETE              DATA_BYTE1
PITCH_WHEEL_MESSAGE_LENGTH        3
PKTDIS                            00000004
PLAYBACK                          2
PLUSW0                            00000FEB
PLUSW1                            00000FE3
PLUSW2                            00000FDB
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 239


SYMBOL TABLE
  LABEL                             VALUE 

POLY                              0
POLY_MODE_OFF                     126
POLY_MODE_ON                      127
POP_R                             
POR                               00000001
PORTA                             00000F80
PORTAMENTO_CONTROL                84
PORTAMENTO_ONOFF                  65
PORTAMENTO_TIME                   5
PORTAMENTO_TIME_LSB               37
PORTB                             00000F81
PORTC                             00000F82
POSTDEC0                          00000FED
POSTDEC1                          00000FE5
POSTDEC2                          00000FDD
POSTINC0                          00000FEE
POSTINC1                          00000FE6
POSTINC2                          00000FDE
PPB0                              00000000
PPB1                              00000001
PPBI                              00000001
PPBRST                            00000006
PR2                               00000FCB
PREINC0                           00000FEC
PREINC1                           00000FE4
PREINC2                           00000FDC
PRI_SD                            00000002
PROD                              00000FF3
PRODH                             00000FF4
PRODL                             00000FF3
PROGRAM_CHANGE                    0xC0
PROGRAM_CHANGE_COMPLETE           DATA_BYTE0
PROGRAM_CHANGE_MESSAGE_LENGTH     2
PRSEN                             00000007
PSA                               00000003
PSSAC0                            00000002
PSSAC1                            00000003
PSSBD0                            00000000
PSSBD1                            00000001
PSTRCON                           00000FB9
PUSH_R                            
PVCFG0                            00000002
PVCFG1                            00000003
PWM1CON                           00000FB7
PWM_IDLE_OUTPUT_VALUE             0x80
R                                 00000002
RA0                               00000000
RA1                               00000001
RA3                               00000003
RA4                               00000004
RA5                               00000005
RABIE                             00000003
RABIF                             00000000
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 240


SYMBOL TABLE
  LABEL                             VALUE 

RABIP                             00000000
RABPU                             00000007
RB4                               00000004
RB5                               00000005
RB6                               00000006
RB7                               00000007
RC0                               00000000
RC1                               00000001
RC2                               00000002
RC3                               00000003
RC4                               00000004
RC5                               00000005
RC6                               00000006
RC7                               00000007
RCEN                              00000003
RCIDL                             00000006
RCIE                              00000005
RCIF                              00000005
RCIP                              00000005
RCON                              00000FD0
RCREG                             00000FAE
RCSTA                             00000FAB
RD                                00000000
RD16                              00000007
RECORD                            1
RECORD_BUTTON_RELEASE_WAIT_TIME   26
REFCON0                           00000FBA
REFCON1                           00000FBB
REFCON2                           00000FBC
REGISTERED_PARAMETER_NUMBERMSB    101
REGISTERED_PARAMETER_NUMBER_LSB   100
RESET_ALL_CONTROLLERS             121
RESUME                            00000002
REVERSE_SAMPLE_IF_MOD_OVER_63     
RI                                00000004
RSEN                              00000001
RX                                00000005
RX9                               00000006
RX9D                              00000000
R_NOT_W                           00000002
R_W                               00000002
S                                 00000003
SAMPLE                            2
SAMPLE_DATA_BUFFER_SIZE           64
SAMPLE_DC_OFFSET                  (PWM_IDLE_OUTPUT_VALUE - 74)
SAMPLE_PRESCALE                   6
SBOREN                            00000006
SCK                               00000006
SCKP                              00000004
SCL                               00000006
SCS0                              00000000
SCS1                              00000001
SDA                               00000004
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 241


SYMBOL TABLE
  LABEL                             VALUE 

SDI                               00000004
SDO                               00000007
SE0                               00000005
SEN                               00000000
SENDB                             00000003
SEND_BYTE_DO_CHECKSUM             
SEND_BYTE_START_CHECKSUM          
SEND_CHECKSUM_CLEAR_RUN           
SEND_CHECKSUM_DO_RUN              
SEND_RUNNING_CHECKSUM             
SEND_SYSEX_INTRO_NO_CHECK         
SINE                              0
SLRA                              00000000
SLRB                              00000001
SLRC                              00000002
SLRCON                            00000F76
SMP                               00000007
SOFIE                             00000006
SOFIF                             00000006
SOFTWARESTACK_H                   
SOFT_PEDAL                        67
SOSTENUTO                         66
SOUND_CONTROLLER_10_GM2_DEFAULT_  79
SOUND_CONTROLLER_1_DEFAULT_SOUND  70
SOUND_CONTROLLER_2_DEFAULT_TIMBR  71
SOUND_CONTROLLER_3_DEFAULT_RELEA  72
SOUND_CONTROLLER_4_DEFAULT_ATTAC  73
SOUND_CONTROLLER_5_DEFAULT_BRIGH  74
SOUND_CONTROLLER_6_GM2_DEFAULT_D  75
SOUND_CONTROLLER_7_GM2_DEFAULT_V  76
SOUND_CONTROLLER_8_GM2_DEFAULT_V  77
SOUND_CONTROLLER_9_GM2_DEFAULT_V  78
SP0                               00000000
SP1                               00000001
SP2                               00000002
SP3                               00000003
SP4                               00000004
SPBRG                             00000FAF
SPBRGH                            00000FB0
SPEN                              00000007
SPLIT_BYTE_THEN_SEND_DO_CHECKSUM  
SPLLEN                            00000006
SQUARE                            1
SRCLK0                            00000004
SRCLK1                            00000005
SRCLK2                            00000006
SRCON0                            00000F68
SRCON1                            00000F69
SREN                              00000005
SRLEN                             00000007
SRNQEN                            00000002
SRPR                              00000000
SRPS                              00000001
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 242


SYMBOL TABLE
  LABEL                             VALUE 

SRQ                               00000004
SRQEN                             00000003
SRRC1E                            00000000
SRRC2E                            00000001
SRRCKE                            00000002
SRRPE                             00000003
SRSC1E                            00000004
SRSC2E                            00000005
SRSCKE                            00000006
SRSPE                             00000007
SS                                00000006
SSPADD                            00000FC8
SSPBUF                            00000FC9
SSPCON1                           00000FC6
SSPCON2                           00000FC5
SSPEN                             00000005
SSPIE                             00000003
SSPIF                             00000003
SSPIP                             00000003
SSPM0                             00000000
SSPM1                             00000001
SSPM2                             00000002
SSPM3                             00000003
SSPMSK                            00000F6F
SSPOV                             00000006
SSPSTAT                           00000FC7
STALLIE                           00000005
STALLIF                           00000005
STATUS                            00000FD8
STKFUL                            00000007
STKOVF                            00000007
STKPTR                            00000FFC
STKUNF                            00000006
STRA                              00000000
STRB                              00000001
STRC                              00000002
STRD                              00000003
STRSYNC                           00000004
SUSPND                            00000001
SUSTAIN                           1
SUSTAIN_PEDAL                     64
SWDTE                             00000000
SWDTEN                            00000000
SYNC                              00000004
SYSEX                             0xF0
T08BIT                            00000006
T0CKI                             00000005
T0CON                             00000FD5
T0CS                              00000005
T0IE                              00000005
T0IF                              00000002
T0PS0                             00000000
T0PS1                             00000001
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 243


SYMBOL TABLE
  LABEL                             VALUE 

T0PS2                             00000002
T0SE                              00000004
T13CKI                            00000006
T1CKPS0                           00000004
T1CKPS1                           00000005
T1CON                             00000FCD
T1OSCEN                           00000003
T1OSCI                            00000006
T1OSCO                            00000007
T1RUN                             00000006
T1SYNC                            00000002
T2CKPS0                           00000000
T2CKPS1                           00000001
T2CON                             00000FCA
T2OUTPS0                          00000003
T2OUTPS1                          00000004
T2OUTPS2                          00000005
T2OUTPS3                          00000006
T3CCP1                            00000003
T3CKPS0                           00000004
T3CKPS1                           00000005
T3CON                             00000FB1
T3SYNC                            00000002
TABLAT                            00000FF5
TBLPTR                            00000FF6
TBLPTRH                           00000FF7
TBLPTRL                           00000FF6
TBLPTRU                           00000FF8
TERMINAL_PACKET_COMMAND_VALUE     0x1E
THROUGH_HOLE_PCB                  
TMR0H                             00000FD7
TMR0IE                            00000005
TMR0IF                            00000002
TMR0IP                            00000002
TMR0L                             00000FD6
TMR0ON                            00000007
TMR1CS                            00000001
TMR1H                             00000FCF
TMR1IE                            00000000
TMR1IF                            00000000
TMR1IP                            00000000
TMR1L                             00000FCE
TMR1ON                            00000000
TMR2                              00000FCC
TMR2IE                            00000001
TMR2IF                            00000001
TMR2IP                            00000001
TMR2ON                            00000002
TMR3CS                            00000001
TMR3H                             00000FB3
TMR3IE                            00000001
TMR3IF                            00000001
TMR3IP                            00000001
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 244


SYMBOL TABLE
  LABEL                             VALUE 

TMR3L                             00000FB2
TMR3ON                            00000000
TO                                00000003
TOS                               00000FFD
TOSH                              00000FFE
TOSL                              00000FFD
TOSU                              00000FFF
TRISA                             00000F92
TRISA4                            00000004
TRISA5                            00000005
TRISB                             00000F93
TRISB4                            00000004
TRISB5                            00000005
TRISB6                            00000006
TRISB7                            00000007
TRISC                             00000F94
TRISC0                            00000000
TRISC1                            00000001
TRISC2                            00000002
TRISC3                            00000003
TRISC4                            00000004
TRISC5                            00000005
TRISC6                            00000006
TRISC7                            00000007
TRMT                              00000001
TRNIE                             00000003
TRNIF                             00000003
TUN0                              00000000
TUN1                              00000001
TUN2                              00000002
TUN3                              00000003
TUN4                              00000004
TUN5                              00000005
TX                                00000007
TX9                               00000006
TX9D                              00000000
TXEN                              00000005
TXIE                              00000004
TXIF                              00000004
TXIP                              00000004
TXREG                             00000FAD
TXSTA                             00000FAC
UA                                00000001
UADDR                             00000F5C
UCFG                              00000F61
UCON                              00000F64
UEIE                              00000F5B
UEIR                              00000F5F
UEP0                              00000F53
UEP1                              00000F54
UEP2                              00000F55
UEP3                              00000F56
UEP4                              00000F57
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 245


SYMBOL TABLE
  LABEL                             VALUE 

UEP5                              00000F58
UEP6                              00000F59
UEP7                              00000F5A
UERRIE                            00000001
UERRIF                            00000001
UFRMH                             00000F5E
UFRML                             00000F5D
UIE                               00000F60
UIR                               00000F62
UNDEFINED_003                     3
UNDEFINED_014                     14
UNDEFINED_015                     15
UNDEFINED_020                     20
UNDEFINED_021                     21
UNDEFINED_022                     22
UNDEFINED_023                     23
UNDEFINED_024                     24
UNDEFINED_025                     25
UNDEFINED_026                     26
UNDEFINED_027                     27
UNDEFINED_028                     28
UNDEFINED_029                     29
UNDEFINED_030                     30
UNDEFINED_031                     31
UNDEFINED_035                     35
UNDEFINED_041                     41
UNDEFINED_046                     46
UNDEFINED_047                     47
UNDEFINED_052                     52
UNDEFINED_053                     53
UNDEFINED_054                     54
UNDEFINED_055                     55
UNDEFINED_056                     56
UNDEFINED_057                     57
UNDEFINED_058                     58
UNDEFINED_059                     59
UNDEFINED_060                     60
UNDEFINED_061                     61
UNDEFINED_062                     62
UNDEFINED_063                     63
UNDEFINED_102                     102
UNDEFINED_103                     103
UNDEFINED_104                     104
UNDEFINED_105                     105
UNDEFINED_106                     106
UNDEFINED_107                     107
UNDEFINED_108                     108
UNDEFINED_109                     109
UNDEFINED_110                     110
UNDEFINED_111                     111
UNDEFINED_112                     112
UNDEFINED_113                     113
UNDEFINED_114                     114
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 246


SYMBOL TABLE
  LABEL                             VALUE 

UNDEFINED_115                     115
UNDEFINED_116                     116
UNDEFINED_117                     117
UNDEFINED_118                     118
UNDEFINED_119                     119
UNDEFINED_85                      85
UNDEFINED_86                      86
UNDEFINED_87                      87
UNDEFINED_88                      88
UNDEFINED_89                      89
UNDEFINED_90                      90
UNDEFINED_MSB                     9
UPUEN                             00000004
URSTIE                            00000000
URSTIF                            00000000
USBEN                             00000003
USBIE                             00000002
USBIF                             00000002
USBIP                             00000002
USER_CODE_START_ADDRESS           0x0040
USTAT                             00000F63
UTEYE                             00000007
VENDOR_ID                         0x77
VOICE_THROUGH                     0
VREFCON0                          00000FBA
VREFCON1                          00000FBB
VREFCON2                          00000FBC
VREFM                             00000001
VREFP                             00000000
W                                 00000000
WAVE_PRESCALE                     2
WCOL                              00000007
WDTCON                            00000FD1
WEL                               1
WPEN                              7
WPUA                              00000F77
WPUA3                             00000003
WPUA4                             00000004
WPUA5                             00000005
WPUB                              00000F78
WPUB4                             00000004
WPUB5                             00000005
WPUB6                             00000006
WPUB7                             00000007
WR                                00000001
WREG                              00000FE8
WREN                              00000002
WRERR                             00000003
WRITE_INTERNAL_EEPROM             
WRITE_INTERNAL_EEPROM_FROM_REGS   
WUE                               00000001
Z                                 00000002
_BBSIZ_OFF_4L                     000000F7
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 247


SYMBOL TABLE
  LABEL                             VALUE 

_BBSIZ_ON_4L                      000000FF
_BOREN_NOSLP_2L                   000000FD
_BOREN_OFF_2L                     000000F9
_BOREN_ON_2L                      000000FB
_BOREN_SBORDIS_2L                 000000FF
_BORV_19_2L                       000000FF
_BORV_22_2L                       000000F7
_BORV_27_2L                       000000EF
_BORV_30_2L                       000000E7
_CONFIG1H                         00300001
_CONFIG1L                         00300000
_CONFIG2H                         00300003
_CONFIG2L                         00300002
_CONFIG3H                         00300005
_CONFIG4L                         00300006
_CONFIG5H                         00300009
_CONFIG5L                         00300008
_CONFIG6H                         0030000B
_CONFIG6L                         0030000A
_CONFIG7H                         0030000D
_CONFIG7L                         0030000C
_CP0_OFF_5L                       000000FF
_CP0_ON_5L                        000000FE
_CP1_OFF_5L                       000000FF
_CP1_ON_5L                        000000FD
_CPB_OFF_5H                       000000FF
_CPB_ON_5H                        000000BF
_CPD_OFF_5H                       000000FF
_CPD_ON_5H                        0000007F
_CPUDIV_CLKDIV2_1L                000000EF
_CPUDIV_CLKDIV3_1L                000000F7
_CPUDIV_CLKDIV4_1L                000000FF
_CPUDIV_NOCLKDIV_1L               000000E7
_DEBUG_OFF_4L                     000000FF
_DEBUG_ON_4L                      0000007F
_DEVID1                           003FFFFE
_DEVID2                           003FFFFF
_EBTR0_OFF_7L                     000000FF
_EBTR0_ON_7L                      000000FE
_EBTR1_OFF_7L                     000000FF
_EBTR1_ON_7L                      000000FD
_EBTRB_OFF_7H                     000000FF
_EBTRB_ON_7H                      000000BF
_EEPROMH_                         
_FCMEN_OFF_1H                     000000BF
_FCMEN_ON_1H                      000000FF
_FOSC_ECCLKOUTH_1H                000000F4
_FOSC_ECCLKOUTL_1H                000000FC
_FOSC_ECCLKOUTM_1H                000000FA
_FOSC_ECH_1H                      000000F5
_FOSC_ECL_1H                      000000FD
_FOSC_ECM_1H                      000000FB
_FOSC_ERCCLKOUT_1H                000000F3
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 248


SYMBOL TABLE
  LABEL                             VALUE 

_FOSC_ERC_1H                      000000F7
_FOSC_HS_1H                       000000F2
_FOSC_IRCCLKOUT_1H                000000F9
_FOSC_IRC_1H                      000000F8
_FOSC_LP_1H                       000000F0
_FOSC_XT_1H                       000000F1
_HFOFST_OFF_3H                    000000F7
_HFOFST_ON_3H                     000000FF
_IDLOC0                           00200000
_IDLOC1                           00200001
_IDLOC2                           00200002
_IDLOC3                           00200003
_IDLOC4                           00200004
_IDLOC5                           00200005
_IDLOC6                           00200006
_IDLOC7                           00200007
_IESO_OFF_1H                      0000007F
_IESO_ON_1H                       000000FF
_LVP_OFF_4L                       000000FB
_LVP_ON_4L                        000000FF
_MCLRE_OFF_3H                     0000007F
_MCLRE_ON_3H                      000000FF
_MIDIH_                           
_MOOTLOADERH_                     
_PCLKEN_OFF_1H                    000000DF
_PCLKEN_ON_1H                     000000FF
_PLLEN_OFF_1H                     000000EF
_PLLEN_ON_1H                      000000FF
_PWRTEN_OFF_2L                    000000FF
_PWRTEN_ON_2L                     000000FE
_SOUNDGENH_                       
_STVREN_OFF_4L                    000000FE
_STVREN_ON_4L                     000000FF
_USBDIV_OFF_1L                    000000DF
_USBDIV_ON_1L                     000000FF
_USERINTERFACEH_                  
_WDTEN_OFF_2H                     000000FE
_WDTEN_ON_2H                      000000FF
_WDTPS_1024_2H                    000000F5
_WDTPS_128_2H                     000000EF
_WDTPS_16384_2H                   000000FD
_WDTPS_16_2H                      000000E9
_WDTPS_1_2H                       000000E1
_WDTPS_2048_2H                    000000F7
_WDTPS_256_2H                     000000F1
_WDTPS_2_2H                       000000E3
_WDTPS_32768_2H                   000000FF
_WDTPS_32_2H                      000000EB
_WDTPS_4096_2H                    000000F9
_WDTPS_4_2H                       000000E5
_WDTPS_512_2H                     000000F3
_WDTPS_64_2H                      000000ED
_WDTPS_8192_2H                    000000FB
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 249


SYMBOL TABLE
  LABEL                             VALUE 

_WDTPS_8_2H                       000000E7
_WRT0_OFF_6L                      000000FF
_WRT0_ON_6L                       000000FE
_WRT1_OFF_6L                      000000FF
_WRT1_ON_6L                       000000FD
_WRTB_OFF_6H                      000000FF
_WRTB_ON_6H                       000000BF
_WRTC_OFF_6H                      000000FF
_WRTC_ON_6H                       000000DF
_WRTD_OFF_6H                      000000FF
_WRTD_ON_6H                       0000007F
_XINST_OFF_4L                     000000BF
_XINST_ON_4L                      000000FF
__18LF13K50                       00000001
accumulators                      000000D1
activeNoteDeltas                  000000B9
activeNoteTable                   00000058
activeNoteTableAdd                000008AA
activeNoteTableAdd_exit           000008DC
activeNoteTableAdd_lp1            000008C8
activeNoteTableModified           3
activeNoteTableRemove             000008F8
activeNoteTableRemove_bubbleCont  00000958
activeNoteTableRemove_bubbleLoop  0000093A
activeNoteTableRemove_lp1         00000918
activeNoteTableRemove_lp1Jmp1     00000928
activeNoteTableRemove_lp1Wipe     00000924
activeNoteTableRemove_sortDone    00000962
activeNoteTableRemove_sortLoop    00000932
activeOutputValues                000000E1
adsrAttackRate                    00000037
adsrLimiterRegs                   00000033
adsrPrescaleCounter               00000039
adsrReleaseRate                   00000038
attack                            3
attackDone                        000011CC
bsrTmp                            00000002
controllerNumber                  noteNumberByte
controllerValue                   velocityByte
count                             sample
decay                             2
delegatedDeltas                   000000C1
delegatorBusy                     0
doAttack                          000011A8
doRelease                         000011DC
dummy_endOfVariables              000001A0
eepromFlags                       00000017
eepromInternalRead                000007CE
eepromReadSingleByte              0000072A
eepromReadSingleByte_lp1          0000073C
eepromReadStatusReg               000006F4
eepromReadStatusReg_doLp1         000006F6
eepromWrite64                     00000768
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 250


SYMBOL TABLE
  LABEL                             VALUE 

eepromWrite64_sendBuffer          0000079E
eepromWriteEnable                 000006E4
eepromWriteEnable_lp              000006E6
eepromWriteStatusReg              0000070A
eepromWriteStatusReg_doLp1        00000712
eepromXferSingleByte              00000694
eepromXferSingleByte_exit         000006B6
eepromXferSingleByte_lp           000006B0
endOfVariables                    0000003F
getActiveNoteDeltas               0000099E
getActiveNoteDeltasAgain          000009CA
getActiveNoteDeltas_exit          00000A42
getActiveNoteDeltas_loadSampleDe  000009F4
getActiveNoteDeltas_loop          000009CE
getActiveNoteDeltas_next          00000A3A
getActiveNoteDeltas_readTableAnd  00000A24
getActiveNoteDeltas_zeroDelta     00000A14
highPriorityISR                   0000004C
highPriorityISRTimer2_prescaleNo  00000070
highPriorityISRTimer2_prescaleOK  00000078
highPriorityISRTimer2_skipStep    00000098
highPriorityISR_INT0Done          000000C0
highPriorityISR_Timer2Done        000000AE
highPriorityISR_redirect          00000044
initADC                           0000032A
initCCP                           0000031C
initCore                          00000294
initExternalEEPROM                000006BC
initHeap                          00000380
initIO                            000002D4
initInternalEEPROM                000007C8
initInterrupts                    00000336
initMIDI                          00000386
initMIDI_lp                       000003AC
initOsc                           000002C6
initOsc_lp1                       000002CC
initRAM                           00000360
initRAM_bank0                     00000360
initRAM_bank0Lp                   00000364
initRAM_bank1                     0000036C
initRAM_bank2                     0000036C
initRAM_bank2Lp                   00000372
initSPI                           00000324
initSoundGen                      000007DA
initSoundGen_lp1                  0000085C
initSoundGen_lp2                  0000086A
initSoundGen_lp3                  00000878
initSoundGen_lp4                  00000888
initSoundGen_lp5                  00000896
initTimer0                        00000304
initTimer1                        00000312
initTimer2                        00000314
initUART                          000002F8
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 251


SYMBOL TABLE
  LABEL                             VALUE 

initUserInterface                 000012D2
intState                          2
keyPressed                        5
lastApplicationProgramMemoryAddr  000017FE
ledBlinkCounter                   0000003D
ledBlinkRate                      0000003C
ledOnOffFlags                     0000003E
lowPriorityISR                    000000CA
lowPriorityISR_INT1Done           000000FA
lowPriorityISR_INT2Done           0000010C
lowPriorityISR_TMR0AllOn          00000126
lowPriorityISR_TMR0Done           0000018E
lowPriorityISR_TMR0NotAllOn       0000012E
lowPriorityISR_TMR0SaBlink        0000017E
lowPriorityISR_TMR0SiBlink        00000140
lowPriorityISR_TMR0SqBlink        00000162
lowPriorityISR_TMR0TrySa          00000172
lowPriorityISR_TMR0TrySq          00000150
lowPriorityISR_redirect           00000048
main                              0000019E
mainCheckPlayback                 000001D0
mainCheckSampleWaveshape          000001DE
mainEepromReady                   000001FA
mainLoop                          000001BE
mainLoop_noRefresh                0000028C
mainNotSample                     00000282
mainSampleMono                    00000280
main_redirect                     00000040
midiFlags                         00000010
midiLastProgramValue              0000000F
midiMessageMapper                 000004DC
midiMessageMapper_doPanic         00000580
midiMessageMapper_exit            0000067A
midiMessageMapper_notAttack       00000626
midiMessageMapper_notControlChan  0000063A
midiMessageMapper_notControllerR  00000590
midiMessageMapper_notMod          00000612
midiMessageMapper_notNoteOff      00000536
midiMessageMapper_notNoteOn       00000528
midiMessageMapper_notNoteOnWithZ  0000051A
midiMessageMapper_notPG           0000065C
midiMessageMapper_notPanic        00000588
midiMessageMapper_notPitchWheel   0000056E
midiMessageMapper_notPolyOff      000005C0
midiMessageMapper_notPolyOn       000005D0
midiMessageMapper_notRelease      0000063A
midiMessageMapper_notSustain      000005B0
midiMessageMapper_notSysEx        0000067A
midiMessageMapper_pgCompare       0000064E
midiMessageMapper_pgDone          00000658
midiMessageMapper_pitchPos        00000568
midiMessageMapper_sustainOff      000005A6
midiNoteDeltaTable                0000133C
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 252


SYMBOL TABLE
  LABEL                             VALUE 

midiRxMessage                     00000040
midiRxMessage_length              0000000E
midiState_lastLength              0000000C
midiState_lastStatus              0000000B
midiState_messageNeedsMapping     1
midiThruModeEnabled               2
mixedOutputH                      0000002E
mixedOutputL                      0000002D
mlBlockEraseBytesRemaining        00000018
mlButtonState                     00000000
mlChecksum                        00000001
mlConsecutiveSymbolCount          00000034
mlCount                           00000013
mlCurrentTxByte                   00000017
mlDatPackIntByteCount             00000019
mlDataPayloadBuffer               0000000B
mlDecodedNybble                   0000003E
mlEepromAddress                   0000003F
mlEepromByteCount                 00000040
mlFlags                           00000015
mlNybbleSplitTmp                  00000016
mlPayloadLength                   00000007
mlPerfectPreludeCount             0000001A
mlPeriodBucketHighLimit           00000037
mlPeriodBucketLowLimit            00000036
mlRA4CompareReg                   00000039
mlRunningChecksum                 00000002
mlRxChecksumOk                    1
mlRxCyclePeriodH                  0000003B
mlRxCyclePeriodL                  0000003A
mlRxPreviousSymbolBucket          00000033
mlRxReceivedByte                  00000032
mlRxReceivedPacket                0000001B
mlRxReceivedPacketByteCount       00000031
mlRxSymbolBucket                  00000035
mlRxTransSyncFlag                 0
mlSchmittReadValue                0000003C
mlStartAddress                    00000003
mlSymbolBucketCount               00000038
mlTransitionCount                 0000003D
modeLevel                         00000020
modulation                        0000001D
modulationBlendTable              0000163C
mootLoader                        00001800
mootLoader_SebWriteReceivedPacke  00001C4C
mootLoader_checkReceive           00001842
mootLoader_checkRestore           0000184A
mootLoader_exit                   00001852
mootLoader_initADC                000018EA
mootLoader_initCCP                000018DC
mootLoader_initCore               00001856
mootLoader_initHeap               00001940
mootLoader_initIO                 00001896
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 253


SYMBOL TABLE
  LABEL                             VALUE 

mootLoader_initInterrupts         000018F6
mootLoader_initOsc                00001888
mootLoader_initOsc_lp1            0000188E
mootLoader_initRAM                00001920
mootLoader_initRAM_bank0          00001920
mootLoader_initRAM_bank0Lp        00001924
mootLoader_initRAM_bank1          0000192C
mootLoader_initRAM_bank2          0000192C
mootLoader_initRAM_bank2Lp        00001932
mootLoader_initSPI                000018E4
mootLoader_initTimer0             000018C6
mootLoader_initTimer1             000018D2
mootLoader_initTimer2             000018D4
mootLoader_initUART               000018BA
mootLoader_receiver               00001B5E
mootLoader_receiverListenForTran  00001B60
mootLoader_restore                00001D3C
mootLoader_rxReceiveNextByte      00001D1C
mootLoader_rxReceiveNextByteGO    00001D32
mootLoader_rxReceiveNextByteRead  00001D20
mootLoader_rxReceiveNextPacket    00001CD0
mootLoader_rxReceiveNextPacketWa  00001CDE
mootLoader_rxReceiverResetHandle  00001CAC
mootLoader_rxRnpPayloadDe_nybble  00001D04
mootLoader_rxRnpPayloadLp         00001CF0
mootLoader_rxWpmhBlockErase       00001BAC
mootLoader_rxWpmhExit             00001C26
mootLoader_rxWpmhGetNextPacket    00001BC0
mootLoader_rxWriteProgramMemoryH  00001B78
mootLoader_sendAsNybbles          00001B22
mootLoader_sendByte               00001B34
mootLoader_signalErrorA           00001C2A
mootLoader_signalErrorALp1        00001C36
mootLoader_signalErrorALp2        00001C38
mootLoader_signalErrorB           00001C46
mootLoader_signalErrorBLp0        00001C74
mootLoader_signalErrorBLp1        00001C80
mootLoader_signalErrorBLp2        00001C82
mootLoader_signalErrorC           00001C90
mootLoader_signalErrorCLp1        00001C9C
mootLoader_signalErrorCLp2        00001C9E
mootLoader_stateWaitLp            0000181E
mootLoader_stateWaitOvLp          00001828
mootLoader_transmitter            00001946
mootLoader_wait                   00001B3C
mootLoader_waitExit               00001B5C
mootLoader_waitIntLp              00001B4A
mootLoader_waitLp                 00001B48
mootLoader_xmitSdppLp             00001A90
mootLoader_xmitSendDataPayloadCo  00001AB8
mootLoader_xmitSendDataPayloadPa  00001A66
mootLoader_xmitSendWpmPacket      000019FA
mootLoader_xmitStartWrite         00001980
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 254


SYMBOL TABLE
  LABEL                             VALUE 

mootLoader_xmitWpmBlockErase      000019A0
mootLoader_xmitWpmByteLp          000019B2
mootLoader_xmitWpmCheckBlockEras  000019E4
mootLoader_xmitWpmNextPayload     000019AA
mootLoader_xmitWpmSendPayloadCom  000019EC
mootLoader_xmitWriteProgramMemor  00001988
mootloader_rxTestSinglePacketChe  00001CB2
needRefresh                       2
nextSampleAddress                 00000015
nextSampleAddresses               000000B1
osc0                              0
osc1                              1
osc2                              2
osc3                              3
oscAdsrTriggerAttack              00001240
oscAdsrTriggerAttackActive        00001266
oscAdsrTriggerAttackExit          0000127A
oscAdsrTriggerAttackNoReAttack    00001270
oscAdsrTriggerRelease             00001288
oscAdsrTriggerReleaseActive       000012BA
oscAdsrTriggerReleaseExit         000012C4
oscDeltas                         000000C9
oscResetFlags                     0000002A
oscStateFlags                     0000002F
pgDec                             1
pitchWheel                        00000019
polyDepth                         00000023
processRxAsMIDI                   000003C0
processRxAsMIDI_Exit              000004CA
processRxAsMIDI_RxHandlingDone    000004C4
processRxAsMIDI_checkEOX          0000049A
processRxAsMIDI_checkRxFIFO       000004C4
processRxAsMIDI_getLength         00000404
processRxAsMIDI_getLengthDone     00000450
processRxAsMIDI_lengthIs2         0000041A
processRxAsMIDI_lengthIs3         00000440
processRxAsMIDI_lengthIsNot2      00000420
processRxAsMIDI_lengthIsNot3      00000446
processRxAsMIDI_messageComplete   000004A0
processRxAsMIDI_noErrors          000003F8
processRxAsMIDI_notStatusContinu  00000484
processRxAsMIDI_notStatusOrIsEOX  0000046E
processRxAsMIDI_readFIFO          000003D4
processRxAsMIDI_readGO            000003E6
processRxAsMIDI_resetUartState    00000468
processRxAsMIDI_rxInProgress      0000047A
processRxAsMIDI_tryRunningStatus  000004AC
processSoundState                 00000C14
processSoundState_ADCWait         00000C52
processSoundState_Playback        00000D68
processSoundState_SoundOn         00000D76
processSoundState_StartADC        00000C50
processSoundState_cancelVoiceThr  00000C9C
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 255


SYMBOL TABLE
  LABEL                             VALUE 

processSoundState_clearTransFlag  000010AE
processSoundState_exit            0000113E
processSoundState_mixer           000010B2
processSoundState_recordGo        00000CA8
processSoundState_recordGoForRea  00000CB2
processSoundState_sampAmpExit     00000C7E
processSoundState_sampAmpNeg      00000C72
processSoundState_soundOnDone     0000113E
processSoundState_stopRecording   00000CDC
programValue                      noteNumberByte
r0                                00000003
r1                                00000004
r2                                00000005
r3                                00000006
r4                                00000007
r5                                00000008
r6                                00000009
r7                                0000000A
ready                             3
recordOrPlayback                  0000001F
recordWaitCountdown               0000003B
refreshActiveNoteState            00000980
refreshActiveNoteState_active     0000098A
refreshActiveNoteState_exit       00000998
refreshActiveNoteState_soundIsOf  00000994
release                           0
releaseDone                       00001202
sample                            0000002C
sampleChunkCount                  00000012
sampleChunkReady                  0
sampleDataBuffer                  00000071
sampleDataBufferIndex             00000011
sampleEndAddress                  00000013
sampleMidiNoteDeltaTable          0000143C
samplePrescaleCounter             00000021
samplesLoaded                     1
serviceADSR                       00001168
serviceADSRLoop                   00001192
serviceADSR_exit                  0000122A
serviceADSR_oscDone               0000121E
sineTable                         000016BC
sineTableBaseAddress              00000024
softwareStackBaseAddress          000002FF
softwareStackPointerFSR           FSR2
softwareStackPointerINDF          INDF2
softwareStackPointerPLUSW         PLUSW2
softwareStackPointerPOSTDEC       POSTDEC2
softwareStackPointerPOSTINC       POSTINC2
softwareStackPointerPREINC        PREINC2
soundGenFlags                     00000018
soundOn                           6
squareTable                       0000153C
squareTableBaseAddress            00000027
MPASM  5.42                ../SOURCE/MAIN.ASM   9-7-2011  18:29:00         PAGE 256


SYMBOL TABLE
  LABEL                             VALUE 

statusTmp                         00000001
sustain                           1
sustainFlags                      0000002B
theDelegatOr                      00000A70
theDelegatOr_andNotZero           00000B58
theDelegatOr_delInLp              00000B60
theDelegatOr_delInLpAssignOsc     00000B7A
theDelegatOr_delInLpForceAssign   00000B74
theDelegatOr_delInLpInit          00000B5A
theDelegatOr_delInLpNext          00000BAC
theDelegatOr_delOutLp             00000B44
theDelegatOr_delOutLpNext         00000BC0
theDelegatOr_done                 00000BE4
theDelegatOr_undelAndLoopDone     00000B2C
theDelegatOr_undelDdNonZero       00000AC6
theDelegatOr_undelInLp            00000ACC
theDelegatOr_undelNextAnd         00000B20
theDelegatOr_undelNextDD          00000B32
theDelegatOr_undelOutLp           00000AB6
theDelgatOr_doMono                00000BCE
turnSoundOff                      4
turnSoundOn                       3
uartState_currentRxIndex          0000000D
uartState_rxInProgress            0
userInterface_incMode             000012D8
userInterface_incModeCheckSustai  000012F6
userInterface_incModeDoMono       0000130E
userInterface_incModeDone         0000131A
userInterface_incWaveform         0000131C
userInterface_incWaveformDone     0000133A
userInterface_incWaveformInc      0000132E
wTmp                              00000000
wavePrescaleCounter               00000022
waveShape                         0000001E

Errors   :     0
Warnings :    26 reported,     0 suppressed
Messages :     0 reported,     0 suppressed

